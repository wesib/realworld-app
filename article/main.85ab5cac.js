import{g as e}from"../js/lib/call-thru.00f7427a.js";import{D as t,l as s,g as o,t as n}from"../js/lib/fun-events.5ba1262f.js";import{s as r,C as c,B as a,p as i,R as m,u as l}from"../js/wesib/wesib.1043e62e.js";import{_ as d}from"../js/helpers.920c7f83.js";import{n as h,a as p}from"../js/core/auth.d50771f1.js";import{a as u}from"../js/core/api.5c106641.js";import{b as f,e as g,i as b,S as j,O as C,a as x,N as _,c as v}from"../js/wesib/generic.8eaae636.js";import{e as y,f as O,I as w,g as E,h as k,j as F,r as M,k as N}from"../js/lib/input-aspects.bb07caa0.js";import{C as T}from"../js/core.f6946162.js";import{R as I,f as A,a as S}from"../js/core/loader.ff943207.js";import{c as R}from"../js/core/main.c1c022c8.js";import{A as D}from"../js/core/articles.eae191d7.js";import{F as $,c as B,n as L,C as U}from"../js/follow-author-btn.component.548049ab.js";import{e as q}from"../js/core/util.4298e8ae.js";import{A as H,D as P,E as Q}from"../js/index.24b61415.js";import{n as z,C as G,a as J}from"../js/current-article.10cd4166.js";import{C as K,a as V}from"../js/core/comments.027b08bc.js";import{C as W,U as X,F as Y}from"../js/core/input.0f0e7482.js";let Z=class{constructor(e){this._context=e,this.user=h,this.article=z;const t=e.get(p),s=e.get(f);e.whenOn(e=>{t.user.tillOff(e)(e=>this.user=e).whenOff(()=>this.user=h),s.get(G).tillOff(e)(e=>this.article=e).whenOff(()=>this.article=z)})}render(){const{document:e}=this._context.get(a),t=e.createDocumentFragment();if(this.article.slug&&this.article.author.username===this.user.username){t.appendChild(e.createElement("conduit-edit-post-btn")).tabIndex=0,t.appendChild(e.createElement("conduit-delete-post-btn")).tabIndex=0}else{t.appendChild(e.createElement("conduit-follow-author-btn")).tabIndex=0;const s=t.appendChild(e.createElement("conduit-favorite-post-btn"));s.innerText="Favorite Post",s.tabIndex=0}return t}};d([r()],Z.prototype,"user",void 0),d([r()],Z.prototype,"article",void 0),d([I()],Z.prototype,"render",null),Z=d([c(["article-actions",T],{feature:{needs:[H,P,Q]}})],Z);class ee extends CustomEvent{}let te=class{constructor(e){this._context=e,this.article=z,this.user=h,this.form={};const t=e.get(p),s=e.get(f);e.whenOn(e=>{t.user.tillOff(e)(e=>this.user=e).whenOff(()=>this.user=h),s.get(G).tillOff(e)(e=>this.article=e).whenOff(()=>this.article=z),s.get(g).tillOff(e)(e=>this.form=e).whenOff(()=>this.form={})})}render(){const e=this.articleComment;if(!e)return;const s=this._context.get(K),{document:o}=this._context.get(a),{author:n}=e,r=`profile/#/${encodeURIComponent(n.username)}`,c=n.image?'<img src="http://i.imgur.com/Qr71crq.jpg" class="comment-author-img" />':"",i=A(new Date(e.createdAt)),m=o.createDocumentFragment(),l=m.appendChild(o.createElement("div"));l.className="card-body";const d=l.appendChild(o.createElement("p"));d.className="card-text",d.innerText=e.body;const h=m.appendChild(o.createElement("div"));h.className="card-footer",h.innerHTML=`\n<a href="${r}" class="comment-author">${c}</a>\n<a href="${r}" class="comment-author">${q(n.username)}</a>\n<span class="date-posted">${i}</span>`;const{control:p}=this.form,{slug:f}=this.article;if(this.user.username===n.username&&p&&f){const n=h.appendChild(o.createElement("span"));n.className="mod-options";const r=n.appendChild(o.createElement("button"));r.type="button",r.className="btn btn-sm",r.innerHTML='<i class="ion-trash-a"></i>',y(r,{form:p}),new t(r).on("click").just(()=>{p.aspect(O).submit(()=>u(s.deleteComment(f,e.id))).then(()=>{this._context.dispatchEvent(new ee("conduit:comment",{bubbles:!0,detail:{removed:e.id}}))}).catch(e=>{e instanceof w?console.error("Failed to remove comment",...e.errors):console.error("Failed to remove comment",e)})})}return m}};d([i()],te.prototype,"articleComment",void 0),d([r()],te.prototype,"article",void 0),d([r()],te.prototype,"user",void 0),d([I({comment:"COMMENT"})],te.prototype,"render",null),te=d([c(["article-comment",T])],te);let se=class{constructor(t){this._context=t,this.comments=[];const n=t.get(K),r=this._context.get(f);this._context.whenOn(c=>{this._context.on("conduit:comment")(({detail:{added:e,removed:t}})=>{this.comments=e?[e,...this.comments]:this.comments.filter(e=>e.id!==t)});let a=z;r.get(G).tillOff(c).thru_(t=>t.slug&&t.slug!==a.slug?(a=t,s(n.articleComments(t.slug))):e)(e=>{this.response=e,e.ok&&(this.comments=e.body.comments)});const i=E({});o(i).needs(c),b(t,i)})}render(){const{document:e}=this._context.get(a),{contentRoot:t}=this._context,s=e.createRange();return s.setStartAfter(t.appendChild(e.createComment("[COMMENTS["))),s.setEndBefore(t.appendChild(e.createComment("]COMMENTS]"))),()=>{s.deleteContents();const{comments:t}=this;if(!t.length)return;const o=e.createDocumentFragment();t.forEach(t=>{o.appendChild(e.createElement("conduit-article-comment")).articleComment=t}),s.insertNode(o)}}};d([S({comment:"COMMENTS"})],se.prototype,"response",void 0),d([r()],se.prototype,"comments",void 0),d([m()],se.prototype,"render",null),se=d([c(["article-comments",T],{feature:{needs:[te,V,W]}})],se);let oe=class{constructor(e){this._context=e;const t=e.get(D),s=this._context.get(f);e.whenOn(o=>{o.whenOff(()=>this.content=void 0),s.get(G).tillOff(o)(s=>{s.slug?t.htmlContents(s).then(t=>{e.connected&&(this.content=t)}).catch(t=>{e.connected&&(this.content=void 0,console.error("Failed to parse article",t))}):this.content=void 0})})}render(){return this.content}};d([r()],oe.prototype,"content",void 0),d([I({comment:"ARTICLE(content)"})],oe.prototype,"render",null),oe=d([c(["article-content",T])],oe);let ne=class{};ne=d([c(["article-comment-text",T],X({select:"textarea",makeControl:({node:e,aspects:t})=>k(e.element,{aspects:t}).setup(F,e=>e.by(M()))}),j("text"))],ne);let re=class{constructor(e){this._context=e,this.article=z,this.user=h,this._commentService=e.get(K);const t=e.get(p),s=e.get(f);e.whenOn(e=>{t.user.tillOff(e)(e=>this.user=e).whenOff(()=>this.user=h),s.get(G).tillOff(e)(e=>this.article=e).whenOff(()=>this.article=z)})}render(){const{element:e}=this._context,t=e.querySelector(".comment-author-img");return()=>{this.user.email&&this.user.image?null==t||t.setAttribute("src",this.user.image):null==t||t.removeAttribute("src")}}submit({control:e}){const{article:t}=this;t.slug&&(e.aspect(N).markEdited(),e.aspect(O).submit(e=>u(this._commentService.addComment(t.slug,e.text))).then(t=>{e.it={text:""},e.aspect(N).markTouched(!1),e.aspect(O).reset(),this._context.dispatchEvent(new ee("conduit:comment",{bubbles:!0,detail:{added:t}}))}).catch(e=>{e instanceof w?console.error("Failed to comment",...e.errors):console.error("Failed to comment",e)}))}};d([r()],re.prototype,"user",void 0),d([m()],re.prototype,"render",null),d([C()],re.prototype,"submit",null),re=d([c(["new-article-comment",T],{feature:{needs:[ne,V]}},Y({emptyModel:{text:""}}))],re);let ce=class{constructor(e){this._context=e,this._response=n();const t=e.get(D),s=e.get(_),o=this._context.get(f),r=(new J).byArticles(this._response.read.keep.thru_(e=>e&&e.ok?e.body:z)),c=B(this._response.read.keep.thru_(e=>e&&e.ok?e.body.author:L));o.provide({a:G,is:r}),o.provide({a:U,is:c}),e.whenOn(o=>{s.read.tillOff(o).consume(e=>{const s=decodeURIComponent(e.get(v).pathname.substring(1));return t.article(s)(e=>this.response=e)}),e.on("conduit:article").just(()=>{s.open("")})})}get response(){return this._response.it}set response(e){this._response.it=e}render(){const{document:e}=this._context.get(a);return()=>{const{response:t}=this;t&&t.ok&&(e.getElementById("article:title").innerText=t.body.title)}}};d([r(),S()],ce.prototype,"response",null),d([m({path:l("response")})],ce.prototype,"render",null),ce=d([c(["article",T],{feature:{needs:[se,oe,H,Z,$,re]}},x())],ce),R.load(ce);//# sourceMappingURL=main.85ab5cac.js.map
