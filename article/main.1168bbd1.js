import{c as e}from"../js/core/main.9847b445.js";import{_ as t}from"../js/helpers.e1623395.js";import{D as s,s as o}from"../js/frontmeans/dom-events.ba8d072f.js";import{s as r,y as n,d as a,g as c,c as i,q as m}from"../js/proc7ts/fun-events.0c993baf.js";import{h as d,d as l,e as p,i as u,j as h,S as f,k as j,O as b,H as g,N as y,P as v}from"../js/wesib/generic.36801613.js";import{S as x,C,B as _,D as w,R as E,w as S}from"../js/wesib/wesib.1ebc214d.js";import{C as O}from"../js/core.10059585.js";import{A as F}from"../js/core/articles.1a8d5347.js";import{R as N,f as T,a as k}from"../js/core/loader.430f4736.js";import{F as M,c as I,n as A,C as D}from"../js/follow-author-btn.component.7a866a4d.js";import{n as R,b as q}from"../js/core/auth.d58e7713.js";import{A as $,D as B,E as H}from"../js/article-buttons-support.feature.68c57cb6.js";import{n as L,C as P,a as U}from"../js/current-article.228ecf92.js";import{g as Q,u as z,I as G,v as J,m as K,w as V,c as W,x as X,b as Y}from"../js/frontmeans/input-aspects.552a677b.js";import{C as Z,a as ee}from"../js/core/comments.3bbd3f7c.js";import{C as te,s as se}from"../js/core/forms.c0daa8d3.js";import{e as oe}from"../js/frontmeans/httongue.6b868a5b.js";import{a as re}from"../js/core/api.e687a690.js";import"../js/core/layout.f26065db.js";import"../js/frontmeans/namespace-aliaser.9467f14d.js";import"../js/proc7ts/primitives.7b24aae7.js";import"../js/proc7ts/supply.9762ee6d.js";import"../js/proc7ts/context-values.5140e67e.js";import"../js/proc7ts/push-iterator.ccd51d52.js";import"../js/proc7ts/call-thru.f4f68410.js";import"../js/hatsy/http-header-value.851567fb.js";import"../js/proc7ts/workbench.dbc8e30b.js";import"../js/frontmeans/render-scheduler.6f331202.js";import"../js/lib/dompurify.f5eadf9f.js";import"../js/lib/marked.9d494571.js";import"../js/proc7ts/delta-set.d5d9e832.js";import"../js/core/users.915439be.js";import"../js/core/feed.ff2da7aa.js";let ne=class{constructor(e){this._context=e,this.user=R,this.article=L;const t=e.get(q),s=e.get(d);t.user.do(r(e))((e=>this.user=e)).whenOff((()=>this.user=R)),s.get(P).do(r(e))((e=>this.article=e)).whenOff((()=>this.article=L))}render(){const{document:e}=this._context.get(_),t=e.createDocumentFragment();if(this.article.slug&&this.article.author.username===this.user.username){t.appendChild(e.createElement("conduit-edit-post-btn")).tabIndex=0;t.appendChild(e.createElement("conduit-delete-post-btn")).tabIndex=0}else{t.appendChild(e.createElement("conduit-follow-author-btn")).tabIndex=0;const s=t.appendChild(e.createElement("conduit-favorite-post-btn"));s.innerText="Favorite Post",s.tabIndex=0}return t}};t([x()],ne.prototype,"user",void 0),t([x()],ne.prototype,"article",void 0),t([N()],ne.prototype,"render",null),ne=t([C(["article-actions",O],{feature:{needs:[$,B,H]}})],ne);class ae extends CustomEvent{}let ce=class{constructor(e){this._context=e,this.article=L,this.user=R;const t=e.get(q),s=e.get(d);t.user.do(r(e))((e=>this.user=e)).whenOff((()=>this.user=R)),s.get(P).do(r(e))((e=>this.article=e)).whenOff((()=>this.article=L)),l[p].valueFor(e)(((e,t)=>this.form=e))}render(){var e;const t=this.articleComment;if(!t)return;const r=this._context.get(Z),{document:n}=this._context.get(_),{author:a}=t,c=`profile/#/${encodeURIComponent(a.username)}`,i=a.image?'<img src="http://i.imgur.com/Qr71crq.jpg" class="comment-author-img" />':"",m=T(new Date(t.createdAt)),d=n.createDocumentFragment(),l=d.appendChild(n.createElement("div"));l.className="card-body";const p=l.appendChild(n.createElement("p"));p.className="card-text",p.innerText=t.body;const u=d.appendChild(n.createElement("div"));u.className="card-footer",u.innerHTML=`\n<a href="${c}" class="comment-author">${i}</a>\n<a href="${c}" class="comment-author">${oe(a.username)}</a>\n<span class="date-posted">${m}</span>`;const h=null===(e=this.form)||void 0===e?void 0:e.control,{slug:f}=this.article;if(this.user.username===a.username&&h&&f){const e=u.appendChild(n.createElement("span"));e.className="mod-options";const a=e.appendChild(n.createElement("button"));a.type="button",a.className="btn btn-sm",a.innerHTML='<i class="ion-trash-a"></i>',Q(a,{form:h}),new s(a).on("click").do(o)((()=>{h.aspect(z).submit((()=>re(r.deleteComment(f,t.id)))).then((()=>{this._context.dispatchEvent(new ae("conduit:comment",{bubbles:!0,detail:{removed:t.id}}))})).catch((e=>{e instanceof G?console.error("Failed to remove comment",...e.errors):console.error("Failed to remove comment",e)}))}))}return d}};t([w()],ce.prototype,"articleComment",void 0),t([x()],ce.prototype,"article",void 0),t([x()],ce.prototype,"user",void 0),t([N({comment:"COMMENT"})],ce.prototype,"render",null),ce=t([C(["article-comment",O])],ce);let ie=class{constructor(e){this._context=e,this.comments=[];const t=e.get(Z),s=this._context.get(d);this._context.on("conduit:comment")((({detail:{added:e,removed:t}})=>{this.comments=e?[e,...this.comments]:this.comments.filter((e=>e.id!==t))}));let o=L;s.get(P).do(n(e),a((e=>{if(e.slug&&e.slug!==o.slug)return o=e,t.articleComments(e.slug)})))((e=>{this.response=e,e.ok&&(this.comments=e.body.comments)}));const r=e.element;this.form=h.by((e=>J({},e)),(e=>K(r,e)))}render(){const{document:e}=this._context.get(_),{contentRoot:t}=this._context,s=e.createRange();return s.setStartAfter(t.appendChild(e.createComment("[COMMENTS["))),s.setEndBefore(t.appendChild(e.createComment("]COMMENTS]"))),()=>{s.deleteContents();const{comments:t}=this;if(!t.length)return;const o=e.createDocumentFragment();t.forEach((t=>{o.appendChild(e.createElement("conduit-article-comment")).articleComment=t})),s.insertNode(o)}}};t([k({comment:"COMMENTS"})],ie.prototype,"response",void 0),t([x()],ie.prototype,"comments",void 0),t([u()],ie.prototype,"form",void 0),t([E()],ie.prototype,"render",null),ie=t([C(["article-comments",O],{feature:{needs:[ce,ee,te]}})],ie);let me=class{constructor(e){this._context=e;const t=e.get(F),s=this._context.get(d);e.supply.whenOff((()=>this.content=void 0)),s.get(P).do(r(e))((s=>{s.slug?t.htmlContents(s).then((t=>{e.connected&&(this.content=t)})).catch((t=>{e.connected&&(this.content=void 0,console.error("Failed to parse article",t))})):this.content=void 0}))}render(){return this.content}};t([x()],me.prototype,"content",void 0),t([N({comment:"ARTICLE(content)"})],me.prototype,"render",null),me=t([C(["article-content",O])],me);let de=class{constructor(e){e.whenSettled((({element:e})=>{this.text=j.by((t=>V(e.querySelector("textarea"),t).setup(W,(e=>e.by(X())))))}))}};t([f()],de.prototype,"text",void 0),de=t([C(["article-comment-text",O])],de);let le=class{constructor(e){this._context=e,this.article=L,this.user=R,this._commentService=e.get(Z);const t=e.get(q),s=e.get(d);t.user.do(r(e))((e=>this.user=e)).whenOff((()=>this.user=R)),s.get(P)((e=>this.article=e)).whenOff((()=>this.article=L)),e.whenSettled((({element:e})=>{this.form=h.by((e=>J({text:""},e)),(t=>K(e.querySelector("form"),t))),this.submitButton=se(e.querySelector("button"))}))}render(){const{element:e}=this._context,t=e.querySelector(".comment-author-img");return()=>{this.user.email&&this.user.image?null==t||t.setAttribute("src",this.user.image):null==t||t.removeAttribute("src")}}submit({control:e}){const{article:t}=this;t.slug&&(e.aspect(Y).markEdited(),e.aspect(z).submit((e=>re(this._commentService.addComment(t.slug,e.text)))).then((t=>{e.it={text:""},e.aspect(Y).markTouched(!1),e.aspect(z).reset(),this._context.dispatchEvent(new ae("conduit:comment",{bubbles:!0,detail:{added:t}}))})).catch((e=>{e instanceof G?console.error("Failed to comment",...e.errors):console.error("Failed to comment",e)})))}};t([x()],le.prototype,"user",void 0),t([u()],le.prototype,"form",void 0),t([f({form:{share:l,local:!0},name:""})],le.prototype,"submitButton",void 0),t([E()],le.prototype,"render",null),t([b()],le.prototype,"submit",null),le=t([C(["new-article-comment",O],{feature:{needs:[de,ee]}})],le);let pe=class{constructor(e){this._context=e,this._response=c();const t=e.get(F),s=e.get(y),n=this._context.get(d),a=(new U).byArticles(this._response.read.do(i((e=>e&&e.ok?e.body:L)))),l=I(this._response.read.do(i((e=>e&&e.ok?e.body.author:A))));n.provide({a:P,is:a.read}),n.provide({a:D,is:l.read}),e.whenConnected((()=>{s.read.do(r(e),m((e=>{const s=decodeURIComponent(e.get(v).pathname.substring(1));return t.article(s)((e=>this.response=e))}))),e.on("conduit:article").do(o)((()=>{s.open("").catch(console.error)}))}))}get response(){return this._response.it}set response(e){this._response.it=e}render(){const{document:e}=this._context.get(_);return()=>{const{response:t}=this;t&&t.ok&&(e.getElementById("article:title").innerText=t.body.title)}}};t([x(),k()],pe.prototype,"response",null),t([E({on:S("response")})],pe.prototype,"render",null),pe=t([C(["article",O],{feature:{needs:[ie,me,$,ne,M,le]}},g())],pe),e.load(pe);//# sourceMappingURL=main.1168bbd1.js.map
