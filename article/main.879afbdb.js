import"../js/proc7ts/primitives.ada6e792.js";import"../js/proc7ts/push-iterator.b943ed6f.js";import"../js/proc7ts/context-values.bb33d989.js";import"../js/frontmeans/namespace-aliaser.e08188c9.js";import{s as e,F as t,d as s,t as o,m as r,l as n}from"../js/proc7ts/fun-events.3d56e7e0.js";import"../js/proc7ts/workbench.76998d65.js";import{D as a,s as c}from"../js/frontmeans/dom-events.455a522c.js";import"../js/frontmeans/render-scheduler.78bb570f.js";import{S as i,C as m,B as d,D as l,R as p,v as h}from"../js/wesib/wesib.4285371a.js";import{_ as u}from"../js/helpers.e1623395.js";import{n as f,b as j}from"../js/core/auth.b3c0ad31.js";import{a as b}from"../js/core/api.59f1313d.js";import"../js/hatsy/http-header-value.0845e903.js";import{a as g,I as C,i as x,S as v,O as y,d as _,N as E,P as w}from"../js/wesib/generic.1b7d8f8d.js";import"../js/proc7ts/delta-set.d5d9e832.js";import{f as O,q as F,I as M,g as N,r as T,c as k,s as I,b as S}from"../js/frontmeans/input-aspects.a0d328af.js";import{C as A}from"../js/core.c152f8fe.js";import{R as D,f as R,a as $}from"../js/core/loader.109ed6d0.js";import"../js/core/layout.09851e00.js";import{c as q}from"../js/core/main.f06f8206.js";import{A as B}from"../js/core/articles.c075cdf1.js";import"../js/lib/dompurify.f5eadf9f.js";import"../js/lib/marked.5b76e7a8.js";import{F as L,c as U,C as H,n as P}from"../js/follow-author-btn.component.a2c43fd0.js";import{e as Q}from"../js/frontmeans/httongue.193345e9.js";import"../js/core/users.bf06b707.js";import"../js/proc7ts/call-thru.f4f68410.js";import"../js/core/feed.f7b108f9.js";import{A as z,D as G,E as J}from"../js/article-buttons-support.feature.f731b322.js";import{n as K,C as V,a as W}from"../js/current-article.611ea08f.js";import{C as X,a as Y}from"../js/core/comments.72ce7523.js";import{C as Z,U as ee,F as te}from"../js/core/input.ec36130b.js";let se=class{constructor(t){this._context=t,this.user=f,this.article=K;const s=t.get(j),o=t.get(g);s.user.do(e(t))((e=>this.user=e)).whenOff((()=>this.user=f)),o.get(V).do(e(t))((e=>this.article=e)).whenOff((()=>this.article=K))}render(){const{document:e}=this._context.get(d),t=e.createDocumentFragment();if(this.article.slug&&this.article.author.username===this.user.username){t.appendChild(e.createElement("conduit-edit-post-btn")).tabIndex=0;t.appendChild(e.createElement("conduit-delete-post-btn")).tabIndex=0}else{t.appendChild(e.createElement("conduit-follow-author-btn")).tabIndex=0;const s=t.appendChild(e.createElement("conduit-favorite-post-btn"));s.innerText="Favorite Post",s.tabIndex=0}return t}};u([i()],se.prototype,"user",void 0),u([i()],se.prototype,"article",void 0),u([D()],se.prototype,"render",null),se=u([m(["article-actions",A],{feature:{needs:[z,G,J]}})],se);class oe extends CustomEvent{}let re=class{constructor(t){this._context=t,this.article=K,this.user=f,this.form={};const s=t.get(j),o=t.get(g);s.user.do(e(t))((e=>this.user=e)).whenOff((()=>this.user=f)),o.get(V).do(e(t))((e=>this.article=e)).whenOff((()=>this.article=K)),o.get(C).do(e(t))((e=>this.form=e)).whenOff((()=>this.form={}))}render(){const e=this.articleComment;if(!e)return;const t=this._context.get(X),{document:s}=this._context.get(d),{author:o}=e,r=`profile/#/${encodeURIComponent(o.username)}`,n=o.image?'<img src="http://i.imgur.com/Qr71crq.jpg" class="comment-author-img" />':"",i=R(new Date(e.createdAt)),m=s.createDocumentFragment(),l=m.appendChild(s.createElement("div"));l.className="card-body";const p=l.appendChild(s.createElement("p"));p.className="card-text",p.innerText=e.body;const h=m.appendChild(s.createElement("div"));h.className="card-footer",h.innerHTML=`\n<a href="${r}" class="comment-author">${n}</a>\n<a href="${r}" class="comment-author">${Q(o.username)}</a>\n<span class="date-posted">${i}</span>`;const{control:u}=this.form,{slug:f}=this.article;if(this.user.username===o.username&&u&&f){const o=h.appendChild(s.createElement("span"));o.className="mod-options";const r=o.appendChild(s.createElement("button"));r.type="button",r.className="btn btn-sm",r.innerHTML='<i class="ion-trash-a"></i>',O(r,{form:u}),new a(r).on("click").do(c)((()=>{u.aspect(F).submit((()=>b(t.deleteComment(f,e.id)))).then((()=>{this._context.dispatchEvent(new oe("conduit:comment",{bubbles:!0,detail:{removed:e.id}}))})).catch((e=>{e instanceof M?console.error("Failed to remove comment",...e.errors):console.error("Failed to remove comment",e)}))}))}return m}};u([l()],re.prototype,"articleComment",void 0),u([i()],re.prototype,"article",void 0),u([i()],re.prototype,"user",void 0),u([D({comment:"COMMENT"})],re.prototype,"render",null),re=u([m(["article-comment",A])],re);let ne=class{constructor(e){this._context=e,this.comments=[];const o=e.get(X),r=this._context.get(g);this._context.on("conduit:comment")((({detail:{added:e,removed:t}})=>{this.comments=e?[e,...this.comments]:this.comments.filter((e=>e.id!==t))}));let n=K;r.get(V).do(t(e),s((e=>{if(e.slug&&e.slug!==n.slug)return n=e,o.articleComments(e.slug)})))((e=>{this.response=e,e.ok&&(this.comments=e.body.comments)}));const a=N({});a.supply.needs(e),x(e,a)}render(){const{document:e}=this._context.get(d),{contentRoot:t}=this._context,s=e.createRange();return s.setStartAfter(t.appendChild(e.createComment("[COMMENTS["))),s.setEndBefore(t.appendChild(e.createComment("]COMMENTS]"))),()=>{s.deleteContents();const{comments:t}=this;if(!t.length)return;const o=e.createDocumentFragment();t.forEach((t=>{o.appendChild(e.createElement("conduit-article-comment")).articleComment=t})),s.insertNode(o)}}};u([$({comment:"COMMENTS"})],ne.prototype,"response",void 0),u([i()],ne.prototype,"comments",void 0),u([p()],ne.prototype,"render",null),ne=u([m(["article-comments",A],{feature:{needs:[re,Y,Z]}})],ne);let ae=class{constructor(t){this._context=t;const s=t.get(B),o=this._context.get(g);t.supply.whenOff((()=>this.content=void 0)),o.get(V).do(e(t))((e=>{e.slug?s.htmlContents(e).then((e=>{t.connected&&(this.content=e)})).catch((e=>{t.connected&&(this.content=void 0,console.error("Failed to parse article",e))})):this.content=void 0}))}render(){return this.content}};u([i()],ae.prototype,"content",void 0),u([D({comment:"ARTICLE(content)"})],ae.prototype,"render",null),ae=u([m(["article-content",A])],ae);let ce=class{};ce=u([m(["article-comment-text",A],ee({select:"textarea",makeControl:({node:e,aspects:t})=>T(e.element,{aspects:t}).setup(k,(e=>e.by(I())))}),v("text"))],ce);let ie=class{constructor(t){this._context=t,this.article=K,this.user=f,this._commentService=t.get(X);const s=t.get(j),o=t.get(g);s.user.do(e(t))((e=>this.user=e)).whenOff((()=>this.user=f)),o.get(V)((e=>this.article=e)).whenOff((()=>this.article=K))}render(){const{element:e}=this._context,t=e.querySelector(".comment-author-img");return()=>{this.user.email&&this.user.image?null==t||t.setAttribute("src",this.user.image):null==t||t.removeAttribute("src")}}submit({control:e}){const{article:t}=this;t.slug&&(e.aspect(S).markEdited(),e.aspect(F).submit((e=>b(this._commentService.addComment(t.slug,e.text)))).then((t=>{e.it={text:""},e.aspect(S).markTouched(!1),e.aspect(F).reset(),this._context.dispatchEvent(new oe("conduit:comment",{bubbles:!0,detail:{added:t}}))})).catch((e=>{e instanceof M?console.error("Failed to comment",...e.errors):console.error("Failed to comment",e)})))}};u([i()],ie.prototype,"user",void 0),u([p()],ie.prototype,"render",null),u([y()],ie.prototype,"submit",null),ie=u([m(["new-article-comment",A],{feature:{needs:[ce,Y]}},te({emptyModel:{text:""}}))],ie);let me=class{constructor(t){this._context=t,this._response=o();const s=t.get(B),a=t.get(E),i=this._context.get(g),m=(new W).byArticles(this._response.read.do(r((e=>e&&e.ok?e.body:K)))),d=U(this._response.read.do(r((e=>e&&e.ok?e.body.author:P))));i.provide({a:V,is:m}),i.provide({a:H,is:d}),t.whenConnected((()=>{a.read.do(e(t),n((e=>{const t=decodeURIComponent(e.get(w).pathname.substring(1));return s.article(t)((e=>this.response=e))}))),t.on("conduit:article").do(c)((()=>{a.open("").catch(console.error)}))}))}get response(){return this._response.it}set response(e){this._response.it=e}render(){const{document:e}=this._context.get(d);return()=>{const{response:t}=this;t&&t.ok&&(e.getElementById("article:title").innerText=t.body.title)}}};u([i(),$()],me.prototype,"response",null),u([p({on:h("response")})],me.prototype,"render",null),me=u([m(["article",A],{feature:{needs:[ne,ae,z,se,L,ie]}},_())],me),q.load(me);//# sourceMappingURL=main.879afbdb.js.map
