import"../js/proc7ts/primitives.90941b78.js";import"../js/proc7ts/push-iterator.e3c0f3f1.js";import"../js/proc7ts/context-values.de0fa082.js";import{a as t}from"../js/proc7ts/call-thru.104a1934.js";import{D as e,n as s,i as o,t as r}from"../js/proc7ts/fun-events.751f4123.js";import"../js/frontmeans/namespace-aliaser.54a2e6c0.js";import"../js/frontmeans/render-scheduler.c6ad5452.js";import{S as n,C as a,B as c,D as i,R as m,w as l}from"../js/wesib/wesib.fd49a6cd.js";import{_ as p}from"../js/helpers.e1623395.js";import{n as d,b as h}from"../js/core/auth.2372f198.js";import{a as u}from"../js/core/api.850f8641.js";import{a as f,I as j,i as g,S as b,O as C,d as x,N as v,P as y}from"../js/wesib/generic.1df87fc1.js";import"../js/proc7ts/delta-set.9ee1ffba.js";import{f as _,q as E,I as O,g as w,r as T,c as k,s as F,b as M}from"../js/frontmeans/input-aspects.8b5674f5.js";import{C as N}from"../js/core.bba16f1a.js";import{R as I,f as S,a as A}from"../js/core/loader.46a2a88b.js";import"../js/core/layout.2906fa88.js";import{c as D}from"../js/core/main.e6d61b54.js";import{A as R}from"../js/core/articles.aa6b0084.js";import"../js/lib/dompurify.0d835c13.js";import"../js/lib/marked.55574563.js";import{F as $,c as q,n as B,C as L}from"../js/follow-author-btn.component.fa4c23c9.js";import{e as U}from"../js/frontmeans/httongue.7343772f.js";import"../js/core/users.43d11713.js";import"../js/core/feed.e63c551e.js";import{A as H,D as P,E as Q}from"../js/article-buttons-support.feature.8243e24d.js";import{n as z,C as G,a as J}from"../js/current-article.faae2888.js";import{C as K,a as V}from"../js/core/comments.e097343a.js";import{C as W,U as X,F as Y}from"../js/core/input.28057277.js";let Z=class{constructor(t){this._context=t,this.user=d,this.article=z;const e=t.get(h),s=t.get(f);e.user().tillOff(t).to((t=>this.user=t)).whenOff((()=>this.user=d)),s.get(G).tillOff(t).to((t=>this.article=t)).whenOff((()=>this.article=z))}render(){const{document:t}=this._context.get(c),e=t.createDocumentFragment();if(this.article.slug&&this.article.author.username===this.user.username){e.appendChild(t.createElement("conduit-edit-post-btn")).tabIndex=0;e.appendChild(t.createElement("conduit-delete-post-btn")).tabIndex=0}else{e.appendChild(t.createElement("conduit-follow-author-btn")).tabIndex=0;const s=e.appendChild(t.createElement("conduit-favorite-post-btn"));s.innerText="Favorite Post",s.tabIndex=0}return e}};p([n()],Z.prototype,"user",void 0),p([n()],Z.prototype,"article",void 0),p([I()],Z.prototype,"render",null),Z=p([a(["article-actions",N],{feature:{needs:[H,P,Q]}})],Z);class tt extends CustomEvent{}let et=class{constructor(t){this._context=t,this.article=z,this.user=d,this.form={};const e=t.get(h),s=t.get(f);e.user().tillOff(t).to((t=>this.user=t)).whenOff((()=>this.user=d)),s.get(G).tillOff(t).to((t=>this.article=t)).whenOff((()=>this.article=z)),s.get(j).tillOff(t).to((t=>this.form=t)).whenOff((()=>this.form={}))}render(){const t=this.articleComment;if(!t)return;const s=this._context.get(K),{document:o}=this._context.get(c),{author:r}=t,n=`profile/#/${encodeURIComponent(r.username)}`,a=r.image?'<img src="http://i.imgur.com/Qr71crq.jpg" class="comment-author-img" />':"",i=S(new Date(t.createdAt)),m=o.createDocumentFragment(),l=m.appendChild(o.createElement("div"));l.className="card-body";const p=l.appendChild(o.createElement("p"));p.className="card-text",p.innerText=t.body;const d=m.appendChild(o.createElement("div"));d.className="card-footer",d.innerHTML=`\n<a href="${n}" class="comment-author">${a}</a>\n<a href="${n}" class="comment-author">${U(r.username)}</a>\n<span class="date-posted">${i}</span>`;const{control:h}=this.form,{slug:f}=this.article;if(this.user.username===r.username&&h&&f){const r=d.appendChild(o.createElement("span"));r.className="mod-options";const n=r.appendChild(o.createElement("button"));n.type="button",n.className="btn btn-sm",n.innerHTML='<i class="ion-trash-a"></i>',_(n,{form:h}),new e(n).on("click").just((()=>{h.aspect(E).submit((()=>u(s.deleteComment(f,t.id)))).then((()=>{this._context.dispatchEvent(new tt("conduit:comment",{bubbles:!0,detail:{removed:t.id}}))})).catch((t=>{t instanceof O?console.error("Failed to remove comment",...t.errors):console.error("Failed to remove comment",t)}))}))}return m}};p([i()],et.prototype,"articleComment",void 0),p([n()],et.prototype,"article",void 0),p([n()],et.prototype,"user",void 0),p([I({comment:"COMMENT"})],et.prototype,"render",null),et=p([a(["article-comment",N])],et);let st=class{constructor(e){this._context=e,this.comments=[];const r=e.get(K),n=this._context.get(f);this._context.on("conduit:comment").to((({detail:{added:t,removed:e}})=>{this.comments=t?[t,...this.comments]:this.comments.filter((t=>t.id!==e))}));let a=z;n.get(G).tillOff(e).thru_((e=>e.slug&&e.slug!==a.slug?(a=e,s(r.articleComments(e.slug))):t)).to((t=>{this.response=t,t.ok&&(this.comments=t.body.comments)}));const c=w({});o(c).needs(e),g(e,c)}render(){const{document:t}=this._context.get(c),{contentRoot:e}=this._context,s=t.createRange();return s.setStartAfter(e.appendChild(t.createComment("[COMMENTS["))),s.setEndBefore(e.appendChild(t.createComment("]COMMENTS]"))),()=>{s.deleteContents();const{comments:e}=this;if(!e.length)return;const o=t.createDocumentFragment();e.forEach((e=>{o.appendChild(t.createElement("conduit-article-comment")).articleComment=e})),s.insertNode(o)}}};p([A({comment:"COMMENTS"})],st.prototype,"response",void 0),p([n()],st.prototype,"comments",void 0),p([m()],st.prototype,"render",null),st=p([a(["article-comments",N],{feature:{needs:[et,V,W]}})],st);let ot=class{constructor(t){this._context=t;const e=t.get(R),s=this._context.get(f);o(t).whenOff((()=>this.content=void 0)),s.get(G).tillOff(t).to((s=>{s.slug?e.htmlContents(s).then((e=>{t.connected&&(this.content=e)})).catch((e=>{t.connected&&(this.content=void 0,console.error("Failed to parse article",e))})):this.content=void 0}))}render(){return this.content}};p([n()],ot.prototype,"content",void 0),p([I({comment:"ARTICLE(content)"})],ot.prototype,"render",null),ot=p([a(["article-content",N])],ot);let rt=class{};rt=p([a(["article-comment-text",N],X({select:"textarea",makeControl:({node:t,aspects:e})=>T(t.element,{aspects:e}).setup(k,(t=>t.by(F())))}),b("text"))],rt);let nt=class{constructor(t){this._context=t,this.article=z,this.user=d,this._commentService=t.get(K);const e=t.get(h),s=t.get(f);e.user().tillOff(t).to((t=>this.user=t)).whenOff((()=>this.user=d)),s.get(G).to((t=>this.article=t)).whenOff((()=>this.article=z))}render(){const{element:t}=this._context,e=t.querySelector(".comment-author-img");return()=>{this.user.email&&this.user.image?null==e||e.setAttribute("src",this.user.image):null==e||e.removeAttribute("src")}}submit({control:t}){const{article:e}=this;e.slug&&(t.aspect(M).markEdited(),t.aspect(E).submit((t=>u(this._commentService.addComment(e.slug,t.text)))).then((e=>{t.it={text:""},t.aspect(M).markTouched(!1),t.aspect(E).reset(),this._context.dispatchEvent(new tt("conduit:comment",{bubbles:!0,detail:{added:e}}))})).catch((t=>{t instanceof O?console.error("Failed to comment",...t.errors):console.error("Failed to comment",t)})))}};p([n()],nt.prototype,"user",void 0),p([m()],nt.prototype,"render",null),p([C()],nt.prototype,"submit",null),nt=p([a(["new-article-comment",N],{feature:{needs:[rt,V]}},Y({emptyModel:{text:""}}))],nt);let at=class{constructor(t){this._context=t,this._response=r();const e=t.get(R),s=t.get(v),o=this._context.get(f),n=(new J).byArticles(this._response.read().keepThru_((t=>t&&t.ok?t.body:z))),a=q(this._response.read().keepThru_((t=>t&&t.ok?t.body.author:B)));o.provide({a:G,is:n}),o.provide({a:L,is:a}),t.whenConnected((()=>{s.read().tillOff(t).consume((t=>{const s=decodeURIComponent(t.get(y).pathname.substring(1));return e.article(s).to((t=>this.response=t))})),t.on("conduit:article").just((()=>{s.open("").catch(console.error)}))}))}get response(){return this._response.it}set response(t){this._response.it=t}render(){const{document:t}=this._context.get(c);return()=>{const{response:e}=this;e&&e.ok&&(t.getElementById("article:title").innerText=e.body.title)}}};p([n(),A()],at.prototype,"response",null),p([m({on:l("response")})],at.prototype,"render",null),at=p([a(["article",N],{feature:{needs:[st,ot,H,Z,$,nt]}},x())],at),D.load(at);//# sourceMappingURL=main.691b1d79.js.map
