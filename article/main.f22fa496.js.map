{"version":3,"file":"main.f22fa496.js","sources":["../../src/pages/article/article.component.ts","../../src/pages/article/index.ts"],"sourcesContent":["import { HandleNavLinks, HierarchyContext, Navigation, PageHashURLParam } from '@wesib/generic';\nimport {\n  BootstrapWindow,\n  Component,\n  ComponentContext,\n  DefaultNamespaceAliaser,\n  ElementRenderer,\n  Render,\n  StateProperty,\n  statePropertyPathTo,\n} from '@wesib/wesib';\nimport { trackValue } from 'fun-events';\nimport { css__naming } from 'namespace-aliaser';\nimport { Conduit__NS } from '../../common';\nimport { ApiResponse } from '../../common/api';\nimport { Article, ArticleService } from '../../common/articles';\nimport { ArticlesSupport } from '../../common/articles/articles-support.feature';\nimport { ApiErrorGenerator } from '../../common/input';\nimport { LoaderComponent } from '../../generic/loader';\nimport { CurrentUserProfile } from '../profile/current-user-profile';\nimport { ArticleMetaSupport } from './article-meta-support.feature';\nimport { CurrentArticle } from './current-article';\nimport { FollowAuthorComponent } from '../profile/follow-author.component';\n\n@Component(\n    ['article', Conduit__NS],\n    {\n      feature: {\n        needs: [\n          ArticleMetaSupport,\n          ArticlesSupport,\n          FollowAuthorComponent,\n          LoaderComponent,\n        ],\n      },\n    },\n    HandleNavLinks(),\n)\nexport class ArticleComponent {\n\n  private readonly _response = trackValue<ApiResponse<Article>>();\n\n  @StateProperty()\n  private content?: Node;\n\n  constructor(private readonly _context: ComponentContext) {\n\n    const articleService = _context.get(ArticleService);\n    const navigation = _context.get(Navigation);\n    const hierarchy = this._context.get(HierarchyContext);\n\n    hierarchy.provide({\n      a: CurrentArticle,\n      is: this._response.read.keep.thru_(\n          response => response && response.ok ? response.body : {},\n      ),\n    });\n    hierarchy.provide({\n      a: CurrentUserProfile,\n      is: this._response.read.keep.thru_(\n          response => response && response.ok ? response.body.author : {},\n      ),\n    });\n    _context.whenOn(supply => {\n      supply.whenOff(() => this.content = undefined);\n      this._response.read.tillOff(supply)(response => {\n        if (response && response.ok) {\n          articleService.htmlContents(response.body)\n              .then(content => {\n                if (_context.connected) {\n                  this.content = content;\n                }\n              })\n              .catch(error => {\n                if (_context.connected) {\n                  this.content = undefined;\n                  this.response = { ok: false, errors: { article: [`can not be parser ${String(error)}`] } };\n                }\n              });\n        } else {\n          this.content = undefined;\n        }\n      });\n    });\n    _context.whenOn(supply => {\n      navigation.read.tillOff(supply).consume(page => {\n\n        const slug = page.get(PageHashURLParam).pathname.substring(0);\n\n        return articleService.article(slug)(response => this.response = response);\n      });\n    });\n  }\n\n  get response(): ApiResponse<Article> | undefined {\n    return this._response.it;\n  }\n\n  @StateProperty()\n  set response(value: ApiResponse<Article> | undefined) {\n    this._response.it = value;\n  }\n\n  @Render({ path: statePropertyPathTo('response') })\n  render(): ElementRenderer {\n\n    const visibleClassName = css__naming.name(['visible', Conduit__NS], this._context.get(DefaultNamespaceAliaser));\n    const genErrors = this._context.get(ApiErrorGenerator);\n    const { element, contentRoot }: { element: Element; contentRoot: Node } = this._context;\n    const { document } = this._context.get(BootstrapWindow);\n    let loader: Element | undefined;\n\n    return () => {\n\n      const { response } = this;\n\n      if (!response) {\n        displayLoader();\n      } else if (!response.ok) {\n        displayErrors(response);\n      } else {\n        displayContents(response);\n      }\n    };\n\n    function displayContents({ body }: ApiResponse.Ok<Article>): void {\n      hideLoader();\n      setContentsVisible(true);\n      document.getElementById('article:title')!.innerText = body.title;\n    }\n\n    function displayErrors({ errors }: ApiResponse.Failure): void {\n      hideLoader();\n      setContentsVisible(false);\n      loader = genErrors(errors);\n      if (loader) {\n        contentRoot.appendChild(loader);\n      }\n    }\n\n    function displayLoader(): void {\n      setContentsVisible(false);\n      if (!loader) {\n        loader = contentRoot.appendChild(document.createElement('conduit-loader'));\n      }\n    }\n\n    function hideLoader(): void {\n      if (loader) {\n        loader.remove();\n        loader = undefined;\n      }\n    }\n\n    function setContentsVisible(visible: boolean): void {\n      if (visible) {\n        element.classList.add(visibleClassName);\n      } else {\n        element.classList.remove(visibleClassName);\n      }\n    }\n  }\n\n  @Render({ path: statePropertyPathTo('content') })\n  renderContent(): ElementRenderer {\n\n    const { document } = this._context.get(BootstrapWindow);\n\n    return () => {\n\n      const contentParent = document.getElementById('article:content');\n\n      if (contentParent) {\n        contentParent.innerHTML = '';\n\n        const content = this.content;\n\n        if (content) {\n          contentParent.appendChild(content);\n        }\n      }\n    };\n  }\n\n}\n","import { conduitContext } from '../../common/main';\nimport { ArticleComponent } from './article.component';\n\nconduitContext.load(ArticleComponent);\n"],"names":["ArticleComponent","[object Object]","_context","this","trackValue","articleService","get","ArticleService","navigation","Navigation","hierarchy","HierarchyContext","provide","a","CurrentArticle","is","_response","read","keep","thru_","response","ok","body","CurrentUserProfile","author","whenOn","supply","whenOff","content","undefined","tillOff","htmlContents","then","connected","catch","error","errors","article","String","consume","page","slug","PageHashURLParam","pathname","substring","it","value","visibleClassName","css__naming","name","Conduit__NS","DefaultNamespaceAliaser","genErrors","ApiErrorGenerator","element","contentRoot","document","BootstrapWindow","loader","hideLoader","setContentsVisible","getElementById","innerText","title","displayContents","appendChild","displayErrors","createElement","remove","visible","classList","add","contentParent","innerHTML","__decorate","StateProperty","Render","path","statePropertyPathTo","Component","feature","needs","ArticleMetaSupport","ArticlesSupport","FollowAuthorComponent","LoaderComponent","HandleNavLinks","conduitContext","load"],"mappings":"2sBAsCA,IAAaA,EAAb,MAOEC,YAA6BC,GAAAC,cAAAD,EALZC,eAAYC,IAO3B,MAAMC,EAAiBH,EAASI,IAAIC,GAC9BC,EAAaN,EAASI,IAAIG,GAC1BC,EAAYP,KAAKD,SAASI,IAAIK,GAEpCD,EAAUE,QAAQ,CAChBC,EAAGC,EACHC,GAAIZ,KAAKa,UAAUC,KAAKC,KAAKC,MACzBC,GAAYA,GAAYA,EAASC,GAAKD,EAASE,KAAO,MAG5DZ,EAAUE,QAAQ,CAChBC,EAAGU,EACHR,GAAIZ,KAAKa,UAAUC,KAAKC,KAAKC,MACzBC,GAAYA,GAAYA,EAASC,GAAKD,EAASE,KAAKE,OAAS,MAGnEtB,EAASuB,OAAOC,IACdA,EAAOC,QAAQ,IAAMxB,KAAKyB,aAAUC,GACpC1B,KAAKa,UAAUC,KAAKa,QAAQJ,EAA5BvB,CAAoCiB,IAC9BA,GAAYA,EAASC,GACvBhB,EAAe0B,aAAaX,EAASE,MAChCU,KAAKJ,IACA1B,EAAS+B,YACX9B,KAAKyB,QAAUA,KAGlBM,MAAMC,IACDjC,EAAS+B,YACX9B,KAAKyB,aAAUC,EACf1B,KAAKiB,SAAW,CAAEC,IAAI,EAAOe,OAAQ,CAAEC,QAAS,CAAC,qBAAqBC,OAAOH,WAIrFhC,KAAKyB,aAAUC,MAIrB3B,EAASuB,OAAOC,IACdlB,EAAWS,KAAKa,QAAQJ,GAAQa,QAAQC,IAEtC,MAAMC,EAAOD,EAAKlC,IAAIoC,GAAkBC,SAASC,UAAU,GAE3D,OAAOvC,EAAegC,QAAQI,EAAvBpC,CAA6Be,GAAYjB,KAAKiB,SAAWA,OAKtEA,eACE,OAAOjB,KAAKa,UAAU6B,GAIxBzB,aAAa0B,GACX3C,KAAKa,UAAU6B,GAAKC,EAItB7C,SAEE,MAAM8C,EAAmBC,EAAYC,KAAK,CAAC,UAAWC,GAAc/C,KAAKD,SAASI,IAAI6C,IAChFC,EAAYjD,KAAKD,SAASI,IAAI+C,IAC9BC,QAAEA,EAAOC,YAAEA,GAAyDpD,KAAKD,UACzEsD,SAAEA,GAAarD,KAAKD,SAASI,IAAImD,GACvC,IAAIC,EAEJ,MAAO,KAEL,MAAMtC,SAAEA,GAAajB,KAEhBiB,EAEOA,EAASC,GAOvB,UAAyBC,KAAEA,IACzBqC,IACAC,GAAmB,GACnBJ,EAASK,eAAe,iBAAkBC,UAAYxC,EAAKyC,MAPzDC,CAAgB5C,GAUpB,UAAuBgB,OAAEA,IACvBuB,IACAC,GAAmB,GACnBF,EAASN,EAAUhB,GACfsB,GACFH,EAAYU,YAAYP,GAjBxBQ,CAAc9C,IAsBhBwC,GAAmB,GACdF,IACHA,EAASH,EAAYU,YAAYT,EAASW,cAAc,sBAI5D,SAASR,IACHD,IACFA,EAAOU,SACPV,OAAS7B,GAIb,SAAS+B,EAAmBS,GACtBA,EACFf,EAAQgB,UAAUC,IAAIxB,GAEtBO,EAAQgB,UAAUF,OAAOrB,IAM/B9C,gBAEE,MAAMuD,SAAEA,GAAarD,KAAKD,SAASI,IAAImD,GAEvC,MAAO,KAEL,MAAMe,EAAgBhB,EAASK,eAAe,mBAE9C,GAAIW,EAAe,CACjBA,EAAcC,UAAY,GAE1B,MAAM7C,EAAUzB,KAAKyB,QAEjBA,GACF4C,EAAcP,YAAYrC,OAvIlC8C,GADCC,mCAyDDD,GADCC,kCAMDD,GADCE,EAAO,CAAEC,KAAMC,EAAoB,0CA6DpCJ,GADCE,EAAO,CAAEC,KAAMC,EAAoB,gDA7HzB9E,KAdZ+E,EACG,CAAC,UAAW7B,GACZ,CACE8B,QAAS,CACPC,MAAO,CACLC,EACAC,EACAC,EACAC,KAINC,MAEStF,GCnCbuF,EAAeC,KAAKxF"}