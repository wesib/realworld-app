{"version":3,"file":"main.9cfcdc1e.js","sources":["../../src/pages/article/article.component.ts","../../src/pages/article/index.ts"],"sourcesContent":["import { HandleNavLinks, HierarchyContext, Navigation, PageHashURLParam } from '@wesib/generic';\nimport {\n  BootstrapWindow,\n  Component,\n  ComponentContext,\n  DefaultNamespaceAliaser,\n  ElementRenderer,\n  Render,\n  StateProperty,\n  statePropertyPathTo,\n} from '@wesib/wesib';\nimport { trackValue } from 'fun-events';\nimport { css__naming } from 'namespace-aliaser';\nimport { Conduit__NS } from '../../core';\nimport { ApiResponse } from '../../core/api';\nimport { Article, ArticleService } from '../../core/articles';\nimport { ArticlesSupport } from '../../core/articles/articles-support.feature';\nimport { ApiErrorGenerator } from '../../core/input';\nimport { LoaderComponent } from '../../core/loader';\nimport { CurrentUserProfile, currentUserProfileBy, noUserProfile } from '../profile/current-user-profile';\nimport { FollowAuthorComponent } from '../profile/follow-author.component';\nimport { ArticleMetaComponentsSupport } from './article-meta-components-support.feature';\nimport { CurrentArticle } from './current-article';\n\n@Component(\n    ['article', Conduit__NS],\n    {\n      feature: {\n        needs: [\n          ArticleMetaComponentsSupport,\n          ArticlesSupport,\n          FollowAuthorComponent,\n          LoaderComponent,\n        ],\n      },\n    },\n    HandleNavLinks(),\n)\nexport class ArticleComponent {\n\n  private readonly _response = trackValue<ApiResponse<Article>>();\n\n  @StateProperty()\n  private content?: Node;\n\n  constructor(private readonly _context: ComponentContext) {\n\n    const articleService = _context.get(ArticleService);\n    const navigation = _context.get(Navigation);\n    const hierarchy = this._context.get(HierarchyContext);\n    const author = currentUserProfileBy(\n        this._response.read.keep.thru_(\n            response => response && response.ok ? response.body.author : noUserProfile,\n        ),\n    );\n\n    hierarchy.provide({\n      a: CurrentArticle,\n      is: this._response.read.keep.thru_(\n          response => response && response.ok ? response.body : {},\n      ),\n    });\n    hierarchy.provide({\n      a: CurrentUserProfile,\n      is: author,\n    });\n    _context.whenOn(supply => {\n      supply.whenOff(() => this.content = undefined);\n      this._response.read.tillOff(supply)(response => {\n        if (response && response.ok) {\n          articleService.htmlContents(response.body)\n              .then(content => {\n                if (_context.connected) {\n                  this.content = content;\n                }\n              })\n              .catch(error => {\n                if (_context.connected) {\n                  this.content = undefined;\n                  this.response = { ok: false, errors: { article: [`can not be parser ${String(error)}`] } };\n                }\n              });\n        } else {\n          this.content = undefined;\n        }\n      });\n    });\n    _context.whenOn(supply => {\n      navigation.read.tillOff(supply).consume(page => {\n\n        const slug = decodeURIComponent(page.get(PageHashURLParam).pathname.substring(0));\n\n        return articleService.article(slug)(response => this.response = response);\n      });\n    });\n  }\n\n  get response(): ApiResponse<Article> | undefined {\n    return this._response.it;\n  }\n\n  @StateProperty()\n  set response(value: ApiResponse<Article> | undefined) {\n    this._response.it = value;\n  }\n\n  @Render({ path: statePropertyPathTo('response') })\n  render(): ElementRenderer {\n\n    const visibleClassName = css__naming.name(['visible', Conduit__NS], this._context.get(DefaultNamespaceAliaser));\n    const genErrors = this._context.get(ApiErrorGenerator);\n    const { element, contentRoot }: { element: Element; contentRoot: Node } = this._context;\n    const { document } = this._context.get(BootstrapWindow);\n    let loader: Element | undefined;\n\n    return () => {\n\n      const { response } = this;\n\n      if (!response) {\n        displayLoader();\n      } else if (!response.ok) {\n        displayErrors(response);\n      } else {\n        displayContents(response);\n      }\n    };\n\n    function displayContents({ body }: ApiResponse.Ok<Article>): void {\n      hideLoader();\n      setContentsVisible(true);\n      document.getElementById('article:title')!.innerText = body.title;\n    }\n\n    function displayErrors({ errors }: ApiResponse.Failure): void {\n      hideLoader();\n      setContentsVisible(false);\n      loader = genErrors(errors);\n      if (loader) {\n        contentRoot.appendChild(loader);\n      }\n    }\n\n    function displayLoader(): void {\n      setContentsVisible(false);\n      if (!loader) {\n        loader = contentRoot.appendChild(document.createElement('conduit-loader'));\n      }\n    }\n\n    function hideLoader(): void {\n      if (loader) {\n        loader.remove();\n        loader = undefined;\n      }\n    }\n\n    function setContentsVisible(visible: boolean): void {\n      if (visible) {\n        element.classList.add(visibleClassName);\n      } else {\n        element.classList.remove(visibleClassName);\n      }\n    }\n  }\n\n  @Render({ path: statePropertyPathTo('content') })\n  renderContent(): ElementRenderer {\n\n    const { document } = this._context.get(BootstrapWindow);\n\n    return () => {\n\n      const contentParent = document.getElementById('article:content');\n\n      if (contentParent) {\n        contentParent.innerHTML = '';\n\n        const content = this.content;\n\n        if (content) {\n          contentParent.appendChild(content);\n        }\n      }\n    };\n  }\n\n}\n","import { conduitContext } from '../../core/main';\nimport { ArticleComponent } from './article.component';\n\nconduitContext.load(ArticleComponent);\n"],"names":["ArticleComponent","[object Object]","_context","this","trackValue","articleService","get","ArticleService","navigation","Navigation","hierarchy","HierarchyContext","author","currentUserProfileBy","_response","read","keep","thru_","response","ok","body","noUserProfile","provide","a","CurrentArticle","is","CurrentUserProfile","whenOn","supply","whenOff","content","undefined","tillOff","htmlContents","then","connected","catch","error","errors","article","String","consume","page","slug","decodeURIComponent","PageHashURLParam","pathname","substring","it","value","visibleClassName","css__naming","name","Conduit__NS","DefaultNamespaceAliaser","genErrors","ApiErrorGenerator","element","contentRoot","document","BootstrapWindow","loader","hideLoader","setContentsVisible","getElementById","innerText","title","displayContents","appendChild","displayErrors","createElement","remove","visible","classList","add","contentParent","innerHTML","__decorate","StateProperty","Render","path","statePropertyPathTo","Component","feature","needs","ArticleMetaComponentsSupport","ArticlesSupport","FollowAuthorComponent","LoaderComponent","HandleNavLinks","conduitContext","load"],"mappings":"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"}