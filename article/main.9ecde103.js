import"../js/proc7ts/primitives.e781e476.js";import"../js/proc7ts/push-iterator.f6f3343e.js";import"../js/proc7ts/context-values.69c73302.js";import"../js/frontmeans/namespace-aliaser.e08188c9.js";import{s as e,G as t,d as s,t as o,m as r,n}from"../js/proc7ts/fun-events.f7c44dc9.js";import{n as c,b as a,D as i,s as m}from"../js/core/auth.e0c9460a.js";import"../js/frontmeans/render-scheduler.78bb570f.js";import{S as l,C as d,B as p,D as h,R as u,w as f}from"../js/wesib/wesib.acbfb4f5.js";import{_ as j}from"../js/helpers.e1623395.js";import{a as b}from"../js/core/api.f9177210.js";import{a as g,I as C,i as x,S as y,O as v,d as _,N as E,P as w}from"../js/wesib/generic.5b4ac940.js";import"../js/proc7ts/delta-set.d5d9e832.js";import{f as O,q as F,I as M,g as N,r as T,c as I,s as k,b as S}from"../js/frontmeans/input-aspects.a58ff15b.js";import{C as A}from"../js/core.c152f8fe.js";import{R as D,f as R,a as $}from"../js/core/loader.57d9ca02.js";import"../js/core/layout.3dca3b65.js";import{c as q}from"../js/core/main.e75f4f7e.js";import{A as B}from"../js/core/articles.34c878ba.js";import"../js/lib/dompurify.f5eadf9f.js";import"../js/lib/marked.5b76e7a8.js";import{F as L,c as U,C as H,n as P}from"../js/follow-author-btn.component.f7e7bfe7.js";import{e as G}from"../js/frontmeans/httongue.193345e9.js";import"../js/core/users.ea939982.js";import"../js/proc7ts/call-thru.f4f68410.js";import"../js/core/feed.9db6d3c0.js";import{A as Q,D as z,E as J}from"../js/article-buttons-support.feature.dff83677.js";import{n as K,C as V,a as W}from"../js/current-article.2a3b7c3c.js";import{C as X,a as Y}from"../js/core/comments.f8eac792.js";import{C as Z,U as ee,F as te}from"../js/core/input.6207225b.js";let se=class{constructor(t){this._context=t,this.user=c,this.article=K;const s=t.get(a),o=t.get(g);s.user.do(e(t))((e=>this.user=e)).whenOff((()=>this.user=c)),o.get(V).do(e(t))((e=>this.article=e)).whenOff((()=>this.article=K))}render(){const{document:e}=this._context.get(p),t=e.createDocumentFragment();if(this.article.slug&&this.article.author.username===this.user.username){t.appendChild(e.createElement("conduit-edit-post-btn")).tabIndex=0;t.appendChild(e.createElement("conduit-delete-post-btn")).tabIndex=0}else{t.appendChild(e.createElement("conduit-follow-author-btn")).tabIndex=0;const s=t.appendChild(e.createElement("conduit-favorite-post-btn"));s.innerText="Favorite Post",s.tabIndex=0}return t}};j([l()],se.prototype,"user",void 0),j([l()],se.prototype,"article",void 0),j([D()],se.prototype,"render",null),se=j([d(["article-actions",A],{feature:{needs:[Q,z,J]}})],se);class oe extends CustomEvent{}let re=class{constructor(t){this._context=t,this.article=K,this.user=c,this.form={};const s=t.get(a),o=t.get(g);s.user.do(e(t))((e=>this.user=e)).whenOff((()=>this.user=c)),o.get(V).do(e(t))((e=>this.article=e)).whenOff((()=>this.article=K)),o.get(C).do(e(t))((e=>this.form=e)).whenOff((()=>this.form={}))}render(){const e=this.articleComment;if(!e)return;const t=this._context.get(X),{document:s}=this._context.get(p),{author:o}=e,r=`profile/#/${encodeURIComponent(o.username)}`,n=o.image?'<img src="http://i.imgur.com/Qr71crq.jpg" class="comment-author-img" />':"",c=R(new Date(e.createdAt)),a=s.createDocumentFragment(),l=a.appendChild(s.createElement("div"));l.className="card-body";const d=l.appendChild(s.createElement("p"));d.className="card-text",d.innerText=e.body;const h=a.appendChild(s.createElement("div"));h.className="card-footer",h.innerHTML=`\n<a href="${r}" class="comment-author">${n}</a>\n<a href="${r}" class="comment-author">${G(o.username)}</a>\n<span class="date-posted">${c}</span>`;const{control:u}=this.form,{slug:f}=this.article;if(this.user.username===o.username&&u&&f){const o=h.appendChild(s.createElement("span"));o.className="mod-options";const r=o.appendChild(s.createElement("button"));r.type="button",r.className="btn btn-sm",r.innerHTML='<i class="ion-trash-a"></i>',O(r,{form:u}),new i(r).on("click").do(m)((()=>{u.aspect(F).submit((()=>b(t.deleteComment(f,e.id)))).then((()=>{this._context.dispatchEvent(new oe("conduit:comment",{bubbles:!0,detail:{removed:e.id}}))})).catch((e=>{e instanceof M?console.error("Failed to remove comment",...e.errors):console.error("Failed to remove comment",e)}))}))}return a}};j([h()],re.prototype,"articleComment",void 0),j([l()],re.prototype,"article",void 0),j([l()],re.prototype,"user",void 0),j([D({comment:"COMMENT"})],re.prototype,"render",null),re=j([d(["article-comment",A])],re);let ne=class{constructor(e){this._context=e,this.comments=[];const o=e.get(X),r=this._context.get(g);this._context.on("conduit:comment")((({detail:{added:e,removed:t}})=>{this.comments=e?[e,...this.comments]:this.comments.filter((e=>e.id!==t))}));let n=K;r.get(V).do(t(e),s((e=>{if(e.slug&&e.slug!==n.slug)return n=e,o.articleComments(e.slug)})))((e=>{this.response=e,e.ok&&(this.comments=e.body.comments)}));const c=N({});c.supply.needs(e),x(e,c)}render(){const{document:e}=this._context.get(p),{contentRoot:t}=this._context,s=e.createRange();return s.setStartAfter(t.appendChild(e.createComment("[COMMENTS["))),s.setEndBefore(t.appendChild(e.createComment("]COMMENTS]"))),()=>{s.deleteContents();const{comments:t}=this;if(!t.length)return;const o=e.createDocumentFragment();t.forEach((t=>{o.appendChild(e.createElement("conduit-article-comment")).articleComment=t})),s.insertNode(o)}}};j([$({comment:"COMMENTS"})],ne.prototype,"response",void 0),j([l()],ne.prototype,"comments",void 0),j([u()],ne.prototype,"render",null),ne=j([d(["article-comments",A],{feature:{needs:[re,Y,Z]}})],ne);let ce=class{constructor(t){this._context=t;const s=t.get(B),o=this._context.get(g);t.supply.whenOff((()=>this.content=void 0)),o.get(V).do(e(t))((e=>{e.slug?s.htmlContents(e).then((e=>{t.connected&&(this.content=e)})).catch((e=>{t.connected&&(this.content=void 0,console.error("Failed to parse article",e))})):this.content=void 0}))}render(){return this.content}};j([l()],ce.prototype,"content",void 0),j([D({comment:"ARTICLE(content)"})],ce.prototype,"render",null),ce=j([d(["article-content",A])],ce);let ae=class{};ae=j([d(["article-comment-text",A],ee({select:"textarea",makeControl:({node:e,aspects:t})=>T(e.element,{aspects:t}).setup(I,(e=>e.by(k())))}),y("text"))],ae);let ie=class{constructor(t){this._context=t,this.article=K,this.user=c,this._commentService=t.get(X);const s=t.get(a),o=t.get(g);s.user.do(e(t))((e=>this.user=e)).whenOff((()=>this.user=c)),o.get(V)((e=>this.article=e)).whenOff((()=>this.article=K))}render(){const{element:e}=this._context,t=e.querySelector(".comment-author-img");return()=>{this.user.email&&this.user.image?null==t||t.setAttribute("src",this.user.image):null==t||t.removeAttribute("src")}}submit({control:e}){const{article:t}=this;t.slug&&(e.aspect(S).markEdited(),e.aspect(F).submit((e=>b(this._commentService.addComment(t.slug,e.text)))).then((t=>{e.it={text:""},e.aspect(S).markTouched(!1),e.aspect(F).reset(),this._context.dispatchEvent(new oe("conduit:comment",{bubbles:!0,detail:{added:t}}))})).catch((e=>{e instanceof M?console.error("Failed to comment",...e.errors):console.error("Failed to comment",e)})))}};j([l()],ie.prototype,"user",void 0),j([u()],ie.prototype,"render",null),j([v()],ie.prototype,"submit",null),ie=j([d(["new-article-comment",A],{feature:{needs:[ae,Y]}},te({emptyModel:{text:""}}))],ie);let me=class{constructor(t){this._context=t,this._response=o();const s=t.get(B),c=t.get(E),a=this._context.get(g),i=(new W).byArticles(this._response.read.do(r((e=>e&&e.ok?e.body:K)))),l=U(this._response.read.do(r((e=>e&&e.ok?e.body.author:P))));a.provide({a:V,is:i}),a.provide({a:H,is:l}),t.whenConnected((()=>{c.read.do(e(t),n((e=>{const t=decodeURIComponent(e.get(w).pathname.substring(1));return s.article(t)((e=>this.response=e))}))),t.on("conduit:article").do(m)((()=>{c.open("").catch(console.error)}))}))}get response(){return this._response.it}set response(e){this._response.it=e}render(){const{document:e}=this._context.get(p);return()=>{const{response:t}=this;t&&t.ok&&(e.getElementById("article:title").innerText=t.body.title)}}};j([l(),$()],me.prototype,"response",null),j([u({on:f("response")})],me.prototype,"render",null),me=j([d(["article",A],{feature:{needs:[ne,ce,Q,se,L,ie]}},_())],me),q.load(me);//# sourceMappingURL=main.9ecde103.js.map
