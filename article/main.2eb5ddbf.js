import{a as t}from"../js/proc7ts/call-thru.3702f6af.js";import{D as e,n as s,i as o,t as r}from"../js/proc7ts/fun-events.cf42a1d4.js";import{S as n,C as c,B as a,D as i,R as m,w as l}from"../js/wesib/wesib.d8a927dd.js";import{_ as d}from"../js/helpers.e1623395.js";import{n as p,b as u}from"../js/core/auth.cd430625.js";import{a as h}from"../js/core/api.0f4960fa.js";import{a as f,I as g,i as b,S as j,O as C,e as x,N as _,P as v}from"../js/wesib/generic.4d2c6788.js";import{f as y,q as E,I as O,g as w,r as T,c as F,s as M,b as N}from"../js/proc7ts/input-aspects.352068d9.js";import{C as k}from"../js/core.714cbb7b.js";import{R as I,a as S}from"../js/core/loader.bec2ccbf.js";import{C as A,U as D,F as R}from"../js/core/input.b5d7b961.js";import{A as $,D as q,E as B,f as L}from"../js/article-buttons-support.feature.33c9c7d5.js";import{c as U}from"../js/core/main.3e023644.js";import{A as H}from"../js/core/articles.9cfd679b.js";import{F as P,c as Q,n as z,C as G}from"../js/follow-author-btn.component.f354b962.js";import{e as J}from"../js/core/util.4ad39fa9.js";import{n as K,C as V,a as W}from"../js/current-article.d08eaadd.js";import{C as X,a as Y}from"../js/core/comments.509d186a.js";let Z=(()=>{let t=class{constructor(t){this._context=t,this.user=p,this.article=K;const e=t.get(u),s=t.get(f);e.user().tillOff(t).to(t=>this.user=t).whenOff(()=>this.user=p),s.get(V).tillOff(t).to(t=>this.article=t).whenOff(()=>this.article=K)}render(){const{document:t}=this._context.get(a),e=t.createDocumentFragment();if(this.article.slug&&this.article.author.username===this.user.username){e.appendChild(t.createElement("conduit-edit-post-btn")).tabIndex=0;e.appendChild(t.createElement("conduit-delete-post-btn")).tabIndex=0}else{e.appendChild(t.createElement("conduit-follow-author-btn")).tabIndex=0;const s=e.appendChild(t.createElement("conduit-favorite-post-btn"));s.innerText="Favorite Post",s.tabIndex=0}return e}};return d([n()],t.prototype,"user",void 0),d([n()],t.prototype,"article",void 0),d([I()],t.prototype,"render",null),t=d([c(["article-actions",k],{feature:{needs:[$,q,B]}})],t),t})();class tt extends CustomEvent{}let et=(()=>{let t=class{constructor(t){this._context=t,this.article=K,this.user=p,this.form={};const e=t.get(u),s=t.get(f);e.user().tillOff(t).to(t=>this.user=t).whenOff(()=>this.user=p),s.get(V).tillOff(t).to(t=>this.article=t).whenOff(()=>this.article=K),s.get(g).tillOff(t).to(t=>this.form=t).whenOff(()=>this.form={})}render(){const t=this.articleComment;if(!t)return;const s=this._context.get(X),{document:o}=this._context.get(a),{author:r}=t,n="profile/#/"+encodeURIComponent(r.username),c=r.image?'<img src="http://i.imgur.com/Qr71crq.jpg" class="comment-author-img" />':"",i=L(new Date(t.createdAt)),m=o.createDocumentFragment(),l=m.appendChild(o.createElement("div"));l.className="card-body";const d=l.appendChild(o.createElement("p"));d.className="card-text",d.innerText=t.body;const p=m.appendChild(o.createElement("div"));p.className="card-footer",p.innerHTML=`\n<a href="${n}" class="comment-author">${c}</a>\n<a href="${n}" class="comment-author">${J(r.username)}</a>\n<span class="date-posted">${i}</span>`;const{control:u}=this.form,{slug:f}=this.article;if(this.user.username===r.username&&u&&f){const r=p.appendChild(o.createElement("span"));r.className="mod-options";const n=r.appendChild(o.createElement("button"));n.type="button",n.className="btn btn-sm",n.innerHTML='<i class="ion-trash-a"></i>',y(n,{form:u}),new e(n).on("click").just(()=>{u.aspect(E).submit(()=>h(s.deleteComment(f,t.id))).then(()=>{this._context.dispatchEvent(new tt("conduit:comment",{bubbles:!0,detail:{removed:t.id}}))}).catch(t=>{t instanceof O?console.error("Failed to remove comment",...t.errors):console.error("Failed to remove comment",t)})})}return m}};return d([i()],t.prototype,"articleComment",void 0),d([n()],t.prototype,"article",void 0),d([n()],t.prototype,"user",void 0),d([I({comment:"COMMENT"})],t.prototype,"render",null),t=d([c(["article-comment",k])],t),t})(),st=(()=>{let e=class{constructor(e){this._context=e,this.comments=[];const r=e.get(X),n=this._context.get(f);this._context.on("conduit:comment").to(({detail:{added:t,removed:e}})=>{this.comments=t?[t,...this.comments]:this.comments.filter(t=>t.id!==e)});let c=K;n.get(V).tillOff(e).thru_(e=>e.slug&&e.slug!==c.slug?(c=e,s(r.articleComments(e.slug))):t).to(t=>{this.response=t,t.ok&&(this.comments=t.body.comments)});const a=w({});o(a).needs(e),b(e,a)}render(){const{document:t}=this._context.get(a),{contentRoot:e}=this._context,s=t.createRange();return s.setStartAfter(e.appendChild(t.createComment("[COMMENTS["))),s.setEndBefore(e.appendChild(t.createComment("]COMMENTS]"))),()=>{s.deleteContents();const{comments:e}=this;if(!e.length)return;const o=t.createDocumentFragment();e.forEach(e=>{o.appendChild(t.createElement("conduit-article-comment")).articleComment=e}),s.insertNode(o)}}};return d([S({comment:"COMMENTS"})],e.prototype,"response",void 0),d([n()],e.prototype,"comments",void 0),d([m()],e.prototype,"render",null),e=d([c(["article-comments",k],{feature:{needs:[et,Y,A]}})],e),e})(),ot=(()=>{let t=class{constructor(t){this._context=t;const e=t.get(H),s=this._context.get(f);o(t).whenOff(()=>this.content=void 0),s.get(V).tillOff(t).to(s=>{s.slug?e.htmlContents(s).then(e=>{t.connected&&(this.content=e)}).catch(e=>{t.connected&&(this.content=void 0,console.error("Failed to parse article",e))}):this.content=void 0})}render(){return this.content}};return d([n()],t.prototype,"content",void 0),d([I({comment:"ARTICLE(content)"})],t.prototype,"render",null),t=d([c(["article-content",k])],t),t})(),rt=(()=>{let t=class{};return t=d([c(["article-comment-text",k],D({select:"textarea",makeControl:({node:t,aspects:e})=>T(t.element,{aspects:e}).setup(F,t=>t.by(M()))}),j("text"))],t),t})(),nt=(()=>{let t=class{constructor(t){this._context=t,this.article=K,this.user=p,this._commentService=t.get(X);const e=t.get(u),s=t.get(f);e.user().tillOff(t).to(t=>this.user=t).whenOff(()=>this.user=p),s.get(V).to(t=>this.article=t).whenOff(()=>this.article=K)}render(){const{element:t}=this._context,e=t.querySelector(".comment-author-img");return()=>{this.user.email&&this.user.image?null==e||e.setAttribute("src",this.user.image):null==e||e.removeAttribute("src")}}submit({control:t}){const{article:e}=this;e.slug&&(t.aspect(N).markEdited(),t.aspect(E).submit(t=>h(this._commentService.addComment(e.slug,t.text))).then(e=>{t.it={text:""},t.aspect(N).markTouched(!1),t.aspect(E).reset(),this._context.dispatchEvent(new tt("conduit:comment",{bubbles:!0,detail:{added:e}}))}).catch(t=>{t instanceof O?console.error("Failed to comment",...t.errors):console.error("Failed to comment",t)}))}};return d([n()],t.prototype,"user",void 0),d([m()],t.prototype,"render",null),d([C()],t.prototype,"submit",null),t=d([c(["new-article-comment",k],{feature:{needs:[rt,Y]}},R({emptyModel:{text:""}}))],t),t})(),ct=(()=>{let t=class{constructor(t){this._context=t,this._response=r();const e=t.get(H),s=t.get(_),o=this._context.get(f),n=(new W).byArticles(this._response.read().keepThru_(t=>t&&t.ok?t.body:K)),c=Q(this._response.read().keepThru_(t=>t&&t.ok?t.body.author:z));o.provide({a:V,is:n}),o.provide({a:G,is:c}),t.whenConnected(()=>{s.read().tillOff(t).consume(t=>{const s=decodeURIComponent(t.get(v).pathname.substring(1));return e.article(s).to(t=>this.response=t)}),t.on("conduit:article").just(()=>{s.open("").catch(console.error)})})}get response(){return this._response.it}set response(t){this._response.it=t}render(){const{document:t}=this._context.get(a);return()=>{const{response:e}=this;e&&e.ok&&(t.getElementById("article:title").innerText=e.body.title)}}};return d([n(),S()],t.prototype,"response",null),d([m({on:l("response")})],t.prototype,"render",null),t=d([c(["article",k],{feature:{needs:[st,ot,$,Z,P,nt]}},x())],t),t})();U.load(ct);//# sourceMappingURL=main.2eb5ddbf.js.map
