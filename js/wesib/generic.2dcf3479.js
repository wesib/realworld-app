import{m as e,n as t,o as n,p as s,l as r}from"../frontmeans/input-aspects.453491d0.js";import{x as o,s as i,l as a,O as c,A as u,j as h,w as l,b as d,n as p,y as f,t as g,B as m,c as w,f as _,v as y,F as v,E as b,G as x,a as S,H as R,z as k,r as C,d as U,I as L,o as D,k as E,g as A,p as N,V as P,J as O,i as M,m as q}from"../proc7ts/fun-events.2a5b87d8.js";import{C as I,B as j,n as F,e as z,o as K,p as B,l as H,q as V,r as W,a as T,W as G,s as J,u as $,v as Q,w as X,k as Y,d as Z}from"./wesib.8c9ee002.js";import{b as ee,C as te,a as ne,c as se,F as re,d as oe,e as ie,S as ae,f as ce}from"../proc7ts/context-values.20584faa.js";import{D as ue,h as he}from"../frontmeans/dom-events.fbc8d9ac.js";import{m as le,i as de,a as pe,d as fe,f as ge,k as me,h as we,j as _e,p as ye,P as ve,g as be,l as xe,n as Se}from"../proc7ts/push-iterator.8feb4ef8.js";import{c as Re,h as ke}from"../frontmeans/namespace-aliaser.9467f14d.js";import{S as Ce,n as Ue,s as Le,v as De,a as Ee,i as Ae,c as Ne,m as Pe}from"../proc7ts/primitives.d6f0dd1c.js";import{h as Oe,a as Me}from"../hatsy/http-header-value.851567fb.js";class qe extends oe{constructor(e){super(e),this.upKey=this.createUpKey((e=>e.insert(e.seed.do(w(((...t)=>t.length?d(function(e){return(t,n)=>{const s=(n,r)=>{const o=e[n];return o?L(o(((e=r)=>s(n+1,e)),r)):t(r)};return s(0,n)}}(t)):e.hasFallback&&e.or?e.or:d(Ie)))))))}grow(e){let t;e.context.get(this.upKey,e.hasFallback?{or:null!=e.or?d(e.or):e.or}:void 0)((e=>t=e)).whenOff((e=>t=ie(e))),e.insert(((e,n)=>t(e,n)))}}function Ie(e,t){return e(t)}const je=new qe("http-fetch-agent"),Fe={};const ze=new re("http-fetch",{byDefault:T((function(e){const t=e.get(j),n=e.get(je);return(e,t)=>n(s,new Request(e,t));function s(e){return _((n=>{const s=new b;let r;if("AbortController"in t){const o=new t.AbortController,{signal:i}=o;r=new Ce((e=>{e===Fe&&o.abort()})),n.supply.whenOff((()=>r.off(Fe))).needs(r),s.on({supply:r,receive(e,t){n.receive(e,t)}});const a=e.signal;a&&(new ue(a).on("abort").do(D)((()=>o.abort())),a.aborted&&o.abort()),e=new Request(e,{signal:i})}else r=s.on(n);t.fetch(e).then((e=>{s.send(e),r.off()})).catch((e=>r.off(e)))}))}}))});const Ke=new ne("hierarchy-root",{byDefault:e=>{const t=e.get(J);return new ue(t).on("wesib:component")((({context:e})=>e.get(He).issue())),g()}}),Be=new ne("hierarchy-updates",{byDefault:e=>new He(e.get(z))});class He{constructor(e){const t=new b,n=e.get(K).get(Ke);this.on=t.on,this.send=()=>t.send(e),this.issue=()=>{const t=Ve(e);t?t[0].get(He).send():n.it=e}}static get[te](){return Be}}function Ve(e){var t;const n=e.get(K).get(J);let{element:s}=e,r=!0;if(s!==n)for(;;){const e=s.parentNode||s.getRootNode().host;if(!e)return;const o=null===(t=e[V])||void 0===t?void 0:t.context;if(o)return[o,r];if(e===n)return;r=!1,s=e}}const We=new ne("hierarchy-context",{byDefault:e=>new Ge(e.get(z))});class Te extends ee{static get[te](){return We}get supply(){return this.context.supply}}class Ge extends Te{constructor(e){super(),this.context=e,this.up=f((e=>{const{supply:t}=e;t.needs(this);const n=g();n.by(this._parent),t.cuts(n);const s=(new Ce).needs(t),r=(new Ce).needs(t),o=()=>{const e=Ve(this.context);if(e){const[t,o]=e;n.it=t.get(Te),s.off(),o&&r.off()}else n.it=void 0};this.context.get(K).get(Ke).read({supply:s,receive:()=>this.context.connected&&o()}),n.read.do(i(r),a((e=>e&&e.context.get(He).on(o)))),n.read(e),this.context.whenConnected({supply:(new Ce).needs(t),receive:o})})).do(m);const t=this._parent=g();e.whenConnected(Ue).cuts(t);const n=this._registry=(s=this.up,new se((e=>function(e){return"upKey"in e}(e)?s.do(w((t=>t?t.get(e):d()))):void 0)));var s;this.get=n.newValues().get}provide(e){return this._registry.provide(e).needs(this)}inside(e){return this._parent.it=e&&e.get(Te),this}}class Je{[c](){return this.onUpdate}[u](){return this.read}}const $e={subtree:!0};function Qe(e,t,n,s,{deep:r,all:o}){const i=new b,a=r?$e:void 0;let c,u=new Set;const h=r?Xe:pe;"string"==typeof n?c=n:e.whenDefined(n).then((({elementDef:{name:t}})=>{if(t&&(c=ke.name(t,e.get(H)),i.size)){const e=p();if(e.size){const t=fe(_e(le(e,(e=>s(e))),Ae));t.length&&i.send(t,[])}}})).catch(console.error),o||t.addEventListener("wesib:component",(e=>{const t=e.target;if(u.has(t)){const e=s(t);i.send([e],[])}}));const l=_e(le(xe((function(){return Se(i.size?u:p())})),(e=>s(e))),Ae);class d extends Je{constructor(){super();const n=e.get($)(g);this.onUpdate=_((e=>{const s=!i.size,r=i.on(e);s&&(p(),n.observe(t,a)),r.whenOff((()=>{i.size||(n.disconnect(),u.clear())})).needs(e.supply)}));const s=De(this);this.read=this.onUpdate.do(E(s,s)),this.track=f((e=>{const t=new b;t.on(e),t.send(fe(this),[]),this.onUpdate(e)})),this.first=A(this.read).do(N(((e,t)=>e(ye(t)))))}[Symbol.iterator](){return this[ve]()}[ve](e){return l[ve](e)}}return new d;function p(){const e=function(){const e=c;if(!e)return new Set;if(r)return new Set(pe(t.querySelectorAll(e)));return new Set(ge(t.children,(t=>t.matches(e))))}();return i.size&&(u=e),e}function g(e){const t=[],n=[];e.forEach((e=>{de(_e(le(h(e.removedNodes),w),Ae),(e=>n.push(e))),de(_e(le(h(e.addedNodes),m),Ae),(e=>t.push(e)))})),(t.length||n.length)&&i.send(t,n)}function m(e){if(Q(e))return c&&e.matches(c)&&!u.has(e)?(u.add(e),s(e)):void 0}function w(e){if(Q(e)&&u.delete(e))return s(e,!0)}}function Xe(e){return be(e,(e=>pe([e,...Xe(e.childNodes)])))}class Ye{constructor(e,t){this._bs=e,this.element=t,this._emitters=new Map}get observer(){if(this._observer)return this._observer;const e=this._bs.get(j).MutationObserver;return this._observer=new e((e=>this._update(e)))}observe(e,t){const n=this,s=this.observer,r=this._emitter(e),o=R(t),i=r.on({supply:new Ce((()=>{this._emitters.delete(e),s.disconnect(),this._emitters.size?a():this._observer=void 0})).needs(o.supply),receive:(e,t,n)=>o.receive(e,t,n)});return s.disconnect(),a(),i;function a(){n._update(s.takeRecords()),s.observe(n.element,{attributes:!0,attributeOldValue:!0,attributeFilter:[...n._emitters.keys()]})}}_update(e){e.forEach((e=>{const t=e.attributeName,n=this._emitters.get(t);n&&n.send(this.element.getAttribute(t),e.oldValue)}))}_emitter(e){const t=new b;return this._emitters.set(e,t),t}}class Ze extends P{constructor(e,t){super(),this._observer=e,this._name=t,this._updates=new b;let n=Ne();this.on=_((e=>{this._updates.size||(n=this._observer.observe(this._name,((e,t)=>this._updates.send(e,t)))),e.supply.needs(n),this._updates.on(e).whenOff((e=>{this._updates.size||n.off(e)}))}))}get supply(){return this._updates.supply}get it(){return this._observer.element.getAttribute(this._name)}set it(e){null!=e?this._observer.element.setAttribute(this._name,e):this._observer.element.removeAttribute(this._name)}}class et{constructor(e,t){this._attrs=new Map,this._observer=new Ye(e,t)}get(e){const t=this._attrs.get(e);if(t)return t;const n=new Ze(this._observer,e);return this._attrs.set(e,n),n}}class tt extends P{constructor(e,t){super(),this._element=e,this._updates=new b,this._key=t}get supply(){return this._updates.supply}get it(){return this._element[this._key]}set it(e){this._element[this._key]=e}get on(){return this._updates.on}bind(e){e.get(X).track(Y(this._key)).onUpdate({supply:this.supply,receive:(e,t,n,s)=>this._updates.send(n,s)})}}class nt{constructor(e){this._element=e,this._props=new Map}bind(e){this._context=e,this._props.forEach((t=>t.bind(e)))}get(e){const t=this._props.get(e);if(t)return t;const n=new tt(this._element,e);return this._context&&n.bind(this._context),this._props.set(e,n),n}}const st=Symbol("element-node");class rt{constructor(e,t){this._bs=e,this.element=t,this._attrs=new et(e,t),this._props=new nt(t),t[st]=this;const n=this.context;n?this._bind(n):t.addEventListener("wesib:component",(e=>this._bind(e.context)))}get context(){var e;return null===(e=this.element[V])||void 0===e?void 0:e.context}get parent(){const e=this.element.parentNode;return e&&ot(this._bs,e)}select(e,t){return function(e,t,n,s={}){if(s.all)return Qe(e,t,n,((t,n)=>ot(e,t,n)),s);const r=e.get(W);return Qe(e,t,n,((t,n)=>r(t)&&ot(e,t,n)),s)}(this._bs,this.element,e,t)}attribute(e){return this._attrs.get(e)}property(e){return this._props.get(e)}_bind(e){this._props.bind(e)}}function ot(e,t,n){const s=t[st];return s||n?s:new rt(e,t)}const it=new ne("component-node",{byDefault:e=>ot(e.get(K),e.get(z).element)});function at(e){return new URL(e.hash.substring(1),e.origin)}function ct(e,t){if(t.origin!==e.origin||t.username)return new URL(`#${t}`,e);const{pathname:n,search:s,hash:r}=t,o=new URL("",e);return o.hash=s||r||n.length>1?n+s+r:s+r,o}const ut=Symbol("page-param");class ht{get[ut](){return this}byDefault(e,t){}}class lt extends ht{create(e,t){let n;const s={get:()=>n,put(t){n="string"==typeof t?new URL(t,e.url.origin):t}};return s.put(t),s}}const dt=new lt;class pt extends ht{create(e,t){const n={get:()=>e.get(dt)||at(e.url),put(t){e.put(dt,t)}};return n.put(t),n}byDefault(e){return this.create(e,null)}}const ft=new pt;class gt extends oe{constructor(e){super(e),this.upKey=this.createUpKey((e=>{const{document:t}=e.context.get(j);e.insert(e.seed.do(w(((...n)=>n.length?d((function(e,s,r,o){return i(0,o);function i(o,a){const c=n[o];if(!c)return e(a);c((({url:e=a.url,title:n=a.title,data:s=a.data}=a)=>i(o+1,{url:new URL(String(e),t.baseURI),title:n,data:s,get visited(){return a.visited},get current(){return a.current},get:e=>a.get(e),put(e,t){a.put(e,t)}})),s,r,a)}})):e.hasFallback&&e.or?e.or:d(mt)))))}))}grow(e){let t;e.context.get(this.upKey,e.hasFallback?{or:null!=e.or?d(e.or):e.or}:void 0)((e=>t=e)).whenOff((e=>t=ie(e))),e.insert(((e,n,s,r)=>t(e,n,s,r)))}}function mt(e,t,n,s){e(s)}const wt=new gt("navigation-agent"),_t={setup(e){e.provide({a:wt,is:vt})}};class yt{static get[B](){return _t}}function vt(e,t,n,s){const r=s.get(dt);r?e({url:ct(s.url,r)}):e()}class bt extends ee{}const xt=new ne("nav-history",{byDefault:T((e=>new Rt(e)))});function St(e){return null==e||"object"!=typeof e?{data:e}:e["wesib:navigation:data"]}class Rt{constructor(e){this._context=e,this._entries=new Map,this._lastId=0;const t=e.get(j);this._document=t.document,this._location=t.location,this._history=t.history,this._uid=btoa(String(Math.random()))}static get[te](){return xt}init(){const{data:e}=St(this._history.state),t=this.newEntry({url:new URL(this._location.href),data:e,title:this._document.title});return this._entries.set(t.id,t),t.schedule((()=>{t.enter("init"),this._history.replaceState(this._historyState(t),"")})),t}newEntry(e){return new kt(this._context,++this._lastId,e)}open(e,t){const{page:{title:n="",url:s}}=e;this._history.pushState(this._historyState(e),n,s.href),this._enter("open",e,t)}_enter(e,t,n){const s=n.it;this._entries.set(t.id,t);try{for(let e=s.next;e;e=e.next)this._forget(e)}finally{t.prev=s,s.next=t,t.schedule((()=>{try{s.leave()}finally{t.enter(e)}})),n.it=t}}replace(e,t){const n=t.it,{page:{title:s="",url:r}}=e;this._history.replaceState(this._historyState(e),s,r.href),this._entries.set(e.id,e);const o=n.prev;o&&(e.prev=o,o.next=e),e.schedule((()=>{try{n.leave()}finally{try{this._forget(n)}finally{e.enter("replace")}}})),t.it=e}popState(e,t){const{state:n}=e;if(null==n)return null==this._history.state?this._changeHash(t):void 0;const s=t.it,{uid:r,data:o,id:i}=St(n);let a;const c=r===this._uid&&null!=i?this._entries.get(i):void 0;return c?a=c:(a=this.newEntry({url:new URL(this._location.href),data:o,title:this._document.title}),s.transfer(a,"return"),this._entries.set(a.id,a),this._history.replaceState(this._historyState(a),"")),a.schedule((()=>{try{s.leave()}finally{a.enter("return")}})),t.it=a,a}hashChange(e){if(null==this._history.state)return this._changeHash(e)}update(e,t){const n=e.it,s=new kt(this._context,++this._lastId,{...n.page,url:t},n);return this._entries.set(s.id,s),this._history.replaceState(this._historyState(s),"",t.href),this._entries.delete(n.id),e.it=s}_changeHash(e){const t=e.it,n=this.newEntry({url:new URL(this._location.href),data:null,title:this._document.title});try{t.transfer(n,"enter")}finally{this._history.replaceState(this._historyState(n),""),this._enter("enter",n,e)}return n}_forget(e){this._entries.delete(e.id),e.forget()}_historyState({id:e,page:{data:t}}){return{"wesib:navigation:data":{uid:this._uid,id:e,data:t}}}}class kt{constructor(e,t,n,s){this._bsContext=e,this.id=t,this._status=0,this._update=Ue,this._params=s?s._params:new Map;const r=this;this.page={get url(){return n.url},get title(){return n.title},get data(){return n.data},get visited(){return!!r._status},get current(){return 2===r._status},get:e=>r.get(e),put(e,t){r.put(e,t)}}}get(e){const t=e[ut],n=this._params.get(t);if(n)return n.get();const s=t.byDefault(this.page,this._newContext());return s&&this._init(t,s)}put(e,t){const n=e[ut],s=this._params.get(n);return s?(s.put(t),s.get()):this._init(n,n.create(this.page,t,this._newContext()))}_newContext(){const e=new se(this._bsContext);return new class extends bt{constructor(){super(...arguments),this.get=e.newValues().get}}}_init(e,t){return this._params.set(e,t),this.page.current&&t.enter&&t.enter(this.page,"init"),t.get()}transfer(e,t){de(this._params.entries(),(([n,s])=>{if(s.transfer){const r=s.transfer(e.page,t);r&&e._params.set(n,r)}}))}stay(e){de(this._params.values(),(t=>t.stay&&t.stay(e)))}enter(e){this._status=2,de(this._params.values(),(t=>t.enter&&t.enter(this.page,e)))}leave(){this._status=1,de(this._params.values(),(e=>e.leave&&e.leave()))}forget(){de(this._params.values(),(e=>e.forget&&e.forget())),this._params.clear()}schedule(e){this._update=e}apply(){const e=this._update;this._update=Ue,e()}}class Ct extends Event{constructor(e,t){super(e,{...t,cancelable:!1}),this.when=t.when,this.to=t.to}}class Ut extends Event{constructor(e,t){super(e,{...t,cancelable:!0}),this.when=t.when,this.from=t.from,this.to=t.to}}class Lt extends Event{constructor(e,t){super(e,{...t,cancelable:!0}),this.from=t.from,this.to=t.to,this.reason=t.reason}get when(){return"stay"}}const Dt=new ne("navigation",{byDefault:T((function(e){const t=e.get(j),{document:n,history:s}=t,r=new ue(t),o=e.get(Rt),i=e.get(wt),a=g(o.init());a.read((e=>e.apply()));let c=Promise.resolve();r.on("popstate")((e=>{const t=o.popState(e,a);t&&r.dispatch(new Ct("wesib:enterPage",{when:null!=e.state?"return":"enter",to:t.page}))})),r.on("hashchange")((()=>{const e=o.hashChange(a);e&&r.dispatch(new Ct("wesib:enterPage",{when:"enter",to:e.page}))}));return new class extends Et{constructor(){super(),this.onEnter=r.on("wesib:enterPage"),this.onLeave=r.on("wesib:leavePage"),this.onStay=r.on("wesib:stayOnPage"),this.on=O(L(this.onEnter),L(this.onLeave),L(this.onStay)),this.read=a.read.do(E((({page:e})=>e)))}get page(){return a.it.page}get length(){return s.length}go(e){s.go(e)}open(e){return d("pre-open","open",e)}replace(e){return d("pre-replace","replace",e)}update(e){return o.update(a,h(e)).page}with(e,t){return u((n=>n.put(e,t)))}};function u(e){return{with:(t,n)=>u(Pe(e,(e=>e.put(t,n)))),open:t=>d("pre-open","open",t,e),replace:t=>d("pre-replace","replace",t,e),pretend(t,n=((e,t)=>t)){let s;"function"==typeof t?(n=t,s=void 0):s=t;const r=l(s),o=a.it,i=p("pretend",o,r,e);try{return f("pretend",o,r,i)?n(o.page,i.page):void 0}finally{i.stay(a.it.page)}}}}function h(e){return"string"==typeof e?new URL(e,n.baseURI):e||a.it.page.url}function l(e){return null==e||"string"==typeof e||e instanceof URL?{url:h(e)}:e.url instanceof URL?e:{...e,url:h(e.url)}}function d(e,t,n,s=Ue){const i=l(n),u=c=c.then(h,h);return u;function h(){let n;try{const h=function(){if(c!==u)return d();const t=a.it,n=p(e,t,i,s),o=new Ut("wesib:leavePage",{when:e,from:t.page,to:n.page});if(!r.dispatch(o)||c!==u||!f(e,t,i,n))return d(n);return n}();return h?(n=h,o[t](n,a),r.dispatch(new Ct("wesib:enterPage",{when:t,to:n.page})),n.page):h}catch(e){throw d(n,e),e}}function d(e,t){return e&&e.stay(a.it.page),r.dispatch(new Lt("wesib:stayOnPage",{from:a.it.page,to:i,reason:t})),null}}function p(e,t,n,s){const r=o.newEntry(n);try{t.transfer(r,e),s(r.page)}catch(e){throw r.stay(a.it.page),e}return r}function f(e,t,n,s){let r=!1;return i((({url:e,data:t,title:s})=>{r=!0,n.url=e,n.data=t,n.title=s}),e,t.page,s.page),r}}))});class Et{static get[te](){return Dt}[c](){return this.on}[u](){return this.read}back(){this.go(-1)}forward(){this.go(1)}reload(){this.go()}}function At(e={}){const{select:t="a",pick:n={all:!0,deep:!0}}=e;return I({define(s){s.whenComponent((s=>{const r=function(e,t){const n=e.get(F),{render:s,active:r=It}=t,o=Re.name(r,e.get(H)),i=t.activate?t.activate.bind(t):Ue,a=(e,{node:t})=>{const{element:n}=t,{classList:s}=n;e?s.add(o):s.remove(o)};return e=>{const{element:t}=e.node,r=t[qt]||(t[qt]=n(s)),o=t=>{r((()=>a(t,e))),i(t,e)};let c;return o(!0),{supply(){const e=c=new Ce((()=>{c===e&&o(!1)}));return e}}}}(s,e),o=function(e){if(!e.weigh)return Nt;return t=>{const n=e.weigh(t);if("number"==typeof n)return d(t.node,n);let s=n[u]().do(p(((e,n)=>e(t.node,n))));return f((e=>{s({supply:(new Ce).needs(e.supply).whenOff((()=>{s=d(t.node,0),s(e)})),receive:e.receive})}))}}(e),c=s.get(Et),g=s.get(it);s.whenConnected((()=>{let e=new Map;c.read.do(i(s),a((i=>g.select(t,n).read.do(h((e=>l(...le(e,(e=>o({node:e,context:s,page:i})))))),a(((...t)=>{const n=function(e){let t=0,n=[];return e.forEach((([e,s])=>{s>t?(t=s,n=[e]):s===t&&n.push(e)})),n}(t),o=new Map,a=new Ce;return n.forEach((t=>{let n;const c=e.get(t);c?(o.set(t,c),n=c):(n=r({node:t,context:s,page:i}),o.set(t,n)),n.supply().needs(a)})),e=o,a}))))))}))}))}})}function Nt({node:e,page:t}){const{element:n}=e,s=n.getAttribute("href");if(null==s)return d(e,-1);const r=new URL(s,n.ownerDocument.baseURI);return d(e,Pt(r,t.url))}function Pt(e,t){if(e.origin!==t.origin)return-1;const n=Ot(e),s=Ot(t);if(e.hash){if(n!==s)return-1;const r=Mt(e,t);return r<0||Mt(t,e)<0?-1:e.pathname.length+r+Pt(at(e),at(t))}const r=Mt(e,t);return r?r<0||n!==s?-1:e.pathname.length+r:s.startsWith(n)?e.pathname.length:-1}function Ot(e){const t=e.pathname;return t.endsWith("/")?t:t+"/"}function Mt({searchParams:e},{searchParams:t}){let n=0;return e.forEach(((e,s)=>{(function(e){return e.startsWith("__")&&e.endsWith("__")})(s)||n>=0&&(t.getAll(s).includes(e)?n+=1:n=-1)})),n}const qt=Symbol("nav-link-render-schedule"),It=["active",G];function jt(e={}){const t=e.handle?e.handle.bind(e):function(e){const t=e.href?e.href.bind(e):Ft;return({event:e,page:n,navigation:s})=>{const r=t(e);if(null==r)return;const o=e.target,i=n.url,a=new URL(r,o.ownerDocument.baseURI);a.origin===i.origin&&(e.preventDefault(),i.href!==a.href&&s.open(r).catch(console.error))}}(e),n=Le(e.event||"click");return I({define(e){e.whenComponent((e=>{e.whenConnected((()=>{const s=e.get(Et);for(const r of n)e.on(r)((n=>{s.read.do(o)((r=>t({event:n,page:r,context:e,navigation:s})))}))}))}))}})}function Ft(e){return e.target.getAttribute("href")}function zt(e,t,n,s=Kt){let r;"function"==typeof n?(s=n,r=null):r=n||null;const o=t.ownerDocument;if(Q(e)){const n=o.createElement(e.tagName.toLowerCase());return e.getAttributeNames().forEach((t=>n.setAttribute(t,e.getAttribute(t)))),s(e,n),t.insertBefore(n,r),n}const i=o.importNode(e,!1);return t.insertBefore(i,r),i}function Kt(e,t){de(pe(e.childNodes),(e=>zt(e,t)))}function Bt(e){let t;return n=>{const s=function(e){return new URL("",e.url).href}(n);if(t){if(t.url===s)return t.on;t.sup.off()}let r;const o=new Ce((()=>{t=void 0,r=void 0})),i=_((t=>{if(!r){const t=e(n),s=g(),i=t((e=>{s.it=e})).whenOff((e=>{null!=e&&o.off(e)}));o.cuts(i).cuts(s),r={on:s.read.do(y(Ee)),num:0}}const s=r;return++s.num,s.on.do(v(o))(t).whenOff((e=>{--s.num||Promise.resolve().then((()=>{s.num||s!==r||o.off(e)})).catch(console.error)}))}));return t={url:s,on:i,sup:o},i}}class Ht extends Error{}const Vt=new class extends ht{create(e,t){return{get:()=>t,put:Ue}}};class Wt{constructor(e,t){this._navigation=e,this._loader=t,this._map=new Map,this._requests=me(xe((()=>this._map.values())))}get fragments(){const e=[];return we(this._requests,(t=>!!t.fragment&&(e.push(t.fragment),!0)))?e:[]}handle(){const e=this,t=new Ce;let n=Ne();return{get(){},put(t){e._add(t)},transfer(t,n){if("pretend"===n)return;const s=e._transfer();return t.put(Vt,s),s.handle()},enter(s,r){if("init"===r)return;n=(new Ce).needs(t);const o=_((t=>{const r=new b,o=r.on(t);return e._loader(s).do(v(n))((e=>r.send(e))).whenOff((e=>{void 0===e||e instanceof Ht||r.send({ok:!1,page:s,error:e})})),o})).do(x);de(e._requests,(({fragment:e,receiver:t})=>function(e,t){return t?e.do(S((e=>e.ok?{...e,fragment:(null!=t.tag?e.document.getElementsByTagName(t.tag)[0]:e.document.getElementById(t.id))||void 0}:e))):e}(o,e)({supply:(new Ce).needs(t.supply),receive(e,n){t.receive(e,n)}})))},leave(){n.off(new Ht("page left"))},stay(){t.off(new Ht("navigation cancelled"))},forget(){t.off(new Ht("page forgotten"))}}}_add(e){const t={...e,receiver:R(e.receiver)},{supply:n}=t.receiver,s=this._map.get(n);s?s.push(t):(this._map.set(n,[t]),n.whenOff((()=>this._map.delete(n))))}_transfer(){const e=new Wt(this._navigation,this._loader);for(const[t,n]of this._map.entries())e._map.set(t,n.slice());return e}}const Tt=new qe("page-load-agent"),Gt=new re("page-load-url",{byDefault:De(Ue)}),Jt=new ne("page-loader",{byDefault:T((function(e){const t=e.get(j),n=e.get(ze),s=e.get(Gt),r=e.get(Tt),o=new t.DOMParser;return e=>{const t=new URL(e.url.href);s(t);const i=new Request(t.href,{mode:"same-origin",credentials:"same-origin",headers:new Headers({Accept:"text/html"})});return _((e=>r(a,i)(e)));function a(s){return function(e,t){var n;const s=null===(n=e.get(Vt))||void 0===n?void 0:n.fragments;s&&s.length&&t.headers.set("Accept-Fragment",s.reduce(((e,t)=>(e?e+", ":"")+(null!=t.tag?"tag="+Oe(t.tag):"id="+Oe(t.id))),""))}(e,s),_((r=>{const i=new k;i.on(r),i.send({page:e}),n(s).do(S((e=>Promise.all([e,e.text()]))),C,U(((...e)=>d(...e))),S((([n,s])=>{if(!n.ok)return{ok:!1,page:e,response:n,error:n.status};try{return{ok:!0,page:e,response:n,document:$t(o,t,n,s)}}catch(t){return{ok:!1,page:e,response:n,error:t}}})))(r)}))}}}))});function $t(e,t,n,s){const r=e.parseFromString(s,Me(n.headers.get("Content-Type")||"text/html")[0].v);if(r.head){const e=r.head.querySelector("base");if(e)e.href=new URL(e.getAttribute("href"),t).href;else{const e=r.createElement("base");e.href=t.href,r.head.appendChild(e)}}return r}class Qt extends ht{create(e,t,n){const s=new Wt(n.get(Et),Bt(n.get(Jt))),r=s.handle();return e.put(Vt,s),r.put(t),r}}const Xt=new Qt,Yt=new ne("page-cache-buster",{byDefault:T((e=>new Zt(e)))});class Zt{constructor(e){const t=en(e.get(j).document);if(t){const n=e.get(Et);this.urlModifier=d((e=>e.searchParams.set("__wesib_app_rev__",t))),this.agent=d(((e,s)=>e(new Request(s.url,s)).do(S((e=>{if(e.ok){const s=en(e.document);if(s&&s!==t){const t=new URL(e.page.url.href);t.searchParams.set("__wesib_app_rev__",s),n.update(t),n.reload()}}return e})))))}else this.urlModifier=d(),this.agent=d()}static get[te](){return Yt}}function en(e){var t;return null===(t=e.querySelector("meta[name=wesib-app-rev]"))||void 0===t?void 0:t.getAttribute("content")}function tn(e){const t=e.get(j).document;return e=>e().do(S((e=>{if(e.ok){const n=new Set(le(nn(t,t.scripts),(([e])=>e)));de(_e(nn(e.document,e.document.querySelectorAll("script")),(([e])=>!n.has(e))),(([e,s])=>{zt(s,t.head,((t,n)=>n.src=e)),n.add(e)}))}return e})))}function nn(e,t){return le(ge(t,(({src:e})=>!!e)),(t=>[new URL(t.src,e.baseURI).href,t]))}function sn(e){const t=e.get(j).document;return e=>e().do(S((e=>{if(!e.ok)return e;const n=e.document.querySelectorAll("link[rel=stylesheet]");if(!n.length)return e;let s=t.head,r=null;const o=t.querySelectorAll("link[rel=stylesheet]"),i=new Map,a=o.item(0);return a&&(s=a.parentNode,r=a,de(pe(o),(e=>i.set(new URL(e.href,t.baseURI).href,e)))),de(pe(n),(e=>{const n=new URL(e.href,t.baseURI).href,o=i.get(n);o?(ye(i.keys())===n?(s=o.parentNode,r=o.nextSibling):s.insertBefore(o,r),i.delete(n)):zt(e,s,r,((e,t)=>t.href=n))})),de(i.values(),(e=>e.parentNode.removeChild(e))),e})))}function rn(e){const t=e.get(j).document;return e=>e().do(S((e=>{if(e.ok){const n=e.document.getElementsByTagName("title").item(0);n&&n.textContent&&(t.title=n.textContent)}return e})))}const on={setup(e){e.provide({a:Gt,by:e=>e.urlModifier,with:[Zt]}),e.provide({a:Tt,by:e=>e.agent,with:[Zt]}),e.provide({a:Tt,by:tn}),e.provide({a:Tt,by:sn}),e.provide({a:Tt,by:rn})}};class an{static get[B](){return on}}function cn(e={}){const t=e.onResponse?e.onResponse.bind(e):Ue,n=e.contentKey?e.contentKey.bind(e):un;return I({feature:{needs:[an]},define(s){s.whenComponent((s=>{const{fragment:r,render:i}=e,a=s.get(j).document,c=s.get(F)(i),u=s.get(Et);let h,l=n(u.page);h=r?De(r):()=>{const{element:{id:e,tagName:t}}=s;return e?{id:e}:{tag:t}},s.whenConnected((()=>{const e=a.createRange();e.selectNodeContents(s.contentRoot),u.read.do(o)((r=>{r.put(Xt,{fragment:h(),receiver:{supply:(new Ce).needs(s),receive:(r,o)=>function(r){const o=n(r.page);if(o===l)return;if(!r.ok)return void c((()=>t({context:s,range:e,response:r})));l=o,c((()=>{e.deleteContents();const n=a.createDocumentFragment(),{fragment:o}=r;o&&(Kt(o,n),e.insertNode(n)),t({context:s,range:e,response:r})}))}(o)}})}))}))}))}})}function un({url:e}){return new URL("",e).href}class hn extends oe{get upKey(){return this}constructor(){super("default-in-aspects")}grow(e){const r=e.context.get(H),o=e.context.get(F);e.insert(e.seed.do(E(((...e)=>t(...e,n.to(o),s.to(r)))),i(e.context.get(ce))))}}const ln=new hn,dn=new ae("input-from-control",{byDefault:()=>({})});function pn(e,t){return e.get(Te).provide({a:dn,by:()=>({root:e,control:t})}).needs(e).needs(t)}function fn(e){return I({define(t){t.whenComponent((t=>{const{up:n}=t.get(Te);M({parent:n.do(h((e=>e?e.get(dn):d({})))),aspects:t.get(ln)}).do(h((({parent:[n],aspects:[s]})=>{if(n.control){const o=e({control:n,context:t,aspects:s});if(o)return o instanceof r?d(o):o}return d()})),a(((e,n)=>{if(!e)return;const s=pn(t,e);return(n||e.supply).needs(s),s})))}))}})}const gn=new ae("input-to-form",{byDefault:()=>({})});function mn(e){const{select:t="form",pick:n={deep:!0,all:!0}}=e;return I({define(s){s.whenComponent((s=>{const r=s.get(it);s.whenConnected((()=>{M({node:r.select(t,n).first,aspects:s.get(ln)}).do(w((({node:[t],aspects:[n]})=>{if(!t)return d();const r=e.makeForm({node:t,context:s,aspects:n});return r?Array.isArray(r)?d(...r):r:d()})),a(((e,t,n)=>{if(!e)return;const r=function(e,t,n){const s=e.get(Te),r=s.provide({a:gn,by:()=>({root:e,control:t,form:n})});return s.provide({a:dn,via:gn}).needs(r),r.needs(e).needs(t).needs(n)}(s,e,t);return n?n.needs(r):r.cuts(t).cuts(e),r})))}))}))}})}function wn(e={}){const{cancel:t=!0}=e;return Z((({get:e})=>({componentDef:{define(n){n.whenComponent((n=>{n.whenConnected((()=>{const s=n.get(Te),{component:r}=n;s.get(gn).do(a((s=>{if(!s.control)return;const o=new ue(s.form.element);o.supply.needs(n);const i=o.on("submit");return(t?i.do(he(!1)):i)((t=>e(r).call(r,s,t)))})))}))}))}}})))}function _n(t){const n="string"==typeof t?De(d(t)):e=>{const n=t(e);return"string"==typeof n?d(n):n};return I({define(t){t.whenComponent((t=>{const s=t.get(Te);M({group:s.up.do(h((e=>e?e.get(dn):d({}))),q((({control:t})=>t&&t.aspect(e)))),control:s.get(dn),name:n(t)}).do(a((({group:[e],control:[{control:t}],name:[n]})=>{if(null!=n&&e&&t&&e!==t)return e.controls.set(n,t)})))}))}})}function yn(e){const{select:t="input",pick:n={deep:!0,all:!0}}=e;return I({define(s){s.whenComponent((s=>{const o=s.get(it);s.whenConnected((()=>{M({node:o.select(t,n).first,aspects:s.get(ln)}).do(w((({node:[t],aspects:[n]})=>{if(!t)return d();const o=e.makeControl({node:t,context:s,aspects:n});return o?o instanceof r?d(o):o:d()})),a(((e,t)=>{if(!e)return;const n=pn(s,e);return(t||e.supply).needs(n),n})))}))}))}})}export{At as A,fn as C,ln as D,mn as F,ze as H,dn as I,Et as N,wn as O,ft as P,_n as S,yn as U,Te as a,it as b,gn as c,jt as d,cn as e,ht as f,yt as g,pn as i};//# sourceMappingURL=generic.2dcf3479.js.map
