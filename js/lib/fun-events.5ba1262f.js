import{n as t,i as e,N as s,f as n,b as r}from"./call-thru.00f7427a.js";const i=Symbol("after-event");function o(t){return i in t}const c=Symbol("events-supply");class u{get[c](){return this}needs(t){return h(t).whenOff(t=>this.off(t)),this}}function h(t){return t[c]}function f(e=t){let s,n=r=>{s=t=>t(r),n=t,e(r)};s=t=>{const e=n;n=s=>{e(s),t(s)}};return new class extends u{get isOff(){return n===t}off(t){return n(t),this}whenOff(t){return s(t),this}}}class p extends u{get isOff(){return!0}off(){return this}whenOff(t){return t(),this}}const a=new p;function l(){return a}function y(e){let s;return s="function"==typeof e?{supply:f(),receive(t,...s){e(...s)}}:{supply:e.supply||f(),receive(t,...s){this.supply.isOff||e.receive(t,...s)}},s.supply.whenOff(()=>s.receive=t),s}const d=Symbol("on-event");class _{constructor(){this._rcvs=new Set,this.send=function(t){let e=function s(n){let r=t;const i=[];e=t=>i.push(t);try{for(;;){r=v(r,n);const t=i.shift();if(!t)break;n=t}}finally{e=s}};return(...t)=>e(t)}(this._rcvs),this[c]=f(t=>{this._rcvs.forEach(({supply:e})=>e.off(t))})}get size(){return this._rcvs.size}[d](t){return this.on(t)}on(t){const e=y(t);return this._rcvs.add(e),e.supply.needs(this).whenOff(()=>this._rcvs.delete(e))}done(t){return h(this).off(t),this}}function v(t,e){const s=[];for(const n of t){const t=s.length;s.push(n);const r={onRecurrent(e){s[t]=y({supply:n.supply,receive(t,...s){e(...s)}})}};n.receive(r,...e)}return s}function g(t){return e=>t({supply:e.supply,receive:(t,...s)=>{e.receive(t,...s),e.supply.off()}})}function O(t){const e=new _;let s,n;return r=>{if(e.size||(n=[],s=f(()=>n=void 0),t({supply:s,receive(t,...s){n&&(e.size?n=void 0:n.push(s)),e.send(...s)}})),r.supply.needs(s),e.on(r).whenOff(t=>{e.size||s.off(t)}),n){const t=new _;t.on(r),n.forEach(e=>t.send(...e))}}}function w(t,e,s){const n=h(e);return e=>{if(s){const r=f().needs(n);s.needs(r),t({supply:r,receive:e.receive.bind(e)})}else e.supply.needs(n),t(e)}}class b extends Function{get[d](){return this}get once(){return m(g(this))}tillOff(t,e){return m(w(this,t,e))}consume(t){let e=l();const s=this((...s)=>{const n=e;try{e=h(t(...s)||l())}finally{e!==n&&n.off()}});return f(t=>{e.off(t),s.off(t)}).needs(s)}share(){return m(O(this))}thru(...t){return m(O(this.thru_(...t)))}thru_(...n){return function(n,r,i,o){return r(r=>{const c=[];n({supply:r.supply,receive(n,...u){const h=(u,p)=>{const a=u>=o.length;++u;const y=c[u];if(y){const t=y.supply;return y.supply=p,[y.chain,t]}const d=u<o.length?o[u]:t,_={chain:{call(t,e){v(t(...e),e)},pass(t,e){v(t(e),[e])},skip(){_.supply.off()},onEvent(t,e){const s=f().needs(_.supply);i(e)({supply:s,receive(e,...n){v(t(...n),n,s)}})}},supply:p};return c[u]=_,[_.chain,l()];function v(t,i,o=_.supply){const[c,p]=h(u,f().needs(o));try{e(t)?t[s](c,d):a?r.receive(n,...i):c.pass(d,t)}finally{p.off()}}},[p,a]=h(0,f().needs(r.supply));try{p.call(o[0],u)}finally{a.off()}}})})}(this,m,k,n)}}function m(t){const e=e=>{const s=y(e),{supply:n}=s;return n.isOff||t(s),n};return Object.setPrototypeOf(e,b.prototype),e}function k(t){const e=d in t?t[d]:t[i];return e instanceof b?e:m(e.bind(t))}const E=m(({supply:t})=>t.off());class j{constructor(t){this._keeper=t}thru(...t){return this.thru_(...t).share()}thru_(...t){return P(this._keeper.thru_(...t))}}class x extends b{get[i](){return this}get keep(){return new j(this)}get once(){return z(g(this))}tillOff(t,e){return z(w(this,t,e))}share(){return z(O(this))}}function z(e,s=U){let n,r=0;const i=i=>{let o=t;const c=y(i);if(c.supply.isOff)return c.supply;const u=f().needs(c.supply);let h=!1;return e({supply:u,receive(t,...e){h=!0,n=e,o(t,...e)}}),++r,u.isOff&&!h||(c.receive({onRecurrent(t){o=(e,...s)=>t(...s)}},...n||(n=s())),o=(t,...e)=>c.receive(t,...e)),u.whenOff(t=>{--r||(n=void 0),c.supply.off(t)}),u};return Object.setPrototypeOf(i,x.prototype),i}function P(t,e){if(!o(t))return R(t,e);const s=t[i];return s instanceof x?s:z(s.bind(t))}function R(t,e){return z(e=>t[d](e),e)}function S(...t){return z(()=>f(),r(t))}function U(){throw new Error("No events to send")}function I(e){const s=Object.keys(e);return z((function(n){const r=new _,o=r.on(n);let c=t;const u={};s.forEach(t=>{o.needs(e[t][i]((...e)=>{u[t]=e,c()}).needs(o))}),o.isOff||(c=()=>r.send(u))}),(function(){const t={};return s.forEach(s=>P(e[s]).once((...e)=>t[s]=e)),[t]})).share()}function N(...e){return z((function(s){const n=new _,r=n.on(s);let o=t;const c=[];e.forEach((t,e)=>{r.needs(t[i]((...t)=>{c[e]=t,o()}).needs(r))}),r.isOff||(o=()=>n.send(...c))}),(function(){const t=[];return e.forEach(e=>P(e).once((...e)=>t.push(e))),t})).share()}function A(t){return n((e,s)=>e.onEvent(s,P(t)))}function D(t){return n((e,s)=>e.onEvent(s,t))}var L,q;class F extends _{constructor(){super(...arguments),this.on=m(t=>super.on(t)),this[L]=this.on}}function M(...t){return t.length?m(e=>{const{supply:s}=e;let n=t.length;const r=t=>{--n||s.off(t)},i=(t,...s)=>{e.receive(t,...s)};t.forEach(t=>k(t)({supply:f(r).needs(s),receive:i}))}).share():E}function V(t){return m(e=>{const{supply:s}=e,n=new _;n.on(e);const r=f();let i=0;const o=k(t).tillOff(s,r).thru_(t=>(++i,t));let c=[],u=1,h=0;r.whenOff(t=>{i||e.supply.off(t)}),function(t){return m(e=>{const{supply:s}=e,n=new _;n.on(e);let r=0;t[d]({supply:s,receive(t,e){const i=++r;Promise.resolve().then(()=>e).then(t=>n.send(t,i),t=>s.off(t))}})})}(o)({supply:s,receive(t,s,o){const f=o-u;if(c[f]=s,++h,h>f){let t;h===c.length?(t=c,c=[]):t=c.splice(0,f+1),u+=t.length,h-=t.length,i-=t.length,n.send(...t),!i&&r.isOff&&e.supply.needs(r)}}})})}function B(t){return Array.isArray(t)?t:[t]}L=d;class C{constructor(t){this._drop=t,this.emitter=new F,this._nested=new Map,this.emitter.on((t,e,s)=>{const n=(t=B(t))[0],r=this._nested.get(n);r&&r.emitter.send(t.slice(1),e,s)})}on(t){const e=this.emitter.on(t);return f(t=>{e.off(t),this._dropIfEmpty()}).needs(e)}nest(t,e){const s=this._nested.get(t);if(s||e)return s;const n=new C(()=>this._remove(t));return this._nested.set(t,n),n}done(t){for(const e of this._nested.values())e.done(t);this.emitter.done(t)}_remove(t){this._nested.delete(t),this._dropIfEmpty()}_dropIfEmpty(){!this._nested.size&&this.emitter.size<=1&&this._drop()}}class G{constructor(){this._root=new C(t)}on(t,e){return this._entry(t).on(e)}send(t,e,s){this._root.emitter.send(t,e,s)}done(t,e){const s=this._entry(t,!0);s&&s.done(e)}_entry(t,e){let s=this._root;for(const n of t){const t=s.nest(n,e);if(!t)return;s=t}return s}}class H{constructor(t,e){this._trackers=t,this._path=e,this.update=(t,e,s)=>{this._trackers.send([...this._path,...B(t)],e,s)},this.onUpdate=m(t=>this._trackers.on(this._path,t))}get _tracker(){return this}get[d](){return this.onUpdate}track(t){return(t=B(t)).length?new H(this._trackers,[...this._path,...t]):this}done(t){this._trackers.done(this._path,t)}}class J{constructor(){this._tracker=new H(new G,[])}get onUpdate(){return this._tracker.onUpdate}get[d](){return this.onUpdate}get update(){return this._tracker.update}track(t){const e=this._tracker.track(t);return e===this._tracker?this:e}done(t){this._tracker.done(t)}}class K{constructor(){this._by=l(),this.read=z(t=>{return this.on({supply:(e=t).supply,receive(t,s){e.receive({onRecurrent(e){t.onRecurrent(t=>e(t))}},s)}});var e},()=>[this.it])}get[d](){return this.on}get[i](){return this.read}by(t,e){const s=t=>(o(t)?t[i]:t[d])(t=>this.it=t);if(this.byNone(),e){const n=t;this._by=k(n).consume((...t)=>{const n=e(...t);if(n)return s(n)})}else{const e=t;this._by=s(e)}return this._by.whenOff(()=>this._by=l()),this}byNone(t){return this._by.off(t),this}done(t){return h(this).off(t),this}}class Q extends K{constructor(t){super(),this._it=t,this._on=new F}get on(){return this._on.on}get[c](){return h(this._on)}get it(){return this._it}set it(t){const e=this._it;e!==t&&(this._it=t,this._on.send(t,e))}}function T(t){return new Q(t)}function W(t,e){return T().by(t,e)}class X extends b{get once(){return Y(g(this))}tillOff(t,e){return Y(w(this,t,e))}get capture(){return Y((t,e)=>null==e?this(t,!0):"object"==typeof e&&null==e.capture?this(t,Object.assign(Object.assign({},e),{capture:!0})):this(t,e))}get instead(){return Y((t,e)=>{const s=y(t);return this({supply:s.supply,receive(t,e){e.preventDefault(),s.receive(t,e)}},e)})}get just(){return Y((t,e)=>{const s=y(t);return this({supply:s.supply,receive(t,e){e.stopPropagation(),s.receive(t,e)}},e)})}get last(){return Y((t,e)=>{const s=y(t);return this({supply:s.supply,receive(t,e){e.stopImmediatePropagation(),s.receive(t,e)}},e)})}get passive(){return Y((t,e)=>null==e?this(t,{passive:!0}):"boolean"==typeof e?this(t,{capture:e,passive:!0}):null==e.passive?this(t,Object.assign(Object.assign({},e),{passive:!0})):this(t,e))}}function Y(t){const e=(e,s)=>{const n=y(e);return t(n,s),n.supply};return Object.setPrototypeOf(e,X.prototype),e}const Z={onRecurrent:t};class ${constructor(t){this[q]=f(),this._target=t}on(t){return Y((e,s)=>{const{supply:n}=e;if(n.needs(h(this)),!n.isOff){const n=t=>e.receive(Z,t);this._target.addEventListener(t,n,s),e.supply.whenOff(()=>this._target.removeEventListener(t,n))}})}dispatch(t){return!h(this).isOff&&this._target.dispatchEvent(t)}done(t){return h(this).off(t),this}}q=c;export{i as A,$ as D,c as E,d as O,J as S,K as V,S as a,z as b,N as c,P as d,I as e,f,h as g,F as h,o as i,M as j,W as k,D as l,V as m,A as n,m as o,y as p,_ as q,k as r,l as s,T as t,R as u};//# sourceMappingURL=fun-events.5ba1262f.js.map
