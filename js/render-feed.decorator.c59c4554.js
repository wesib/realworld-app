import{n as e}from"./proc7ts/primitives.e781e476.js";import{S as t,C as s,a as r}from"./proc7ts/context-values.69c73302.js";import{s as n,j as a,t as i,m as o,d as c}from"./proc7ts/fun-events.f7c44dc9.js";import{n as l,b as d}from"./core/auth.e0c9460a.js";import{S as p,D as u,C as f,B as h,u as m,R as g,d as b,f as C,g as _,e as v,h as x}from"./wesib/wesib.acbfb4f5.js";import{_ as w}from"./helpers.e1623395.js";import{f as y,P as E,d as j,a as q,N as P}from"./wesib/generic.5b4ac940.js";import{C as D}from"./core.c152f8fe.js";import{R,b as A,a as I}from"./core/loader.57d9ca02.js";import{f as N,n as S,F,a as M,b as k}from"./core/feed.9db6d3c0.js";import{A as T}from"./article-buttons-support.feature.dff83677.js";import{a as B,C as O}from"./current-article.2a3b7c3c.js";import{r as U}from"./core/util.db2cfcdd.js";const $=new class extends y{create(e,t){const s=this.byDefault(e);return s.put(t),s}byDefault(e){return{get(){const{searchParams:t,pathname:s}=e.get(E);return{feed:"/personal-feed"===s?s:void 0,tag:t.get("tag")||void 0,limit:parseInt(t.get("limit")||"",10)||void 0,offset:parseInt(t.get("offset")||"",10)||void 0}},put(t){const{feed:s}=t,r=new URL(e.get(E).href);r.pathname="/personal-feed"===s?s:"";const n=N(t).toString();r.search=n?"?"+n:"",e.put(E,r)}}}};let H=class{constructor(e){this._context=e,this._article=new B,this.user=l;const t=e.get(d),s=e.get(q);t.user.do(n(e))((e=>this.user=e)).whenOff((()=>this.user=l)),s.provide({a:O,is:this._article})}get article(){return this._article.it}set article(e){this._article.set(e)}postMeta(){if(!this.article.slug)return;const{author:e}=this.article,{document:t}=this._context.get(h),s=t.createDocumentFragment(),r=s.appendChild(t.createElement("div"));r.className="post-meta";const n=r.appendChild(t.createElement("conduit-article-author"));if(U(n,this._context),this.user.username===e.username){const e=r.appendChild(t.createElement("conduit-edit-post-btn"));e.tabIndex=0,U(e,this._context);const s=r.appendChild(t.createElement("conduit-delete-post-btn"));s.tabIndex=0,U(s,this._context)}else{const e=r.appendChild(t.createElement("conduit-favorite-post-btn"));e.tabIndex=0,U(e,this._context)}const a=s.appendChild(t.createElement("a"));a.className="preview-link",a.setAttribute("href",`article/#/${encodeURIComponent(this.article.slug)}`);a.appendChild(t.createElement("h1")).innerText=this.article.title;a.appendChild(t.createElement("p")).innerText=this.article.description;a.appendChild(t.createElement("span")).innerText="Read more...";const i=a.appendChild(t.createElement("conduit-article-tags"));return U(i,this._context),s}};w([p()],H.prototype,"user",void 0),w([u({propertyKey:"feedArticle"})],H.prototype,"article",null),w([R()],H.prototype,"postMeta",null),H=w([f(["article-preview",D],{feature:{needs:[T]}},j({href(e){let t=e.target;for(;;){const e=t.getAttribute("href");if(null!=e)return e;const{parentNode:s}=t;if(!s||!m(s))return;t=s}}}))],H);const K=new t("feed-article-list",{byDefault:()=>S});let L=class{constructor(e){this._context=e,this.articles=S;e.get(q).get(K)((e=>this.articles=e)).whenOff((()=>this.articles=S))}render(){const e=this._context.get(h).document,t=e.createRange();return t.selectNodeContents(this._context.contentRoot),()=>{if(t.deleteContents(),!this.articles.articlesCount)return;const s=e.createDocumentFragment();this.articles.articles.forEach((t=>{const r=s.appendChild(e.createElement("conduit-article-preview"));r.feedArticle=t,U(r,this._context)})),t.insertNode(s)}}};w([p()],L.prototype,"articles",void 0),w([g()],L.prototype,"render",null),L=w([f(["article-list",D],{feature:{needs:H}})],L);const z=new t("feed-request-page-param",{byDefault:()=>$});let G=class{constructor(e){this._feedPaging={};const t=e.get(q),s=e.get(P);e.whenConnected((()=>{a({param:t.get(z),page:s,list:t.get(K)}).do(n(e))((({param:[e],page:[t],list:[{articlesCount:r}]})=>{const n=t.get(e),{limit:a=20,offset:i=0}=n;this.feedPaging={totalPages:Math.ceil(r/a),currentPage:Math.floor(i/a),pageHref(t){var r;return(null===(r=s.with(e,{...n,offset:a*t}).pretend())||void 0===r?void 0:r.url.href)||""}}}))}))}get feedPaging(){return this._feedPaging}set feedPaging(e){this._feedPaging=e}};w([A()],G.prototype,"feedPaging",null),G=w([f(["feed-pager",D])],G);const J=new r("render-feed-state"),Q=Symbol("render-feed-state");class V{constructor(e,t){this.response=i(),this._request=i({}),e.supply.cuts(this._request);const s=e.get(M);this.response.on(((s,r)=>e.updateState(t,s,r))),e.get(q).provide({a:K,is:this.response.read.do(o((e=>(null==e?void 0:e.ok)?e.body:{articles:[],articlesCount:0})))}),this._request.read.do(c((e=>(this.response.it=void 0,s.articles(e)))))((e=>this.response.it=e)),e.on("conduit:article")((()=>this._request.it={...this._request.it}))}static get[s](){return J}get request(){return this._request.it}set request(e){const t=this.request;k(e,t)||(this._request.it=e)}}function W(t={}){const{requestParam:s,render:r}=t;return b((({get:t,set:n,key:a})=>{const i=[x,Q,a],o=C.fulfill({on:i},r);return{componentDef:_.all({feature:{needs:[L,G,F]},define(e){e.perComponent({a:V,by:e=>new V(e,i)}),s&&e.whenComponent((e=>{e.get(q).provide({a:z,is:s})}))}},I({render:o,comment:`FEED(${String(a)})`}).By((function(e){return v.of(e).get(V).response.it}),a),g(o).As((function(){const t=v.of(this),{contentRoot:s}=t,r=t.get(h).document;return s.appendChild(r.createElement("conduit-article-list")),s.appendChild(r.createElement("conduit-feed-pager")),e}),a)),get:t,set(e,t){n(e,t),v.of(e).get(V).request=t}}}))}export{$ as P,W as R};//# sourceMappingURL=render-feed.decorator.c59c4554.js.map
