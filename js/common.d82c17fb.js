import{S as e,a as t,a0 as s,F as n,g as a,a4 as r,R as o,a5 as i,t as u,d as c,a6 as h,w as p,a7 as l,a8 as d,f,a9 as g,aa as m,h as b,ab as _,N as w,I as k,ac as y,ad as v,J as O}from"./lib.66b09466.js";import{b as j,H as x,B as R,F as T,C as q,a as N,A,c as S,d as $,I as C,e as I,f as L,R as D,D as F,g as P}from"./wesib.867fc5e7.js";const J=new e("auth-service");class U{static get[t](){return J}}const z=new s("api-root-url",{byDefault:()=>new URL("https://conduit.productionready.io/api/")}),E=new n("api-fetch",{byDefault:j((function(e){const t=e.get(x),s=e.get(z);return({path:n,init:i,auth:u})=>{const c=s.thru_(e=>new URL(n,e),e=>function(e,t={}){const s=new Request(e.href,Object.assign({mode:"cors"},t)),{headers:n}=s;return n.set("X-Requested-With","XMLHttpRequest"),s}(e,i)).thru_(t=>!1===u?a({request:t}):r(function(e,t,s){return e.get(J).user.keep.thru_((e,n)=>e?(t.headers.set("Authorization",`Token ${e.token}`),{request:t}):s?(n||(n={ok:!1,errors:{api:["Not authenticated"]}}),{failure:n}):{request:t})}(e,t,u)),e=>e.request?r(t(e.request).thru_(e=>({response:e}))):a({failure:e.failure}));return o(c.thru_(H)).thru_(([e,t])=>function(e,t){if(!e.response)return e.failure;const{response:s}=e;if(s.ok)return{ok:!0,response:s,body:t};return{ok:!1,response:s,errors:t.errors||{http:[s.statusText?`${s.status}: ${s.statusText}`:`ERROR ${s.status}`]}}}(e,t))}}))});function H(e){return e.response?Promise.all([e,e.response.json()]).catch(t=>[{failure:{ok:!1,response:e.response,errors:{api:[`Failed to parse response: ${t}`]}}}]):[e]}new n("api-submitter",{byDefault:j((function(e){const t=e.get(E);return e=>{const{init:s={}}=e,{method:n="POST",headers:a={}}=s;return r=>{const o=Object.assign(Object.assign({},e),{init:Object.assign(Object.assign({},s),{method:n,body:JSON.stringify(r),headers:Object.assign(Object.assign({},a),{Accept:"application/json","Content-Type":"application/json"})})});return X(t(o))}}}))});function X(e){return new Promise((t,s)=>{e.once(e=>{e.ok?t(e.body):s(new i({submit:"api",api:e.errors}))}).whenOff(e=>{s(e instanceof i?e:new i({submit:"cancel",cancel:e}))})})}class B extends U{constructor(e){super(),this._context=e;const t=e.get(R).localStorage;this._auth=u(t.getItem("wesib-conduit:auth")),this._auth.on((function(e){e?t.setItem("wesib-conduit:auth","string"==typeof e?e:e.token):t.removeItem("wesib-conduit:auth")})),this.user=this._auth.read.keep.thru((function(t){if(!t)return a();if("string"==typeof t)return r(function(t){const s=e.get(E);return c(e=>{s({path:"user",init:{headers:{Authorization:`Token ${t}`}},auth:!1}).thru_(e=>e.ok?a(e.body):a(void 0,e))({supply:p().needs(e.supply),receive(t,...s){e.receive(t,...s)}})},h())}(t));return a(t)}))}login(e){return this._context.get(E)({path:"users/login",init:{method:"POST",body:JSON.stringify(e),headers:{Accept:"application/json","Content-Type":"application/json"}},auth:!1}).thru_(e=>(e.ok?this._auth.it=e.body:this._auth.it=null,e))}logout(){this._auth.it=null}}let M=class{};function W({mark:e="is-invalid",when:t}={}){return s=>{const n=s.aspect(d);return f({status:s.aspect(g),validity:s.aspect(m)}).keep.thru(({status:[{touched:s,hasFocus:r}],validity:[o]})=>{const i=o.has("incomplete")||o.has("missing");return!s||r&&i?a():b(n.specs(_({mark:e,when:t})))})}}M=l([T({setup(e){e.provide({a:U,as:B})}})],M);const G=new w("https://wesib.github.io/realworld-app/ns/","conduit");let K=class{};K=l([q(["in-error",G],A("code"),N(({control:{control:e},aspects:t,context:s})=>{const{element:n}=s;return k(s.get(S).track($("code")).onUpdate.thru_((e,t)=>t),()=>[n.getAttribute("code")]).keep.thru_(e=>e?e.trim().split(/\s+/):[]).keep.thru(n=>e.convert(y.to(s.element),t).setup(d,e=>{e.add(v()),e.add(W({when:n}))}))}))],K);let Q=class{};Q=l([T({needs:K})],Q);let V=class{};V=l([q(["main",G],C({onResponse({response:e,range:t}){e.ok||(t.deleteContents(),null==e.ok?t.insertNode(document.createTextNode("Loading...")):t.insertNode(document.createTextNode(`Error. ${e.error}`)))}}))],V);let Y=class{};Y=l([q(["navbar",G],L(),I({active:"active"}))],Y);const Z=["authenticated",G],ee=["not-authenticated",G];let te=class{constructor(e){this._context=e,e.whenOn(t=>{e.get(U).user.tillOff(t)((e,t)=>{this.user=e})})}get user(){return this._user}set user(e){const t=this._user;this._user=e,this._context.updateState("user",e,t)}render(){const e=this._context.get(F),t=O.name(Z,e),s=O.name(ee,e),{classList:n}=this._context.element;return()=>{this.user?(n.remove(s),n.add(t)):(n.remove(t),n.add(s))}}};l([D()],te.prototype,"render",null),te=l([q({name:["container",G],feature:{needs:[V,Y]}})],te);let se=class{};se=l([q(["footer",G],L())],se);let ne=class{};ne=l([T({needs:[te,se]})],ne);let ae=class{};ae=l([T({needs:[M,Q,ne]})],ae);const re=P(ae);export{U as A,G as C,X as a,W as b,re as c};//# sourceMappingURL=common.d82c17fb.js.map
