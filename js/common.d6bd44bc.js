import{S as e,a as t,R as s,F as n,e as o,o as r,X as a,t as i,d as c,Y as u,j as l,u as h,_ as p,Z as d,$ as f,G as g,f as m,a0 as _}from"./lib.39d76e81.js";import{b as w,H as k,B as y,F as b,R as v,C as x,N as R,p as O,i as L,a as N,D as T,c as q,P as C,d as $,I as j,e as I,f as S,g as U}from"./wesib.de17e122.js";const D=new e("auth-service");class E{static get[t](){return D}}const F=new s("api-root-url",{byDefault:()=>new URL("https://conduit.productionready.io/api/")}),A=new n("api-fetch",{byDefault:w((function(e){const t=e.get(k),s=e.get(F);return({path:n,init:r,auth:a})=>s.thru_(e=>new URL(n,e),e=>function(e,t={}){const s=new Request(e.href,Object.assign({mode:"cors"},t)),{headers:n}=s;n.set("X-Requested-With","XMLHttpRequest"),null==s.body||n.has("Content-Type")||n.set("Content-Type","application/json");return s}(e,r)).dig_(t=>!1===a?o({request:t}):function(e,t,s){return e.get(D).user.keep.thru_((e,n)=>e?(t.headers.set("Authorization",`Token ${e.token}`),{request:t}):s?(n||(n={ok:!1,errors:{api:["Not authenticated"]}}),{failure:n}):{request:t})}(e,t,a)).dig_(e=>e.request?t(e.request).thru_(e=>({response:e})):o({failure:e.failure})).dig_(W)}))});function W(e){return r(t=>{const s=new a;if(s.on(t),e.response){const{response:t}=e;t.json().then(e=>{t.ok?s.send({ok:!0,response:t,body:e}):s.send({ok:!1,response:t,errors:e.errors||{http:[t.statusText?`${t.status}: ${t.statusText}`:`ERROR ${t.status}`]}})}).catch(e=>{s.send({ok:!1,response:t,errors:{api:[`Failed to parse response: ${e}`]}})})}else s.send(e.failure);s.done()})}class X extends E{constructor(e){super(),this._context=e;const t=e.get(y).localStorage;this._auth=i(t.getItem("wesib-conduit:auth")),this._auth.on((function(e){e?t.setItem("wesib-conduit:auth","string"==typeof e?e:e.token):t.removeItem("wesib-conduit:auth")})),this.user=this._auth.read.keep.dig((function(t){if(!t)return o();if("string"==typeof t)return function(t){const s=e.get(A);return c(e=>{s({path:"user",init:{headers:{Authorization:`Token ${t}`}},auth:!1}).thru_(e=>e.ok?l(e.body):l(void 0,e))({supply:h().needs(e.supply),receive(t,...s){e.receive(t,...s)}})},u())}(t);return o(t)}))}signIn(e){return this._context.get(A)({path:"users/login",init:{method:"POST",body:JSON.stringify(e)},auth:!1}).thru_(e=>(e.ok?this._auth.it=e.body:this._auth.it=null,e))}signOut(){this._auth.it=null}}let z=class{};z=p([b({setup(e){e.provide({a:E,as:X})}})],z);const H=new d("https://wesib.github.io/realworld-app/ns/","conduit");let M=class{constructor(e){this._context=e,this._response=i(),this._response.on((t,s)=>e.updateState("response",t,s));const t=e.get(R);e.whenOn(s=>{t.read.once(t=>{t.put(O,{fragment:{tag:e.element.tagName},receiver:{supply:s,receive:(e,t)=>this._response.it=t}})})})}render(){const e=this._context.get(y).document,t=e.createRange();return t.selectNodeContents(this._context.element),()=>{const s=this._response.it;if(s)if(t.deleteContents(),s.ok){const n=e.createDocumentFragment(),{fragment:o}=s;o&&(L(o,n),t.insertNode(n))}else null==s.ok?t.insertNode(e.createTextNode("Loading...")):t.insertNode(e.createTextNode(`Error. ${s.error}`))}}};function P({select:e="a",pick:t={all:!0,deep:!0},active:s}={}){return{feature:{needs:N},define(n){const o=s&&f.name(s,n.get(T)),r=new URL(n.get(y).document.baseURI);n.whenComponent(s=>{const n=s.get(q),a=s.get(R);s.whenOn(s=>{const i=n.select(e,t),c=new Map;i.track.tillOff(s)((e,t)=>{t.forEach(e=>{const t=c.get(e);t&&(c.delete(e),t.off())}),e.forEach(e=>{const t=e.element,n=new g(t).on("click")(e=>{if(!o||!t.classList.contains(o)){const s=t.getAttribute("href")||"";new URL(s,r).hostname===r.hostname&&(a.open(s),e.preventDefault())}}).needs(s);c.set(e,n)})}),o&&m({links:i,page:a})({supply:s,receive(e,{links:[t],page:[s]}){const n=B(s.url);let r,a="";t.forEach(e=>{const t=e.element,s=B(new URL(t.href));t.classList.remove(o),n.startsWith(s)&&a.length<s.length&&(r=t,a=s)}),r&&r.classList.add(o)}})})})}}}function B(e){const t=e.pathname;return t.endsWith("/")?t:t+"/"}p([v()],M.prototype,"render",null),M=p([x(["main",H])],M);let G=class{};G=p([x(["navbar",H],P({active:"active"}))],G);const J=["authenticated",H],Y=["not-authenticated",H];let Z=class{constructor(e){this._context=e,e.whenOn(t=>{e.get(E).user.tillOff(t)((e,t)=>{this.user=e})})}get user(){return this._user}set user(e){const t=this._user;this._user=e,this._context.updateState("user",e,t)}render(){const e=this._context.get(T),t=f.name(J,e),s=f.name(Y,e),{classList:n}=this._context.element;return()=>{this.user?(n.remove(s),n.add(t)):(n.remove(t),n.add(s))}}};p([v()],Z.prototype,"render",null),Z=p([x({name:["container",H],feature:{needs:[M,G]}})],Z);let K=class{};K=p([x(["footer",H],P())],K);let Q=class{};Q=p([b({needs:[Z,K,C]})],Q);let V=class{};function ee({select:e="input",pick:t={deep:!0,all:!0},name:s,controlOf:n}){return{feature:{needs:N},define(r){r.whenComponent(r=>{const a=r.get($),i=r.get(q);r.whenOn(c=>{m({group:a.up.keep.dig_(e=>e?e.get(j):o({})).keep.thru_(({control:e})=>e&&e.aspect(_)),node:i.select(e,t).first,aspects:r.get(I)}).consume(({group:[e],node:[t],aspects:[o]})=>{if(!e||!t)return;const a="function"==typeof s?s(t):s,i=h(()=>e.controls.remove(a)),c=n({node:t,context:r,supply:i,aspects:o});return S(r,c).needs(i),e.controls.set(a,c),i}).needs(c)})})}}}V=p([b({needs:[z,Q]})],V);const te=U(V);export{H as C,P as a,te as c,ee as e};//# sourceMappingURL=common.d6bd44bc.js.map
