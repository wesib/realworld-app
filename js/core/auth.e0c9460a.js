import{S as t,n as e,v as s}from"../proc7ts/primitives.e781e476.js";import{a as n,C as o}from"../proc7ts/context-values.69c73302.js";import{e as i,O as r,c as a,t as u,v as c,f as h,m as p,a as d,b as f,g as l}from"../proc7ts/fun-events.f7c44dc9.js";import{B as _,F as g}from"../wesib/wesib.acbfb4f5.js";import{_ as k}from"../helpers.e1623395.js";import{A as m,n as v}from"./api.f9177210.js";const y=a(e);function b(t){const e=(e,s)=>{const n=i(e),{supply:o}=n;return o.isOff||t(n,s),o};return e[r]=y[r],e.do=y.do,e.then=y.then,e}const j={onRecurrent:e};class w{constructor(e){this.supply=new t,this._target=e}on(t){return b(((e,s)=>{const{supply:n}=e;if(n.needs(this),!n.isOff){const n=t=>e.receive(j,t);this._target.addEventListener(t,n,s),e.supply.whenOff((()=>this._target.removeEventListener(t,n)))}}))}dispatch(t){return!this.supply.isOff&&this._target.dispatchEvent(t)}}function S(t=!0){return t?A:O}function A(t){return b(((e,s)=>null==s?t(e,{passive:!0}):"boolean"==typeof s?t(e,{capture:s,passive:!0}):null==s.passive?t(e,{...s,passive:!0}):t(e,s)))}function O(t){return b(((e,s)=>{const n=i(e);return t({supply:n.supply,receive(t,e){e.preventDefault(),n.receive(t,e)}},s)}))}function U(t){return b(((e,s)=>{const n=i(e);return t({supply:n.supply,receive(t,e){e.stopPropagation(),n.receive(t,e)}},s)}))}const x=new n("auth-service");class q{static get[o](){return x}}const T={};class E extends q{constructor(t){super(),this._context=t,this._token=u(T);const e=t.get(_),n=e.localStorage;let o;this._auth=u(C(n.getItem("wesib-conduit:auth"))),this._token.by(this.authentication.do(c((({token:t})=>this._token.it.token!==t&&{token:t})))),this._auth.on((function({token:t}){t?n.setItem("wesib-conduit:auth",t):n.removeItem("wesib-conduit:auth")})),this.requireUser=this.authentication.do(h((t=>{if(!t.token)return f({failure:{ok:!1,errors:v()}});if(t.email){const e=u(t);return o=[t,e],e}if(o){const[e,s]=o;if(e.token===t.token)return s;s.byNone()}const e=l(this.loadUser().do(p((t=>t.ok?t.body:{failure:t}),s(T))));return o=[t,e],e}))),this.user=this.requireUser.do(p((t=>t.username?t:T))),new w(e).on("storage")((({key:t,newValue:e})=>{if("wesib-conduit:auth"===t){const t=e||void 0;this._auth.it.token!==t&&(this._auth.it=C(t))}}))}get token(){return this._token.read}get authentication(){return this._auth.read}login(t){return this._request("users/login",t)}register(t){return this._request("users",t)}loadUser(){return this._context.get(m)({path:"user",init:{method:"GET",headers:{Accept:"application/json"}},respondAs:"user",auth:!0}).do(d((t=>(t.ok&&this._setUserSettings(t.body),t))))}updateSettings(t){return this._context.get(m)({path:"user",init:{method:"PUT",body:JSON.stringify({user:t}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!0}).do(d((t=>(t.ok&&this._setUserSettings(t.body),t))))}logout(){this._auth.it=T}_setUserSettings(t){this._auth.it={...t,token:this._token.it.token||t.token}}_request(t,e){return this._context.get(m)({path:t,init:{method:"POST",body:JSON.stringify({user:e}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!1}).do(d((t=>(this._auth.it=t.ok?t.body:{failure:t},t))))}}function C(t){return t?{token:t}:T}let I=class{};I=k([g({setup(t){t.provide({a:q,as:E})}})],I);export{I as A,w as D,x as a,q as b,S as h,T as n,U as s};//# sourceMappingURL=auth.e0c9460a.js.map
