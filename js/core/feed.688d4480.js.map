{"version":3,"file":"feed.688d4480.js","sources":["../../../src/core/feed/feed-request.ts","../../../src/core/feed/feed-service.ts","../../../src/core/feed/feed-service.impl.ts","../../../src/core/feed/feed-support.feature.ts"],"sourcesContent":["import { itsEach, thruIt } from '@proc7ts/a-iterable';\nimport { NextSkip, nextSkip } from '@proc7ts/call-thru';\n\nexport type FeedId = '/personal-feed' | '/global-feed';\n\nexport interface FeedRequest {\n  readonly feed?: FeedId;\n  readonly tag?: string;\n  readonly author?: string;\n  readonly favorited?: string;\n  readonly limit?: number;\n  readonly offset?: number;\n}\n\nconst feedRequestKeys: readonly (keyof FeedRequest)[] = ['feed', 'tag', 'author', 'favorited', 'limit', 'offset'];\n\nexport function feedRequestsEqual(first: FeedRequest, second: FeedRequest): boolean {\n  return feedRequestKeys.every(key => first[key] === second[key]);\n}\n\nexport function feedRequestSearchParams(request: FeedRequest): URLSearchParams {\n\n  const params = new URLSearchParams();\n\n  itsEach(\n      thruIt(\n          feedRequestKeys,\n          key => key !== 'feed' ? key : nextSkip,\n          (key: keyof FeedRequest): [keyof FeedRequest, string] | NextSkip => {\n\n            const value = request[key];\n\n            return value ? [key, String(value)] : nextSkip;\n          },\n      ),\n      ([key, value]) => params.set(key, value),\n  );\n\n  return params;\n}\n","import { ContextRef, SingleContextKey } from '@proc7ts/context-values';\nimport { EventReceiver, EventSupply, OnEvent } from '@proc7ts/fun-events';\nimport { ApiResponse } from '../api';\nimport { Article } from '../articles';\nimport { FeedRequest } from './feed-request';\n\nexport interface ArticleList {\n  readonly articles: readonly Article[];\n  readonly articlesCount: number;\n}\n\nexport const noArticles: ArticleList = { articles: [], articlesCount: 0 };\n\nexport interface FeedService {\n\n  articles(request: FeedRequest): OnEvent<[ApiResponse<ArticleList>]>;\n\n  tags(): OnEvent<string[]>;\n  tags(receiver: EventReceiver<string[]>): EventSupply;\n\n}\n\nexport const FeedService: ContextRef<FeedService> = (\n    /*#__PURE__*/ new SingleContextKey<FeedService>('feed-service')\n);\n","import { nextArg, nextArgs, nextSkip } from '@proc7ts/call-thru';\nimport { afterSupplied, EventReceiver, EventSupply, OnEvent, onEventBy, trackValueBy } from '@proc7ts/fun-events';\nimport { asis } from '@proc7ts/primitives';\nimport { BootstrapContext } from '@wesib/wesib';\nimport { ApiFetch, ApiRequest, ApiResponse } from '../api';\nimport { FeedId, FeedRequest, feedRequestSearchParams } from './feed-request';\nimport { ArticleList, FeedService } from './feed-service';\n\ninterface FeedSource {\n  path: string;\n  auth?: boolean;\n}\n\nconst feedSources: { readonly [id in FeedId]: FeedSource } = {\n  '/personal-feed': { path: 'articles/feed', auth: true },\n  '/global-feed': { path: 'articles' },\n};\n\nexport class FeedService$ implements FeedService {\n\n  private readonly _apiFetch: ApiFetch;\n\n  constructor(context: BootstrapContext) {\n    this._apiFetch = context.get(ApiFetch);\n  }\n\n  articles(request: FeedRequest): OnEvent<[ApiResponse<ArticleList>]> {\n\n    const { path, auth } = feedSources[request.feed || '/global-feed'];\n\n    const apiRequest: ApiRequest<ArticleList> = {\n      path: `${path}?${feedRequestSearchParams(request)}`,\n      init: {\n        method: 'GET',\n        headers: {\n          Accept: 'application/json',\n        },\n      },\n      auth,\n      respondAs: asis,\n    };\n\n    return this._apiFetch(apiRequest);\n  }\n\n  tags(): OnEvent<string[]>;\n  tags(receiver: EventReceiver<string[]>): EventSupply;\n  tags(receiver?: EventReceiver<string[]>): OnEvent<string[]> | EventSupply {\n\n    let onTags: OnEvent<string[]> | undefined;\n\n    return (this.tags = onEventBy(receiver => {\n      if (!onTags) {\n\n        const apiRequest: ApiRequest<string[]> = {\n          path: 'tags',\n          init: {\n            method: 'GET',\n            headers: {\n              Accept: 'application/json',\n            },\n          },\n          respondAs: 'tags',\n          auth: false,\n        };\n        const onTagsLoad: OnEvent<[string[]]> = this._apiFetch(apiRequest).thru_(response => {\n          if (response.ok) {\n            return nextArg(response.body);\n          }\n\n          console.error('Failed to load tags', response.errors);\n\n          return nextArg([]);\n        });\n        const tags = trackValueBy<string[] | undefined>(\n            afterSupplied<[string[]?]>(onTagsLoad, () => []),\n        );\n\n        onTags = tags.read().thru_(\n            tagList => tagList ? nextArgs(...tagList) : nextSkip,\n        );\n      }\n\n      onTags.to(receiver);\n    }).F)(receiver);\n  }\n\n}\n","import { Feature } from '@wesib/wesib';\nimport { FeedService } from './feed-service';\nimport { FeedService$ } from './feed-service.impl';\n\n@Feature({\n  setup(setup) {\n    setup.provide({ a: FeedService, as: FeedService$ });\n  },\n})\nexport class FeedSupport {\n}\n"],"names":["feedRequestKeys","feedRequestsEqual","first","second","every","key","feedRequestSearchParams","request","params","URLSearchParams","itsEach","thruIt","nextSkip","value","String","set","noArticles","articles","articlesCount","FeedService","SingleContextKey","feedSources","/personal-feed","path","auth","/global-feed","FeedService$","[object Object]","context","this","_apiFetch","get","ApiFetch","feed","apiRequest","init","method","headers","Accept","respondAs","asis","receiver","onTags","tags","onEventBy","onTagsLoad","thru_","response","ok","nextArg","body","console","error","errors","trackValueBy","afterSupplied","read","tagList","nextArgs","to","F","FeedSupport","Feature","setup","provide","a","as"],"mappings":"obAcA,MAAMA,EAAkD,CAAC,OAAQ,MAAO,SAAU,YAAa,QAAS,mBAExFC,EAAkBC,EAAoBC,GACpD,OAAOH,EAAgBI,MAAMC,GAAOH,EAAMG,KAASF,EAAOE,aAG5CC,EAAwBC,GAEtC,MAAMC,EAAS,IAAIC,gBAgBnB,OAdAC,EACIC,EACIX,EACAK,GAAe,SAARA,EAAiBA,EAAMO,EAC7BP,IAEC,MAAMQ,EAAQN,EAAQF,GAEtB,OAAOQ,EAAQ,CAACR,EAAKS,OAAOD,IAAUD,IAG5C,EAAEP,EAAKQ,KAAWL,EAAOO,IAAIV,EAAKQ,IAG/BL,QC3BIQ,EAA0B,CAAEC,SAAU,GAAIC,cAAe,GAWzDC,MACSC,EAA8B,gBCV9CC,EAAuD,CAC3DC,iBAAkB,CAAEC,KAAM,gBAAiBC,MAAM,GACjDC,eAAgB,CAAEF,KAAM,mBAGbG,EAIXC,YAAYC,GACVC,KAAKC,UAAYF,EAAQG,IAAIC,GAG/BL,SAASpB,GAEP,MAAMgB,KAAEA,EAAIC,KAAEA,GAASH,EAAYd,EAAQ0B,MAAQ,gBAE7CC,EAAsC,CAC1CX,KAAM,GAAGA,KAAQjB,EAAwBC,KACzC4B,KAAM,CACJC,OAAQ,MACRC,QAAS,CACPC,OAAQ,qBAGZd,KAAAA,EACAe,UAAWC,GAGb,OAAOX,KAAKC,UAAUI,GAKxBP,KAAKc,GAEH,IAAIC,EAEJ,OAAQb,KAAKc,KAAOC,EAAUH,IAC5B,IAAKC,EAAQ,CAEX,MAAMR,EAAmC,CACvCX,KAAM,OACNY,KAAM,CACJC,OAAQ,MACRC,QAAS,CACPC,OAAQ,qBAGZC,UAAW,OACXf,MAAM,GAEFqB,EAAkChB,KAAKC,UAAUI,GAAYY,MAAMC,GACnEA,EAASC,GACJC,EAAQF,EAASG,OAG1BC,QAAQC,MAAM,sBAAuBL,EAASM,QAEvCJ,EAAQ,MAEXN,EAAOW,EACTC,EAA2BV,EAAY,IAAM,KAGjDH,EAASC,EAAKa,OAAOV,MACjBW,GAAWA,EAAUC,KAAYD,GAAW7C,GAIlD8B,EAAOiB,GAAGlB,KACTmB,GAAGnB,gBC3EV,IAAaoB,EAAb,QACA,OADaA,KALZC,EAAQ,CACPnC,MAAMoC,GACJA,EAAMC,QAAQ,CAAEC,EAAG9C,EAAa+C,GAAIxC,QAG3BmC"}