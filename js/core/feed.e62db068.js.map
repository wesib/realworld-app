{"version":3,"file":"feed.e62db068.js","sources":["../../../src/core/feed/feed-request.ts","../../../src/core/feed/feed-service.ts","../../../src/core/feed/feed-service.impl.ts","../../../src/core/feed/feed-support.feature.ts"],"sourcesContent":["import { NextSkip, nextSkip } from '@proc7ts/call-thru';\nimport { itsEach } from '@proc7ts/push-iterator';\nimport { thruIt } from '@proc7ts/push-iterator/call-thru';\n\nexport type FeedId = '/personal-feed' | '/global-feed';\n\nexport interface FeedRequest {\n  readonly feed?: FeedId;\n  readonly tag?: string;\n  readonly author?: string;\n  readonly favorited?: string;\n  readonly limit?: number;\n  readonly offset?: number;\n}\n\nconst feedRequestKeys: readonly (keyof FeedRequest)[] = ['feed', 'tag', 'author', 'favorited', 'limit', 'offset'];\n\nexport function feedRequestsEqual(first: FeedRequest, second: FeedRequest): boolean {\n  return feedRequestKeys.every(key => first[key] === second[key]);\n}\n\nexport function feedRequestSearchParams(request: FeedRequest): URLSearchParams {\n\n  const params = new URLSearchParams();\n\n  itsEach(\n      thruIt(\n          feedRequestKeys,\n          key => key !== 'feed' ? key : nextSkip,\n          (key: keyof FeedRequest): [keyof FeedRequest, string] | NextSkip => {\n\n            const value = request[key];\n\n            return value ? [key, String(value)] : nextSkip;\n          },\n      ),\n      ([key, value]) => params.set(key, value),\n  );\n\n  return params;\n}\n","import { ContextRef, SingleContextKey } from '@proc7ts/context-values';\nimport { OnEvent } from '@proc7ts/fun-events';\nimport { ApiResponse } from '../api';\nimport { Article } from '../articles';\nimport { FeedRequest } from './feed-request';\n\nexport interface ArticleList {\n  readonly articles: readonly Article[];\n  readonly articlesCount: number;\n}\n\nexport const noArticles: ArticleList = { articles: [], articlesCount: 0 };\n\nexport interface FeedService {\n\n  readonly tags: OnEvent<string[]>;\n\n  articles(request: FeedRequest): OnEvent<[ApiResponse<ArticleList>]>;\n\n}\n\nexport const FeedService: ContextRef<FeedService> = (\n    /*#__PURE__*/ new SingleContextKey<FeedService>('feed-service')\n);\n","import { afterSupplied, mapOn_, OnEvent, onEventBy, trackValueBy, translateOn_ } from '@proc7ts/fun-events';\nimport { asis } from '@proc7ts/primitives';\nimport { BootstrapContext } from '@wesib/wesib';\nimport { ApiFetch, ApiRequest, ApiResponse } from '../api';\nimport { FeedId, FeedRequest, feedRequestSearchParams } from './feed-request';\nimport { ArticleList, FeedService } from './feed-service';\n\ninterface FeedSource {\n  path: string;\n  auth?: boolean;\n}\n\nconst feedSources: { readonly [id in FeedId]: FeedSource } = {\n  '/personal-feed': { path: 'articles/feed', auth: true },\n  '/global-feed': { path: 'articles' },\n};\n\nexport class FeedService$ implements FeedService {\n\n  readonly tags: OnEvent<string[]>;\n  private readonly _apiFetch: ApiFetch;\n\n  constructor(context: BootstrapContext) {\n    this._apiFetch = context.get(ApiFetch);\n\n    let onTags: OnEvent<string[]> | undefined;\n\n    this.tags = onEventBy(receiver => {\n      if (!onTags) {\n\n        const apiRequest: ApiRequest<string[]> = {\n          path: 'tags',\n          init: {\n            method: 'GET',\n            headers: {\n              Accept: 'application/json',\n            },\n          },\n          respondAs: 'tags',\n          auth: false,\n        };\n        const onTagsLoad: OnEvent<[string[]]> = this._apiFetch(apiRequest).do(\n            mapOn_(response => {\n              if (response.ok) {\n                return response.body;\n              }\n\n              console.error('Failed to load tags', response.errors);\n\n              return [];\n            }),\n        );\n        const tags = trackValueBy<string[] | undefined>(\n            afterSupplied<[string[]?]>(onTagsLoad, () => []),\n        );\n\n        onTags = tags.read.do(\n            translateOn_((send, tagList) => tagList && send(...tagList)),\n        );\n      }\n\n      onTags(receiver);\n    });\n  }\n\n  articles(request: FeedRequest): OnEvent<[ApiResponse<ArticleList>]> {\n\n    const { path, auth } = feedSources[request.feed || '/global-feed'];\n\n    const apiRequest: ApiRequest<ArticleList> = {\n      path: `${path}?${feedRequestSearchParams(request)}`,\n      init: {\n        method: 'GET',\n        headers: {\n          Accept: 'application/json',\n        },\n      },\n      auth,\n      respondAs: asis,\n    };\n\n    return this._apiFetch(apiRequest);\n  }\n\n}\n","import { Feature } from '@wesib/wesib';\nimport { FeedService } from './feed-service';\nimport { FeedService$ } from './feed-service.impl';\n\n@Feature({\n  setup(setup) {\n    setup.provide({ a: FeedService, as: FeedService$ });\n  },\n})\nexport class FeedSupport {\n}\n"],"names":["feedRequestKeys","feedRequestsEqual","first","second","every","key","feedRequestSearchParams","request","params","URLSearchParams","itsEach","thruIt","nextSkip","value","String","set","noArticles","articles","articlesCount","FeedService","SingleContextKey","feedSources","/personal-feed","path","auth","/global-feed","FeedService$","[object Object]","context","onTags","this","_apiFetch","get","ApiFetch","tags","onEventBy","receiver","apiRequest","init","method","headers","Accept","respondAs","onTagsLoad","do","mapOn_","response","ok","body","console","error","errors","trackValueBy","afterSupplied","read","translateOn_","send","tagList","feed","asis","FeedSupport","Feature","setup","provide","a","as"],"mappings":"2dAeA,MAAMA,EAAkD,CAAC,OAAQ,MAAO,SAAU,YAAa,QAAS,mBAExFC,EAAkBC,EAAoBC,GACpD,OAAOH,EAAgBI,OAAMC,GAAOH,EAAMG,KAASF,EAAOE,cAG5CC,EAAwBC,GAEtC,MAAMC,EAAS,IAAIC,gBAgBnB,OAdAC,EACIC,EACIX,GACAK,GAAe,SAARA,EAAiBA,EAAMO,IAC7BP,IAEC,MAAMQ,EAAQN,EAAQF,GAEtB,OAAOQ,EAAQ,CAACR,EAAKS,OAAOD,IAAUD,MAG5C,EAAEP,EAAKQ,KAAWL,EAAOO,IAAIV,EAAKQ,KAG/BL,QC5BIQ,EAA0B,CAAEC,SAAU,GAAIC,cAAe,GAUzDC,MACSC,EAA8B,gBCV9CC,EAAuD,CAC3DC,iBAAkB,CAAEC,KAAM,gBAAiBC,MAAM,GACjDC,eAAgB,CAAEF,KAAM,mBAGbG,EAKXC,YAAYC,GAGV,IAAIC,EAFJC,KAAKC,UAAYH,EAAQI,IAAIC,GAI7BH,KAAKI,KAAOC,GAAUC,IACpB,IAAKP,EAAQ,CAEX,MAAMQ,EAAmC,CACvCd,KAAM,OACNe,KAAM,CACJC,OAAQ,MACRC,QAAS,CACPC,OAAQ,qBAGZC,UAAW,OACXlB,MAAM,GAEFmB,EAAkCb,KAAKC,UAAUM,GAAYO,GAC/DC,GAAOC,GACDA,EAASC,GACJD,EAASE,MAGlBC,QAAQC,MAAM,sBAAuBJ,EAASK,QAEvC,OAGPjB,EAAOkB,EACTC,EAA2BV,GAAY,IAAM,MAGjDd,EAASK,EAAKoB,KAAKV,GACfW,GAAa,CAACC,EAAMC,IAAYA,GAAWD,KAAQC,MAIzD5B,EAAOO,MAIXT,SAASpB,GAEP,MAAMgB,KAAEA,EAAIC,KAAEA,GAASH,EAAYd,EAAQmD,MAAQ,gBAE7CrB,EAAsC,CAC1Cd,KAAM,GAAGA,KAAQjB,EAAwBC,KACzC+B,KAAM,CACJC,OAAQ,MACRC,QAAS,CACPC,OAAQ,qBAGZjB,KAAAA,EACAkB,UAAWiB,GAGb,OAAO7B,KAAKC,UAAUM,QCxEbuB,EAAb,QAAaA,KALZC,EAAQ,CACPlC,MAAMmC,GACJA,EAAMC,QAAQ,CAAEC,EAAG7C,EAAa8C,GAAIvC,QAG3BkC"}