import{_ as t}from"../helpers.e1623395.js";import{B as e,F as s}from"../wesib/wesib.289eabae.js";import{a as o,C as i}from"../proc7ts/context-values.cc32b8c5.js";import{D as n}from"../frontmeans/dom-events.bc847677.js";import{t as r,v as a,c as u,b as h,e as c,m as p,a as d}from"../proc7ts/fun-events.8f536596.js";import{v as m}from"../proc7ts/primitives.38e5298b.js";import{n as f,A as k}from"./api.48f5edea.js";import"../frontmeans/input-aspects.e72f213f.js";const l=new o("auth-service");class _{static get[i](){return l}}const b={};class g extends _{constructor(t){super(),this._context=t,this._token=r(b);const s=t.get(e),o=s.localStorage;let i;this._auth=r(j(o.getItem("wesib-conduit:auth"))),this._token.by(this.authentication.do(a((({token:t})=>this._token.it.token!==t&&{token:t})))),this._auth.on((function({token:t}){t?o.setItem("wesib-conduit:auth",t):o.removeItem("wesib-conduit:auth")})),this.requireUser=this.authentication.do(u((t=>{if(!t.token)return h({failure:{ok:!1,errors:f()}});if(t.email){const e=r(t);return i=[t,e],e}if(i){const[e,s]=i;if(e.token===t.token)return s;s.byNone()}const e=c(this.loadUser().do(p((t=>t.ok?t.body:{failure:t}),m(b))));return i=[t,e],e}))),this.user=this.requireUser.do(p((t=>t.username?t:b))),new n(s).on("storage")((({key:t,newValue:e})=>{if("wesib-conduit:auth"===t){const t=e||void 0;this._auth.it.token!==t&&(this._auth.it=j(t))}}))}get token(){return this._token.read}get authentication(){return this._auth.read}login(t){return this._request("users/login",t)}register(t){return this._request("users",t)}loadUser(){return this._context.get(k)({path:"user",init:{method:"GET",headers:{Accept:"application/json"}},respondAs:"user",auth:!0}).do(d((t=>(t.ok&&this._setUserSettings(t.body),t))))}updateSettings(t){return this._context.get(k)({path:"user",init:{method:"PUT",body:JSON.stringify({user:t}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!0}).do(d((t=>(t.ok&&this._setUserSettings(t.body),t))))}logout(){this._auth.it=b}_setUserSettings(t){this._auth.it={...t,token:this._token.it.token||t.token}}_request(t,e){return this._context.get(k)({path:t,init:{method:"POST",body:JSON.stringify({user:e}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!1}).do(d((t=>(this._auth.it=t.ok?t.body:{failure:t},t))))}}function j(t){return t?{token:t}:b}let y=class{};y=t([s({setup(t){t.provide({a:_,as:g})}})],y);export{y as A,l as a,_ as b,b as n};//# sourceMappingURL=auth.98c2c25d.js.map
