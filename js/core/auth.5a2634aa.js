import{a as t,C as e}from"../proc7ts/context-values.be8ff8e3.js";import{a as s,b as r}from"../proc7ts/call-thru.3702f6af.js";import{t as i,D as o,b as n,c as a,d as u}from"../proc7ts/fun-events.b7373782.js";import{B as h,F as c}from"../wesib/wesib.8dbf8db7.js";import{_ as p}from"../helpers.e1623395.js";import{n as d,A as _}from"./api.f51c1783.js";const k=new t("auth-service");class l{static get[e](){return k}}const f={};class b extends l{constructor(t){super(),this._context=t,this._token=i(f);const e=t.get(h),r=e.localStorage;this._auth=i(m(r.getItem("wesib-conduit:auth"))),this._token.by(this.authentication().thru_((({token:t})=>this._token.it.token!==t?{token:t}:s))),this._auth.on((function({token:t}){t?r.setItem("wesib-conduit:auth",t):r.removeItem("wesib-conduit:auth")})),new o(e).on("storage").to((({key:t,newValue:e})=>{if("wesib-conduit:auth"===t){const t=e||void 0;this._auth.it.token!==t&&(this._auth.it=m(t))}}))}token(t){return(this.token=this._token.read().F)(t)}authentication(t){return(this.authentication=this._auth.read().F)(t)}user(t){return(this.user=this.requireUser().keepThru((t=>t.username?t:f)).F)(t)}requireUser(t){let e;return(this.requireUser=this.authentication().keepThru((t=>{if(!t.token)return r({failure:{ok:!1,errors:d()}});if(t.email){const s=i(t);return e=[t,s],n(s)}if(e){const[s,r]=e;if(s.token===t.token)return n(r);r.byNone()}const s=a(u(this.loadUser().thru_((t=>t.ok?t.body:{failure:t})),(()=>[f])));return e=[t,s],n(s)})).F)(t)}login(t){return this._request("users/login",t)}register(t){return this._request("users",t)}loadUser(){return this._context.get(_)({path:"user",init:{method:"GET",headers:{Accept:"application/json"}},respondAs:"user",auth:!0}).thru_((t=>(t.ok&&this._setUserSettings(t.body),t)))}updateSettings(t){return this._context.get(_)({path:"user",init:{method:"PUT",body:JSON.stringify({user:t}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!0}).thru_((t=>(t.ok&&this._setUserSettings(t.body),t)))}logout(){this._auth.it=f}_setUserSettings(t){this._auth.it={...t,token:this._token.it.token||t.token}}_request(t,e){return this._context.get(_)({path:t,init:{method:"POST",body:JSON.stringify({user:e}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!1}).thru_((t=>(this._auth.it=t.ok?t.body:{failure:t},t)))}}function m(t){return t?{token:t}:f}let g=class{};g=p([c({setup(t){t.provide({a:l,as:b})}})],g);export{g as A,k as a,l as b,f as n};//# sourceMappingURL=auth.5a2634aa.js.map
