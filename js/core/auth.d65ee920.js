import{b as t,c as e}from"../proc7ts/call-thru.ea70618a.js";import{a as s,C as i}from"../proc7ts/context-values.ec10addc.js";import{t as r,D as o,b as n,c as a,d as u}from"../proc7ts/fun-events.6f8cd792.js";import{B as h,F as c}from"../wesib/wesib.b26c9eb2.js";import{_ as p}from"../helpers.920c7f83.js";import{n as d,A as _}from"./api.a4379be1.js";const k=new s("auth-service");class l{static get[i](){return k}}const b={};class f extends l{constructor(e){super(),this._context=e,this._token=r(b);const s=e.get(h),i=s.localStorage;this._auth=r(m(i.getItem("wesib-conduit:auth"))),this._token.by(this.authentication().thru_(({token:e})=>this._token.it.token!==e?{token:e}:t)),this._auth.on((function({token:t}){t?i.setItem("wesib-conduit:auth",t):i.removeItem("wesib-conduit:auth")})),new o(s).on("storage").to(({key:t,newValue:e})=>{if("wesib-conduit:auth"===t){const t=e||void 0;this._auth.it.token!==t&&(this._auth.it=m(t))}})}token(t){return(this.token=this._token.read().F)(t)}authentication(t){return(this.authentication=this._auth.read().F)(t)}user(t){return(this.user=this.requireUser().keepThru(t=>t.username?t:b).F)(t)}requireUser(t){let s;return(this.requireUser=this.authentication().keepThru(t=>{if(!t.token)return e({failure:{ok:!1,errors:d()}});if(t.email){const e=r(t);return s=[t,e],n(e)}if(s){const[e,i]=s;if(e.token===t.token)return n(i);i.byNone()}const i=a(u(this.loadUser().thru_(t=>t.ok?t.body:{failure:t}),()=>[b]));return s=[t,i],n(i)}).F)(t)}login(t){return this._request("users/login",t)}register(t){return this._request("users",t)}loadUser(){return this._context.get(_)({path:"user",init:{method:"GET",headers:{Accept:"application/json"}},respondAs:"user",auth:!0}).thru_(t=>(t.ok&&this._setUserSettings(t.body),t))}updateSettings(t){return this._context.get(_)({path:"user",init:{method:"PUT",body:JSON.stringify({user:t}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!0}).thru_(t=>(t.ok&&this._setUserSettings(t.body),t))}logout(){this._auth.it=b}_setUserSettings(t){this._auth.it=Object.assign(Object.assign({},t),{token:this._token.it.token||t.token})}_request(t,e){return this._context.get(_)({path:t,init:{method:"POST",body:JSON.stringify({user:e}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!1}).thru_(t=>(t.ok?this._auth.it=t.body:!1===t.ok&&(this._auth.it={failure:t}),t))}}function m(t){return t?{token:t}:b}let g=class{};g=p([c({setup(t){t.provide({a:l,as:f})}})],g);const j={};export{g as A,k as a,l as b,j as n};//# sourceMappingURL=auth.d65ee920.js.map
