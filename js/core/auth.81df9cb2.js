import{v as t}from"../proc7ts/primitives.3596c309.js";import{a as e,C as s}from"../proc7ts/context-values.91624d4c.js";import{t as o,v as i,c as n,m as r,a,b as u,e as h}from"../proc7ts/fun-events.26e814e4.js";import{D as c}from"../frontmeans/dom-events.272f64a1.js";import{B as p,F as d}from"../wesib/wesib.a2d60763.js";import{_ as m}from"../helpers.e1623395.js";import{A as k,n as l}from"./api.a7ea7d29.js";const _=new e("auth-service");class f{static get[s](){return _}}const g={};class b extends f{constructor(e){super(),this._context=e,this._token=o(g);const s=e.get(p),a=s.localStorage;let d;this._auth=o(y(a.getItem("wesib-conduit:auth"))),this._token.by(this.authentication.do(i((({token:t})=>this._token.it.token!==t&&{token:t})))),this._auth.on((function({token:t}){t?a.setItem("wesib-conduit:auth",t):a.removeItem("wesib-conduit:auth")})),this.requireUser=this.authentication.do(n((e=>{if(!e.token)return u({failure:{ok:!1,errors:l()}});if(e.email){const t=o(e);return d=[e,t],t}if(d){const[t,s]=d;if(t.token===e.token)return s;s.byNone()}const s=h(this.loadUser().do(r((t=>t.ok?t.body:{failure:t}),t(g))));return d=[e,s],s}))),this.user=this.requireUser.do(r((t=>t.username?t:g))),new c(s).on("storage")((({key:t,newValue:e})=>{if("wesib-conduit:auth"===t){const t=e||void 0;this._auth.it.token!==t&&(this._auth.it=y(t))}}))}get token(){return this._token.read}get authentication(){return this._auth.read}login(t){return this._request("users/login",t)}register(t){return this._request("users",t)}loadUser(){return this._context.get(k)({path:"user",init:{method:"GET",headers:{Accept:"application/json"}},respondAs:"user",auth:!0}).do(a((t=>(t.ok&&this._setUserSettings(t.body),t))))}updateSettings(t){return this._context.get(k)({path:"user",init:{method:"PUT",body:JSON.stringify({user:t}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!0}).do(a((t=>(t.ok&&this._setUserSettings(t.body),t))))}logout(){this._auth.it=g}_setUserSettings(t){this._auth.it={...t,token:this._token.it.token||t.token}}_request(t,e){return this._context.get(k)({path:t,init:{method:"POST",body:JSON.stringify({user:e}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!1}).do(a((t=>(this._auth.it=t.ok?t.body:{failure:t},t))))}}function y(t){return t?{token:t}:g}let j=class{};j=m([d({setup(t){t.provide({a:f,as:b})}})],j);export{j as A,_ as a,f as b,g as n};//# sourceMappingURL=auth.81df9cb2.js.map
