import{e}from"../lib/call-thru.00f7427a.js";import{d as r,F as t}from"../lib/context-values.956fc686.js";import{k as s,l as o}from"../lib/fun-events.a21352be.js";import{b as n}from"../wesib/wesib.e063c4fa.js";import{A as u}from"./auth.e4fdf66e.js";import{H as a}from"../wesib/generic.2d4b9745.js";import{I as i}from"../lib/input-aspects.88ad3da2.js";const f=new r("api-root-url",{byDefault:()=>new URL("https://conduit.productionready.io/api/")}),p=new t("api-fetch",{byDefault:n((function(r){const t=r.get(a),n=r.get(f);return a=>{const{path:i,init:f,auth:p}=a,h=n.thru_(e=>new URL(i,e),e=>function(e,r={}){const t=new Request(e.href,Object.assign({mode:"cors"},r)),{headers:s}=t;return s.set("X-Requested-With","XMLHttpRequest"),t}(e,f)).thru_(t=>!1===p?e({request:t}):s(function(e,r,t){return e.get(u).token.keep.thru_(({token:e,failure:s})=>e?(r.headers.set("Authorization",`Token ${e}`),{request:r}):t?(s||(s={ok:!1,errors:{api:["Not authenticated"]}}),{failure:s}):{request:r})}(r,t,p)),r=>r.request?s(t(r.request).thru_(e=>({response:e}))):e({failure:r.failure}));return o(h.thru_(c)).thru_(([e,r])=>function({respondAs:e},r,t){if(!r.response)return r.failure;const{response:s}=r;if(s.ok)return{ok:!0,response:s,body:"function"==typeof e?e(t):t[e]};return{ok:!1,response:s,errors:t.errors||l(s)}}(a,e,r))}}))});function c(e){return e.response?Promise.all([e,e.response.json()]).catch(r=>[{failure:{ok:!1,response:e.response,errors:e.response.ok?{api:[`Failed to parse response: ${r}`]}:l(e.response)}}]):[e]}function l(e){return{HTTP:["ERROR "+e.status+(e.statusText?": "+e.statusText:"")]}}function h(e){return new Promise((r,t)=>{e.once(e=>{e.ok?r(e.body):t(new i({submit:"api",api:e.errors}))}).whenOff(e=>{t(e instanceof i?e:new i({submit:"cancel",cancel:e}))})})}export{p as A,h as a};//# sourceMappingURL=api.bc423b77.js.map
