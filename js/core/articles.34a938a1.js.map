{"version":3,"file":"articles.34a938a1.js","sources":["../../../src/core/articles/article-service.ts","../../../src/core/articles/article-service.impl.ts","../../../src/core/articles/articles-support.feature.ts"],"sourcesContent":["import { ContextRef, SingleContextKey } from '@proc7ts/context-values';\nimport { OnEvent } from '@proc7ts/fun-events';\nimport { ApiResponse } from '../api';\nimport { Article } from './article';\n\nexport interface CreateArticleRequest {\n\n  readonly title: string;\n  readonly description: string;\n  readonly body: string;\n  readonly tagList?: readonly string[];\n\n}\n\nexport interface ArticleService {\n\n  article(slug: string): OnEvent<[ApiResponse<Article>]>;\n\n  htmlContents(article: Article): Promise<Node>;\n\n  likeArticle(slug: string, like?: boolean): OnEvent<[ApiResponse<Article>]>;\n\n  createArticle(request: CreateArticleRequest): OnEvent<[ApiResponse<Article>]>;\n\n  updateArticle(slug: string, request: Partial<CreateArticleRequest>): OnEvent<[ApiResponse<Article>]>;\n\n  deleteArticle(slug: string): OnEvent<[ApiResponse<any>]>;\n\n}\n\nexport const ArticleService: ContextRef<ArticleService> = (\n    /*#__PURE__*/ new SingleContextKey<ArticleService>('article-service')\n);\n\n","import { afterThe, OnEvent } from '@proc7ts/fun-events';\nimport { asis } from '@proc7ts/primitives';\nimport { BootstrapContext, BootstrapWindow } from '@wesib/wesib';\nimport DOMPurify from 'dompurify';\nimport marked from 'marked';\nimport { ApiFetch, ApiRequest, ApiResponse } from '../api';\nimport { Article } from './article';\nimport { ArticleService, CreateArticleRequest } from './article-service';\n\nexport class ArticleService$ implements ArticleService {\n\n  private readonly _apiFetch: ApiFetch;\n  private readonly _schedule: (task: () => void) => void;\n  private readonly _purify: DOMPurify.DOMPurifyI;\n\n  constructor(context: BootstrapContext) {\n    this._apiFetch = context.get(ApiFetch);\n\n    const window = context.get(BootstrapWindow);\n\n    this._purify = DOMPurify(window);\n\n    const { requestIdleCallback } = window;\n\n    if (requestIdleCallback) {\n      this._schedule = task => requestIdleCallback(task, { timeout: 750 });\n    } else {\n      this._schedule = task => window.setTimeout(task);\n    }\n  }\n\n  article(slug: string): OnEvent<[ApiResponse<Article>]> {\n    if (!slug) {\n      return afterThe<[ApiResponse.Failure]>({ ok: false, errors: { article: ['not found'] } });\n    }\n\n    const apiRequest: ApiRequest<Article> = {\n      path: `articles/${encodeURIComponent(slug)}`,\n      init: {\n        method: 'GET',\n        headers: {\n          Accept: 'application/json',\n        },\n      },\n      respondAs: 'article',\n    };\n\n    return this._apiFetch(apiRequest);\n  }\n\n  async htmlContents(article: Article): Promise<Node> {\n\n    const html = await new Promise<string>((resolve, reject) => {\n      this._schedule(() => {\n        marked(article.body, (error, html) => {\n          if (error != null) {\n            reject(error);\n          } else {\n            resolve(html);\n          }\n        });\n      });\n    });\n\n    return this._purify.sanitize(\n        html, {\n          RETURN_DOM_FRAGMENT: true,\n          RETURN_DOM_IMPORT: true,\n        },\n    );\n  }\n\n  likeArticle(slug: string, like = true): OnEvent<[ApiResponse<Article>]> {\n\n    const apiRequest: ApiRequest<Article> = {\n      path: `articles/${encodeURIComponent(slug)}/favorite`,\n      init: {\n        method: like ? 'POST' : 'DELETE',\n        headers: {\n          Accept: 'application/json',\n        },\n      },\n      respondAs: 'article',\n      auth: true,\n    };\n\n    return this._apiFetch(apiRequest);\n  }\n\n  createArticle(request: CreateArticleRequest): OnEvent<[ApiResponse<Article>]> {\n\n    const apiRequest: ApiRequest<Article> = {\n      path: 'articles',\n      init: {\n        method: 'POST',\n        headers: {\n          Accept: 'application/json',\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ article: request }),\n      },\n      respondAs: 'article',\n      auth: true,\n    };\n\n    return this._apiFetch(apiRequest);\n  }\n\n  updateArticle(slug: string, request: Partial<CreateArticleRequest>): OnEvent<[ApiResponse<Article>]> {\n\n    const apiRequest: ApiRequest<Article> = {\n      path: `articles/${encodeURIComponent(slug)}`,\n      init: {\n        method: 'PUT',\n        headers: {\n          Accept: 'application/json',\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ article: request }),\n      },\n      respondAs: 'article',\n      auth: true,\n    };\n\n    return this._apiFetch(apiRequest);\n  }\n\n  deleteArticle(slug: string): OnEvent<[ApiResponse<any>]> {\n\n    const apiRequest: ApiRequest<any> = {\n      path: `articles/${encodeURIComponent(slug)}`,\n      init: {\n        method: 'DELETE',\n        headers: {\n          Accept: 'application/json',\n        },\n      },\n      respondAs: asis,\n      auth: true,\n    };\n\n    return this._apiFetch(apiRequest);\n  }\n\n}\n\ndeclare global {\n  interface Window {\n    requestIdleCallback?(this: void, task: () => void, options?: { timeout: number }): void;\n  }\n}\n","import { Feature } from '@wesib/wesib';\nimport { ArticleService } from './article-service';\nimport { ArticleService$ } from './article-service.impl';\n\n@Feature({\n  setup(setup) {\n    setup.provide({ a: ArticleService, as: ArticleService$ });\n  },\n})\nexport class ArticlesSupport {\n}\n"],"names":["ArticleService","SingleContextKey","ArticleService$","[object Object]","context","this","_apiFetch","get","ApiFetch","window","BootstrapWindow","_purify","DOMPurify","requestIdleCallback","_schedule","task","timeout","setTimeout","slug","afterThe","ok","errors","article","apiRequest","path","encodeURIComponent","init","method","headers","Accept","respondAs","html","Promise","resolve","reject","marked","body","error","sanitize","RETURN_DOM_FRAGMENT","RETURN_DOM_IMPORT","like","auth","request","Content-Type","JSON","stringify","asis","ArticlesSupport","Feature","setup","provide","a","as"],"mappings":"kZA8BaA,MACSC,EAAiC,yBCtB1CC,EAMXC,YAAYC,GACVC,KAAKC,UAAYF,EAAQG,IAAIC,GAE7B,MAAMC,EAASL,EAAQG,IAAIG,GAE3BL,KAAKM,QAAUC,EAAUH,GAEzB,MAAMI,oBAAEA,GAAwBJ,EAG9BJ,KAAKS,UADHD,EACeE,GAAQF,EAAoBE,EAAM,CAAEC,QAAS,MAE7CD,GAAQN,EAAOQ,WAAWF,GAI/CZ,QAAQe,GACN,IAAKA,EACH,OAAOC,EAAgC,CAAEC,IAAI,EAAOC,OAAQ,CAAEC,QAAS,CAAC,gBAG1E,MAAMC,EAAkC,CACtCC,KAAM,YAAYC,mBAAmBP,KACrCQ,KAAM,CACJC,OAAQ,MACRC,QAAS,CACPC,OAAQ,qBAGZC,UAAW,WAGb,OAAOzB,KAAKC,UAAUiB,GAGxBpB,mBAAmBmB,GAEjB,MAAMS,QAAa,IAAIC,SAAgB,CAACC,EAASC,KAC/C7B,KAAKS,WAAU,KACbqB,EAAOb,EAAQc,MAAM,CAACC,EAAON,KACd,MAATM,EACFH,EAAOG,GAEPJ,EAAQF,YAMhB,OAAO1B,KAAKM,QAAQ2B,SAChBP,EAAM,CACJQ,qBAAqB,EACrBC,mBAAmB,IAK3BrC,YAAYe,EAAcuB,GAAO,GAE/B,MAAMlB,EAAkC,CACtCC,KAAM,YAAYC,mBAAmBP,cACrCQ,KAAM,CACJC,OAAQc,EAAO,OAAS,SACxBb,QAAS,CACPC,OAAQ,qBAGZC,UAAW,UACXY,MAAM,GAGR,OAAOrC,KAAKC,UAAUiB,GAGxBpB,cAAcwC,GAEZ,MAAMpB,EAAkC,CACtCC,KAAM,WACNE,KAAM,CACJC,OAAQ,OACRC,QAAS,CACPC,OAAQ,mBACRe,eAAgB,oBAElBR,KAAMS,KAAKC,UAAU,CAAExB,QAASqB,KAElCb,UAAW,UACXY,MAAM,GAGR,OAAOrC,KAAKC,UAAUiB,GAGxBpB,cAAce,EAAcyB,GAE1B,MAAMpB,EAAkC,CACtCC,KAAM,YAAYC,mBAAmBP,KACrCQ,KAAM,CACJC,OAAQ,MACRC,QAAS,CACPC,OAAQ,mBACRe,eAAgB,oBAElBR,KAAMS,KAAKC,UAAU,CAAExB,QAASqB,KAElCb,UAAW,UACXY,MAAM,GAGR,OAAOrC,KAAKC,UAAUiB,GAGxBpB,cAAce,GAEZ,MAAMK,EAA8B,CAClCC,KAAM,YAAYC,mBAAmBP,KACrCQ,KAAM,CACJC,OAAQ,SACRC,QAAS,CACPC,OAAQ,qBAGZC,UAAWiB,EACXL,MAAM,GAGR,OAAOrC,KAAKC,UAAUiB,QCpIbyB,EAAb,QAAaA,KALZC,EAAQ,CACP9C,MAAM+C,GACJA,EAAMC,QAAQ,CAAEC,EAAGpD,EAAgBqD,GAAInD,QAG9B8C"}