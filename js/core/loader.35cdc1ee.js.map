{"version":3,"file":"loader.35cdc1ee.js","sources":["../../../src/core/loader/loader.component.ts","../../../src/reusable/render-html.decorator.ts","../../../src/core/loader/render-loader.decorator.ts"],"sourcesContent":["import { Attribute, BootstrapWindow, Component, ComponentContext, ElementRenderer, Render } from '@wesib/wesib';\nimport { Conduit__NS } from '../index';\n\n@Component(['loader', Conduit__NS])\nexport class LoaderComponent {\n\n  @Attribute('load-error')\n  loadError?: string | null;\n\n  constructor(private readonly _context: ComponentContext) {\n  }\n\n  @Render()\n  render(): ElementRenderer {\n\n    const { document } = this._context.get(BootstrapWindow);\n    const range = document.createRange();\n\n    range.selectNodeContents(this._context.contentRoot);\n\n    return () => {\n      range.deleteContents();\n      if (this.loadError != null) {\n        range.insertNode(document.createTextNode(this.loadError));\n      }\n    };\n  }\n\n}\n","import { StatePath } from '@proc7ts/fun-events';\nimport {\n  BootstrapWindow,\n  ComponentClass,\n  ComponentContext,\n  ComponentProperty,\n  ComponentPropertyDecorator,\n  ElementRenderer,\n  Render,\n} from '@wesib/wesib';\n\nexport function RenderHTML<T extends ComponentClass>(\n    def: {\n      path?: StatePath;\n      comment?: string;\n    } = {},\n): ComponentPropertyDecorator<() => string | Node | null | undefined, T> {\n  return ComponentProperty(({ get, key }) => {\n\n    const {\n      comment = String(key),\n      path,\n    } = def;\n\n    return {\n      componentDef: Render({ path }).As(renderHTML, key),\n    };\n\n    function renderHTML(this: InstanceType<T>): ElementRenderer {\n\n      const context = ComponentContext.of(this);\n      const { document } = context.get(BootstrapWindow);\n      const { contentRoot }: { contentRoot: Node } = context;\n      const start = contentRoot.appendChild(document.createComment(`[${comment}[`));\n      const end = contentRoot.appendChild(document.createComment(`]${comment}]`));\n      const range = document.createRange();\n\n      range.setStartAfter(start);\n      range.setEndBefore(end);\n\n      return () => {\n        range.deleteContents();\n\n        const html = get(this).call(this);\n\n        if (!html) {\n          return;\n        }\n        if (typeof html === 'string') {\n\n          const node = document.createElement('template');\n\n          node.innerHTML = html;\n          range.insertNode(node.content);\n        } else {\n          range.insertNode(html);\n        }\n      };\n    }\n  });\n}\n","import { StatePath } from '@proc7ts/fun-events';\nimport { css__naming, QualifiedName } from '@proc7ts/namespace-aliaser';\nimport { RenderExecution } from '@proc7ts/render-scheduler';\nimport {\n  ComponentClass,\n  ComponentContext,\n  ComponentDef,\n  ComponentProperty,\n  ComponentPropertyDecorator,\n  DefaultNamespaceAliaser,\n  ElementRenderer,\n  Render,\n} from '@wesib/wesib';\nimport { ApiErrorGenerator, RenderHTML } from '../../reusable';\nimport { ApiResponse } from '../api';\nimport { Conduit__NS } from '../conduit.ns';\nimport { LoaderComponent } from './loader.component';\n\nexport type LoadStatus =\n    | LoadStatus.Succeed\n    | LoadStatus.Failed;\n\nexport namespace LoadStatus {\n\n  export interface Succeed {\n    readonly ok: true;\n  }\n\n  export interface Failed {\n    readonly ok: false;\n    readonly errors: ApiResponse.Errors;\n  }\n\n}\n\nconst LoadStatus__symbol = (/*#__PURE__*/ Symbol('load-status'));\nconst defaultLoadedClass: QualifiedName = ['loaded', Conduit__NS];\n\nexport function RenderLoader<T extends ComponentClass>(\n    def: {\n      loaded?: QualifiedName;\n      path?: StatePath;\n      comment?: string;\n    } = {},\n): ComponentPropertyDecorator<LoadStatus | undefined, T> {\n  return ComponentProperty(({ get, set: setValue, key }) => {\n\n    const {\n      path = [LoadStatus__symbol, key],\n      loaded = defaultLoadedClass,\n      comment = String(key),\n    } = def;\n    let loadedClassName: string;\n\n    return {\n      componentDef: ComponentDef.all(\n          {\n            feature: {\n              needs: LoaderComponent,\n            },\n            define(defContext) {\n              loadedClassName = css__naming.name(loaded, defContext.get(DefaultNamespaceAliaser));\n            },\n          },\n          Render({ path }).As(updateClass, key),\n          RenderHTML({ path, comment: `LOADER(${comment})` }).As(renderLoader, key),\n          RenderHTML({ path, comment: `ERRORS(${comment})` }).As(renderErrors, key),\n      ),\n      get,\n      set(component, value) {\n\n        const prev = get(component);\n\n        setValue(component, value);\n        ComponentContext.of(component).updateState(path, value, prev);\n      },\n    };\n\n    function updateClass(this: InstanceType<T>): ElementRenderer {\n\n      const { element }: { element: Element } = ComponentContext.of(this);\n\n      return (execution: RenderExecution) => {\n\n        const status = get(this);\n\n        if (status && status.ok) {\n          // Make contents visible in the very end\n          execution.postpone(() => {\n            element.classList.add(loadedClassName);\n          });\n        } else {\n          element.classList.remove(loadedClassName);\n        }\n      };\n    }\n\n    function renderLoader(this: InstanceType<T>): Node | undefined {\n\n      const status = get(this);\n\n      return !status ? document.createElement('conduit-loader') : undefined;\n    }\n\n    function renderErrors(this: InstanceType<T>): Node | undefined {\n\n      const status = get(this);\n\n      return status && !status.ok\n          ? ComponentContext.of(this).get(ApiErrorGenerator)(status.errors)\n          : undefined;\n    }\n\n  });\n}\n"],"names":["LoaderComponent","[object Object]","_context","this","document","get","BootstrapWindow","range","createRange","selectNodeContents","contentRoot","deleteContents","loadError","insertNode","createTextNode","RenderHTML","def","ComponentProperty","key","comment","String","path","componentDef","Render","As","context","ComponentContext","of","start","appendChild","createComment","end","setStartAfter","setEndBefore","html","call","node","createElement","innerHTML","content","__decorate","Attribute","Component","Conduit__NS","LoadStatus__symbol","Symbol","defaultLoadedClass","RenderLoader","set","setValue","loaded","loadedClassName","ComponentDef","all","feature","needs","defContext","css__naming","name","DefaultNamespaceAliaser","element","execution","status","ok","postpone","classList","add","remove","undefined","ApiErrorGenerator","errors","component","value","prev","updateState"],"mappings":"sUAIaA,EAAb,MAKEC,YAA6BC,GAAAC,cAAAD,EAI7BD,SAEE,MAAMG,SAAEA,GAAaD,KAAKD,SAASG,IAAIC,GACjCC,EAAQH,EAASI,cAIvB,OAFAD,EAAME,mBAAmBN,KAAKD,SAASQ,aAEhC,KACLH,EAAMI,iBACgB,MAAlBR,KAAKS,WACPL,EAAMM,WAAWT,EAASU,eAAeX,KAAKS,wBCZtCG,EACZC,EAGI,IAEN,OAAOC,EAAkB,EAAGZ,IAAAA,EAAKa,IAAAA,MAE/B,MAAMC,QACJA,EAAUC,OAAOF,GAAIG,KACrBA,GACEL,EAEJ,MAAO,CACLM,aAAcC,EAAO,CAAEF,KAAAA,IAAQG,IAGjC,WAEE,MAAMC,EAAUC,EAAiBC,GAAGxB,OAC9BC,SAAEA,GAAaqB,EAAQpB,IAAIC,IAC3BI,YAAEA,GAAuCe,EACzCG,EAAQlB,EAAYmB,YAAYzB,EAAS0B,cAAc,IAAIX,OAC3DY,EAAMrB,EAAYmB,YAAYzB,EAAS0B,cAAc,IAAIX,OACzDZ,EAAQH,EAASI,cAKvB,OAHAD,EAAMyB,cAAcJ,GACpBrB,EAAM0B,aAAaF,GAEZ,KACLxB,EAAMI,iBAEN,MAAMuB,EAAO7B,EAAIF,MAAMgC,KAAKhC,MAE5B,GAAK+B,EAGL,GAAoB,iBAATA,EAAmB,CAE5B,MAAME,EAAOhC,EAASiC,cAAc,YAEpCD,EAAKE,UAAYJ,EACjB3B,EAAMM,WAAWuB,EAAKG,cAEtBhC,EAAMM,WAAWqB,MA9ByBhB,MDlBlDsB,GADCC,EAAU,+CAOXD,GADCjB,gCARUvB,KADZ0C,EAAU,CAAC,SAAUC,KACT3C,GE+Bb,MAAM4C,EAAoCC,OAAO,eAC3CC,EAAoC,CAAC,SAAUH,YAErCI,EACZ/B,EAII,IAEN,OAAOC,EAAkB,EAAGZ,IAAAA,EAAK2C,IAAKC,EAAU/B,IAAAA,MAE9C,MAAMG,KACJA,EAAO,CAACuB,EAAoB1B,GAAIgC,OAChCA,EAASJ,EAAkB3B,QAC3BA,EAAUC,OAAOF,IACfF,EACJ,IAAImC,EAEJ,MAAO,CACL7B,aAAc8B,EAAaC,IACvB,CACEC,QAAS,CACPC,MAAOvD,GAETC,OAAOuD,GACLL,EAAkBM,EAAYC,KAAKR,EAAQM,EAAWnD,IAAIsD,MAG9DpC,EAAO,CAAEF,KAAAA,IAAQG,IAcvB,WAEE,MAAMoC,QAAEA,GAAkClC,EAAiBC,GAAGxB,MAE9D,OAAQ0D,IAEN,MAAMC,EAASzD,EAAIF,MAEf2D,GAAUA,EAAOC,GAEnBF,EAAUG,SAAS,KACjBJ,EAAQK,UAAUC,IAAIf,KAGxBS,EAAQK,UAAUE,OAAOhB,MA5BQjC,GACjCH,EAAW,CAAEM,KAAAA,EAAMF,QAAS,UAAUA,OAAcK,IAgC1D,WAIE,OAFenB,EAAIF,WAEyCiE,EAA3ChE,SAASiC,cAAc,oBApCiCnB,GACrEH,EAAW,CAAEM,KAAAA,EAAMF,QAAS,UAAUA,OAAcK,IAsC1D,WAEE,MAAMsC,EAASzD,EAAIF,MAEnB,OAAO2D,IAAWA,EAAOC,GACnBrC,EAAiBC,GAAGxB,MAAME,IAAIgE,EAA9B3C,CAAiDoC,EAAOQ,aACxDF,IA5CmElD,IAEzEb,IAAAA,EACAJ,IAAIsE,EAAWC,GAEb,MAAMC,EAAOpE,EAAIkE,GAEjBtB,EAASsB,EAAWC,GACpB9C,EAAiBC,GAAG4C,GAAWG,YAAYrD,EAAMmD,EAAOC"}