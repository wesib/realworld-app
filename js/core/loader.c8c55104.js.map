{"version":3,"file":"loader.c8c55104.js","sources":["../../../src/core/loader/loader.component.ts","../../../src/reusable/render-html.decorator.ts","../../../src/core/loader/render-loader.decorator.ts"],"sourcesContent":["import { Attribute, BootstrapWindow, Component, ComponentContext, ElementRenderer, Render } from '@wesib/wesib';\nimport { Conduit__NS } from '../index';\n\n@Component(['loader', Conduit__NS])\nexport class LoaderComponent {\n\n  @Attribute('load-error')\n  loadError?: string | null;\n\n  constructor(private readonly _context: ComponentContext) {\n  }\n\n  @Render()\n  render(): ElementRenderer {\n\n    const { document } = this._context.get(BootstrapWindow);\n    const range = document.createRange();\n\n    range.selectNodeContents(this._context.contentRoot);\n\n    return () => {\n      range.deleteContents();\n      if (this.loadError != null) {\n        range.insertNode(document.createTextNode(this.loadError));\n      }\n    };\n  }\n\n}\n","import {\n  BootstrapWindow,\n  ComponentClass,\n  ComponentContext,\n  ComponentProperty,\n  ComponentPropertyDecorator,\n  ElementRenderer,\n  Render,\n  RenderDef,\n} from '@wesib/wesib';\n\nexport function RenderHTML<T extends ComponentClass>(\n    def: {\n      render?: RenderDef;\n      comment?: string;\n    } = {},\n): ComponentPropertyDecorator<() => string | Node | null | undefined, T> {\n  return ComponentProperty(({ get, key }) => {\n\n    const {\n      comment = String(key),\n      render,\n    } = def;\n\n    return {\n      componentDef: Render(render).As(renderHTML, key),\n    };\n\n    function renderHTML(this: InstanceType<T>): ElementRenderer {\n\n      const context = ComponentContext.of(this);\n      const { document } = context.get(BootstrapWindow);\n      const { contentRoot }: { contentRoot: Node } = context;\n      const start = contentRoot.appendChild(document.createComment(`[${comment}[`));\n      const end = contentRoot.appendChild(document.createComment(`]${comment}]`));\n      const range = document.createRange();\n\n      range.setStartAfter(start);\n      range.setEndBefore(end);\n\n      return () => {\n        range.deleteContents();\n\n        const html = get(this).call(this);\n\n        if (!html) {\n          return;\n        }\n        if (typeof html === 'string') {\n\n          const node = document.createElement('template');\n\n          node.innerHTML = html;\n          range.insertNode(node.content);\n        } else {\n          range.insertNode(html);\n        }\n      };\n    }\n  });\n}\n","import { css__naming, QualifiedName } from '@proc7ts/namespace-aliaser';\nimport { RenderExecution } from '@proc7ts/render-scheduler';\nimport {\n  ComponentClass,\n  ComponentContext,\n  ComponentDef,\n  ComponentProperty,\n  ComponentPropertyDecorator,\n  DefaultNamespaceAliaser,\n  ElementRenderer,\n  Render,\n  RenderDef,\n  RenderPath__root,\n} from '@wesib/wesib';\nimport { ApiErrorGenerator, RenderHTML } from '../../reusable';\nimport { ApiResponse } from '../api';\nimport { Conduit__NS } from '../conduit.ns';\nimport { LoaderComponent } from './loader.component';\n\nexport type LoadStatus =\n    | LoadStatus.Succeed\n    | LoadStatus.Failed;\n\nexport namespace LoadStatus {\n\n  export interface Succeed {\n    readonly ok: true;\n  }\n\n  export interface Failed {\n    readonly ok: false;\n    readonly errors: ApiResponse.Errors;\n  }\n\n}\n\nconst LoadStatus__symbol = (/*#__PURE__*/ Symbol('load-status'));\nconst defaultLoadedClass: QualifiedName = ['loaded', Conduit__NS];\n\nexport function RenderLoader<T extends ComponentClass>(\n    def: {\n      loaded?: QualifiedName;\n      render?: RenderDef.Spec;\n      comment?: string;\n    } = {},\n): ComponentPropertyDecorator<LoadStatus | undefined, T> {\n  return ComponentProperty(({ get, set: setValue, key }) => {\n\n    const {\n      render: renderSpec = {},\n      loaded = defaultLoadedClass,\n      comment = String(key),\n    } = def;\n    const path = [RenderPath__root, LoadStatus__symbol, key];\n    let loadedClassName: string;\n    const render = RenderDef.fulfill({ on: path }, renderSpec);\n\n    return {\n      componentDef: ComponentDef.all(\n          {\n            feature: {\n              needs: LoaderComponent,\n            },\n            define(defContext) {\n              loadedClassName = css__naming.name(loaded, defContext.get(DefaultNamespaceAliaser));\n              if (renderSpec.on) {\n                defContext.whenComponent(context => {\n                  RenderDef.trigger(context, renderSpec)\n                      .to(() => context.updateState(path, 'new', 'old'));\n                });\n              }\n            },\n          },\n          Render(render).As(updateClass, key),\n          RenderHTML({ render, comment: `LOADER(${comment})` }).As(renderLoader, key),\n          RenderHTML({ render, comment: `ERRORS(${comment})` }).As(renderErrors, key),\n      ),\n      get,\n      set(component, value) {\n\n        const prev = get(component);\n\n        setValue(component, value);\n        ComponentContext.of(component).updateState(path, value, prev);\n      },\n    };\n\n    function updateClass(this: InstanceType<T>): ElementRenderer {\n\n      const { element }: { element: Element } = ComponentContext.of(this);\n\n      return (execution: RenderExecution) => {\n\n        const status = get(this);\n\n        if (status && status.ok) {\n          // Make contents visible in the very end\n          execution.postpone(() => {\n            element.classList.add(loadedClassName);\n          });\n        } else {\n          element.classList.remove(loadedClassName);\n        }\n      };\n    }\n\n    function renderLoader(this: InstanceType<T>): Node | undefined {\n\n      const status = get(this);\n\n      return !status ? document.createElement('conduit-loader') : undefined;\n    }\n\n    function renderErrors(this: InstanceType<T>): Node | undefined {\n\n      const status = get(this);\n\n      return status && !status.ok\n          ? ComponentContext.of(this).get(ApiErrorGenerator)(status.errors)\n          : undefined;\n    }\n\n  });\n}\n"],"names":["LoaderComponent","[object Object]","_context","this","document","get","BootstrapWindow","range","createRange","selectNodeContents","contentRoot","deleteContents","loadError","insertNode","createTextNode","RenderHTML","def","ComponentProperty","key","comment","String","render","componentDef","Render","As","context","ComponentContext","of","start","appendChild","createComment","end","setStartAfter","setEndBefore","html","call","node","createElement","innerHTML","content","__decorate","Attribute","Component","Conduit__NS","LoadStatus__symbol","Symbol","defaultLoadedClass","RenderLoader","set","setValue","renderSpec","loaded","path","RenderPath__root","loadedClassName","RenderDef","fulfill","on","ComponentDef","all","feature","needs","defContext","css__naming","name","DefaultNamespaceAliaser","whenComponent","trigger","to","updateState","element","execution","status","ok","postpone","classList","add","remove","undefined","ApiErrorGenerator","errors","component","value","prev"],"mappings":"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"}