import{n as t,a as e}from"../proc7ts/call-thru.7f76a0d9.js";import{S as s,C as r}from"../proc7ts/context-values.7886ab40.js";import{d as i,D as n,e as o,t as a,f as u}from"../proc7ts/fun-events.c2220af5.js";import{B as h,F as c}from"../wesib/wesib.e7f21d38.js";import{_ as p}from"../helpers.e1623395.js";import{n as d,A as _}from"./api.ac725a89.js";const k=new s("auth-service");class l{static get[r](){return k}}const f={};class m extends l{constructor(e){super(),this._context=e,this._token=i(f);const s=e.get(h),r=s.localStorage;this._auth=i(g(r.getItem("wesib-conduit:auth"))),this._token.by(this.authentication().thru_(({token:e})=>this._token.it.token!==e?{token:e}:t)),this._auth.on((function({token:t}){t?r.setItem("wesib-conduit:auth",t):r.removeItem("wesib-conduit:auth")})),new n(s).on("storage").to(({key:t,newValue:e})=>{if("wesib-conduit:auth"===t){const t=e||void 0;this._auth.it.token!==t&&(this._auth.it=g(t))}})}token(t){return(this.token=this._token.read().F)(t)}authentication(t){return(this.authentication=this._auth.read().F)(t)}user(t){return(this.user=this.requireUser().keepThru(t=>t.username?t:f).F)(t)}requireUser(t){let s;return(this.requireUser=this.authentication().keepThru(t=>{if(!t.token)return e({failure:{ok:!1,errors:d()}});if(t.email){const e=i(t);return s=[t,e],o(e)}if(s){const[e,r]=s;if(e.token===t.token)return o(r);r.byNone()}const r=a(u(this.loadUser().thru_(t=>t.ok?t.body:{failure:t}),()=>[f]));return s=[t,r],o(r)}).F)(t)}login(t){return this._request("users/login",t)}register(t){return this._request("users",t)}loadUser(){return this._context.get(_)({path:"user",init:{method:"GET",headers:{Accept:"application/json"}},respondAs:"user",auth:!0}).thru_(t=>(t.ok&&this._setUserSettings(t.body),t))}updateSettings(t){return this._context.get(_)({path:"user",init:{method:"PUT",body:JSON.stringify({user:t}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!0}).thru_(t=>(t.ok&&this._setUserSettings(t.body),t))}logout(){this._auth.it=f}_setUserSettings(t){this._auth.it={...t,token:this._token.it.token||t.token}}_request(t,e){return this._context.get(_)({path:t,init:{method:"POST",body:JSON.stringify({user:e}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!1}).thru_(t=>(this._auth.it=t.ok?t.body:{failure:t},t))}}function g(t){return t?{token:t}:f}let b=(()=>{let t=class{};return t=p([c({setup(t){t.provide({a:l,as:m})}})],t),t})();export{b as A,k as a,l as b,f as n};//# sourceMappingURL=auth.e494f44f.js.map
