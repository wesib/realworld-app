import{g as t}from"../lib/call-thru.00f7427a.js";import{S as e,a as s}from"../lib/context-values.956fc686.js";import{t as i,D as o}from"../lib/fun-events.a21352be.js";import{B as n,F as r}from"../wesib/wesib.e063c4fa.js";import{_ as a}from"../helpers.920c7f83.js";import{A as u}from"./api.bc423b77.js";const h=new e("auth-service");class c{static get[s](){return h}}const p={};class _ extends c{constructor(e){super(),this._context=e,this._token=i(p);const s=e.get(n),r=s.localStorage;this._auth=i(d(r.getItem("wesib-conduit:auth"))),this._token.by(this._auth.read.thru_(({token:e})=>this._token.it.token!==e?{token:e}:t)),this._auth.on((function({token:t}){t?r.setItem("wesib-conduit:auth",t):r.removeItem("wesib-conduit:auth")})),new o(s).on("storage")(({key:t,newValue:e})=>{if("wesib-conduit:auth"===t){const t=e||void 0;this._auth.it.token!==t&&(this._auth.it=d(t))}})}get authentication(){return this._auth.read}get token(){return this._token.read}login(t){return this._request("users/login",t)}register(t){return this._request("users",t)}loadUser(){return this._context.get(u)({path:"user",init:{method:"GET",headers:{Accept:"application/json"}},respondAs:"user",auth:!0}).thru_(t=>(t.ok&&this._setUserSettings(t.body),t))}updateSettings(t){return this._context.get(u)({path:"user",init:{method:"PUT",body:JSON.stringify({user:t}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!0}).thru_(t=>(t.ok&&this._setUserSettings(t.body),t))}logout(){this._auth.it=p}_setUserSettings(t){this._auth.it=Object.assign(Object.assign({},t),{token:this._token.it.token||t.token})}_request(t,e){return this._context.get(u)({path:t,init:{method:"POST",body:JSON.stringify({user:e}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!1}).thru_(t=>(t.ok?this._auth.it=t.body:!1===t.ok&&(this._auth.it={failure:t}),t))}}function d(t){return t?{token:t}:p}let l=class{};l=a([r({setup(t){t.provide({a:c,as:_})}})],l);export{h as A,c as a,l as b};//# sourceMappingURL=auth.e4fdf66e.js.map
