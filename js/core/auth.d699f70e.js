import{v as t}from"../proc7ts/primitives.ada6e792.js";import{a as e,C as s}from"../proc7ts/context-values.bb33d989.js";import{t as o,v as i,c as n,m as r,a,b as u,e as h}from"../proc7ts/fun-events.3d56e7e0.js";import{D as c}from"../frontmeans/dom-events.455a522c.js";import{B as d,F as p}from"../wesib/wesib.342b4a6e.js";import{_ as m}from"../helpers.e1623395.js";import{A as k,n as l}from"./api.de086b78.js";const _=new e("auth-service");class f{static get[s](){return _}}const b={};class g extends f{constructor(e){super(),this._context=e,this._token=o(b);const s=e.get(d),a=s.localStorage;let p;this._auth=o(y(a.getItem("wesib-conduit:auth"))),this._token.by(this.authentication.do(i((({token:t})=>this._token.it.token!==t&&{token:t})))),this._auth.on((function({token:t}){t?a.setItem("wesib-conduit:auth",t):a.removeItem("wesib-conduit:auth")})),this.requireUser=this.authentication.do(n((e=>{if(!e.token)return u({failure:{ok:!1,errors:l()}});if(e.email){const t=o(e);return p=[e,t],t}if(p){const[t,s]=p;if(t.token===e.token)return s;s.byNone()}const s=h(this.loadUser().do(r((t=>t.ok?t.body:{failure:t}),t(b))));return p=[e,s],s}))),this.user=this.requireUser.do(r((t=>t.username?t:b))),new c(s).on("storage")((({key:t,newValue:e})=>{if("wesib-conduit:auth"===t){const t=e||void 0;this._auth.it.token!==t&&(this._auth.it=y(t))}}))}get token(){return this._token.read}get authentication(){return this._auth.read}login(t){return this._request("users/login",t)}register(t){return this._request("users",t)}loadUser(){return this._context.get(k)({path:"user",init:{method:"GET",headers:{Accept:"application/json"}},respondAs:"user",auth:!0}).do(a((t=>(t.ok&&this._setUserSettings(t.body),t))))}updateSettings(t){return this._context.get(k)({path:"user",init:{method:"PUT",body:JSON.stringify({user:t}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!0}).do(a((t=>(t.ok&&this._setUserSettings(t.body),t))))}logout(){this._auth.it=b}_setUserSettings(t){this._auth.it={...t,token:this._token.it.token||t.token}}_request(t,e){return this._context.get(k)({path:t,init:{method:"POST",body:JSON.stringify({user:e}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!1}).do(a((t=>(this._auth.it=t.ok?t.body:{failure:t},t))))}}function y(t){return t?{token:t}:b}let j=class{};j=m([p({setup(t){t.provide({a:f,as:g})}})],j);export{j as A,_ as a,f as b,b as n};//# sourceMappingURL=auth.d699f70e.js.map
