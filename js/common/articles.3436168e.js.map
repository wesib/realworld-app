{"version":3,"file":"articles.3436168e.js","sources":["../../../src/common/articles/article-service.ts","../../../src/common/articles/feed-request.ts","../../../src/common/articles/feed-service.ts","../../../src/common/articles/article-service.impl.ts","../../../src/common/articles/feed-service.impl.ts","../../../src/common/articles/feed-support.feature.ts"],"sourcesContent":["import { ContextRef, SingleContextKey } from 'context-values';\nimport { OnEvent } from 'fun-events';\nimport { ApiResponse } from '../api';\nimport { Article } from './article';\n\nexport interface ArticleService {\n\n  article(slug: string): OnEvent<[ApiResponse<Article>]>;\n\n  htmlContents(article: Article): Promise<Node>;\n\n}\n\nexport const ArticleService: ContextRef<ArticleService> = new SingleContextKey<ArticleService>('article-service');\n\n","import { itsEach, thruIt } from 'a-iterable';\nimport { NextSkip, nextSkip } from 'call-thru';\n\nexport type FeedId = '/personal-feed' | '/global-feed';\n\nexport interface FeedRequest {\n  readonly feed?: FeedId;\n  readonly tag?: string;\n  readonly author?: string;\n  readonly favorited?: string;\n  readonly limit?: number;\n  readonly offset?: number;\n}\n\nconst feedRequestKeys: readonly (keyof FeedRequest)[] = ['feed', 'tag', 'author', 'favorited', 'limit', 'offset'];\n\nexport function feedRequestsEqual(first: FeedRequest, second: FeedRequest): boolean {\n  return feedRequestKeys.every(key => first[key] === second[key]);\n}\n\nexport function feedRequestSearchParams(request: FeedRequest): URLSearchParams {\n\n  const params = new URLSearchParams();\n\n  itsEach(\n      thruIt(\n          feedRequestKeys,\n          key => key !== 'feed' ? key : nextSkip,\n          (key: keyof FeedRequest): [keyof FeedRequest, string] | NextSkip => {\n\n            const value = request[key];\n\n            return value ? [key, String(value)] : nextSkip;\n          },\n      ),\n      ([key, value]) => params.set(key, value),\n  );\n\n  return params;\n}\n","import { ContextRef, SingleContextKey } from 'context-values';\nimport { OnEvent } from 'fun-events';\nimport { ApiResponse } from '../api';\nimport { Article } from './article';\nimport { FeedRequest } from './feed-request';\n\nexport interface ArticleList {\n  readonly articles: readonly Article[];\n  readonly articlesCount: number;\n}\n\nexport interface FeedService {\n\n  articles(request: FeedRequest): OnEvent<[ApiResponse<ArticleList>]>;\n\n  tags(): OnEvent<string[]>;\n\n}\n\nexport const FeedService: ContextRef<FeedService> = new SingleContextKey<FeedService>('feed-service');\n","import { BootstrapContext, BootstrapWindow } from '@wesib/wesib';\nimport { OnEvent } from 'fun-events';\nimport { ApiFetch, ApiRequest, ApiResponse } from '../api';\nimport { Article } from './article';\nimport { ArticleService } from './article-service';\nimport marked from 'marked';\nimport DOMPurify from 'dompurify';\n\nexport class ArticleService$ implements ArticleService {\n\n  private readonly _apiFetch: ApiFetch;\n  private readonly _schedule: (task: () => void) => void;\n  private readonly _purify: DOMPurify.DOMPurifyI;\n\n  constructor(context: BootstrapContext) {\n    this._apiFetch = context.get(ApiFetch);\n\n    const window = context.get(BootstrapWindow);\n\n    this._purify = DOMPurify(window);\n    if ((window as any).requestIdleCallback) {\n      this._schedule = task => (window as any).requestIdleCallback(task, { timeout: 750 });\n    } else {\n      this._schedule = task => window.setTimeout(task);\n    }\n  }\n\n  article(slug: string): OnEvent<[ApiResponse<Article>]> {\n\n    const apiRequest: ApiRequest<Article> = {\n      path: `articles/${encodeURIComponent(slug)}`,\n      init: {\n        method: 'GET',\n        headers: {\n          Accept: 'application/json',\n        },\n      },\n      respondAs: 'article',\n    };\n\n    return this._apiFetch(apiRequest);\n  }\n\n  async htmlContents(article: Article): Promise<Node> {\n\n    const html = await new Promise<string>((resolve, reject) => {\n      this._schedule(() => {\n        marked(article.body, (error, html) => {\n          if (error != null) {\n            reject(error);\n          } else {\n            resolve(html);\n          }\n        });\n      });\n    });\n\n    return this._purify.sanitize(\n        html, {\n          RETURN_DOM_FRAGMENT: true,\n          RETURN_DOM_IMPORT: true,\n        },\n    );\n  }\n\n}\n","import { BootstrapContext } from '@wesib/wesib';\nimport { asis, nextArg, nextArgs, nextSkip } from 'call-thru';\nimport { afterSupplied, OnEvent, onEventBy, trackValueBy } from 'fun-events';\nimport { ApiFetch, ApiRequest, ApiResponse } from '../api';\nimport { FeedId, FeedRequest, feedRequestSearchParams } from './feed-request';\nimport { ArticleList, FeedService } from './feed-service';\n\ninterface FeedSource {\n  path: string;\n  auth?: boolean;\n}\n\nconst feedSources: { readonly [id in FeedId]: FeedSource } = {\n  '/personal-feed': { path: 'articles/feed', auth: true },\n  '/global-feed': { path: 'articles' },\n};\n\nexport class FeedService$ implements FeedService {\n\n  private readonly _apiFetch: ApiFetch;\n  private _tags?: OnEvent<string[]>;\n\n  constructor(context: BootstrapContext) {\n    this._apiFetch = context.get(ApiFetch);\n  }\n\n  articles(request: FeedRequest): OnEvent<[ApiResponse<ArticleList>]> {\n\n    const { path, auth } = feedSources[request.feed || '/global-feed'];\n\n    const apiRequest: ApiRequest<ArticleList> = {\n      path: `${path}?${feedRequestSearchParams(request)}`,\n      init: {\n        method: 'GET',\n        headers: {\n          Accept: 'application/json',\n        },\n      },\n      auth,\n      respondAs: asis,\n    };\n\n    return this._apiFetch(apiRequest);\n  }\n\n  tags(): OnEvent<string[]> {\n    if (this._tags) {\n      return this._tags;\n    }\n\n    let onTags: OnEvent<string[]> | undefined;\n\n    return this._tags = onEventBy(receiver => {\n      if (!onTags) {\n\n        const apiRequest: ApiRequest<string[]> = {\n          path: 'tags',\n          init: {\n            method: 'GET',\n            headers: {\n              Accept: 'application/json',\n            },\n          },\n          respondAs: 'tags',\n          auth: false,\n        };\n        const onTagsLoad: OnEvent<[string[]]> = this._apiFetch(apiRequest).thru_(response => {\n          if (response.ok) {\n            return nextArg(response.body);\n          }\n          if (response.ok === false) {\n            console.log('Failed to load tags', response.errors);\n            return nextArg([]);\n          }\n          return nextSkip;\n        });\n        const tags = trackValueBy<string[] | undefined>(\n            afterSupplied<[string[]?]>(onTagsLoad, () => []),\n        );\n\n        onTags = tags.read.thru_(\n            tagList => tagList ? nextArgs(...tagList) : nextSkip,\n        );\n      }\n\n      onTags(receiver);\n    });\n  }\n\n}\n","import { Feature } from '@wesib/wesib';\nimport { ArticleService } from './article-service';\nimport { ArticleService$ } from './article-service.impl';\nimport { FeedService } from './feed-service';\nimport { FeedService$ } from './feed-service.impl';\n\n@Feature({\n  setup(setup) {\n    setup.provide({ a: ArticleService, as: ArticleService$ });\n    setup.provide({ a: FeedService, as: FeedService$ });\n  },\n})\nexport class FeedSupport {\n}\n"],"names":["ArticleService","SingleContextKey","feedRequestKeys","feedRequestsEqual","first","second","every","key","feedRequestSearchParams","request","params","URLSearchParams","itsEach","thruIt","nextSkip","value","String","set","FeedService","ArticleService$","[object Object]","context","this","_apiFetch","get","ApiFetch","window","BootstrapWindow","_purify","DOMPurify","requestIdleCallback","_schedule","task","timeout","setTimeout","slug","apiRequest","path","encodeURIComponent","init","method","headers","Accept","respondAs","article","html","Promise","resolve","reject","marked","body","error","sanitize","RETURN_DOM_FRAGMENT","RETURN_DOM_IMPORT","feedSources","/personal-feed","auth","/global-feed","FeedService$","feed","asis","_tags","onTags","onEventBy","receiver","onTagsLoad","thru_","response","ok","nextArg","console","log","errors","tags","trackValueBy","afterSupplied","read","tagList","nextArgs","FeedSupport","Feature","setup","provide","a","as"],"mappings":"ieAaaA,EAA6C,IAAIC,EAAiC,mBCCzFC,EAAkD,CAAC,OAAQ,MAAO,SAAU,YAAa,QAAS,mBAExFC,EAAkBC,EAAoBC,GACpD,OAAOH,EAAgBI,MAAMC,GAAOH,EAAMG,KAASF,EAAOE,aAG5CC,EAAwBC,GAEtC,MAAMC,EAAS,IAAIC,gBAgBnB,OAdAC,EACIC,EACIX,EACAK,GAAe,SAARA,EAAiBA,EAAMO,EAC7BP,IAEC,MAAMQ,EAAQN,EAAQF,GAEtB,OAAOQ,EAAQ,CAACR,EAAKS,OAAOD,IAAUD,IAG5C,EAAEP,EAAKQ,KAAWL,EAAOO,IAAIV,EAAKQ,IAG/BL,EACR,MCpBYQ,EAAuC,IAAIjB,EAA8B,sBCXzEkB,EAMXC,YAAYC,GACVC,KAAKC,UAAYF,EAAQG,IAAIC,GAE7B,MAAMC,EAASL,EAAQG,IAAIG,GAE3BL,KAAKM,QAAUC,EAAUH,GACpBA,EAAeI,oBAClBR,KAAKS,UAAYC,GAASN,EAAeI,oBAAoBE,EAAM,CAAEC,QAAS,MAE9EX,KAAKS,UAAYC,GAAQN,EAAOQ,WAAWF,GAI/CZ,QAAQe,GAEN,MAAMC,EAAkC,CACtCC,KAAM,YAAYC,mBAAmBH,KACrCI,KAAM,CACJC,OAAQ,MACRC,QAAS,CACPC,OAAQ,qBAGZC,UAAW,WAGb,OAAOrB,KAAKC,UAAUa,GAGxBhB,mBAAmBwB,GAEjB,MAAMC,QAAa,IAAIC,QAAgB,CAACC,EAASC,KAC/C1B,KAAKS,UAAU,KACbkB,EAAOL,EAAQM,KAAM,CAACC,EAAON,KACd,MAATM,EACFH,EAAOG,GAEPJ,EAAQF,SAMhB,OAAOvB,KAAKM,QAAQwB,SAChBP,EAAM,CACJQ,qBAAqB,EACrBC,mBAAmB,KChD7B,MAAMC,EAAuD,CAC3DC,iBAAkB,CAAEnB,KAAM,gBAAiBoB,MAAM,GACjDC,eAAgB,CAAErB,KAAM,aAG1B,MAAasB,EAKXvC,YAAYC,GACVC,KAAKC,UAAYF,EAAQG,IAAIC,GAG/BL,SAASX,GAEP,MAAM4B,KAAEA,EAAIoB,KAAEA,GAASF,EAAY9C,EAAQmD,MAAQ,gBAE7CxB,EAAsC,CAC1CC,KAAM,GAAGA,KAAQ7B,EAAwBC,KACzC8B,KAAM,CACJC,OAAQ,MACRC,QAAS,CACPC,OAAQ,qBAGZe,KAAAA,EACAd,UAAWkB,GAGb,OAAOvC,KAAKC,UAAUa,GAGxBhB,OACE,GAAIE,KAAKwC,MACP,OAAOxC,KAAKwC,MAGd,IAAIC,EAEJ,OAAOzC,KAAKwC,MAAQE,EAAUC,IAC5B,IAAKF,EAAQ,CAEX,MAAM3B,EAAmC,CACvCC,KAAM,OACNE,KAAM,CACJC,OAAQ,MACRC,QAAS,CACPC,OAAQ,qBAGZC,UAAW,OACXc,MAAM,GAEFS,EAAkC5C,KAAKC,UAAUa,GAAY+B,MAAMC,GACnEA,EAASC,GACJC,EAAQF,EAASlB,OAEN,IAAhBkB,EAASC,IACXE,QAAQC,IAAI,sBAAuBJ,EAASK,QACrCH,EAAQ,KAEVxD,GAEH4D,EAAOC,EACTC,EAA2BV,EAAY,IAAM,KAGjDH,EAASW,EAAKG,KAAKV,MACfW,GAAWA,EAAUC,KAAYD,GAAWhE,GAIlDiD,EAAOE,MAIZ,IC7EYe,EAAb,QAAaA,KANZC,EAAQ,CACP7D,MAAM8D,GACJA,EAAMC,QAAQ,CAAEC,EAAGpF,EAAgBqF,GAAIlE,IACvC+D,EAAMC,QAAQ,CAAEC,EAAGlE,EAAamE,GAAI1B,QAG3BqB"}