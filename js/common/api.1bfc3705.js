import{e}from"../lib/call-thru.00f7427a.js";import{d as t,F as r}from"../lib/context-values.d686e0c8.js";import{k as s,l as o}from"../lib/fun-events.a21352be.js";import{b as n}from"../wesib/wesib.84ff8eb8.js";import{A as i}from"./auth.53fccc19.js";import{H as u}from"../wesib/generic.643f46dc.js";import{I as a}from"../lib/input-aspects.963c1cb4.js";const c=new t("api-root-url",{byDefault:()=>new URL("https://conduit.productionready.io/api/")}),f=new r("api-fetch",{byDefault:n((function(t){const r=t.get(u),n=t.get(c);return u=>{const{path:a,init:c,auth:f}=u,h=n.thru_(e=>new URL(a,e),e=>function(e,t={}){const r=new Request(e.href,Object.assign({mode:"cors"},t)),{headers:s}=r;return s.set("X-Requested-With","XMLHttpRequest"),r}(e,c)).thru_(r=>!1===f?e({request:r}):s(function(e,t,r){return e.get(i).authentication.keep.thru_(({token:e,failure:s})=>e?(t.headers.set("Authorization",`Token ${e}`),{request:t}):r?(s||(s={ok:!1,errors:{api:["Not authenticated"]}}),{failure:s}):{request:t})}(t,r,f)),t=>t.request?s(r(t.request).thru_(e=>({response:e}))):e({failure:t.failure}));return o(h.thru_(p)).thru_(([e,t])=>function({respondAs:e},t,r){if(!t.response)return t.failure;const{response:s}=t;if(s.ok)return{ok:!0,response:s,body:"function"==typeof e?e(r):r[e]};return{ok:!1,response:s,errors:r.errors||{http:[s.statusText?`${s.status}: ${s.statusText}`:`ERROR ${s.status}`]}}}(u,e,t))}}))});function p(e){return e.response?Promise.all([e,e.response.json()]).catch(t=>[{failure:{ok:!1,response:e.response,errors:{api:[`Failed to parse response: ${t}`]}}}]):[e]}function h(e){return new Promise((t,r)=>{e.once(e=>{e.ok?t(e.body):r(new a({submit:"api",api:e.errors}))}).whenOff(e=>{r(e instanceof a?e:new a({submit:"cancel",cancel:e}))})})}export{f as A,h as a};//# sourceMappingURL=api.1bfc3705.js.map
