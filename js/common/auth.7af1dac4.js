import{e as t,v as e}from"../lib/call-thru.00f7427a.js";import{S as s,a as i}from"../lib/context-values.d686e0c8.js";import{t as o,D as r,k as a,b as n,f as u}from"../lib/fun-events.a21352be.js";import{B as h,F as c}from"../wesib/wesib.84ff8eb8.js";import{_ as p}from"../helpers.920c7f83.js";import{A as l}from"./api.c33a392f.js";const f=new s("auth-service");class d{static get[i](){return f}}class m extends d{constructor(s){super(),this._context=s;const i=s.get(h),c=i.localStorage;this._auth=o(b(c.getItem("wesib-conduit:auth"))),this._auth.on((function({token:t}){t?c.setItem("wesib-conduit:auth",t):c.removeItem("wesib-conduit:auth")})),this.user=this.authentication.keep.thru((function(i){if(i.email)return t(i);if(i.failure)return t(void 0,i.failure);if(!i.token)return t();return a(function(i){const o=s.get(l),r={path:"user",init:{headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Token ${i}`}},respondAs:"user",auth:!1};return n(e=>{o(r).thru_(e=>e.ok?t(e.body):t(void 0,e))({supply:u().needs(e.supply),receive(t,...s){e.receive(t,...s)}})},e())}(i.token))})),new r(i).on("storage")(({key:t,newValue:e})=>{if("wesib-conduit:auth"===t){const t=e||void 0;this._auth.it.token!==t&&(this._auth.it=b(t))}})}get authentication(){return this._auth.read}login(t){return this._request("users/login",t)}register(t){return this._request("users",t)}logout(){this._auth.it={}}_request(t,e){return this._context.get(l)({path:t,init:{method:"POST",body:JSON.stringify({user:e}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!1}).thru_(t=>(t.ok?this._auth.it=t.body:!1===t.ok&&(this._auth.it={failure:t}),t))}}function b(t){return t?{token:t}:{}}let _=class{};_=p([c({setup(t){t.provide({a:d,as:m})}})],_);export{f as A,d as a,_ as b};//# sourceMappingURL=auth.7af1dac4.js.map
