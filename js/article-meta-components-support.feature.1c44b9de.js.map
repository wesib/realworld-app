{"version":3,"file":"article-meta-components-support.feature.1c44b9de.js","sources":["../../src/pages/article/current-article.ts","../../src/pages/profile/page-user-profile-param.ts","../../src/pages/article/article-author.component.ts","../../src/pages/article/favorite-post.component.ts","../../src/pages/article/article-meta-components-support.feature.ts"],"sourcesContent":["import { SingleContextUpKey, SingleContextUpRef } from 'context-values/updatable';\nimport {\n  EventSupplier,\n  EventSupply,\n  EventSupply__symbol,\n  eventSupplyOf,\n  OnEvent, onSupplied,\n  trackValue,\n  ValueTracker,\n} from 'fun-events';\nimport { Article } from '../../core/articles';\n\nexport interface UpdatableArticle extends Article {\n  update(article: Article): void;\n}\n\nexport interface NoArticle {\n  readonly slug?: undefined;\n}\n\nexport type CurrentArticle =\n    | UpdatableArticle\n    | NoArticle;\n\nexport const noArticle: NoArticle = {};\nexport const CurrentArticle: SingleContextUpRef<CurrentArticle> = (\n    /*#__PURE__*/ new SingleContextUpKey<CurrentArticle>(\n        'current-article',\n        {\n          byDefault: () => noArticle,\n        },\n    )\n);\n\nexport class CurrentArticleTracker extends ValueTracker<CurrentArticle> {\n\n  private readonly _it = trackValue<CurrentArticle>(noArticle);\n\n  get on(): OnEvent<[CurrentArticle, CurrentArticle]> {\n    return this._it.on;\n  }\n\n  get [EventSupply__symbol](): EventSupply {\n    return eventSupplyOf(this._it);\n  }\n\n  get it(): CurrentArticle {\n    return this._it.it;\n  }\n\n  set it(value: CurrentArticle) {\n    this._it.it = value;\n  }\n\n  set(article: Article | NoArticle): void {\n    this.it = this.cast(article);\n  }\n\n  byArticles(source: EventSupplier<[Article | NoArticle]>): this {\n    return this.by(onSupplied(source).thru_(article => this.cast(article)));\n  }\n\n  cast(article: Article | NoArticle): CurrentArticle {\n    return article.slug\n        ? {\n          ...article,\n          update: updated => this.set(updated),\n        }\n        : noArticle;\n  }\n\n}\n","import { Page, PageHashURLParam, PageParam } from '@wesib/generic';\nimport { FeedRequest, feedRequestSearchParams } from '../../core/feed';\n\nclass PageUserProfileParam$ extends PageParam<FeedRequest, FeedRequest> {\n\n  create(page: Page, input: FeedRequest): PageParam.Handle<FeedRequest, FeedRequest> {\n\n    const handle = this.byDefault(page);\n\n    handle.put(input);\n\n    return handle;\n  }\n\n  byDefault(page: Page): PageParam.Handle<FeedRequest, FeedRequest> {\n    return {\n      get() {\n\n        const { searchParams: params, pathname } = page.get(PageHashURLParam);\n        const slashIdx = pathname.indexOf('/', 1);\n        const user = decodeURIComponent(slashIdx < 0 ? pathname.substring(1) : pathname.substring(1, slashIdx));\n        let author: string | undefined;\n        let favorited: string | undefined;\n\n        if (slashIdx > 0 && pathname.substring(slashIdx + 1) === 'favorite') {\n          favorited = user;\n        } else {\n          author = user;\n        }\n\n        return {\n          tag: params.get('tag') || undefined,\n          author,\n          favorited,\n          limit: parseInt(params.get('limit') || '', 10) || undefined,\n          offset: parseInt(params.get('offset') || '', 10) || undefined,\n        };\n      },\n      put(value) {\n\n        const { favorited, author = '' } = value;\n        const url = new URL(page.get(PageHashURLParam).href);\n\n        url.pathname = favorited\n            ? `/${encodeURIComponent(favorited)}/favorite`\n            : `/${encodeURIComponent(author)}`;\n\n        const searchParams = feedRequestSearchParams({ ...value, favorited: undefined, author: undefined }).toString();\n\n        url.search = searchParams ? '?' + searchParams : '';\n\n        page.put(PageHashURLParam, url);\n      },\n    };\n  }\n\n}\n\nexport const PageUserProfileParam: PageParam.WithDefaults<FeedRequest, FeedRequest> = new PageUserProfileParam$();\n","import { HandleNavLinks, HierarchyContext, Navigation, PageHashURLSupport } from '@wesib/generic';\nimport { BootstrapWindow, Component, ComponentContext, ElementRenderer, Render, StateProperty } from '@wesib/wesib';\nimport { Conduit__NS } from '../../core';\nimport { PageUserProfileParam } from '../profile/page-user-profile-param';\nimport { CurrentArticle } from './current-article';\n\n@Component(\n    ['article-author', Conduit__NS],\n    {\n      feature: {\n        needs: PageHashURLSupport,\n      },\n    },\n    HandleNavLinks(),\n)\nexport class ArticleAuthorComponent {\n\n  @StateProperty()\n  private article: CurrentArticle = {};\n\n  constructor(private readonly _context: ComponentContext) {\n\n    const hierarchy = _context.get(HierarchyContext);\n\n    _context.whenOn(supply => {\n      hierarchy.get(CurrentArticle).tillOff(supply)(article => this.article = article);\n    });\n  }\n\n  @Render()\n  render(): ElementRenderer {\n\n    const navigation = this._context.get(Navigation);\n    const { document } = this._context.get(BootstrapWindow);\n    const { contentRoot }: { contentRoot: Node } = this._context;\n    const fragment = document.createDocumentFragment();\n    const authorImgLink = fragment.appendChild(document.createElement('a'));\n    const info = fragment.appendChild(document.createElement('div'));\n\n    info.className = 'info';\n\n    const authorLink = info.appendChild(document.createElement('a'));\n\n    authorLink.className = 'author';\n\n    const time = info.appendChild(document.createElement('time'));\n\n    time.className = 'date';\n\n    contentRoot.appendChild(fragment);\n\n    return () => {\n\n      const article = this.article;\n\n      let profileURL = '';\n      let profileImage = '';\n      let username = '';\n      let timestamp = '';\n      let postDate = '';\n\n      if (article.slug) {\n\n        const { author } = article;\n\n        profileURL = navigation.with(\n            PageUserProfileParam,\n            { author: author.username },\n        ).pretend('profile/')?.url?.href || '';\n        profileImage = author.image ? `<img src=\"${encodeURI(author.image)}\"/>` : '';\n        username = author.username;\n        timestamp = article.createdAt;\n        postDate = formatArticleDate(new Date(article.createdAt));\n      }\n\n      authorImgLink.href = profileURL;\n      authorImgLink.innerHTML = profileImage;\n      authorLink.href = profileURL;\n      authorLink.innerText = username;\n      time.innerText = postDate;\n      if (timestamp) {\n        time.setAttribute('datetime', timestamp);\n      } else {\n        time.removeAttribute('datetime');\n      }\n    };\n  }\n\n}\n\nconst thisYearDateFormat = new Intl.DateTimeFormat('en-US', { month: 'long', day: 'numeric' });\nconst otherYearFateFormat = new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'long', day: 'numeric' });\n\nfunction formatArticleDate(date: Date): string {\n\n  const now = new Date();\n  const format = now.getFullYear() === date.getFullYear() ? thisYearDateFormat : otherYearFateFormat;\n\n  return format.format(date);\n}\n","import { HierarchyContext } from '@wesib/generic';\nimport { BootstrapWindow, Component, ComponentContext, ElementRenderer, Render, StateProperty } from '@wesib/wesib';\nimport { Conduit__NS } from '../../core';\nimport { ArticleService, ArticlesSupport } from '../../core/articles';\nimport { CurrentArticle, noArticle } from './current-article';\n\n@Component(\n    ['favorite-post', Conduit__NS],\n    {\n      feature: {\n        needs: ArticlesSupport,\n      },\n    },\n)\nexport class FavoritePostComponent {\n\n  @StateProperty()\n  article: CurrentArticle = noArticle;\n\n  constructor(private readonly _context: ComponentContext) {\n\n    const hierarchy = _context.get(HierarchyContext);\n    const articleService = _context.get(ArticleService);\n\n    _context.whenOn(supply => {\n      hierarchy.get(CurrentArticle).tillOff(supply)(article => {\n        this.article = article;\n      });\n    });\n    _context.on('click')(() => {\n\n      const { article } = this;\n\n      if (article.slug) {\n\n        const like = !article.favorited;\n\n        article.update({\n          ...article,\n          favorited: like,\n        });\n        articleService.likeArticle(article.slug, like)(\n            response => {\n              if (this.article.slug) {\n                if (response.ok) {\n                  this.article.update(response.body);\n                } else {\n                  this.article.update(article);\n                  console.error(`Failed to like article ${article.slug}`, response.errors);\n                }\n              }\n            },\n        );\n      }\n    });\n  }\n\n  @Render()\n  render(): ElementRenderer {\n\n    const { contentRoot }: { contentRoot: HTMLElement } = this._context;\n    const { document } = this._context.get(BootstrapWindow);\n    const icon = document.createElement('i');\n\n    contentRoot.insertBefore(icon, contentRoot.childNodes[0]);\n\n    const counter = contentRoot.appendChild(document.createElement('span'));\n\n    counter.className = 'counter';\n\n    return () => {\n      icon.className = this.article.slug && this.article.favorited ? 'ion-heart' : 'ion-ios-heart-outline';\n      counter.innerText = this.article.slug && this.article.favoritesCount ? String(this.article.favoritesCount) : '';\n      contentRoot.className = this.article.slug && this.article.favorited ? 'btn-secondary' : 'btn-outline-secondary';\n    };\n  }\n\n}\n","import { Feature } from '@wesib/wesib';\nimport { ArticleAuthorComponent } from './article-author.component';\nimport { FavoritePostComponent } from './favorite-post.component';\n\n@Feature({\n  needs: [\n    ArticleAuthorComponent,\n    FavoritePostComponent,\n  ],\n})\nexport class ArticleMetaComponentsSupport {\n}\n"],"names":["noArticle","CurrentArticle","SingleContextUpKey","byDefault","CurrentArticleTracker","ValueTracker","[object Object]","this","trackValue","on","_it","EventSupply__symbol","eventSupplyOf","it","value","article","cast","source","by","onSupplied","thru_","slug","update","updated","set","PageUserProfileParam","PageParam","page","input","handle","put","searchParams","params","pathname","get","PageHashURLParam","slashIdx","indexOf","user","decodeURIComponent","substring","author","favorited","tag","undefined","limit","parseInt","offset","url","URL","href","encodeURIComponent","feedRequestSearchParams","toString","search","ArticleAuthorComponent","_context","hierarchy","HierarchyContext","whenOn","supply","tillOff","navigation","Navigation","document","BootstrapWindow","contentRoot","fragment","createDocumentFragment","authorImgLink","appendChild","createElement","info","className","authorLink","time","profileURL","profileImage","username","timestamp","postDate","with","pretend","image","encodeURI","createdAt","date","Date","getFullYear","thisYearDateFormat","otherYearFateFormat","format","innerHTML","innerText","setAttribute","removeAttribute","__decorate","StateProperty","Render","Component","Conduit__NS","feature","needs","PageHashURLSupport","HandleNavLinks","Intl","DateTimeFormat","month","day","year","FavoritePostComponent","articleService","ArticleService","like","likeArticle","response","ok","body","console","error","errors","icon","insertBefore","childNodes","counter","favoritesCount","String","ArticlesSupport","ArticleMetaComponentsSupport","Feature"],"mappings":"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"}