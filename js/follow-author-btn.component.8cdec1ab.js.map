{"version":3,"file":"follow-author-btn.component.8cdec1ab.js","sources":["../../src/pages/profile/current-user-profile.ts","../../src/pages/profile/follow-author-btn.component.ts"],"sourcesContent":["import { SingleContextUpKey, SingleContextUpRef } from '@proc7ts/context-values/updatable';\nimport { afterSupplied, EventKeeper, trackValueBy, ValueTracker } from '@proc7ts/fun-events';\nimport { UserProfile } from '../../core/users';\n\nexport interface UpdatableUserProfile extends UserProfile {\n\n  update(profile: UserProfile): void;\n\n}\nexport interface NoUserProfile {\n  readonly username?: undefined;\n}\n\nexport type CurrentUserProfile =\n    | UpdatableUserProfile\n    | NoUserProfile;\n\nexport const noUserProfile: NoUserProfile = {};\n\nexport const CurrentUserProfile: SingleContextUpRef<CurrentUserProfile> = (\n    /*#__PURE__*/ new SingleContextUpKey<CurrentUserProfile>(\n        'current-user-profile',\n        {\n          byDefault: () => noUserProfile,\n        },\n    )\n);\n\nexport function currentUserProfileBy(\n    source: EventKeeper<[UserProfile | NoUserProfile]>,\n): ValueTracker<CurrentUserProfile> {\n\n  const currentProfile = trackValueBy<CurrentUserProfile>(\n      afterSupplied(source).keepThru_(\n          profile => {\n            if (profile.username == null) {\n              return profile;\n            }\n\n            const update = (updated: UserProfile): void => {\n              currentProfile.it = {\n                ...updated,\n                update,\n              };\n            };\n\n            return {\n              ...profile,\n              update,\n            };\n          },\n      ),\n  );\n\n  return currentProfile;\n}\n","import { escapeHTML } from '@hatsy/hten';\nimport { HierarchyContext } from '@wesib/generic';\nimport { Component, ComponentContext, ContentRoot, ElementRenderer, Render, StateProperty } from '@wesib/wesib';\nimport { Conduit__NS } from '../../core';\nimport { UserService, UserSupport } from '../../core/users';\nimport { CurrentUserProfile, noUserProfile } from './current-user-profile';\n\n@Component(\n    ['follow-author-btn', Conduit__NS],\n    {\n      feature: {\n        needs: UserSupport,\n      },\n    },\n)\nexport class FollowAuthorBtnComponent {\n\n  @StateProperty()\n  private author: CurrentUserProfile = noUserProfile;\n\n  constructor(private readonly _context: ComponentContext) {\n\n    const hierarchy = _context.get(HierarchyContext);\n    const userService = _context.get(UserService);\n\n    hierarchy.get(CurrentUserProfile).to(profile => {\n      this.author = profile;\n    });\n    _context.on('click').to(() => {\n\n      const { author } = this;\n\n      if (author.username) {\n\n        const follow = !author.following;\n\n        author.update({\n          ...author,\n          following: follow,\n        });\n        userService.followUser(author.username, follow).to(\n            response => {\n              if (this.author.username) {\n                if (response.ok) {\n                  this.author.update(response.body);\n                } else {\n                  this.author.update(author);\n                  console.error(`Failed to follow user ${author.username}`, response.errors);\n                }\n              }\n            },\n        );\n      }\n    });\n  }\n\n  @Render()\n  render(): ElementRenderer {\n\n    const { contentRoot, element } = this._context as { contentRoot: ContentRoot; element: Element };\n\n    return () => {\n      if (this.author.username) {\n        element.className = this.author.following ? 'btn-secondary' : 'btn-outline-secondary';\n        contentRoot.innerHTML = `<i class=\"ion-plus-round\"></i> Follow ${escapeHTML(this.author.username)}`;\n      } else {\n        contentRoot.innerHTML = '';\n      }\n\n    };\n  }\n\n}\n"],"names":["noUserProfile","CurrentUserProfile","SingleContextUpKey","byDefault","currentUserProfileBy","source","currentProfile","trackValueBy","afterSupplied","keepThru_","profile","username","update","updated","it","FollowAuthorBtnComponent","[object Object]","_context","this","hierarchy","get","HierarchyContext","userService","UserService","to","author","on","follow","following","followUser","response","ok","body","console","error","errors","contentRoot","element","className","innerHTML","escapeHTML","__decorate","StateProperty","Render","Component","Conduit__NS","feature","needs","UserSupport"],"mappings":"yZAiBaA,EAA+B,GAE/BC,MACSC,EACd,uBACA,CACEC,UAAW,IAAMH,aAKXI,EACZC,GAGF,MAAMC,EAAiBC,EACnBC,EAAcH,GAAQI,WAClBC,IACE,GAAwB,MAApBA,EAAQC,SACV,OAAOD,EAGT,MAAME,EAAUC,IACdP,EAAeQ,GAAK,IACfD,EACHD,OAAAA,IAIJ,MAAO,IACFF,EACHE,OAAAA,OAMZ,OAAON,MCvCIS,EAAb,MAKEC,YAA6BC,GAAAC,cAAAD,EAFrBC,YAA6BlB,EAInC,MAAMmB,EAAYF,EAASG,IAAIC,GACzBC,EAAcL,EAASG,IAAIG,GAEjCJ,EAAUC,IAAInB,GAAoBuB,IAAGd,IACnCQ,KAAKO,OAASf,KAEhBO,EAASS,GAAG,SAASF,IAAG,KAEtB,MAAMC,OAAEA,GAAWP,KAEnB,GAAIO,EAAOd,SAAU,CAEnB,MAAMgB,GAAUF,EAAOG,UAEvBH,EAAOb,OAAO,IACTa,EACHG,UAAWD,IAEbL,EAAYO,WAAWJ,EAAOd,SAAUgB,GAAQH,IAC5CM,IACMZ,KAAKO,OAAOd,WACVmB,EAASC,GACXb,KAAKO,OAAOb,OAAOkB,EAASE,OAE5Bd,KAAKO,OAAOb,OAAOa,GACnBQ,QAAQC,MAAM,yBAAyBT,EAAOd,WAAYmB,EAASK,iBAUnFnB,SAEE,MAAMoB,YAAEA,EAAWC,QAAEA,GAAYnB,KAAKD,SAEtC,MAAO,KACDC,KAAKO,OAAOd,UACd0B,EAAQC,UAAYpB,KAAKO,OAAOG,UAAY,gBAAkB,wBAC9DQ,EAAYG,UAAY,yCAAyCC,EAAWtB,KAAKO,OAAOd,aAExFyB,EAAYG,UAAY,MAhD9BE,GADCC,kCAwCDD,GADCE,gCAzCU5B,KARZ6B,EACG,CAAC,oBAAqBC,GACtB,CACEC,QAAS,CACPC,MAAOC,MAIFjC"}