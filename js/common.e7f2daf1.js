import{S as e,a as t,a1 as s,F as n,g as a,a5 as r,U as o,a6 as i,t as u,d as c,a7 as h,w as p,a8 as l,a9 as d,f,aa as b,ab as g,h as m,ac as _,N as w,ad as k,ae as y,L as v}from"./lib.b2c89f25.js";import{b as O,H as j,B as x,F as R,C as T,a as q,A as N,t as S,I as $,c as A,d as L,R as C,D,e as F}from"./wesib.62985baa.js";const I=new e("auth-service");class P{static get[t](){return I}}const U=new s("api-root-url",{byDefault:()=>new URL("https://conduit.productionready.io/api/")}),z=new n("api-fetch",{byDefault:O((function(e){const t=e.get(j),s=e.get(U);return({path:n,init:i,auth:u})=>{const c=s.thru_(e=>new URL(n,e),e=>function(e,t={}){const s=new Request(e.href,Object.assign({mode:"cors"},t)),{headers:n}=s;return n.set("X-Requested-With","XMLHttpRequest"),s}(e,i)).thru_(t=>!1===u?a({request:t}):r(function(e,t,s){return e.get(I).user.keep.thru_((e,n)=>e?(t.headers.set("Authorization",`Token ${e.token}`),{request:t}):s?(n||(n={ok:!1,errors:{api:["Not authenticated"]}}),{failure:n}):{request:t})}(e,t,u)),e=>e.request?r(t(e.request).thru_(e=>({response:e}))):a({failure:e.failure}));return o(c.thru_(E)).thru_(([e,t])=>function(e,t){if(!e.response)return e.failure;const{response:s}=e;if(s.ok)return{ok:!0,response:s,body:t};return{ok:!1,response:s,errors:t.errors||{http:[s.statusText?`${s.status}: ${s.statusText}`:`ERROR ${s.status}`]}}}(e,t))}}))});function E(e){return e.response?Promise.all([e,e.response.json()]).catch(t=>[{failure:{ok:!1,response:e.response,errors:{api:[`Failed to parse response: ${t}`]}}}]):[e]}new n("api-submitter",{byDefault:O((function(e){const t=e.get(z);return e=>{const{init:s={}}=e,{method:n="POST",headers:a={}}=s;return r=>{const o=Object.assign(Object.assign({},e),{init:Object.assign(Object.assign({},s),{method:n,body:JSON.stringify(r),headers:Object.assign(Object.assign({},a),{Accept:"application/json","Content-Type":"application/json"})})});return H(t(o))}}}))});function H(e){return new Promise((t,s)=>{e.once(e=>{e.ok?t(e.body):s(new i({submit:"api",api:e.errors}))}).whenOff(e=>{s(e instanceof i?e:new i({submit:"cancel",cancel:e}))})})}class J extends P{constructor(e){super(),this._context=e;const t=e.get(x).localStorage;this._auth=u(t.getItem("wesib-conduit:auth")),this._auth.on((function(e){e?t.setItem("wesib-conduit:auth","string"==typeof e?e:e.token):t.removeItem("wesib-conduit:auth")})),this.user=this._auth.read.keep.thru((function(t){if(!t)return a();if("string"==typeof t)return r(function(t){const s=e.get(z);return c(e=>{s({path:"user",init:{headers:{Authorization:`Token ${t}`}},auth:!1}).thru_(e=>e.ok?a(e.body):a(void 0,e))({supply:p().needs(e.supply),receive(t,...s){e.receive(t,...s)}})},h())}(t));return a(t)}))}login(e){return this._context.get(z)({path:"users/login",init:{method:"POST",body:JSON.stringify(e),headers:{Accept:"application/json","Content-Type":"application/json"}},auth:!1}).thru_(e=>(e.ok?this._auth.it=e.body:this._auth.it=null,e))}logout(){this._auth.it=null}}let X=class{};function B({mark:e="is-invalid",when:t}={}){return s=>{const n=s.aspect(d);return f({status:s.aspect(b),validity:s.aspect(g)}).keep.thru(({status:[{touched:s,hasFocus:r}],validity:[o]})=>{const i=o.has("incomplete")||o.has("missing");return!s||r&&i?a():m(n.specs(_({mark:e,when:t})))})}}X=l([R({setup(e){e.provide({a:P,as:J})}})],X);const M=new w("https://wesib.github.io/realworld-app/ns/","conduit");let W=class{};W=l([T(["in-error",M],N("code"),q(({control:{control:e},aspects:t,context:s})=>S(s,"code").read.keep.thru_(e=>e?e.trim().split(/\s+/):[]).keep.thru(n=>e.convert(k.to(s.element),t).setup(d,e=>{e.add(y()),e.add(B({when:n}))}))))],W);let G=class{};G=l([R({needs:W})],G);let K=class{};K=l([T(["main",M],$({onResponse({response:e,range:t}){e.ok||(t.deleteContents(),null==e.ok?t.insertNode(document.createTextNode("Loading...")):t.insertNode(document.createTextNode(`Error. ${e.error}`)))}}))],K);let Q=class{};Q=l([T(["navbar",M],L(),A({active:"active"}))],Q);const V=["authenticated",M],Y=["not-authenticated",M];let Z=class{constructor(e){this._context=e,e.whenOn(t=>{e.get(P).user.tillOff(t)((e,t)=>{this.user=e})})}get user(){return this._user}set user(e){const t=this._user;this._user=e,this._context.updateState("user",e,t)}render(){const e=this._context.get(D),t=v.name(V,e),s=v.name(Y,e),{classList:n}=this._context.element;return()=>{this.user?(n.remove(s),n.add(t)):(n.remove(t),n.add(s))}}};l([C()],Z.prototype,"render",null),Z=l([T({name:["container",M],feature:{needs:[K,Q]}})],Z);let ee=class{};ee=l([T(["footer",M],L())],ee);let te=class{};te=l([R({needs:[Z,ee]})],te);let se=class{};se=l([R({needs:[X,G,te]})],se);const ne=F(se);export{P as A,M as C,H as a,B as b,ne as c};//# sourceMappingURL=common.e7f2daf1.js.map
