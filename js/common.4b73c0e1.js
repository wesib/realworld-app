import{t,O as e,o as s,k as r,a6 as n,S as a,a1 as o,F as i,g as c,a7 as u,T as h,a8 as p,a9 as l,aa as d,Z as m,ab as f,a as g,d as _,ac as b,q as k,ad as w,f as y,ae as j,af as O,h as v,ag as x,N as A,w as T,ah as C,ai as R,aj as q,ak as $,al as S,am as F,an as L,a0 as N,K as E,L as H}from"./lib.9ec3b7f1.js";import{b as D,H as U,F as I,B as P,R as z,C as G,a as J,I as M,c as X,A as B,t as K,d as W,e as Z,D as Q,f as V,U as Y,g as tt,h as et,i as st,j as rt,k as nt}from"./wesib.29dab4ef.js";class at{constructor(e){this.data=e,this._html=t()}get createdAt(){return new Date(this.data.createdAt)}get updatedAt(){return new Date(this.data.updatedAt)}get[e](){return this.onHtml}get onHtml(){return s(t=>{this._onHtml?this._onHtml(t):(this._onHtml=this._html.read.thru_(t=>null!=t?t:r),n(this.data.body,(t,e)=>{null!=t?this._html.done(t):this._html.it=e}))})}}const ot=new a("feed-service"),it=new o("api-root-url",{byDefault:()=>new URL("https://conduit.productionready.io/api/")}),ct=new a("auth-service"),ut=new i("api-fetch",{byDefault:D((function(t){const e=t.get(U),s=t.get(it);return r=>{const{path:n,init:a,auth:o}=r,i=s.thru_(t=>new URL(n,t),t=>function(t,e={}){const s=new Request(t.href,Object.assign({mode:"cors"},e)),{headers:r}=s;return r.set("X-Requested-With","XMLHttpRequest"),s}(t,a)).thru_(e=>!1===o?c({request:e}):u(function(t,e,s){return t.get(ct).user.keep.thru_((t,r)=>t?(e.headers.set("Authorization",`Token ${t.token}`),{request:e}):s?(r||(r={ok:!1,errors:{api:["Not authenticated"]}}),{failure:r}):{request:e})}(t,e,o)),t=>t.request?u(e(t.request).thru_(t=>({response:t}))):c({failure:t.failure}));return h(i.thru_(ht)).thru_(([t,e])=>function({respondAs:t},e,s){if(!e.response)return e.failure;const{response:r}=e;if(r.ok)return{ok:!0,response:r,body:"function"==typeof t?t(s):s[t]};return{ok:!1,response:r,errors:s.errors||{http:[r.statusText?`${r.status}: ${r.statusText}`:`ERROR ${r.status}`]}}}(r,t,e))}}))});function ht(t){return t.response?Promise.all([t,t.response.json()]).catch(e=>[{failure:{ok:!1,response:t.response,errors:{api:[`Failed to parse response: ${e}`]}}}]):[t]}new i("api-submitter",{byDefault:D((function(t){const e=t.get(ut);return t=>{const{init:s={}}=t,{method:r="POST",headers:n={}}=s;return a=>{const o=Object.assign(Object.assign({},t),{init:Object.assign(Object.assign({},s),{method:r,body:JSON.stringify(a),headers:Object.assign(Object.assign({},n),{Accept:"application/json","Content-Type":"application/json"})})});return pt(e(o))}}}))});function pt(t){return new Promise((e,s)=>{t.once(t=>{t.ok?e(t.body):s(new p({submit:"api",api:t.errors}))}).whenOff(t=>{s(t instanceof p?t:new p({submit:"cancel",cancel:t}))})})}class lt{constructor(t){this._apiFetch=t.get(ut)}articles(t){return this._articles("articles",t)}feed(t){return this._articles("articles/feed",t,!0)}article(t){const e={path:`articles/${encodeURIComponent(t)}`,init:{method:"GET",headers:{Accept:"application/json"}},respondAs:"article"};return this._apiFetch(e)}_articles(t,e,s){const n=Array.from(l(d(e),([t,e])=>e?m([t,String(e)]):r));n.length&&(t=`${t}?${new URLSearchParams(n)}`);const a={path:t,init:{method:"GET",headers:{Accept:"application/json"}},auth:s,respondAs:({articleCount:t,articles:e})=>({articleCount:t,articles:e.map(t=>new at(t))})};return this._apiFetch(a)}}let dt=class{};dt=f([I({setup(t){t.provide({a:ot,as:lt})}})],dt);class mt{static get[g](){return ct}}class ft extends mt{constructor(e){super(),this._context=e;const s=e.get(P).localStorage;this._auth=t(s.getItem("wesib-conduit:auth")),this._auth.on((function(t){t?s.setItem("wesib-conduit:auth","string"==typeof t?t:t.token):s.removeItem("wesib-conduit:auth")})),this.user=this._auth.read.keep.thru((function(t){if(!t)return c();if("string"==typeof t)return u(function(t){const s=e.get(ut),r={path:"user",init:{headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Token ${t}`}},respondAs:"user",auth:!1};return _(t=>{s(r).thru_(t=>t.ok?c(t.body):c(void 0,t))({supply:k().needs(t.supply),receive(e,...s){t.receive(e,...s)}})},b())}(t));return c(t)}))}login(t){return this._request("users/login",t)}register(t){return this._request("users",t)}logout(){this._auth.it=null}_request(t,e){return this._context.get(ut)({path:t,init:{method:"POST",body:JSON.stringify({user:e}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!1}).thru_(t=>(t.ok?this._auth.it=t.body:this._auth.it=null,t))}}let gt=class{};function _t({mark:t="is-invalid",when:e}={}){return s=>{const r=s.aspect(w);return y({status:s.aspect(j),validity:s.aspect(O)}).keep.thru(({status:[{touched:s,hasFocus:n}],validity:[a]})=>{const o=a.has("incomplete")||a.has("missing");return!s||n&&o?c():v(r.specs(x({mark:t,when:e})))})}}gt=f([I({setup(t){t.provide({a:mt,as:ft})}})],gt);const bt=new A("https://wesib.github.io/realworld-app/ns/","conduit"),kt={};let wt=class{constructor(t){this._context=t,this._errors=kt,t.get(J).get(M).thru_(({control:t})=>t?v(t.aspect(O).read.keep.thru_(t=>t.messages("api").reduce((t,e)=>Object.assign(Object.assign({},t),e.api),kt))):c(kt))(t=>this.errors=t)}get errors(){return this._errors}set errors(t){const e=this._errors;e!==t&&(this._errors=t,this._context.updateState("errors",e,t))}render(){const{contentRoot:t}=this._context,e=this._context.get(P).document;let s;return()=>{s&&(s.remove(),s=void 0),T(d(this.errors),([t,r])=>{s||(s=e.createElement("ul"),s.classList.add("error-messages"));const n=s;r.forEach(s=>{const r=e.createElement("li");r.innerText=`${t} ${s}`,n.appendChild(r)})}),s&&t.append(s)}}};f([z()],wt.prototype,"render",null),wt=f([G(["api-errors",bt])],wt);let yt=class{};yt=f([G(["in-error",bt],B("code"),X(({control:{control:t},aspects:e,context:s})=>K(s,"code").read.keep.thru_(t=>t?t.trim().split(/\s+/):[]).keep.thru(r=>t.convert(C.to(s.element),e).setup(w,t=>{t.add(R()),t.add(_t({when:r}))}))))],yt);let jt=class{};function Ot({emptyModel:t={},form:e={makeForm({node:e,aspects:s}){const r=$(t).setup(w,t=>t.add(R())).setup(S,t=>t.derive(F())),n=L(e.element,{form:r,aspects:s}).setup(w,t=>t.add(r.aspect(w)));return[r,n]}},button:s}={}){return G(V(e),function({select:t="button",pick:e={deep:!0,all:!0}}={}){return G({feature:{needs:W},define(s){s.whenComponent(s=>{const r=s.get(Z),n=s.get(J);s.whenOn(a=>{y({form:n.get(M),button:r.select(t,e).first,aspects:s.get(Q)}).tillOff(a).consume(({form:[{control:t}],button:[e],aspects:[s]})=>t&&e&&q(e.element,{form:t,aspects:s}))})})}})}(s))}function vt(t){return Y(Object.assign(Object.assign({},t),{makeControl:e=>e.context.get(J).get(M).keep.thru_(({form:s})=>{const r=t.makeControl(e);return r?r instanceof N?n(r):v(E(r).keep.thru_((t,e)=>t?(n(t),e?c(t,e):c(t)):c())):c();function n(t){s&&t.aspect(S).derive(s.aspect(S));const e=t.aspect(w);return e.add(R()),e.add(_t()),t}})}))}jt=f([I({needs:[wt,yt]})],jt);let xt=class{};xt=f([G(["main",bt],tt({onResponse({response:t,range:e}){t.ok||(e.deleteContents(),null==t.ok?e.insertNode(document.createTextNode("Loading...")):e.insertNode(document.createTextNode(`Error. ${t.error}`)))}}))],xt);let At=class{};At=f([G(["navbar",bt],st(),et({active:"active"}))],At);const Tt=["authenticated",bt],Ct=["not-authenticated",bt];let Rt=class{constructor(t){this._context=t,t.whenOn(e=>{t.get(mt).user.tillOff(e)((t,e)=>{this.user=t})})}get user(){return this._user}set user(t){const e=this._user;this._user=t,this._context.updateState("user",t,e)}render(){const t=this._context.get(rt),e=H.name(Tt,t),s=H.name(Ct,t),{classList:r}=this._context.element;return()=>{this.user?(r.remove(s),r.add(e)):(r.remove(e),r.add(s))}}};f([z()],Rt.prototype,"render",null),Rt=f([G({name:["container",bt],feature:{needs:[xt,At]}})],Rt);let qt=class{};qt=f([G(["footer",bt],st())],qt);let $t=class{};$t=f([I({needs:[Rt,qt]})],$t);let St=class{};St=f([I({needs:[gt,jt,$t,dt]})],St);const Ft=nt(St);export{mt as A,bt as C,Ot as F,vt as U,pt as a,Ft as c};//# sourceMappingURL=common.4b73c0e1.js.map
