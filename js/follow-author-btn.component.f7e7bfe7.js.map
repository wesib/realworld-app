{"version":3,"file":"follow-author-btn.component.f7e7bfe7.js","sources":["../../src/pages/profile/current-user-profile.ts","../../src/pages/profile/follow-author-btn.component.ts"],"sourcesContent":["import { SingleContextUpKey, SingleContextUpRef } from '@proc7ts/context-values/updatable';\nimport { afterSupplied, EventKeeper, mapAfter_, trackValueBy, ValueTracker } from '@proc7ts/fun-events';\nimport { UserProfile } from '../../core/users';\n\nexport interface UpdatableUserProfile extends UserProfile {\n\n  update(profile: UserProfile): void;\n\n}\nexport interface NoUserProfile {\n  readonly username?: undefined;\n}\n\nexport type CurrentUserProfile =\n    | UpdatableUserProfile\n    | NoUserProfile;\n\nexport const noUserProfile: NoUserProfile = {};\n\nexport const CurrentUserProfile: SingleContextUpRef<CurrentUserProfile> = (\n    /*#__PURE__*/ new SingleContextUpKey<CurrentUserProfile>(\n        'current-user-profile',\n        {\n          byDefault: () => noUserProfile,\n        },\n    )\n);\n\nexport function currentUserProfileBy(\n    source: EventKeeper<[UserProfile | NoUserProfile]>,\n): ValueTracker<CurrentUserProfile> {\n\n  const currentProfile = trackValueBy<CurrentUserProfile>(\n      afterSupplied(source).do(\n          mapAfter_(profile => {\n            if (profile.username == null) {\n              return profile;\n            }\n\n            const update = (updated: UserProfile): void => {\n              currentProfile.it = {\n                ...updated,\n                update,\n              };\n            };\n\n            return {\n              ...profile,\n              update,\n            };\n          }),\n      ),\n  );\n\n  return currentProfile;\n}\n","import { escapeHTML } from '@frontmeans/httongue';\nimport { HierarchyContext } from '@wesib/generic';\nimport { Component, ComponentContext, ContentRoot, ElementRenderer, Render, StateProperty } from '@wesib/wesib';\nimport { Conduit__NS } from '../../core';\nimport { UserService, UserSupport } from '../../core/users';\nimport { CurrentUserProfile, noUserProfile } from './current-user-profile';\n\n@Component(\n    ['follow-author-btn', Conduit__NS],\n    {\n      feature: {\n        needs: UserSupport,\n      },\n    },\n)\nexport class FollowAuthorBtnComponent {\n\n  @StateProperty()\n  private author: CurrentUserProfile = noUserProfile;\n\n  constructor(private readonly _context: ComponentContext) {\n\n    const hierarchy = _context.get(HierarchyContext);\n    const userService = _context.get(UserService);\n\n    hierarchy.get(CurrentUserProfile)(profile => {\n      this.author = profile;\n    });\n    _context.on('click')(() => {\n\n      const { author } = this;\n\n      if (author.username) {\n\n        const follow = !author.following;\n\n        author.update({\n          ...author,\n          following: follow,\n        });\n        userService.followUser(author.username, follow)(\n            response => {\n              if (this.author.username) {\n                if (response.ok) {\n                  this.author.update(response.body);\n                } else {\n                  this.author.update(author);\n                  console.error(`Failed to follow user ${author.username}`, response.errors);\n                }\n              }\n            },\n        );\n      }\n    });\n  }\n\n  @Render()\n  render(): ElementRenderer {\n\n    const { contentRoot, element } = this._context as { contentRoot: ContentRoot; element: Element };\n\n    return () => {\n      if (this.author.username) {\n        element.className = this.author.following ? 'btn-secondary' : 'btn-outline-secondary';\n        contentRoot.innerHTML = `<i class=\"ion-plus-round\"></i> Follow ${escapeHTML(this.author.username)}`;\n      } else {\n        contentRoot.innerHTML = '';\n      }\n\n    };\n  }\n\n}\n"],"names":["noUserProfile","CurrentUserProfile","SingleContextUpKey","byDefault","currentUserProfileBy","source","currentProfile","trackValueBy","afterSupplied","do","mapAfter_","profile","username","update","updated","it","FollowAuthorBtnComponent","[object Object]","_context","this","hierarchy","get","HierarchyContext","userService","UserService","author","on","follow","following","followUser","response","ok","body","console","error","errors","contentRoot","element","className","innerHTML","escapeHTML","__decorate","StateProperty","Render","Component","Conduit__NS","feature","needs","UserSupport"],"mappings":"yaAiBaA,EAA+B,GAE/BC,MACSC,EACd,uBACA,CACEC,UAAW,IAAMH,aAKXI,EACZC,GAGF,MAAMC,EAAiBC,EACnBC,EAAcH,GAAQI,GAClBC,GAAUC,IACR,GAAwB,MAApBA,EAAQC,SACV,OAAOD,EAGT,MAAME,EAAUC,IACdR,EAAeS,GAAK,IACfD,EACHD,OAAAA,IAIJ,MAAO,IACFF,EACHE,OAAAA,QAMZ,OAAOP,MCvCIU,EAAb,MAKEC,YAA6BC,GAAAC,cAAAD,EAFrBC,YAA6BnB,EAInC,MAAMoB,EAAYF,EAASG,IAAIC,GACzBC,EAAcL,EAASG,IAAIG,GAEjCJ,EAAUC,IAAIpB,EAAdmB,EAAkCT,IAChCQ,KAAKM,OAASd,KAEhBO,EAASQ,GAAG,QAAZR,EAAqB,KAEnB,MAAMO,OAAEA,GAAWN,KAEnB,GAAIM,EAAOb,SAAU,CAEnB,MAAMe,GAAUF,EAAOG,UAEvBH,EAAOZ,OAAO,IACTY,EACHG,UAAWD,IAEbJ,EAAYM,WAAWJ,EAAOb,SAAUe,EAAxCJ,EACIO,IACMX,KAAKM,OAAOb,WACVkB,EAASC,GACXZ,KAAKM,OAAOZ,OAAOiB,EAASE,OAE5Bb,KAAKM,OAAOZ,OAAOY,GACnBQ,QAAQC,MAAM,yBAAyBT,EAAOb,WAAYkB,EAASK,iBAUnFlB,SAEE,MAAMmB,YAAEA,EAAWC,QAAEA,GAAYlB,KAAKD,SAEtC,MAAO,KACDC,KAAKM,OAAOb,UACdyB,EAAQC,UAAYnB,KAAKM,OAAOG,UAAY,gBAAkB,wBAC9DQ,EAAYG,UAAY,yCAAyCC,EAAWrB,KAAKM,OAAOb,aAExFwB,EAAYG,UAAY,MAhD9BE,GADCC,kCAwCDD,GADCE,gCAzCU3B,KARZ4B,EACG,CAAC,oBAAqBC,GACtB,CACEC,QAAS,CACPC,MAAOC,MAIFhC"}