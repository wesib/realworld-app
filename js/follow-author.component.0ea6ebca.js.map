{"version":3,"file":"follow-author.component.0ea6ebca.js","sources":["../../src/pages/profile/current-user-profile.ts","../../src/pages/profile/follow-author.component.ts"],"sourcesContent":["import { SingleContextUpKey, SingleContextUpRef } from 'context-values/updatable';\nimport { afterSupplied, EventKeeper, trackValueBy, ValueTracker } from 'fun-events';\nimport { UserProfile } from '../../core/users';\n\nexport interface UpdatableUserProfile extends UserProfile {\n\n  update(profile: UserProfile): void;\n\n}\nexport interface NoUserProfile {\n  readonly username?: undefined;\n}\n\nexport type CurrentUserProfile =\n    | UpdatableUserProfile\n    | NoUserProfile;\n\nexport const noUserProfile: NoUserProfile = {};\n\nexport const CurrentUserProfile: SingleContextUpRef<CurrentUserProfile> = (\n    /*#__PURE__*/ new SingleContextUpKey<CurrentUserProfile>(\n        'current-user-profile',\n        {\n          byDefault: () => noUserProfile,\n        },\n    )\n);\n\nexport function currentUserProfileBy(\n    source: EventKeeper<[UserProfile | NoUserProfile]>,\n): ValueTracker<CurrentUserProfile> {\n\n  const currentProfile = trackValueBy<CurrentUserProfile>(\n      afterSupplied(source).keep.thru_(\n          profile => {\n            if (profile.username == null) {\n              return profile;\n            }\n\n            const update = (updated: UserProfile): void => {\n              currentProfile.it = {\n                ...updated,\n                update,\n              };\n            };\n\n            return {\n              ...profile,\n              update,\n            };\n          },\n      ),\n  );\n\n  return currentProfile;\n}\n","import { HierarchyContext } from '@wesib/generic';\nimport { Component, ComponentContext, ElementRenderer, Render, StateProperty } from '@wesib/wesib';\nimport { Conduit__NS } from '../../core';\nimport { UserService, UserSupport } from '../../core/users';\nimport { escapeHtml } from '../../core/util';\nimport { CurrentUserProfile, noUserProfile } from './current-user-profile';\n\n@Component(\n    ['follow-author', Conduit__NS],\n    {\n      feature: {\n        needs: UserSupport,\n      },\n    },\n)\nexport class FollowAuthorComponent {\n\n  @StateProperty()\n  private author: CurrentUserProfile = noUserProfile;\n\n  constructor(private readonly _context: ComponentContext) {\n\n    const hierarchy = _context.get(HierarchyContext);\n    const userService = _context.get(UserService);\n\n    _context.whenOn(supply => {\n      hierarchy.get(CurrentUserProfile).tillOff(supply)(profile => {\n        this.author = profile;\n      });\n    });\n    _context.on('click')(() => {\n\n      const { author } = this;\n\n      if (author.username) {\n\n        const follow = !author.following;\n\n        author.update({\n          ...author,\n          following: follow,\n        });\n        userService.followUser(author.username, follow)(\n            response => {\n              if (this.author.username) {\n                if (response.ok) {\n                  this.author.update(response.body);\n                } else {\n                  this.author.update(author);\n                  console.error(`Failed to follow user ${author.username}`, response.errors);\n                }\n              }\n            },\n        );\n      }\n    });\n  }\n\n  @Render()\n  render(): ElementRenderer {\n\n    const { contentRoot }: { contentRoot: Element } = this._context;\n\n    return () => {\n      if (this.author.username) {\n        contentRoot.className = this.author.following ? 'btn-secondary' : 'btn-outline-secondary';\n        contentRoot.innerHTML = `<i class=\"ion-plus-round\"></i> Follow ${escapeHtml(this.author.username)}`;\n      } else {\n        contentRoot.innerHTML = '';\n      }\n\n    };\n  }\n\n}\n"],"names":["noUserProfile","CurrentUserProfile","SingleContextUpKey","byDefault","currentUserProfileBy","source","currentProfile","trackValueBy","afterSupplied","keep","thru_","profile","username","update","updated","it","FollowAuthorComponent","[object Object]","_context","this","hierarchy","get","HierarchyContext","userService","UserService","whenOn","supply","tillOff","author","on","follow","following","followUser","response","ok","body","console","error","errors","contentRoot","className","innerHTML","escapeHtml","__decorate","StateProperty","Render","Component","Conduit__NS","feature","needs","UserSupport"],"mappings":"2YAiBaA,EAA+B,GAE/BC,MACSC,EACd,uBACA,CACEC,UAAW,IAAMH,aAKXI,EACZC,GAGF,MAAMC,EAAiBC,EACnBC,EAAcH,GAAQI,KAAKC,MACvBC,IACE,GAAwB,MAApBA,EAAQC,SACV,OAAOD,EAGT,MAAME,EAAUC,IACdR,EAAeS,kCACVD,IACHD,OAAAA,KAIJ,sCACKF,IACHE,OAAAA,OAMZ,OAAOP,MCvCIU,EAAb,MAKEC,YAA6BC,GAAAC,cAAAD,EAFrBC,YAA6BnB,EAInC,MAAMoB,EAAYF,EAASG,IAAIC,GACzBC,EAAcL,EAASG,IAAIG,GAEjCN,EAASO,OAAOC,IACdN,EAAUC,IAAIpB,GAAoB0B,QAAQD,EAA1CN,CAAkDT,IAChDQ,KAAKS,OAASjB,MAGlBO,EAASW,GAAG,QAAZX,CAAqB,KAEnB,MAAMU,OAAEA,GAAWT,KAEnB,GAAIS,EAAOhB,SAAU,CAEnB,MAAMkB,GAAUF,EAAOG,UAEvBH,EAAOf,sCACFe,IACHG,UAAWD,KAEbP,EAAYS,WAAWJ,EAAOhB,SAAUkB,EAAxCP,CACIU,IACMd,KAAKS,OAAOhB,WACVqB,EAASC,GACXf,KAAKS,OAAOf,OAAOoB,EAASE,OAE5BhB,KAAKS,OAAOf,OAAOe,GACnBQ,QAAQC,MAAM,yBAAyBT,EAAOhB,WAAYqB,EAASK,eAUnFrB,SAEE,MAAMsB,YAAEA,GAA0CpB,KAAKD,SAEvD,MAAO,KACDC,KAAKS,OAAOhB,UACd2B,EAAYC,UAAYrB,KAAKS,OAAOG,UAAY,gBAAkB,wBAClEQ,EAAYE,UAAY,yCAAyCC,EAAWvB,KAAKS,OAAOhB,aAExF2B,EAAYE,UAAY,MAlD9BE,GADCC,kCA0CDD,GADCE,gCA3CU7B,KARZ8B,EACG,CAAC,gBAAiBC,GAClB,CACEC,QAAS,CACPC,MAAOC,MAIFlC"}