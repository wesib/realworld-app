import{S as t,c as n,n as e,e as s,a as r,v as o}from"./primitives.d6f0dd1c.js";const i=Symbol("after-event");function c(t){return!!t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof t[i]}function u(n){let e,s;return"function"==typeof n?(e=new t,s=(t,...e)=>n(...e)):(e=n.supply||new t,s=(t,...s)=>{e.isOff||n.receive(t,...s)}),e.whenOff((()=>s=f)),{supply:e,receive:(t,...n)=>s(t,...n)}}function f(t,...n){}function h(t){let n=function e(s){let r=t;const o=[];n=t=>o.push(t);try{for(;;){r=p(r,s);const t=o.shift();if(!t)break;s=t}}finally{n=e}};return(...t)=>n(t)}function p(t,n){const e=[];for(const s of t){const t=e.length;e.push(s);const r={onRecurrent(n){e[t]=u({supply:s.supply,receive(t,...e){n(...e)}})}};s.receive(r,...n)}return e}class a{constructor(){const n=this._rcs=new Set;this.send=h(n),this.supply=new t((()=>{n.clear(),delete this._rcs}))}get size(){return this._rcs?this._rcs.size:0}on(t){const n=u(t),e=n.supply.needs(this),s=this._rcs;return s&&!e.isOff&&(s.add(n),e.whenOff((()=>s.delete(n)))),e}}const l=Symbol("on-event");function y(t){return!!t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof t[l]}class d extends TypeError{constructor(t="No events to send"){super(t)}}function _(t){const n=u(t);let s=h([n]);return n.supply.whenOff((()=>s=e)),(...t)=>s(...t)}function v(){throw new d}function w(e,s){return({supply:r,receive:o})=>{let i=n();e({supply:r,receive:(e,...c)=>{const u=i,f=s(...c);i=f?f({supply:new t((t=>{t!==w&&r.off(t)})).needs(r),receive:o}):n(),u.off(w)}})}}function g(...t){return t.reduce(((t,n)=>n(t)),this)}function m(){return this}function b(t){return({supply:n,receive:e})=>{t({supply:n,receive:(t,...s)=>{e(t,...s),n.off()}})}}function k(n,e){return new Promise(((s,r)=>{b(this)({supply:new t(e?t=>{try{s(e(t))}catch(t){r(t)}}:r),receive:n?(t,...e)=>{try{s(n(...e))}catch(t){r(t)}}:(t,n)=>s(n)})}))}function O(t){const n=new E(t);return n.on.bind(n)}class E extends a{constructor(t){super(),this.supplier=t,this._on=this._onInit()}on(t){return this._on.on(t),t.supply}_onInit(){return{on:n=>{const e=[],s=new t((()=>this._on=this._onInit())),r=this._on=this._onFirst(s,e);try{r.on(n),this.supplier({supply:s,receive:(t,...n)=>this._on.dispatch(...n)})}finally{this._on===r&&(this._on=this._onNext(s,e))}},dispatch:null}}_onFirst(t,n){return{on:e=>this._addReceiver(e,t,n),dispatch:(...t)=>{n.push(t),this.send(...t)}}}_onNext(t,n){return{on:e=>this._addReceiver(e,t,n),dispatch:(...t)=>{n.length=0,this.send(...t)}}}_addReceiver(t,n,e){if(n.cuts(t),super.on(t).whenOff((t=>{this.size||n.off(t)})),e.length){const n=_(t);e.forEach((t=>n(...t)))}}}function x(n,e,s){return r=>{s?n({supply:(new t).needs(e).cuts(s),receive:r.receive}):(r.supply.needs(e),n(r))}}function I(t,n){return e=>{const s=_(e);t({supply:e.supply,receive:(t,...e)=>{n(s,...e)}})}}function R({supply:t}){t.off()}function z(t){const n=n=>{const e=u(n),{supply:s}=e;if(!s.isOff)try{t(e)}catch(t){s.off(t)}return s};return n[l]=m,n.do=g,n.then=k,n}function N(n,s=v,r=j){let o,c=0;const f=i=>{let f=e;const h=u(i);if(h.supply.isOff)return h.supply;const p=(new t).needs(h);let a=!1;++c;try{n({supply:p,receive:(t,...n)=>{a=!0,o=n,f(t,...n)}})}catch(t){p.off(t)}if(!p.isOff||a){if(!o)try{o=s()}catch(t){p.off(t)}o&&(h.receive({onRecurrent(t){f=(n,...e)=>t(...e)}},...o),f=(t,...n)=>h.receive(t,...n))}return p.whenOff((t=>{--c||(o=void 0),h.supply.off(t),c||r(t)}))};return f[l]=m,f.do=g,f.then=k,f[i]=m,f}function j(t){}function S(t){return function(t){return"function"==typeof t&&t[l]===m&&t.do===g&&t.then===k}(t)&&t[i]===m}function U(n){const s=Object.keys(n);return N(O(N((t=>{const{supply:r}=t,o=_(t);let c=e;const u={};s.forEach((t=>{r.needs(n[t][i]()(((...n)=>{u[t]=n,c()})).needs(r))})),r.isOff||(c=()=>o(u))}),(()=>{const e={};return s.forEach((s=>b(n[s][i]())({supply:new t,receive:(t,...n)=>e[s]=n}))),[e]}))))}function A(...n){return N(O(N((t=>{const{supply:s}=t,r=_(t);let o=e;const c=[];n.forEach(((t,n)=>{s.needs(t[i]()(((...t)=>{c[n]=t,o()})).needs(s))})),s.isOff||(o=()=>r(...c))}),(()=>{const e=[];return n.forEach((n=>b(n[i]())({supply:new t,receive:(t,...n)=>e.push(n)}))),e}))))}function F(t,n){return N((n=>t[l]()(n)),n)}function P(t,n){return c(t)?t[i]():F(t,n)}function M(...t){return N(e,o(t))}function q(e){return s=>{let r=n();const o=new t((t=>r.off(t)));return s({supply:o,receive(t,...s){const o=r;try{r=(e(...s)||n()).supply}finally{r!==o&&o.off()}}}),o}}function B(t){return N(O(t))}function C(t,n){const e=D(t,n);return t=>B(e(t))}function D(t,n){const e=(...n)=>{const e=t(...n);return e&&P(e)};return t=>N(w(t,e),n)}class G extends a{constructor(){super(...arguments),this.on=z((t=>super.on(t)))}[l](){return this.on}}const H=z(R);function J(t){return y(t)?t[l]():t[i]()}function K(...n){return n.length?z(O(z((({supply:e,receive:s})=>{let r=n.length;const o=t=>{--r||e.off(t)};n.forEach((n=>J(n)({supply:new t(o).needs(e),receive:s})))})))):H}function L(t){let n=e=>{t.then((()=>n(e)),(()=>n(e)))};return t.then((t=>{n=function(t){return n=>{try{_(n)(t),n.supply.off()}catch(t){n.supply.off(t)}}}(t)})).catch((t=>{var e;e=t,n=({supply:t})=>t.off(e)})),z((t=>n(t)))}function Q(t){return z(O(t))}function T(t){const n=(...n)=>{const e=t(...n);return e&&J(e)};return t=>z(w(t,n))}function V(t){const n=W(t);return t=>Q(n(t))}function W(t){return n=>z(I(n,t))}function X(t){return W(((n,...e)=>t(...e)&&n(...e)))}function Y(t,n){const e=Z(t,n);return t=>B(e(t))}function Z(t,n){return e=>N(I(e,((n,...e)=>n(t(...e)))),n&&(()=>[n()]))}function $(t){const n=tt(t);return t=>Q(n(t))}function tt(t){return n=>z(I(n,((n,...e)=>n(t(...e)))))}function nt(t){return N(b(t))}function et(t){return z(b(t))}function st(t,n){return s(t.supply)?r:e=>z(x(e,t,n))}function rt(n){return z((e=>{const{supply:s}=e,r=_(e),o=new t;let i=0;const c=n.do(st(s,o),$((t=>(++i,t))));let u=[],f=1,h=0;o.whenOff((t=>{i||s.off(t)})),function(t){return z((n=>{const{supply:e}=n,s=_(n);let r=0;t({supply:e,receive(t,n){const o=++r;Promise.resolve().then((()=>n)).then((t=>s(t,o)),(t=>e.off(t)))}})}))}(c)({supply:s,receive(t,n,e){const c=e-f;if(u[c]=n,++h,h>c){let t;h===u.length?(t=u,u=[]):t=u.splice(0,c+1),f+=t.length,h-=t.length,i-=t.length,r(...t),!i&&o.isOff&&s.needs(o)}}})}))}function ot(t,n){return s(t.supply)?r:e=>N(x(e,t,n))}function it(t,n){const e=ct(t,n);return t=>B(e(t))}function ct(t,n){return e=>N(I(e,t),n)}function ut(t){const n=ft(t);return t=>Q(n(t))}function ft(t){return W(((n,...e)=>{const s=t(...e);null!=s&&!1!==s&&n(s)}))}function ht(t){return Array.isArray(t)?t:[t]}class pt{constructor(t){this._drop=t,this.emitter=new G,this._nested=new Map,this.emitter.on(((t,n,e)=>{const s=t[0],r=this._nested.get(s);r&&r.emitter.send(t.slice(1),n,e)}))}on(n){const e=this.emitter.on(n);return new t((t=>{e.off(t),this._dropIfEmpty()})).needs(e)}nest(t,n){const e=this._nested.get(t);if(e||n)return e;const s=new pt((()=>this._remove(t)));return this._nested.set(t,s),s}done(t){for(const n of this._nested.values())n.done(t);this.emitter.supply.off(t)}_remove(t){this._nested.delete(t),this._dropIfEmpty()}_dropIfEmpty(){!this._nested.size&&this.emitter.size<=1&&this._drop()}}class at{constructor(){this._root=new pt(e)}on(t,n){return this._entry(t).on(n)}send(t,n,e){this._root.emitter.send(t,n,e)}done(t,n){const e=this._entry(t,!0);e&&e.done(n)}_entry(t,n){let e=this._root;for(const s of t){const t=e.nest(s,n);if(!t)return;e=t}return e}}class lt{constructor(t,n){this._trackers=t,this._path=n,this.onUpdate=z((t=>this._trackers.on(this._path,t))),this.update=(t,n,e)=>{this._trackers.send([...this._path,...ht(t)],n,e)}}get _tracker(){return this}[l](){return this.onUpdate}track(t){return(t=ht(t)).length?new lt(this._trackers,[...this._path,...t]):this}done(t){this._trackers.done(this._path,t)}}class yt{constructor(){this._tracker=new lt(new at,[])}get onUpdate(){return this._tracker.onUpdate}[l](){return this.onUpdate}get update(){return this._tracker.update}track(t){const n=this._tracker.track(t);return n===this._tracker?this:n}done(t){this._tracker.done(t)}}class dt{constructor(){this._by=n(),this.read=N((t=>{return this.on({supply:(n=t).supply,receive(t,e){n.receive({onRecurrent(n){t.onRecurrent((t=>n(t)))}},e)}});var n}),(()=>[this.it]))}[l](){return this.on}[i](){return this.read}by(t,e){const s=t=>(c(t)?t[i]():t[l]())((t=>this.it=t));if(this.byNone(),e){const n=t;this._by=J(n).do(q(((...t)=>{const n=e(...t);if(n)return s(n)})))}else{const n=t;this._by=s(n)}return this._by.whenOff((()=>this._by=n())),this}byNone(t){return this._by.off(t),this}}class _t extends dt{constructor(t){super(),this._it=t,this._on=new G}get supply(){return this._on.supply}get on(){return this._on.on}get it(){return this._it}set it(t){const n=this._it;n!==t&&(this._it=t,this._on.send(t,n))}}function vt(t){return new _t(t)}function wt(t,n){return vt().by(t,n)}export{i as A,B,F as C,$ as D,G as E,st as F,Q as G,u as H,J as I,K as J,ut as K,y as L,L as M,ht as N,l as O,X as P,S as Q,yt as S,dt as V,tt as a,M as b,C as c,T as d,wt as e,z as f,P as g,W as h,U as i,D as j,Y as k,q as l,Z as m,ct as n,et as o,it as p,V as q,rt as r,ot as s,vt as t,c as u,ft as v,A as w,nt as x,N as y,a as z};//# sourceMappingURL=fun-events.2a5b87d8.js.map
