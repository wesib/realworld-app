import{n as t,a as n,v as e,o as s,p as r}from"./primitives.7b24aae7.js";import{S as o,n as i,i as c}from"./supply.9762ee6d.js";const u=Symbol("after-event");function f(t){return!!t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof t[u]}function p(t){let n,e;return"function"==typeof t?(n=new o,e=(n,...e)=>t(...e)):(n=t.supply||new o,e=(e,...s)=>{n.isOff||t.receive(e,...s)}),n.whenOff((()=>e=h)),{supply:n,receive:(t,...n)=>e(t,...n)}}function h(t,...n){}function a(t){let n=function e(s){let r=t;const o=[];n=t=>o.push(t);try{for(;;){r=l(r,s);const t=o.shift();if(!t)break;s=t}}finally{n=e}};return(...t)=>n(t)}function l(t,n){const e=[];for(const s of t){const t=e.length;e.push(s);const r={onRecurrent(n){e[t]=p({supply:s.supply,receive(t,...e){n(...e)}})}};s.receive(r,...n)}return e}class y{constructor(){const t=this._rcs=new Set;this.send=a(t),this.supply=new o((()=>{t.clear(),delete this._rcs}))}get size(){return this._rcs?this._rcs.size:0}on(t){const n=p(t),e=n.supply.needs(this),s=this._rcs;return s&&!e.isOff&&(s.add(n),e.whenOff((()=>s.delete(n)))),e}}const d=Symbol("on-event");function _(t){return!!t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof t[d]}class v extends TypeError{constructor(t="No events to send"){super(t)}}function w(n){const e=p(n);let s=a([e]);return e.supply.whenOff((()=>s=t)),(...t)=>s(...t)}function m(){throw new v}function g(t,n){return({supply:e,receive:s})=>{let r=i();t({supply:e,receive:(t,...c)=>{const u=r,f=n(...c);r=f?f({supply:new o((t=>{t!==g&&e.off(t)})).needs(e),receive:s}):i(),u.off(g)}})}}function b(...t){return t.reduce(((t,n)=>n(t)),this)}function k(){return this}function O(t){return({supply:n,receive:e})=>{t({supply:n,receive:(t,...s)=>{e(t,...s),n.off()}})}}function E(t,n){return new Promise(((e,s)=>{O(this)({supply:new o(n?t=>{try{e(n(t))}catch(t){s(t)}}:s),receive:t?(n,...r)=>{try{e(t(...r))}catch(t){s(t)}}:(t,n)=>e(n)})}))}function x(t){const n=new R(t);return n.on.bind(n)}class R extends y{constructor(t){super(),this.supplier=t,this._on=this._onInit()}on(t){return this._on.on(t),t.supply}_onInit(){return{on:t=>{const n=[],e=new o((()=>this._on=this._onInit())),s=this._on=this._onFirst(e,n);try{s.on(t),this.supplier({supply:e,receive:(t,...n)=>this._on.dispatch(...n)})}finally{this._on===s&&(this._on=this._onNext(e,n))}},dispatch:null}}_onFirst(t,n){return{on:e=>this._addReceiver(e,t,n),dispatch:(...t)=>{n.push(t),this.send(...t)}}}_onNext(t,n){return{on:e=>this._addReceiver(e,t,n),dispatch:(...t)=>{n.length=0,this.send(...t)}}}_addReceiver(t,n,e){if(n.cuts(t),super.on(t).whenOff((t=>{this.size||n.off(t)})),e.length){const n=w(t);e.forEach((t=>n(...t)))}}}function I(t,n,e){return s=>{e?t({supply:(new o).needs(n).cuts(e),receive:s.receive}):(s.supply.needs(n),t(s))}}function j(t,n){return e=>{const s=w(e);t({supply:e.supply,receive:(t,...e)=>{n(s,...e)}})}}function z({supply:t}){t.off()}function N(t){const n=n=>{const e=p(n),{supply:s}=e;if(!s.isOff)try{t(e)}catch(t){s.off(t)}return s};return n[d]=k,n.do=b,n.then=E,n}function U(n,e=m,s=S){let r,i=0;const c=c=>{let u=t;const f=p(c);if(f.supply.isOff)return f.supply;const h=new o(t).needs(f);let a=!1;++i;try{n({supply:h,receive:(t,...n)=>{a=!0,r=n,u(t,...n)}})}catch(t){h.off(t)}if(!h.isOff||a){if(!r)try{r=e()}catch(t){h.off(t)}r&&(f.receive({onRecurrent(t){u=(n,...e)=>t(...e)}},...r),u=(t,...n)=>f.receive(t,...n))}return h.whenOff((t=>{--i||(r=void 0),f.supply.off(t),i||s(t)}))};return c[d]=k,c.do=b,c.then=E,c[u]=k,c}function S(t){}function A(t){return function(t){return"function"==typeof t&&t[d]===k&&t.do===b&&t.then===E}(t)&&t[u]===k}function F(n){const e=Object.keys(n);return U(x(U((s=>{const{supply:r}=s,o=w(s);let i=t;const c={};e.forEach((t=>{r.needs(n[t][u]()(((...n)=>{c[t]=n,i()})).needs(r))})),r.isOff||(i=()=>o(c))}),(()=>{const t={};return e.forEach((e=>O(n[e][u]())({supply:new o,receive:(n,...s)=>t[e]=s}))),[t]}))))}function M(...n){return U(x(U((e=>{const{supply:s}=e,r=w(e);let o=t;const i=[];n.forEach(((t,n)=>{s.needs(t[u]()(((...t)=>{i[n]=t,o()})).needs(s))})),s.isOff||(o=()=>r(...i))}),(()=>{const t=[];return n.forEach((n=>O(n[u]())({supply:new o,receive:(n,...e)=>t.push(e)}))),t}))))}function P(t,n){return U((n=>t[d]()(n)),n)}function T(t,n){return f(t)?t[u]():P(t,n)}function q(...n){return U(t,e(n))}function B(t){return A(t)?t:q(t)}function C(t){return n=>{let e=i();const s=new o((t=>e.off(t)));return n({supply:s,receive(n,...s){const r=e;try{e=(t(...s)||i()).supply}finally{e!==r&&r.off()}}}),s}}function D(t){return U(x(t))}let G,H;function J(t,n){return t||n?K(t,n):G||(G=K())}function K(t,n){const e=L(t,n);return t=>D(e(t))}function L(t,n){return t||n?V(t,n):H||(H=V())}const Q={};function V(t=W,e=n){return n=>{let s=Q;return U((({supply:r,receive:o})=>n({supply:r,receive(n,...r){const i=e(r);s!==Q&&t(s,i)||(s=i,o(n,...r))}})),void 0,(t=>s=Q))}}function W(t,n){return s(t,n,Math.max(r(t),r(n)))}function X(t,n){const e=Y(t,n);return t=>D(e(t))}function Y(t,n){const e=(...n)=>{const e=t(...n);return e&&T(e)};return t=>U(g(t,e),n)}class Z extends y{constructor(){super(...arguments),this.on=N((t=>super.on(t)))}[d](){return this.on}}const $=N(z);function tt(t){return _(t)?t[d]():t[u]()}function nt(...t){return t.length?N(x(N((({supply:n,receive:e})=>{let s=t.length;const r=t=>{--s||n.off(t)};t.forEach((t=>tt(t)({supply:new o(r).needs(n),receive:e})))})))):$}function et(t){let n=e=>{t.then((()=>n(e)),(()=>n(e)))};return t.then((t=>{n=function(t){return n=>{try{w(n)(t),n.supply.off()}catch(t){n.supply.off(t)}}}(t)})).catch((t=>{var e;e=t,n=({supply:t})=>t.off(e)})),N((t=>n(t)))}function st(t){return N(x(t))}function rt(t){const n=(...n)=>{const e=t(...n);return e&&tt(e)};return t=>N(g(t,n))}function ot(t){const n=it(t);return t=>st(n(t))}function it(t){return n=>N(j(n,t))}function ct(t){return it(((n,...e)=>t(...e)&&n(...e)))}function ut(t,n){const e=ft(t,n);return t=>D(e(t))}function ft(t,n){return e=>U(j(e,((n,...e)=>n(t(...e)))),n&&(()=>[n()]))}function pt(t){const n=ht(t);return t=>st(n(t))}function ht(t){return n=>N(j(n,((n,...e)=>n(t(...e)))))}function at(t){return U(O(t))}function lt(t){return N(O(t))}function yt(t,e){return c(t.supply)?n:n=>N(I(n,t,e))}function dt(t){return N((n=>{const{supply:e}=n,s=w(n),r=new o;let i=0;const c=t.do(yt(e,r),pt((t=>(++i,t))));let u=[],f=1,p=0;r.whenOff((t=>{i||e.off(t)})),function(t){return N((n=>{const{supply:e}=n,s=w(n);let r=0;t({supply:e,receive(t,n){const o=++r;Promise.resolve().then((()=>n)).then((t=>s(t,o)),(t=>e.off(t)))}})}))}(c)({supply:e,receive(t,n,o){const c=o-f;if(u[c]=n,++p,p>c){let t;p===u.length?(t=u,u=[]):t=u.splice(0,c+1),f+=t.length,p-=t.length,i-=t.length,s(...t),!i&&r.isOff&&e.needs(r)}}})}))}function _t(t,e){return c(t.supply)?n:n=>U(I(n,t,e))}function vt(t,n){const e=wt(t,n);return t=>D(e(t))}function wt(t,n){return e=>U(j(e,t),n)}function mt(t){const n=gt(t);return t=>st(n(t))}function gt(t){return it(((n,...e)=>{const s=t(...e);null!=s&&!1!==s&&n(s)}))}function bt(t){return Array.isArray(t)?t:[t]}class kt{constructor(t){this._drop=t,this.emitter=new Z,this._nested=new Map,this.emitter.on(((t,n,e)=>{const s=t[0],r=this._nested.get(s);r&&r.emitter.send(t.slice(1),n,e)}))}on(t){const n=this.emitter.on(t);return new o((t=>{n.off(t),this._dropIfEmpty()})).needs(n)}nest(t,n){const e=this._nested.get(t);if(e||n)return e;const s=new kt((()=>this._remove(t)));return this._nested.set(t,s),s}done(t){for(const n of this._nested.values())n.done(t);this.emitter.supply.off(t)}_remove(t){this._nested.delete(t),this._dropIfEmpty()}_dropIfEmpty(){!this._nested.size&&this.emitter.size<=1&&this._drop()}}class Ot{constructor(){this._root=new kt(t)}on(t,n){return this._entry(t).on(n)}send(t,n,e){this._root.emitter.send(t,n,e)}done(t,n){const e=this._entry(t,!0);e&&e.done(n)}_entry(t,n){let e=this._root;for(const s of t){const t=e.nest(s,n);if(!t)return;e=t}return e}}class Et{constructor(t,n){this._trackers=t,this._path=n,this.onUpdate=N((t=>this._trackers.on(this._path,t))),this.update=(t,n,e)=>{this._trackers.send([...this._path,...bt(t)],n,e)}}get _tracker(){return this}[d](){return this.onUpdate}track(t){return(t=bt(t)).length?new Et(this._trackers,[...this._path,...t]):this}done(t){this._trackers.done(this._path,t)}}class xt{constructor(){this._tracker=new Et(new Ot,[])}get onUpdate(){return this._tracker.onUpdate}[d](){return this.onUpdate}get update(){return this._tracker.update}track(t){const n=this._tracker.track(t);return n===this._tracker?this:n}done(t){this._tracker.done(t)}}class Rt{constructor(){this._by=i(),this.read=U((t=>{return this.on({supply:(n=t).supply,receive(t,e){n.receive({onRecurrent(n){t.onRecurrent((t=>n(t)))}},e)}});var n}),(()=>[this.it]))}[d](){return this.on}[u](){return this.read}by(t,n){const e=t=>(f(t)?t[u]():t[d]())((t=>this.it=t));if(this.byNone(),n){const s=t;this._by=tt(s).do(C(((...t)=>{const s=n(...t);if(s)return e(s)})))}else{const n=t;this._by=e(n)}return this._by.whenOff((()=>this._by=i())),this}byNone(t){return this._by.off(t),this}}class It extends Rt{constructor(t){super(),this._it=t,this._on=new Z}get supply(){return this._on.supply}get on(){return this._on.on}get it(){return this._it}set it(t){const n=this._it;n!==t&&(this._it=t,this._on.send(t,n))}}function jt(t){return new It(t)}function zt(t,n){return jt().by(t,n)}export{u as A,st as B,p as C,y as D,Z as E,vt as F,L as G,J as H,w as I,tt as J,nt as K,mt as L,_ as M,et as N,d as O,bt as P,ot as Q,ct as R,xt as S,f as T,P as U,Rt as V,pt as W,T as a,it as b,ft as c,rt as d,q as e,lt as f,jt as g,X as h,F as i,wt as j,Y as k,B as l,ht as m,ut as n,N as o,at as p,C as q,dt as r,_t as s,zt as t,M as u,gt as v,U as w,A as x,yt as y,D as z};//# sourceMappingURL=fun-events.0c993baf.js.map
