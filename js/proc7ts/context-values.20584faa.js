import{c as e,b as t,y as s,s as r,t as n,j as i,w as o,Q as u,p as a,m as h,f as d,A as c}from"./fun-events.2a5b87d8.js";import{n as l,o as p,v as y,S as f,p as _,s as w,q as m,c as v}from"./primitives.d6f0dd1c.js";import{m as g,l as b,d as x,v as K,b as k}from"./push-iterator.8feb4ef8.js";class S extends Error{constructor(e,t=`There is no value with key ${e}`){super(t),this.key=e}}const D=Symbol("ContextKey");class ${constructor(e){this.name=e}get[D](){return this}toString(){return`ContextKey(${this.name})`}}class C extends ${constructor(e){super(`${e.name}:seed`)}get seedKey(){return this}grow(e){const{seeder:t,seed:s}=e;t.isEmpty(s)&&e.hasFallback||e.insert(s)}}class B{}class F{constructor(){this._providers=[]}provide(e){const t=[e];return this._providers.unshift(t),new f((()=>this._providers.splice(this._providers.lastIndexOf(t),1)))}seed(e,t){const{length:s}=this._providers;if(!s)return t||l;const r=([t])=>_(t.bind(void 0,e));if(!t&&1===s)return r(this._providers[0]);const n=this._providers.map(r);return t&&n.push(t),E(n)}isEmpty(e){return null==e()}combine(e,t){return e===l?t:t===l?e:E([t,e])}}function E(e){return _((()=>{for(const t of e){const e=t();if(null!=e)return e}}))}class O extends C{seeder(){return new F}}class M extends ${constructor(e,{seedKey:t}={}){super(e),this.seedKey=t||new O(this)}}class j extends M{constructor(e,{seedKey:t,byDefault:s=l}={}){super(e,{seedKey:t}),this.byDefault=s}grow(e){const t=e.seed();null!=t?e.insert(t):e.hasFallback||e.insert(this.byDefault(e.context,this))}}class P extends M{constructor(){super("context-supply")}grow(e){e.insert(e.seed()||e.context.supply||(e.hasFallback?e.or:p()))}}const R=new P,T=Symbol("ContextBuilder");class z{constructor(e){this._initial=e,this._issuers=new Map}issuer(e){const t=this._issuers.get(e);if(t)return t;const s=e.seeder(),r=[s,t=>s.seed(t,this._initial(e,t))];return this._issuers.set(e,r),r}newSeed(e,t){const{seedKey:s}=t,[r,n]=this.issuer(s);return s!==t?[r,e.get(s)]:[r,n(e)]}}function H(e){return"with"in e}class I{constructor(e,t,s,r={}){this.context=t,this.key=s,this._opts=r,this._constructed=null,this._setup=l;const[n,i]=e.newSeed(t,s);this.seeder=n,this.seed=i,this.hasFallback="or"in r}get or(){return this._opts.or}insert(e){this._constructed=e}fillBy(e){return e(this),this._constructed}setup(e){const t=this._setup;this._setup=s=>{t(s),e(s)}}_grow(){if(this.key.grow(this),null!=this._constructed)return[this._constructed,this._setup];if(!this.hasFallback)throw new S(this.key);return[this.or]}}class U{constructor(e){this._seeders=new z(e?"function"==typeof e?e:t=>e.get(t):l)}provide(e){if(function(e){return"function"==typeof e[T]}(e))return e[T](this);const{a:{[D]:{seedKey:t}},by:s}=function(e){if(function(e){return"by"in e}(e)){if(!H(e))return e;const{a:t,by:s,with:r}=e;return{a:t,by:e=>s(...r.map((t=>e.get(t))))}}if(function(e){return"is"in e}(e)){const{a:t,is:s}=e;return{a:t,by:y(s)}}if(function(e){return"via"in e}(e)){const{a:t,via:s}=e;return{a:t,by:e=>e.get(s)}}if(function(e){return"as"in e}(e)){if(function(e){return!("a"in e)}(e)&&(e=function(e){return{...e,a:e.as}}(e)),!H(e)){const{as:t}=e;return{a:e.a,by:e=>new t(e)}}const{as:t,with:s}=e;return{a:e.a,by:e=>new t(...s.map((t=>e.get(t))))}}throw new TypeError(`Malformed context value specifier: ${JSON.stringify(e)}`)}(e),[r]=this._seeders.issuer(t);return r.provide(s)}seed(e,t){const[,s]=this._seeders.issuer(t);return s(e)}seeds(){return(e,t)=>this.seed(t,e)}seedIn(e){return this.newValues().get.bind(e)}newValues(){return function(e,t){const s=new Map;return new class extends B{get({[D]:r},n){const i=s.get(r);if(null!=i)return i;const[o,u]=new I(t,this,r,n)._grow();return u&&(s.set(r,o),u({key:r,context:this,registry:e})),o}}}(this,this._seeders)}append(e){const t="function"==typeof e?e:e.seeds();return new U(((e,s)=>{const r=t(e,s),[n,i]=this._seeders.issuer(e),o=i(s);return r?n.combine(o,r,s):o}))}}function V(e=new TypeError("Context destroyed")){return()=>{throw e}}const q=a(((e,...t)=>e(...x(k(...t)))));class A{constructor(){this._providers=n([new Map])}provide(e){const[t]=this._providers.it,s=new f;return t.set(s,e),this._providers.it=[t],s.whenOff((()=>{const[e]=this._providers.it;e.delete(s),this._providers.it=[e]}))}seed(e,s=t()){return this.combine(s,function(e,s){return s.read.do(i((([s])=>s.size?o(...g(g(b((()=>s.values())),(t=>t(e))),J)):t())),q)}(e,this._providers))}isEmpty(){return!1}combine(e,t){return o(e,t).do(q)}}function J(e){return u(e)?e:null!=e?t(e):t()}class N extends C{get upKey(){return this}seeder(){return new A}}class Q extends ${constructor(e,t){super(e.name+":up"),this._key=e,this.grow=e=>{const s=e.fillBy(t);null!=s&&e.insert(s.do(r(e.context.get(R))))}}get seedKey(){return this._key.seedKey}get upKey(){return this}}class G extends ${constructor(e,{seedKey:t}={}){super(e),this.seedKey=t||new N(this)}createUpKey(e){return new Q(this,e)}}class L extends G{constructor(s,{seedKey:r,byDefault:n=l}={}){super(s,r),this.byDefault=(e,t)=>n(e,t)||(()=>{throw new S(this)}),this.upKey=this.createUpKey((s=>s.insert(s.seed.do(e(((...e)=>e.length?t(e[e.length-1]):s.hasFallback&&s.or?s.or:t(this.byDefault(s.context,this))))))))}grow(e){let s;e.context.get(this.upKey,e.hasFallback?{or:null!=e.or?t(e.or):e.or}:void 0)((e=>s=e)).whenOff((e=>s=V(e))),e.insert(((...e)=>s(...e)))}}class W extends G{constructor(e,{seedKey:t,byDefault:s=l}={}){super(e,t),this.byDefault=s}get upKey(){return this}grow(n){const i=n.seed.do(e(((...e)=>{if(e.length)return t(e[e.length-1]);let r;if(n.hasFallback)r=n.or;else{const e=this.byDefault(n.context,this);null!=e&&(r=t(e))}return r||s((({supply:e})=>{e.off(new S(this))}))})));n.insert(i.do(r(n.context.get(R))))}}class X extends Error{constructor(e,t=[],s=function(e,t){const s=t.reduce(((e,[t,s])=>(e?e+=", ":e=": ",e+=void 0!==s?`${t} failed to load (${s})`:`${t} not loaded`)),"");return`Failed to load ${e}${s}`}(e,t)){super(s),this.module=e,this.reasons=t,this.message=s}}class Y{constructor(e,t){this.module=t,this._useCounter=0,this._impl=n(),this._rev=n({status:{module:this.module,provided:!1,used:!1,settled:!1,ready:!1},supply:v()});const s=e.get(R);s.cuts(this._impl),s.cuts(this._rev),this._impl.read((e=>{const t=this._rev.it.supply;e&&this._load(e),t.off()}))}createHandle(){const e=this._rev.read.do(h((({status:e})=>e))),t={read:e,[c]:y(e),use:e=>this._use(t,e)};return t}setup(e,t){this._setup=()=>{const s=this._rev.it,{status:{module:r},supply:n}=s;r!==this.module?e.get(r).use(n).read({supply:n,receive:(e,{settled:t,ready:r,error:n})=>{this._updateStatus(s,t,r,n)}}):async function(e,t,{status:{module:s},supply:r}){const n=new Z(s);return await s.setup({module:s,supply:r,get:t=>e.get(t),provide:e=>t.provide(e).needs(r),initBy(e){n.initBy(e)}}),n}(e,t,s).then((({whenReady:e})=>(this._updateStatus(s,!0,!1),e))).then((()=>this._updateStatus(s,!0,!0))).catch((e=>s.supply.off(e)))}}implementBy(e){this._impl.by(e)}_updateStatus(e,t,s,r){this._rev.it.supply!==e.supply?e.supply.off():this._rev.it=e={status:{module:e.status.module,provided:e.status.provided,used:!0,settled:t,ready:s,error:r},supply:e.supply}}_load(e){const t=(new f).needs(this._rev).whenOff((e=>{this._rev.it.supply===t&&(this._rev.it={status:{...this._rev.it.status,provided:!1,settled:!1,ready:!1,error:e},supply:t})})),s=!!this._useCounter;this._rev.it={status:{module:e,provided:!0,used:s,settled:!1,ready:!1},supply:t},s&&this._setup()}_use(e,t){const s=new f;t&&s.needs(t);const n=e.read.do(r(s)),i={...e,read:n,whenSettled:ee(n,te),whenReady:ee(n,se),supply:s};if(!s.isOff&&(s.whenOff((e=>{if(!--this._useCounter){const t=this._rev.it;this._rev.it={status:{...t.status,used:!1,settled:!1,ready:!1,error:e},supply:(new f).off(e)},t.supply.off(e)}})),!this._useCounter++)){const e=this._rev.it;this._rev.it={status:{...e.status,used:!0},supply:e.supply},this._setup()}return i}}class Z{constructor(e){this._module=e,this._whenDone=Promise.resolve(),this.whenReady=new Promise((e=>this._ready=e))}initBy(e){const t=this._whenDone=this._whenDone.then(e).finally((()=>this._done(t)))}_done(e){this._whenDone===e&&(this._ready(e),this.initBy=e=>{throw new TypeError(`${this._module} initialized already, and does not accept new initializers`)})}}function ee(e,t){return d((s=>e({supply:s.supply,receive:(e,r)=>{t(r)?(s.receive(e,r),s.supply.off()):r.error&&s.supply.off(r.error)}})))}function te({settled:e}){return e}function se({ready:e}){return e}class re extends G{constructor(e,t){super(e),this._module=t}get upKey(){return this}grow(e){const t=new Y(e.context,this._module);var s;e.insert(t.createHandle()),e.setup((({context:e,registry:s})=>t.setup(e,s))),t.implementBy((s=this._module,e.seed.do(h(((...e)=>{let t;for(let r=e.length-1;r>=0&&(t=e[r],t===s);--r);return t})))))}}const ne=Symbol("ContextModule.impl");class ie{constructor(e,t,s){this.name=t,this.options=s,this.key=new re(`${t}:module`,e);const{needs:r,has:n,setup:i}=s;this.has=w(n).add(e),this.needs=w(r),this._setup=i?i.bind(s):l}replace(e,t,s){for(const r of e.has)r!==e&&t.provide({a:r,is:e}).needs(s)}async setup(e){const t=function(e){const{module:t,supply:s}=e;return x(K(t.needs,(r=>r!==t&&e.provide(r).needs(s)&&{dep:r,use:e.get(r).use(e)})))}(e);await oe(e,t,ue)&&(e.initBy((async()=>{await oe(e,t,ae)})),await this._setup(e))}}function oe(e,t,s){const{module:r,supply:n}=e,i=y(!1),o=n.whenDone().then(i,i);return Promise.race([o,Promise.all(t.map((({dep:e,use:t})=>s(t).then(l,(t=>[e,t]))))).then((e=>{const t=e.filter(m);return!t.length||new X(r,t)}))]).then((e=>"boolean"!=typeof e?Promise.reject(e):e))}function ue(e){return e.whenSettled}function ae(e){return e.whenReady}class he{constructor(e,t={}){this[ne]=new ie(this,e,t)}get[D](){return this[ne].key}get name(){return this[ne].name}get needs(){return this[ne].needs}get has(){return this[ne].has}[T](e){const t=e.provide({a:this,is:this});return this[ne].replace(this,e,t),t}setup(e){return this[ne].setup(e)}toString(){return`ContextModule(${this.name})`}}export{D as C,L as F,W as S,j as a,B as b,U as c,G as d,V as e,R as f,he as g,M as h};//# sourceMappingURL=context-values.20584faa.js.map
