import{h as e,e as t,w as s,s as r,z as n,j as i,g as o,k as u,u as a,x as c,c as h,F as d,o as l,A as p}from"./fun-events.0c993baf.js";import{n as y,v as f,l as _,i as w,s as m,q as v}from"./primitives.7b24aae7.js";import{e as g,m as b,b as x,v as K,j as k,l as S}from"./push-iterator.ccd51d52.js";import{S as D,a as C,n as $}from"./supply.9762ee6d.js";class F extends Error{constructor(e,t=`There is no value with key ${e}`){super(t),this.key=e}}const B=Symbol("ContextKey");class j{constructor(e){this.name=e}get[B](){return this}toString(){return`ContextKey(${this.name})`}}class E extends j{constructor(e){super(`${e.name}:seed`)}get seedKey(){return this}grow(e){const{seeder:t,seed:s}=e;t.isEmpty(s)&&e.hasFallback||e.insert(s)}}class O{}const M=Symbol("Contextual");function P(e){return!!e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof e[M]}function z(e){return P(e)?t=>e[M](t):f(e)}class R{constructor(){this._providers=[]}provide(e){const t=[e];return this._providers.unshift(t),new D((()=>this._providers.splice(this._providers.lastIndexOf(t),1)))}seed(e,t){const{length:s}=this._providers;if(!s)return t||y;const r=([t])=>_(t.bind(void 0,e));if(!t&&1===s)return r(this._providers[0]);const n=this._providers.map(r);return t&&n.push(t),T(n)}isEmpty(e){return null==e()}combine(e,t){return e===y?t:t===y?e:T([t,e])}}function T(e){return _((()=>{for(const t of e){const e=t();if(null!=e)return e}}))}class H extends E{seeder(){return new R}}class I extends j{constructor(e,{seedKey:t}={}){super(e),this.seedKey=t||new H(this)}}class U extends I{constructor(e,{seedKey:t,byDefault:s=y}={}){super(e,{seedKey:t}),this.byDefault=s}grow(e){const t=e.seed();null!=t?e.insert(t):e.hasFallback||e.insert(this.byDefault(e.context,this))}}class V extends I{constructor(){super("context-supply")}grow(e){e.insert(e.seed()||e.context.supply||(e.hasFallback?e.or:C()))}}const q=new V,A=Symbol("ContextBuilder");class J{constructor(e){this._initial=e,this._issuers=new Map}issuer(e){const t=this._issuers.get(e);if(t)return t;const s=e.seeder(),r=[s,t=>s.seed(t,this._initial(e,t))];return this._issuers.set(e,r),r}newSeed(e,t){const{seedKey:s}=t,[r,n]=this.issuer(s);return s!==t?[r,e.get(s)]:[r,n(e)]}}function N(e){return"with"in e}class G{constructor(e,t,s,r={}){this.context=t,this.key=s,this._opts=r,this._constructed=null,this._setup=y;const[n,i]=e.newSeed(t,s);this.seeder=n,this.seed=i,this.hasFallback="or"in r}get or(){return this._opts.or}insert(e){this._constructed=e}fillBy(e){return e(this),this._constructed}setup(e){const t=this._setup;this._setup=s=>{t(s),e(s)}}_grow(){if(this.key.grow(this),null!=this._constructed)return[this._constructed,this._setup];if(!this.hasFallback)throw new F(this.key);return[this.or]}}class L{constructor(e){this._seeders=new J(e?"function"==typeof e?e:t=>e.get(t):y)}provide(e){if(function(e){return"function"==typeof e[A]}(e))return e[A](this);const{a:{[B]:{seedKey:t}},by:s}=function(e){if(function(e){return"by"in e}(e)){if(!N(e))return e;const{a:t,by:s,with:r}=e;return{a:t,by:e=>s(...r.map((t=>e.get(t))))}}if(function(e){return"is"in e}(e)){const{a:t,is:s}=e;return{a:t,by:f(s)}}if(function(e){return"via"in e}(e)){const{a:t,via:s}=e;return{a:t,by:e=>e.get(s)}}if(function(e){return"as"in e}(e)){if(function(e){return!("a"in e)}(e)&&(e=function(e){return{...e,a:e.as}}(e)),!N(e)){const{as:t}=e;return{a:e.a,by:e=>new t(e)}}const{as:t,with:s}=e;return{a:e.a,by:e=>new t(...s.map((t=>e.get(t))))}}throw new TypeError(`Malformed context value specifier: ${JSON.stringify(e)}`)}(e),[r]=this._seeders.issuer(t);return r.provide(s)}seed(e,t){const[,s]=this._seeders.issuer(t);return s(e)}seeds(){return(e,t)=>this.seed(t,e)}seedIn(e){return this.newValues().get.bind(e)}newValues(){return function(e,t){const s=new Map;return new class extends O{get({[B]:r},n){const i=s.get(r);if(null!=i)return i;const[o,u]=new G(t,this,r,n)._grow();return u&&(s.set(r,o),u({key:r,context:this,registry:e})),o}}}(this,this._seeders)}append(e){const t="function"==typeof e?e:e.seeds();return new L(((e,s)=>{const r=t(e,s),[n,i]=this._seeders.issuer(e),o=i(s);return r?n.combine(o,r,s):o}))}}function Q(e=new TypeError("Context destroyed")){return()=>{throw e}}const W=d(((e,...t)=>e(...x(S(...t)))));class X{constructor(){this._providers=o([new Map])}provide(e){const[t]=this._providers.it,s=new D;return t.set(s,e),this._providers.it=[t],s.whenOff((()=>{const[e]=this._providers.it;e.delete(s),this._providers.it=[e]}))}seed(e,s=t()){return this.combine(s,function(e,s){return s.read.do(u((([s])=>s.size?a(...b(b(k((()=>s.values())),(t=>t(e))),Y)):t())),W)}(e,this._providers))}isEmpty(){return!1}combine(e,t){return a(e,t).do(W)}}function Y(e){return c(e)?e:null!=e?t(e):t()}class Z extends E{get upKey(){return this}seeder(){return new X}}class ee extends j{constructor(e,t){super(e.name+":up"),this._key=e,this.grow=e=>{const s=e.fillBy(t);null!=s&&e.insert(s.do(r(e.context.get(q))))}}get seedKey(){return this._key.seedKey}get upKey(){return this}}class te extends j{constructor(e,{seedKey:t}={}){super(e),this.seedKey=t||new Z(this)}createUpKey(e){return new ee(this,e)}}function se(e){const t=function(e){return i(((t,...s)=>t(...g(b(s,(t=>P(t)?t[M](e):t)),w))))}(e);return e=>n(t(e))}class re extends te{constructor(s,{seedKey:r,byDefault:n=y}={}){super(s,r),this.byDefault=(e,t)=>n(e,t)||(()=>{throw new F(this)}),this.upKey=this.createUpKey((s=>s.insert(s.seed.do(e(((...e)=>e.length?t(e[e.length-1]):s.hasFallback&&s.or?s.or:t(this.byDefault(s.context,this))))))))}grow(e){let s;e.context.get(this.upKey,e.hasFallback?{or:null!=e.or?t(e.or):e.or}:void 0)((e=>s=e)).whenOff((e=>s=Q(e))),e.insert(((...e)=>s(...e)))}}class ne extends te{constructor(e,{seedKey:t,byDefault:s=y}={}){super(e,t),this.byDefault=s}get upKey(){return this}grow(n){const i=n.seed.do(e(((...e)=>{if(e.length)return t(e[e.length-1]);let r;if(n.hasFallback)r=n.or;else{const e=this.byDefault(n.context,this);null!=e&&(r=t(e))}return r||s((({supply:e})=>{e.off(new F(this))}))})));n.insert(i.do(r(n.context.get(q))))}}class ie extends Error{constructor(e,t=[],s=function(e,t){const s=t.reduce(((e,[t,s])=>(e?e+=", ":e=": ",e+=void 0!==s?`${t} failed to load (${s})`:`${t} not loaded`)),"");return`Failed to load ${e}${s}`}(e,t)){super(s),this.module=e,this.reasons=t,this.message=s}}class oe{constructor(e,t){this.module=t,this._useCounter=0,this._impl=o(),this._rev=o({status:{module:this.module,provided:!1,used:!1,settled:!1,ready:!1},supply:$()});const s=e.get(q);s.cuts(this._impl),s.cuts(this._rev),this._impl.read((e=>{const t=this._rev.it.supply;e&&this._load(e),t.off()}))}createHandle(){const e=this._rev.read.do(h((({status:e})=>e))),t={read:e,[p]:f(e),use:e=>this._use(t,e)};return t}setup(e,t){this._setup=()=>{const s=this._rev.it,{status:{module:r},supply:n}=s;r!==this.module?e.get(r).use(n).read({supply:n,receive:(e,{settled:t,ready:r,error:n})=>{this._updateStatus(s,t,r,n)}}):async function(e,t,{status:{module:s},supply:r}){const n=new ue(s);return await s.setup({module:s,supply:r,get:t=>e.get(t),provide:e=>t.provide(e).needs(r),initBy(e){n.initBy(e)}}),n}(e,t,s).then((({whenReady:e})=>(this._updateStatus(s,!0,!1),e))).then((()=>this._updateStatus(s,!0,!0))).catch((e=>s.supply.off(e)))}}implementBy(e){this._impl.by(e)}_updateStatus(e,t,s,r){this._rev.it.supply!==e.supply?e.supply.off():this._rev.it=e={status:{module:e.status.module,provided:e.status.provided,used:!0,settled:t,ready:s,error:r},supply:e.supply}}_load(e){const t=new D(y).needs(this._rev).whenOff((e=>{this._rev.it.supply===t&&(this._rev.it={status:{...this._rev.it.status,provided:!1,settled:!1,ready:!1,error:e},supply:t})})),s=!!this._useCounter;this._rev.it={status:{module:e,provided:!0,used:s,settled:!1,ready:!1},supply:t},s&&this._setup()}_use(e,t){const s=new D(y);t&&s.needs(t);const n=e.read.do(r(s)),i={...e,read:n,whenSettled:ae(n,ce),whenReady:ae(n,he),supply:s};if(!s.isOff&&(s.whenOff((e=>{if(!--this._useCounter){const t=this._rev.it;this._rev.it={status:{...t.status,used:!1,settled:!1,ready:!1,error:e},supply:new D(y).off(e)},t.supply.off(e)}})),!this._useCounter++)){const e=this._rev.it;this._rev.it={status:{...e.status,used:!0},supply:e.supply},this._setup()}return i}}class ue{constructor(e){this._module=e,this._whenDone=Promise.resolve(),this.whenReady=new Promise((e=>this._ready=e))}initBy(e){const t=this._whenDone=this._whenDone.then(e).finally((()=>this._done(t)))}_done(e){this._whenDone===e&&(this._ready(e),this.initBy=e=>{throw new TypeError(`${this._module} initialized already, and does not accept new initializers`)})}}function ae(e,t){return l((s=>e({supply:s.supply,receive:(e,r)=>{t(r)?(s.receive(e,r),s.supply.off()):r.error&&s.supply.off(r.error)}})))}function ce({settled:e}){return e}function he({ready:e}){return e}class de extends te{constructor(e,t){super(e),this._module=t}get upKey(){return this}grow(e){const t=new oe(e.context,this._module);var s;e.insert(t.createHandle()),e.setup((({context:e,registry:s})=>t.setup(e,s))),t.implementBy((s=this._module,e.seed.do(h(((...e)=>{let t;for(let r=e.length-1;r>=0&&(t=e[r],t===s);--r);return t})))))}}const le=Symbol("ContextModule.impl");class pe{constructor(e,t,s){this.name=t,this.options=s,this.key=new de(`${t}:module`,e);const{needs:r,has:n,setup:i}=s;this.has=m(n).add(e),this.needs=m(r),this._setup=i?i.bind(s):y}replace(e,t,s){for(const r of e.has)r!==e&&t.provide({a:r,is:e}).needs(s)}async setup(e){const t=function(e){const{module:t,supply:s}=e;return x(K(t.needs,(r=>r!==t&&e.provide(r).needs(s)&&{dep:r,use:e.get(r).use(e)})))}(e);await ye(e,t,fe)&&(e.initBy((async()=>{await ye(e,t,_e)})),await this._setup(e))}}function ye(e,t,s){const{module:r,supply:n}=e,i=f(!1),o=n.whenDone().then(i,i);return Promise.race([o,Promise.all(t.map((({dep:e,use:t})=>s(t).then(y,(t=>[e,t]))))).then((e=>{const t=e.filter(v);return!t.length||new ie(r,t)}))]).then((e=>"boolean"!=typeof e?Promise.reject(e):e))}function fe(e){return e.whenSettled}function _e(e){return e.whenReady}class we{constructor(e,t={}){this[le]=new pe(this,e,t)}get[B](){return this[le].key}get name(){return this[le].name}get needs(){return this[le].needs}get has(){return this[le].has}[A](e){const t=e.provide({a:this,is:this});return this[le].replace(this,e,t),t}setup(e){return this[le].setup(e)}toString(){return`ContextModule(${this.name})`}}export{B as C,re as F,U as S,ne as a,A as b,M as c,O as d,L as e,se as f,z as g,te as h,P as i,Q as j,q as k,we as l,I as m};//# sourceMappingURL=context-values.5140e67e.js.map
