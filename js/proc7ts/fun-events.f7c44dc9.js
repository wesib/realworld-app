import{n as t,S as e,c as n,v as s}from"./primitives.e781e476.js";const r=Symbol("after-event");function o(t){return r in t}function i(n){let s;return s="function"==typeof n?{supply:new e,receive(t,...e){n(...e)}}:{supply:n.supply||new e,receive(t,...e){this.supply.isOff||n.receive(t,...e)}},s.supply.whenOff((()=>s.receive=t)),s}function u(t){let e=function n(s){let r=t;const o=[];e=t=>o.push(t);try{for(;;){r=c(r,s);const t=o.shift();if(!t)break;s=t}}finally{e=n}};return(...t)=>e(t)}function c(t,e){const n=[];for(const s of t){const t=n.length;n.push(s);const r={onRecurrent(e){n[t]=i({supply:s.supply,receive(t,...n){e(...n)}})}};s.receive(r,...e)}return n}class f{constructor(){const t=this._rcs=new Set;this.send=u(t),this.supply=new e((()=>{t.clear(),delete this._rcs}))}get size(){return this._rcs?this._rcs.size:0}on(t){const e=i(t),n=e.supply.needs(this),s=this._rcs;return s&&!n.isOff&&(s.add(e),n.whenOff((()=>s.delete(e)))),n}}const p=Symbol("on-event");function h(t){return p in t}function a(e){const n=i(e);let s=u([n]);return n.supply.whenOff((()=>s=t)),(...t)=>s(...t)}function l(){throw new Error("No events to send")}function y(t,s){return r=>{let o=n();t({supply:r.supply,receive:(t,...i)=>{const u=o,c=s(...i);try{o=c?c({supply:(new e).needs(r.supply),receive(t,...e){r.receive(t,...e)}}):n()}finally{u.off()}}})}}function d(...t){return t.reduce(((t,e)=>e(t)),this)}function _(){return this}function v(t){return e=>{t({supply:e.supply,receive:(t,...n)=>{e.receive(t,...n),e.supply.off()}})}}function w(t,n){return new Promise(((s,r)=>{v(this)({supply:new e(n?t=>{try{s(n(t))}catch(t){r(t)}}:r),receive:t?(e,...n)=>{try{s(t(...n))}catch(t){r(t)}}:(t,e)=>s(e)})}))}function m(t){const n=new f;let s,r;return o=>{if(n.size||(r=[],s=new e((()=>r=void 0)),t({supply:s,receive(t,...e){r&&(n.size?r=void 0:r.push(e)),n.send(...e)}})),o.supply.needs(s),n.on(o).whenOff((t=>{n.size||s.off(t)})),r){const t=a(o);r.forEach((e=>t(...e)))}}}function g(t,n,s){return r=>{s?t({supply:(new e).needs(n).cuts(s),receive:r.receive.bind(r)}):(r.supply.needs(n),t(r))}}function k(t,e){return n=>{const s=a(n);t({supply:n.supply,receive:(t,...n)=>{e(s,...n)}})}}function O({supply:t}){t.off()}function b(n,s=l){let o,u=0;const c=r=>{let c=t;const f=i(r);if(f.supply.isOff)return f.supply;const p=(new e).needs(f.supply);let h=!1;return n({supply:p,receive:(t,...e)=>{h=!0,o=e,c(t,...e)}}),++u,p.isOff&&!h||(f.receive({onRecurrent(t){c=(e,...n)=>t(...n)}},...o||(o=s())),c=(t,...e)=>f.receive(t,...e)),p.whenOff((t=>{--u||(o=void 0),f.supply.off(t)})),p};return c[p]=_,c.do=d,c.then=w,c[r]=_,c}function E(n){const s=Object.keys(n);return b(m(b((e=>{const{supply:o}=e,i=a(e);let u=t;const c={};s.forEach((t=>{o.needs(n[t][r]()(((...e)=>{c[t]=e,u()})).needs(o))})),o.isOff||(u=()=>i(c))}),(()=>{const t={};return s.forEach((s=>v(n[s][r]())({supply:new e,receive:(e,...n)=>t[s]=n}))),[t]}))))}function z(...n){return b(m(b((e=>{const{supply:s}=e,o=a(e);let i=t;const u=[];n.forEach(((t,e)=>{s.needs(t[r]()(((...t)=>{u[e]=t,i()})).needs(s))})),s.isOff||(i=()=>o(...u))}),(()=>{const t=[];return n.forEach((n=>v(n[r]())({supply:new e,receive:(e,...n)=>t.push(n)}))),t}))))}function S(t,e){return b((e=>t[p]()(e)),e)}function U(t,e){return o(t)?t[r]():S(t,e)}function x(...e){return b(t,s(e))}function I(t){const e=e=>{const n=i(e),{supply:s}=n;return s.isOff||t(n),s};return e[p]=_,e.do=d,e.then=w,e}function N(t){return s=>{let r=n();const o=new e((t=>r.off(t)));return s({supply:o,receive(e,...s){const o=r;try{r=(t(...s)||n()).supply}finally{r!==o&&o.off()}}}),o}}function R(t){return b(m(t))}function j(t){const e=A(t);return t=>R(e(t))}function A(t){const e=(...e)=>{const n=t(...e);return n&&U(n)};return t=>b(y(t,e))}class M extends f{constructor(){super(...arguments),this.on=I((t=>super.on(t)))}[p](){return this.on}}const P=I(O);function q(t){return h(t)?t[p]():t[r]()}function B(...t){return t.length?I(m(I((n=>{const{supply:s}=n;let r=t.length;const o=t=>{--r||s.off(t)},i=(t,...e)=>{n.receive(t,...e)};t.forEach((t=>q(t)({supply:new e(o).needs(s),receive:i})))})))):P}function C(t){let e=n=>{t.then((()=>e(n)),(()=>e(n)))};return t.then((t=>{e=function(t){return e=>{try{a(e)(t),e.supply.off()}catch(t){e.supply.off(t)}}}(t)})).catch((t=>{var n;n=t,e=({supply:t})=>t.off(n)})),I((t=>e(t)))}function D(t){return I(m(t))}function F(t){const e=(...e)=>{const n=t(...e);return n&&q(n)};return t=>I(y(t,e))}function G(t){const e=H(t);return t=>D(e(t))}function H(t){return e=>I(k(e,t))}function J(t,e){const n=K(t,e);return t=>R(n(t))}function K(t,e){return n=>b(k(n,((e,...n)=>e(t(...n)))),e&&(()=>[e()]))}function L(t){const e=V(t);return t=>D(e(t))}function V(t){return e=>I(k(e,((e,...n)=>e(t(...n)))))}function Q(t){return b(v(t))}function T(t){return I(v(t))}function W(t,e){return n=>I(g(n,t,e))}function X(t){return I((n=>{const{supply:s}=n,r=a(n),o=new e;let i=0;const u=t.do(W(s,o),L((t=>(++i,t))));let c=[],f=1,p=0;o.whenOff((t=>{i||s.off(t)})),function(t){return I((e=>{const{supply:n}=e,s=a(e);let r=0;t({supply:n,receive(t,e){const o=++r;Promise.resolve().then((()=>e)).then((t=>s(t,o)),(t=>n.off(t)))}})}))}(u)({supply:s,receive(t,e,s){const u=s-f;if(c[u]=e,++p,p>u){let t;p===c.length?(t=c,c=[]):t=c.splice(0,u+1),f+=t.length,p-=t.length,i-=t.length,r(...t),!i&&o.isOff&&n.supply.needs(o)}}})}))}function Y(t,e){return n=>b(g(n,t,e))}function Z(t,e){const n=$(t,e);return t=>R(n(t))}function $(t,e){return n=>b(k(n,t),e)}function tt(t){const e=et(t);return t=>D(e(t))}function et(t){return H(((e,...n)=>{const s=t(...n);null!=s&&!1!==s&&e(s)}))}function nt(t){return Array.isArray(t)?t:[t]}class st{constructor(t){this._drop=t,this.emitter=new M,this._nested=new Map,this.emitter.on(((t,e,n)=>{const s=t[0],r=this._nested.get(s);r&&r.emitter.send(t.slice(1),e,n)}))}on(t){const n=this.emitter.on(t);return new e((t=>{n.off(t),this._dropIfEmpty()})).needs(n)}nest(t,e){const n=this._nested.get(t);if(n||e)return n;const s=new st((()=>this._remove(t)));return this._nested.set(t,s),s}done(t){for(const e of this._nested.values())e.done(t);this.emitter.supply.off(t)}_remove(t){this._nested.delete(t),this._dropIfEmpty()}_dropIfEmpty(){!this._nested.size&&this.emitter.size<=1&&this._drop()}}class rt{constructor(){this._root=new st(t)}on(t,e){return this._entry(t).on(e)}send(t,e,n){this._root.emitter.send(t,e,n)}done(t,e){const n=this._entry(t,!0);n&&n.done(e)}_entry(t,e){let n=this._root;for(const s of t){const t=n.nest(s,e);if(!t)return;n=t}return n}}class ot{constructor(t,e){this._trackers=t,this._path=e,this.onUpdate=I((t=>this._trackers.on(this._path,t))),this.update=(t,e,n)=>{this._trackers.send([...this._path,...nt(t)],e,n)}}get _tracker(){return this}[p](){return this.onUpdate}track(t){return(t=nt(t)).length?new ot(this._trackers,[...this._path,...t]):this}done(t){this._trackers.done(this._path,t)}}class it{constructor(){this._tracker=new ot(new rt,[])}get onUpdate(){return this._tracker.onUpdate}[p](){return this.onUpdate}get update(){return this._tracker.update}track(t){const e=this._tracker.track(t);return e===this._tracker?this:e}done(t){this._tracker.done(t)}}class ut{constructor(){this._by=n(),this.read=b((t=>{return this.on({supply:(e=t).supply,receive(t,n){e.receive({onRecurrent(e){t.onRecurrent((t=>e(t)))}},n)}});var e}),(()=>[this.it]))}[p](){return this.on}[r](){return this.read}by(t,e){const s=t=>(o(t)?t[r]():t[p]())((t=>this.it=t));if(this.byNone(),e){const n=t;this._by=q(n).do(N(((...t)=>{const n=e(...t);if(n)return s(n)})))}else{const e=t;this._by=s(e)}return this._by.whenOff((()=>this._by=n())),this}byNone(t){return this._by.off(t),this}}class ct extends ut{constructor(t){super(),this._it=t,this._on=new M}get supply(){return this._on.supply}get on(){return this._on.on}get it(){return this._it}set it(t){const e=this._it;e!==t&&(this._it=t,this._on.send(t,e))}}function ft(t){return new ct(t)}function pt(t,e){return ft().by(t,e)}export{r as A,R as B,S as C,L as D,M as E,f as F,W as G,D as H,q as I,B as J,tt as K,h as L,C as M,nt as N,p as O,it as S,ut as V,V as a,x as b,I as c,F as d,i as e,j as f,pt as g,U as h,H as i,E as j,A as k,J as l,K as m,N as n,T as o,$ as p,Z as q,X as r,Y as s,ft as t,G as u,et as v,o as w,z as x,Q as y,b as z};//# sourceMappingURL=fun-events.f7c44dc9.js.map
