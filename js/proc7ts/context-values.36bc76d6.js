import{d as e,f as t,v as s,g as r,c as n,n as i}from"./call-thru.505a1d44.js";import{j as o,f as u,c,m as a,a as h,k as d}from"./a-iterable.1242fbf9.js";import{a as l,b as f,m as p,t as y,l as b,k as g,f as w}from"./fun-events.5a9906d8.js";const _=Symbol("context-key");class m{constructor(e){this.name=e}get[_](){return this}toString(){return`ContextKey(${this.name})`}}class v extends m{constructor(e){super(e.name+":seed")}get seedKey(){return this}grow(e){const{seeder:t,seed:s}=e;return t.isEmpty(s)?e.byDefault(()=>s):s}}class x extends Error{constructor(e,t="There is no value with key "+e){super(t),this.key=e}}function D(e){if(function(e){return"by"in e}(e)){if(!K(e))return e;const{a:t,by:s,with:r}=e;return{a:t,by:e=>s(...r.map(t=>e.get(t)))}}if(function(e){return"is"in e}(e)){const{a:t,is:r}=e;return{a:t,by:s(r)}}if(function(e){return"via"in e}(e)){const{a:t,via:s}=e;return{a:t,by:e=>e.get(s)}}if(function(e){return"as"in e}(e)){if(function(e){return!("a"in e)}(e)&&(e=function(e){return Object.assign(Object.assign({},e),{a:e.as})}(e)),!K(e)){const{as:t}=e;return{a:e.a,by:e=>new t(e)}}const{as:t,with:s}=e;return{a:e.a,by:e=>new t(...s.map(t=>e.get(t)))}}throw new TypeError("Malformed context value specifier: "+e)}function K(e){return"with"in e}class k{}class j{constructor(t){this._seeds=new Map,this._initial=null==t?e:"function"==typeof t?t:e=>t.get(e)}provide(e){const{a:{[_]:{seedKey:t}},by:s}=D(e),[r]=this._seeding(t);return r.provide(s)}_seeding(e){const t=this._seeds.get(e);if(t)return t;const s=e.seeder(),r=[s,t=>s.seed(t,this._initial(e,t))];return this._seeds.set(e,r),r}seed(e,t){const[,s]=this._seeding(t);return s(e)}seedIn(e,t){return this.newValues(t).get.bind(e)}newValues(e=!0){if(!e&&this._nonCachedValues)return this._nonCachedValues;const t=new Map,s=this;class r extends k{get({[_]:r},n){const i=t.get(r);if(null!=i)return i;const[o,u]=function(e,t,r){const[n,i]=function(e,t){const{seedKey:r}=t,[n,i]=s._seeding(r);if(r!==t)return[n,e.get(r)];return[n,i(e)]}(e,t);let o=!1;const u={context:e,seeder:n,seed:i,byDefault:r&&"or"in r?()=>(o=!0,r.or):e=>{const s=e();if(null==s)throw new x(t);return s}};r&&"or"in r&&(u.or=r.or);return[t.grow(u),o]}(this,r,n);return e&&!u&&t.set(r,o),o}}return e?new r:this._nonCachedValues=new r}append(e){return new j((t,s)=>{const[r,n]=this._seeding(t);return r.combine(n(s),e.seed(s,t),s)})}}class E{constructor(){this._providers=[]}provide(e){return this._providers.push(e),()=>{const t=this._providers.indexOf(e);t>=0&&this._providers.splice(t,1)}}seed(e,t=o()){return u([t,O(e,this._providers)])}isEmpty(e){return d(e)}combine(e,t){return u([e,t])}}class T extends v{seeder(){return new E}}class C extends m{constructor(e,t){super(e),this.seedKey=t||new T(this)}}function O(e,t){return c(a(h(t.map(e=>[e])),t=>{if(t.length>1)return t[1];const s=t[0](e);return t.push(s),s}),r)}class V extends C{constructor(e,{seedKey:s,byDefault:r=t()}={}){super(e,s),this.byDefault=r}grow(e){const t=Array.from(e.seed);return t.length?t:e.byDefault(()=>{const t=this.byDefault(e.context,this);if(t)return Array.from(t)})}}class M{constructor(){this._providers=[]}provide(e){return this._providers.unshift(e),()=>{const t=this._providers.lastIndexOf(e);t>=0&&this._providers.splice(t,1)}}seed(t,r){let n=this._providers.map(e=>function(e,t){let r=()=>(r=s(t(e)),r());return()=>r()}(t,e));if(r){if(!this._providers.length)return r;n=[...n,r]}else if(n.length<2)return n.length?n[0]:e;return S(n)}isEmpty(e){return null==e()}combine(t,s){return t===e?s:s===e?t:S([s,t])}}function S(e){return()=>{for(const t of e){const e=t();if(null!=e)return e}}}class A extends v{seeder(){return new M}}class I extends m{constructor(e,t){super(e),this.seedKey=t||new A(this)}}class U extends I{constructor(t,{seedKey:s,byDefault:r=e}={}){super(t,s),this.byDefault=r}grow(e){const t=e.seed();return null!=t?t:e.byDefault(()=>this.byDefault(e.context,this))}}class F{constructor(){this._providers=y([])}provide(e){return this._providers.it=[...this._providers.it,e],()=>{const t=this._providers.it,s=t.indexOf(e);s>=0&&(this._providers.it=t.slice(0,s).concat(t.slice(s+1)))}}seed(e,t=l()){return this.combine(t,function(e,t){return t.read().keepThru(t=>t.length?f(b(...a(a(h(t),t=>t(e)),$))):i(),q)}(e,this._providers))}isEmpty(){return!1}combine(e,t){return b(e,t).keepThru(q)}}function $(e){return null==e?l():function(e){return("object"==typeof e||"function"==typeof e)&&g(e)}(e)?w(e):l(e)}function q(...e){return i(...u(e))}class z extends v{seeder(){return new F}}class B extends m{constructor(e,t){super(e.name+":up"),this._key=e,this.grow=t}get seedKey(){return this._key.seedKey}}class G extends m{constructor(e,t){super(e),this.seedKey=t||new z(this)}createUpKey(e){return new B(this,e)}}class H extends G{constructor(t,{seedKey:s,byDefault:r=e}={}){super(t,s),this.byDefault=(e,t)=>r(e,t)||(()=>{throw new x(this)}),this.upKey=this.createUpKey(e=>e.seed.keepThru((...t)=>{if(t.length)return t[t.length-1];const s=()=>l(this.byDefault(e.context,this));return f(e.byDefault(s)||s())}))}grow(e){let t;return e.context.get(this.upKey,"or"in e?{or:null!=e.or?l(e.or):e.or}:void 0).to(e=>t=e),(...e)=>t(...e)}}class J extends G{constructor(t,{seedKey:s,byDefault:r=e}={}){super(t,s),this.byDefault=r}get upKey(){return this}grow(e){return e.seed.keepThru((...t)=>{if(t.length)return n(t[t.length-1]);const s=e.byDefault(()=>{const t=this.byDefault(e.context,this);return t&&l(t)});return f(null!=s?s:p(()=>{throw new x(this)}))})}}export{_ as C,H as F,V as M,J as S,U as a,k as b,j as c,G as d};//# sourceMappingURL=context-values.36bc76d6.js.map
