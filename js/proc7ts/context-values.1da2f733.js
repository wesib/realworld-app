import{n as e,v as t,l as s}from"./primitives.e0fbf82a.js";import{m as r,a as n,b as i}from"./push-iterator.38276a56.js";import{b as o,n as u}from"./call-thru.3702f6af.js";import{a as c,b as a,m as h,j as l,t as d,l as f,k as p,f as y}from"./fun-events.fad06cca.js";const b=Symbol("context-key");class w{constructor(e){this.name=e}get[b](){return this}toString(){return`ContextKey(${this.name})`}}class _ extends w{constructor(e){super(e.name+":seed")}get seedKey(){return this}grow(e){const{seeder:t,seed:s}=e;t.isEmpty(s)&&e.hasFallback||e.insert(s)}}class g extends Error{constructor(e,t="There is no value with key "+e){super(t),this.key=e}}class x{}class m{constructor(e){this._initial=e,this._byKey=new Map}seedData(e){const t=this._byKey.get(e);if(t)return t;const s=e.seeder(),r=[s,t=>s.seed(t,this._initial(e,t))];return this._byKey.set(e,r),r}findSeed(e,t){const{seedKey:s}=t,[r,n]=this.seedData(s);return s!==t?[r,e.get(s)]:[r,n(e)]}}class v{constructor(t,s,r,n={}){this.context=s,this.key=r,this._opts=n,this._constructed=null,this._setup=e;const[i,o]=t.findSeed(s,r);this.seeder=i,this.seed=o,this.hasFallback="or"in n}get or(){return this._opts.or}insert(e){this._constructed=e}fillBy(e){return e(this),this._constructed}setup(e){const t=this._setup;this._setup=s=>{t(s),e(s)}}_grow(){if(this.key.grow(this),null!=this._constructed)return[this._constructed,this._setup];if(!this.hasFallback)throw new g(this.key);return[this.or]}}function K(e){return"with"in e}class k{constructor(t){let s;s=null==t?e:"function"==typeof t?t:e=>t.get(e),this._seeds=new m(s)}provide(e){const{a:{[b]:{seedKey:s}},by:r}=function(e){if(function(e){return"by"in e}(e)){if(!K(e))return e;const{a:t,by:s,with:r}=e;return{a:t,by:e=>s(...r.map((t=>e.get(t))))}}if(function(e){return"is"in e}(e)){const{a:s,is:r}=e;return{a:s,by:t(r)}}if(function(e){return"via"in e}(e)){const{a:t,via:s}=e;return{a:t,by:e=>e.get(s)}}if(function(e){return"as"in e}(e)){if(function(e){return!("a"in e)}(e)&&(e=function(e){return{...e,a:e.as}}(e)),!K(e)){const{as:t}=e;return{a:e.a,by:e=>new t(e)}}const{as:t,with:s}=e;return{a:e.a,by:e=>new t(...s.map((t=>e.get(t))))}}throw new TypeError("Malformed context value specifier: "+JSON.stringify(e))}(e),[n]=this._seeds.seedData(s);return n.provide(r)}seed(e,t){const[,s]=this._seeds.seedData(t);return s(e)}seedIn(e){return this.newValues().get.bind(e)}newValues(){return function(e,t){const s=new Map;return new class extends x{get({[b]:r},n){const i=s.get(r);if(null!=i)return i;const[o,u]=new v(t,this,r,n)._grow();return u&&(s.set(r,o),u({key:r,context:this,registry:e})),o}}}(this,this._seeds)}append(e){return new k(((t,s)=>{const[r,n]=this._seeds.seedData(t);return r.combine(n(s),e.seed(s,t),s)}))}}class D{constructor(){this._providers=[]}provide(e){return this._providers.unshift(e),()=>{const t=this._providers.lastIndexOf(e);t>=0&&this._providers.splice(t,1)}}seed(t,r){const{length:n}=this._providers;if(!n)return r||e;const i=e=>s(e.bind(void 0,t));if(!r&&1===n)return i(this._providers[0]);const o=this._providers.map(i);return r&&o.push(r),F(o)}isEmpty(e){return null==e()}combine(t,s){return t===e?s:s===e?t:F([s,t])}}function F(e){return s((()=>{for(const t of e){const e=t();if(null!=e)return e}}))}class T extends _{seeder(){return new D}}class j extends w{constructor(e,{seedKey:t}={}){super(e),this.seedKey=t||new T(this)}}class E extends j{constructor(t,{seedKey:s,byDefault:r=e}={}){super(t,{seedKey:s}),this.byDefault=r}grow(e){const t=e.seed();null!=t?e.insert(t):e.hasFallback||e.insert(this.byDefault(e.context,this))}}function O(e){return()=>{throw null!=e?e:new TypeError("Context destroyed")}}class S extends j{constructor(){super("context-supply")}grow(e){e.insert(e.seed()||(e.hasFallback?e.or:null)||e.context[l])}}const C=new S;class M{constructor(){this._providers=d([])}provide(e){return this._providers.it=[...this._providers.it,e],()=>{const t=this._providers.it,s=t.indexOf(e);s>=0&&(this._providers.it=t.slice(0,s).concat(t.slice(s+1)))}}seed(e,t=c()){return this.combine(t,function(e,t){return t.read().keepThru((t=>t.length?a(f(...r(r(n(t),(t=>t(e))),B))):u()),I)}(e,this._providers))}isEmpty(){return!1}combine(e,t){return f(e,t).keepThru(I)}}function B(e){return null==e?c():function(e){return("object"==typeof e||"function"==typeof e)&&p(e)}(e)?y(e):c(e)}function I(...e){return u(...i(...e))}class U extends _{get upKey(){return this}seeder(){return new M}}class V extends w{constructor(e,t){super(e.name+":up"),this._key=e,this.grow=e=>{const s=e.fillBy(t);if(s){const t=e.context.get(C,{or:null});t&&e.insert(s.tillOff(t))}}}get seedKey(){return this._key.seedKey}}class J extends w{constructor(e,{seedKey:t}={}){super(e),this.seedKey=t||new U(this)}createUpKey(e){return new V(this,e)}}class N extends J{constructor(t,{seedKey:s,byDefault:r=e}={}){super(t,s),this.byDefault=(e,t)=>r(e,t)||(()=>{throw new g(this)}),this.upKey=this.createUpKey((e=>{e.insert(e.seed.keepThru(((...t)=>t.length?t[t.length-1]:e.hasFallback&&e.or?a(e.or):a(c(this.byDefault(e.context,this))))))}))}grow(e){let t;e.context.get(this.upKey,e.hasFallback?{or:null!=e.or?c(e.or):e.or}:void 0).to((e=>t=e)).whenOff((e=>t=O(e))),e.insert(((...e)=>t(...e)))}}class $ extends J{constructor(t,{seedKey:s,byDefault:r=e}={}){super(t,s),this.byDefault=r}get upKey(){return this}grow(e){const t=e.seed.keepThru(((...t)=>{if(t.length)return o(t[t.length-1]);let s;if(e.hasFallback)s=e.or;else{const t=this.byDefault(e.context,this);s=t&&c(t)}return a(null!=s?s:h((()=>{throw new g(this)})))})),s=e.context.get(C,{or:null});e.insert(s?t.tillOff(s):t)}}export{b as C,N as F,$ as S,E as a,x as b,k as c,J as d,O as e,C as f,j as g};//# sourceMappingURL=context-values.1da2f733.js.map
