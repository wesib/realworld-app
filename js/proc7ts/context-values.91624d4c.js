import{n as e,v as t,o as s,S as r,p as n,s as i,q as o,c as u}from"./primitives.3596c309.js";import{m as a,k as c,j as h,v as d,b as l}from"./push-iterator.b943ed6f.js";import{c as p,s as y,b as f,A as _,y as w,t as m,g as v,w as g,u as b,j as x,p as K,m as k,l as S}from"./fun-events.26e814e4.js";const D=Symbol("context-value-registrar"),$=Symbol("context-key");class F{constructor(e){this.name=e}get[$](){return this}toString(){return`ContextKey(${this.name})`}}class B extends F{constructor(e){super(`${e.name}:seed`)}get seedKey(){return this}grow(e){const{seeder:t,seed:s}=e;t.isEmpty(s)&&e.hasFallback||e.insert(s)}}class C extends Error{constructor(e,t=`There is no value with key ${e}`){super(t),this.key=e}}class E{constructor(e){this._initial=e,this._issuers=new Map}issuer(e){const t=this._issuers.get(e);if(t)return t;const s=e.seeder(),r=[s,t=>s.seed(t,this._initial(e,t))];return this._issuers.set(e,r),r}newSeed(e,t){const{seedKey:s}=t,[r,n]=this.issuer(s);return s!==t?[r,e.get(s)]:[r,n(e)]}}function j(e){return"with"in e}class O{}class M{constructor(t,s,r,n={}){this.context=s,this.key=r,this._opts=n,this._constructed=null,this._setup=e;const[i,o]=t.newSeed(s,r);this.seeder=i,this.seed=o,this.hasFallback="or"in n}get or(){return this._opts.or}insert(e){this._constructed=e}fillBy(e){return e(this),this._constructed}setup(e){const t=this._setup;this._setup=s=>{t(s),e(s)}}_grow(){if(this.key.grow(this),null!=this._constructed)return[this._constructed,this._setup];if(!this.hasFallback)throw new C(this.key);return[this.or]}}class P{constructor(t){this._seeders=new E(t?"function"==typeof t?t:e=>t.get(e):e)}provide(e){if(function(e){return"function"==typeof e[D]}(e))return e[D](this);const{a:{[$]:{seedKey:s}},by:r}=function(e){if(function(e){return"by"in e}(e)){if(!j(e))return e;const{a:t,by:s,with:r}=e;return{a:t,by:e=>s(...r.map((t=>e.get(t))))}}if(function(e){return"is"in e}(e)){const{a:s,is:r}=e;return{a:s,by:t(r)}}if(function(e){return"via"in e}(e)){const{a:t,via:s}=e;return{a:t,by:e=>e.get(s)}}if(function(e){return"as"in e}(e)){if(function(e){return!("a"in e)}(e)&&(e=function(e){return{...e,a:e.as}}(e)),!j(e)){const{as:t}=e;return{a:e.a,by:e=>new t(e)}}const{as:t,with:s}=e;return{a:e.a,by:e=>new t(...s.map((t=>e.get(t))))}}throw new TypeError(`Malformed context value specifier: ${JSON.stringify(e)}`)}(e),[n]=this._seeders.issuer(s);return n.provide(r)}seed(e,t){const[,s]=this._seeders.issuer(t);return s(e)}seeds(){return(e,t)=>this.seed(t,e)}seedIn(e){return this.newValues().get.bind(e)}newValues(){return function(e,t){const s=new Map;return new class extends O{get({[$]:r},n){const i=s.get(r);if(null!=i)return i;const[o,u]=new M(t,this,r,n)._grow();return u&&(s.set(r,o),u({key:r,context:this,registry:e})),o}}}(this,this._seeders)}append(e){const t="function"==typeof e?e:e.seeds();return new P(((e,s)=>{const r=t(e,s),[n,i]=this._seeders.issuer(e),o=i(s);return r?n.combine(o,r,s):o}))}}class R{constructor(){this._providers=[]}provide(e){const t=[e];return this._providers.unshift(t),new r((()=>this._providers.splice(this._providers.lastIndexOf(t),1)))}seed(t,s){const{length:r}=this._providers;if(!r)return s||e;const i=([e])=>n(e.bind(void 0,t));if(!s&&1===r)return i(this._providers[0]);const o=this._providers.map(i);return s&&o.push(s),T(o)}isEmpty(e){return null==e()}combine(t,s){return t===e?s:s===e?t:T([s,t])}}function T(e){return n((()=>{for(const t of e){const e=t();if(null!=e)return e}}))}class z extends B{seeder(){return new R}}class H extends F{constructor(e,{seedKey:t}={}){super(e),this.seedKey=t||new z(this)}}class I extends H{constructor(){super("context-supply")}grow(e){e.insert(e.seed()||e.context.supply||(e.hasFallback?e.or:s()))}}const U=new I;class V extends H{constructor(t,{seedKey:s,byDefault:r=e}={}){super(t,{seedKey:s}),this.byDefault=r}grow(e){const t=e.seed();null!=t?e.insert(t):e.hasFallback||e.insert(this.byDefault(e.context,this))}}function q(e=new TypeError("Context destroyed")){return()=>{throw e}}class A extends Error{constructor(e,t=[],s=function(e,t){const s=t.reduce(((e,[t,s])=>(e?e+=", ":e=": ",e+=void 0!==s?`${t} failed to load (${s})`:`${t} not loaded`)),"");return`Failed to load ${e}${s}`}(e,t)){super(s),this.module=e,this.reasons=t,this.message=s}}class J{constructor(e,t){this.module=t,this._useCounter=0,this._impl=m(),this._rev=m({status:{module:this.module,provided:!1,used:!1,settled:!1,ready:!1},supply:u()});const s=e.get(U);s.cuts(this._impl),s.cuts(this._rev),this._impl.read((e=>{const t=this._rev.it.supply;e&&this._load(e),t.off()}))}createHandle(){const e=this._rev.read.do(k((({status:e})=>e))),s={read:e,[_]:t(e),use:e=>this._use(s,e)};return s}setup(e,t){this._setup=()=>{const s=this._rev.it,{status:{module:r},supply:n}=s;r!==this.module?e.get(r).use(n).read({supply:n,receive:(e,{settled:t,ready:r,error:n})=>{this._updateStatus(s,t,r,n)}}):async function(e,t,{status:{module:s},supply:r}){const n=new N(s);return await s.setup({module:s,supply:r,get:t=>e.get(t),provide:e=>t.provide(e).needs(r),initBy(e){n.initBy(e)}}),n}(e,t,s).then((({whenReady:e})=>(this._updateStatus(s,!0,!1),e))).then((()=>this._updateStatus(s,!0,!0))).catch((e=>s.supply.off(e)))}}implementBy(e){this._impl.by(e)}_updateStatus(e,t,s,r){this._rev.it.supply!==e.supply?e.supply.off():this._rev.it=e={status:{module:e.status.module,provided:e.status.provided,used:!0,settled:t,ready:s,error:r},supply:e.supply}}_load(e){const t=(new r).needs(this._rev).whenOff((e=>{this._rev.it.supply===t&&(this._rev.it={status:{...this._rev.it.status,provided:!1,settled:!1,ready:!1,error:e},supply:t})})),s=!!this._useCounter;this._rev.it={status:{module:e,provided:!0,used:s,settled:!1,ready:!1},supply:t},s&&this._setup()}_use(e,t){const s=new r;t&&s.needs(t);const n=e.read.do(y(s)),i={...e,read:n,whenSettled:G(n,L),whenReady:G(n,Q),supply:s};if(!s.isOff&&(s.whenOff((e=>{if(!--this._useCounter){const t=this._rev.it;this._rev.it={status:{...t.status,used:!1,settled:!1,ready:!1,error:e},supply:(new r).off(e)},t.supply.off(e)}})),!this._useCounter++)){const e=this._rev.it;this._rev.it={status:{...e.status,used:!0},supply:e.supply},this._setup()}return i}}class N{constructor(e){this._module=e,this._whenDone=Promise.resolve(),this.whenReady=new Promise((e=>this._ready=e))}initBy(e){const t=this._whenDone=this._whenDone.then(e).finally((()=>this._done(t)))}_done(e){this._whenDone===e&&(this._ready(e),this.initBy=e=>{throw new TypeError(`${this._module} initialized already, and does not accept new initializers`)})}}function G(e,t){return S((s=>e({supply:s.supply,receive:(e,r)=>{t(r)?(s.receive(e,r),s.supply.off()):r.error&&s.supply.off(r.error)}})))}function L({settled:e}){return e}function Q({ready:e}){return e}const W=K(((e,...t)=>e(...h(l(...t)))));class X{constructor(){this._providers=m([new Map])}provide(e){const[t]=this._providers.it,s=new r;return t.set(s,e),this._providers.it=[t],s.whenOff((()=>{const[e]=this._providers.it;e.delete(s),this._providers.it=[e]}))}seed(e,t=f()){return this.combine(t,function(e,t){return t.read.do(v((([t])=>t.size?g(...a(a(c((()=>t.values())),(t=>t(e))),Y)):f())),W)}(e,this._providers))}isEmpty(){return!1}combine(e,t){return g(e,t).do(W)}}function Y(e){return null==e?f():function(e){return("object"==typeof e||"function"==typeof e)&&b(e)}(e)?x(e):f(e)}class Z extends B{get upKey(){return this}seeder(){return new X}}class ee extends F{constructor(e,t){super(e.name+":up"),this._key=e,this.grow=e=>{const s=e.fillBy(t);null!=s&&e.insert(s[_]().do(y(e.context.get(U))))}}get seedKey(){return this._key.seedKey}get upKey(){return this}}class te extends F{constructor(e,{seedKey:t}={}){super(e),this.seedKey=t||new Z(this)}createUpKey(e){return new ee(this,e)}}class se extends te{constructor(e,t){super(e),this._module=t}get upKey(){return this}grow(e){const t=new J(e.context,this._module);var s;e.insert(t.createHandle()),e.setup((({context:e,registry:s})=>t.setup(e,s))),t.implementBy((s=this._module,e.seed.do(k(((...e)=>{let t;for(let r=e.length-1;r>=0&&(t=e[r],t===s);--r);return t})))))}}const re=Symbol("ContextModule.impl");class ne{constructor(t,s,r){this.name=s,this.options=r,this.key=new se(`${s}:module`,t);const{needs:n,has:o,setup:u}=r;this.has=i(o).add(t),this.needs=i(n),this._setup=u?u.bind(r):e}replace(e,t,s){for(const r of e.has)r!==e&&t.provide({a:r,is:e}).needs(s)}async setup(e){const t=function(e){const{module:t,supply:s}=e;return h(d(t.needs,(r=>r!==t&&e.provide(r).needs(s)&&{dep:r,use:e.get(r).use(e)})))}(e);await ie(e,t,oe)&&(e.initBy((async()=>{await ie(e,t,ue)})),await this._setup(e))}}function ie(s,r,n){const{module:i,supply:u}=s,a=t(!1),c=u.whenDone().then(a,a);return Promise.race([c,Promise.all(r.map((({dep:t,use:s})=>n(s).then(e,(e=>[t,e]))))).then((e=>{const t=e.filter(o);return!t.length||new A(i,t)}))]).then((e=>"boolean"!=typeof e?Promise.reject(e):e))}function oe(e){return e.whenSettled}function ue(e){return e.whenReady}class ae{constructor(e,t={}){this[re]=new ne(this,e,t)}get[$](){return this[re].key}get name(){return this[re].name}get needs(){return this[re].needs}get has(){return this[re].has}[D](e){const t=e.provide({a:this,is:this});return this[re].replace(this,e,t),t}setup(e){return this[re].setup(e)}toString(){return`ContextModule(${this.name})`}}class ce extends te{constructor(t,{seedKey:s,byDefault:r=e}={}){super(t,s),this.byDefault=(e,t)=>r(e,t)||(()=>{throw new C(this)}),this.upKey=this.createUpKey((e=>{e.insert(e.seed.do(p(((...t)=>t.length?f(t[t.length-1]):e.hasFallback&&e.or?e.or:f(this.byDefault(e.context,this))))))}))}grow(e){let t;e.context.get(this.upKey,e.hasFallback?{or:null!=e.or?f(e.or):e.or}:void 0)((e=>t=e)).whenOff((e=>t=q(e))),e.insert(((...e)=>t(...e)))}}class he extends te{constructor(t,{seedKey:s,byDefault:r=e}={}){super(t,s),this.byDefault=r}get upKey(){return this}grow(e){const t=e.seed.do(p(((...t)=>{if(t.length)return f(t[t.length-1]);let s;if(e.hasFallback)s=e.or;else{const t=this.byDefault(e.context,this);s=t&&f(t)}return null!=s?s:w((()=>{throw new C(this)}))})));e.insert(t.do(y(e.context.get(U))))}}export{$ as C,ce as F,he as S,V as a,O as b,P as c,te as d,q as e,U as f,ae as g,H as h};//# sourceMappingURL=context-values.91624d4c.js.map
