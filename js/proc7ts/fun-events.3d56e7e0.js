import{n as t,S as e,c as n,e as s,a as r,v as o}from"./primitives.ada6e792.js";const i=Symbol("after-event");function u(t){return i in t}function c(n){let s;return s="function"==typeof n?{supply:new e,receive(t,...e){n(...e)}}:{supply:n.supply||new e,receive(t,...e){this.supply.isOff||n.receive(t,...e)}},s.supply.whenOff((()=>s.receive=t)),s}function f(t){let e=function n(s){let r=t;const o=[];e=t=>o.push(t);try{for(;;){r=p(r,s);const t=o.shift();if(!t)break;s=t}}finally{e=n}};return(...t)=>e(t)}function p(t,e){const n=[];for(const s of t){const t=n.length;n.push(s);const r={onRecurrent(e){n[t]=c({supply:s.supply,receive(t,...n){e(...n)}})}};s.receive(r,...e)}return n}class h{constructor(){const t=this._rcs=new Set;this.send=f(t),this.supply=new e((()=>{t.clear(),delete this._rcs}))}get size(){return this._rcs?this._rcs.size:0}on(t){const e=c(t),n=e.supply.needs(this),s=this._rcs;return s&&!n.isOff&&(s.add(e),n.whenOff((()=>s.delete(e)))),n}}const a=Symbol("on-event");function l(t){return a in t}function y(e){const n=c(e);let s=f([n]);return n.supply.whenOff((()=>s=t)),(...t)=>s(...t)}function d(){throw new Error("No events to send")}function _(t,s){return r=>{let o=n();t({supply:r.supply,receive:(t,...i)=>{const u=o,c=s(...i);try{o=c?c({supply:(new e).needs(r.supply),receive(t,...e){r.receive(t,...e)}}):n()}finally{u.off()}}})}}function v(...t){return t.reduce(((t,e)=>e(t)),this)}function w(){return this}function m(t){return e=>{t({supply:e.supply,receive:(t,...n)=>{e.receive(t,...n),e.supply.off()}})}}function g(t,n){return new Promise(((s,r)=>{m(this)({supply:new e(n?t=>{try{s(n(t))}catch(t){r(t)}}:r),receive:t?(e,...n)=>{try{s(t(...n))}catch(t){r(t)}}:(t,e)=>s(e)})}))}function k(t){const n=new h;let s,r;return o=>{if(n.size||(r=[],s=new e((()=>r=void 0)),t({supply:s,receive(t,...e){r&&(n.size?r=void 0:r.push(e)),n.send(...e)}})),o.supply.needs(s),n.on(o).whenOff((t=>{n.size||s.off(t)})),r){const t=y(o);r.forEach((e=>t(...e)))}}}function O(t,n,s){return r=>{s?t({supply:(new e).needs(n).cuts(s),receive:r.receive.bind(r)}):(r.supply.needs(n),t(r))}}function b(t,e){return n=>{const s=y(n);t({supply:n.supply,receive:(t,...n)=>{e(s,...n)}})}}function E({supply:t}){t.off()}function z(n,s=d){let r,o=0;const u=i=>{let u=t;const f=c(i);if(f.supply.isOff)return f.supply;const p=(new e).needs(f.supply);let h=!1;return n({supply:p,receive:(t,...e)=>{h=!0,r=e,u(t,...e)}}),++o,p.isOff&&!h||(f.receive({onRecurrent(t){u=(e,...n)=>t(...n)}},...r||(r=s())),u=(t,...e)=>f.receive(t,...e)),p.whenOff((t=>{--o||(r=void 0),f.supply.off(t)})),p};return u[a]=w,u.do=v,u.then=g,u[i]=w,u}function S(n){const s=Object.keys(n);return z(k(z((e=>{const{supply:r}=e,o=y(e);let u=t;const c={};s.forEach((t=>{r.needs(n[t][i]()(((...e)=>{c[t]=e,u()})).needs(r))})),r.isOff||(u=()=>o(c))}),(()=>{const t={};return s.forEach((s=>m(n[s][i]())({supply:new e,receive:(e,...n)=>t[s]=n}))),[t]}))))}function U(...n){return z(k(z((e=>{const{supply:s}=e,r=y(e);let o=t;const u=[];n.forEach(((t,e)=>{s.needs(t[i]()(((...t)=>{u[e]=t,o()})).needs(s))})),s.isOff||(o=()=>r(...u))}),(()=>{const t=[];return n.forEach((n=>m(n[i]())({supply:new e,receive:(e,...n)=>t.push(n)}))),t}))))}function x(t,e){return z((e=>t[a]()(e)),e)}function I(t,e){return u(t)?t[i]():x(t,e)}function N(...e){return z(t,o(e))}function R(t){const e=e=>{const n=c(e),{supply:s}=n;return s.isOff||t(n),s};return e[a]=w,e.do=v,e.then=g,e}function j(t){return s=>{let r=n();const o=new e((t=>r.off(t)));return s({supply:o,receive(e,...s){const o=r;try{r=(t(...s)||n()).supply}finally{r!==o&&o.off()}}}),o}}function A(t){return z(k(t))}function M(t){const e=P(t);return t=>A(e(t))}function P(t){const e=(...e)=>{const n=t(...e);return n&&I(n)};return t=>z(_(t,e))}class q extends h{constructor(){super(...arguments),this.on=R((t=>super.on(t)))}[a](){return this.on}}const B=R(E);function C(t){return l(t)?t[a]():t[i]()}function D(...t){return t.length?R(k(R((n=>{const{supply:s}=n;let r=t.length;const o=t=>{--r||s.off(t)},i=(t,...e)=>{n.receive(t,...e)};t.forEach((t=>C(t)({supply:new e(o).needs(s),receive:i})))})))):B}function F(t){let e=n=>{t.then((()=>e(n)),(()=>e(n)))};return t.then((t=>{e=function(t){return e=>{try{y(e)(t),e.supply.off()}catch(t){e.supply.off(t)}}}(t)})).catch((t=>{var n;n=t,e=({supply:t})=>t.off(n)})),R((t=>e(t)))}function G(t){return R(k(t))}function H(t){const e=(...e)=>{const n=t(...e);return n&&C(n)};return t=>R(_(t,e))}function J(t){const e=K(t);return t=>G(e(t))}function K(t){return e=>R(b(e,t))}function L(t,e){const n=V(t,e);return t=>A(n(t))}function V(t,e){return n=>z(b(n,((e,...n)=>e(t(...n)))),e&&(()=>[e()]))}function Q(t){const e=T(t);return t=>G(e(t))}function T(t){return e=>R(b(e,((e,...n)=>e(t(...n)))))}function W(t){return z(m(t))}function X(t){return R(m(t))}function Y(t,e){return s(t.supply)?r:n=>R(O(n,t,e))}function Z(t){return R((n=>{const{supply:s}=n,r=y(n),o=new e;let i=0;const u=t.do(Y(s,o),Q((t=>(++i,t))));let c=[],f=1,p=0;o.whenOff((t=>{i||s.off(t)})),function(t){return R((e=>{const{supply:n}=e,s=y(e);let r=0;t({supply:n,receive(t,e){const o=++r;Promise.resolve().then((()=>e)).then((t=>s(t,o)),(t=>n.off(t)))}})}))}(u)({supply:s,receive(t,e,s){const u=s-f;if(c[u]=e,++p,p>u){let t;p===c.length?(t=c,c=[]):t=c.splice(0,u+1),f+=t.length,p-=t.length,i-=t.length,r(...t),!i&&o.isOff&&n.supply.needs(o)}}})}))}function $(t,e){return s(t.supply)?r:n=>z(O(n,t,e))}function tt(t,e){const n=et(t,e);return t=>A(n(t))}function et(t,e){return n=>z(b(n,t),e)}function nt(t){const e=st(t);return t=>G(e(t))}function st(t){return K(((e,...n)=>{const s=t(...n);null!=s&&!1!==s&&e(s)}))}function rt(t){return Array.isArray(t)?t:[t]}class ot{constructor(t){this._drop=t,this.emitter=new q,this._nested=new Map,this.emitter.on(((t,e,n)=>{const s=t[0],r=this._nested.get(s);r&&r.emitter.send(t.slice(1),e,n)}))}on(t){const n=this.emitter.on(t);return new e((t=>{n.off(t),this._dropIfEmpty()})).needs(n)}nest(t,e){const n=this._nested.get(t);if(n||e)return n;const s=new ot((()=>this._remove(t)));return this._nested.set(t,s),s}done(t){for(const e of this._nested.values())e.done(t);this.emitter.supply.off(t)}_remove(t){this._nested.delete(t),this._dropIfEmpty()}_dropIfEmpty(){!this._nested.size&&this.emitter.size<=1&&this._drop()}}class it{constructor(){this._root=new ot(t)}on(t,e){return this._entry(t).on(e)}send(t,e,n){this._root.emitter.send(t,e,n)}done(t,e){const n=this._entry(t,!0);n&&n.done(e)}_entry(t,e){let n=this._root;for(const s of t){const t=n.nest(s,e);if(!t)return;n=t}return n}}class ut{constructor(t,e){this._trackers=t,this._path=e,this.onUpdate=R((t=>this._trackers.on(this._path,t))),this.update=(t,e,n)=>{this._trackers.send([...this._path,...rt(t)],e,n)}}get _tracker(){return this}[a](){return this.onUpdate}track(t){return(t=rt(t)).length?new ut(this._trackers,[...this._path,...t]):this}done(t){this._trackers.done(this._path,t)}}class ct{constructor(){this._tracker=new ut(new it,[])}get onUpdate(){return this._tracker.onUpdate}[a](){return this.onUpdate}get update(){return this._tracker.update}track(t){const e=this._tracker.track(t);return e===this._tracker?this:e}done(t){this._tracker.done(t)}}class ft{constructor(){this._by=n(),this.read=z((t=>{return this.on({supply:(e=t).supply,receive(t,n){e.receive({onRecurrent(e){t.onRecurrent((t=>e(t)))}},n)}});var e}),(()=>[this.it]))}[a](){return this.on}[i](){return this.read}by(t,e){const s=t=>(u(t)?t[i]():t[a]())((t=>this.it=t));if(this.byNone(),e){const n=t;this._by=C(n).do(j(((...t)=>{const n=e(...t);if(n)return s(n)})))}else{const e=t;this._by=s(e)}return this._by.whenOff((()=>this._by=n())),this}byNone(t){return this._by.off(t),this}}class pt extends ft{constructor(t){super(),this._it=t,this._on=new q}get supply(){return this._on.supply}get on(){return this._on.on}get it(){return this._it}set it(t){const e=this._it;e!==t&&(this._it=t,this._on.send(t,e))}}function ht(t){return new pt(t)}function at(t,e){return ht().by(t,e)}export{i as A,x as B,Q as C,h as D,q as E,Y as F,G,c as H,C as I,D as J,nt as K,l as L,F as M,rt as N,a as O,ct as S,ft as V,T as a,N as b,M as c,H as d,at as e,R as f,I as g,K as h,S as i,P as j,L as k,j as l,V as m,et as n,X as o,tt as p,J as q,Z as r,$ as s,ht as t,u,st as v,U as w,W as x,z as y,A as z};//# sourceMappingURL=fun-events.3d56e7e0.js.map
