import{n as e,v as t,S as s,l as r}from"./primitives.e781e476.js";import{m as n,k as i,j as o,b as u}from"./push-iterator.f6f3343e.js";import{f as c,s as a,b as h,z as l,t as d,k as p,x as f,w as y,h as w,q as _}from"./fun-events.f7c44dc9.js";const b=Symbol("context-key");class g{constructor(e){this.name=e}get[b](){return this}toString(){return`ContextKey(${this.name})`}}class x extends g{constructor(e){super(`${e.name}:seed`)}get seedKey(){return this}grow(e){const{seeder:t,seed:s}=e;t.isEmpty(s)&&e.hasFallback||e.insert(s)}}class v extends Error{constructor(e,t=`There is no value with key ${e}`){super(t),this.key=e}}class m{constructor(e){this._initial=e,this._issuers=new Map}issuer(e){const t=this._issuers.get(e);if(t)return t;const s=e.seeder(),r=[s,t=>s.seed(t,this._initial(e,t))];return this._issuers.set(e,r),r}newSeed(e,t){const{seedKey:s}=t,[r,n]=this.issuer(s);return s!==t?[r,e.get(s)]:[r,n(e)]}}function K(e){return"with"in e}class k{}class D{constructor(t,s,r,n={}){this.context=s,this.key=r,this._opts=n,this._constructed=null,this._setup=e;const[i,o]=t.newSeed(s,r);this.seeder=i,this.seed=o,this.hasFallback="or"in n}get or(){return this._opts.or}insert(e){this._constructed=e}fillBy(e){return e(this),this._constructed}setup(e){const t=this._setup;this._setup=s=>{t(s),e(s)}}_grow(){if(this.key.grow(this),null!=this._constructed)return[this._constructed,this._setup];if(!this.hasFallback)throw new v(this.key);return[this.or]}}class F{constructor(t){this._seeders=new m(t?"function"==typeof t?t:e=>t.get(e):e)}provide(e){const{a:{[b]:{seedKey:s}},by:r}=function(e){if(function(e){return"by"in e}(e)){if(!K(e))return e;const{a:t,by:s,with:r}=e;return{a:t,by:e=>s(...r.map((t=>e.get(t))))}}if(function(e){return"is"in e}(e)){const{a:s,is:r}=e;return{a:s,by:t(r)}}if(function(e){return"via"in e}(e)){const{a:t,via:s}=e;return{a:t,by:e=>e.get(s)}}if(function(e){return"as"in e}(e)){if(function(e){return!("a"in e)}(e)&&(e=function(e){return{...e,a:e.as}}(e)),!K(e)){const{as:t}=e;return{a:e.a,by:e=>new t(e)}}const{as:t,with:s}=e;return{a:e.a,by:e=>new t(...s.map((t=>e.get(t))))}}throw new TypeError(`Malformed context value specifier: ${JSON.stringify(e)}`)}(e),[n]=this._seeders.issuer(s);return n.provide(r)}seed(e,t){const[,s]=this._seeders.issuer(t);return s(e)}seeds(){return(e,t)=>this.seed(t,e)}seedIn(e){return this.newValues().get.bind(e)}newValues(){return function(e,t){const s=new Map;return new class extends k{get({[b]:r},n){const i=s.get(r);if(null!=i)return i;const[o,u]=new D(t,this,r,n)._grow();return u&&(s.set(r,o),u({key:r,context:this,registry:e})),o}}}(this,this._seeders)}append(e){const t="function"==typeof e?e:e.seeds();return new F(((e,s)=>{const r=t(e,s),[n,i]=this._seeders.issuer(e),o=i(s);return r?n.combine(o,r,s):o}))}}class S{constructor(){this._providers=[]}provide(e){const t=[e];return this._providers.unshift(t),new s((()=>this._providers.splice(this._providers.lastIndexOf(t),1)))}seed(t,s){const{length:n}=this._providers;if(!n)return s||e;const i=([e])=>r(e.bind(void 0,t));if(!s&&1===n)return i(this._providers[0]);const o=this._providers.map(i);return s&&o.push(s),E(o)}isEmpty(e){return null==e()}combine(t,s){return t===e?s:s===e?t:E([s,t])}}function E(e){return r((()=>{for(const t of e){const e=t();if(null!=e)return e}}))}class j extends x{seeder(){return new S}}class M extends g{constructor(e,{seedKey:t}={}){super(e),this.seedKey=t||new j(this)}}class O extends M{constructor(){super("context-supply")}grow(e){e.insert(e.seed()||(e.hasFallback?e.or:null)||e.context.supply)}}const $=new O;class C extends M{constructor(t,{seedKey:s,byDefault:r=e}={}){super(t,{seedKey:s}),this.byDefault=r}grow(e){const t=e.seed();null!=t?e.insert(t):e.hasFallback||e.insert(this.byDefault(e.context,this))}}function T(e){return()=>{throw null!=e?e:new TypeError("Context destroyed")}}const z=_(((e,...t)=>e(...o(u(...t)))));class B{constructor(){this._providers=d([new Map])}provide(e){const[t]=this._providers.it,r=new s;return t.set(r,e),this._providers.it=[t],r.whenOff((()=>{const[e]=this._providers.it;e.delete(r),this._providers.it=[e]}))}seed(e,t=h()){return this.combine(t,function(e,t){return t.read.do(p((([t])=>t.size?f(...n(n(i((()=>t.values())),(t=>t(e))),I)):h())),z)}(e,this._providers))}isEmpty(){return!1}combine(e,t){return f(e,t).do(z)}}function I(e){return null==e?h():function(e){return("object"==typeof e||"function"==typeof e)&&y(e)}(e)?w(e):h(e)}class U extends x{get upKey(){return this}seeder(){return new B}}class V extends g{constructor(e,t){super(e.name+":up"),this._key=e,this.grow=e=>{const s=e.fillBy(t);if(s){const t=e.context.get($,{or:null});t&&e.insert(s.do(a(t)))}}}get seedKey(){return this._key.seedKey}}class q extends g{constructor(e,{seedKey:t}={}){super(e),this.seedKey=t||new U(this)}createUpKey(e){return new V(this,e)}}class J extends q{constructor(t,{seedKey:s,byDefault:r=e}={}){super(t,s),this.byDefault=(e,t)=>r(e,t)||(()=>{throw new v(this)}),this.upKey=this.createUpKey((e=>{e.insert(e.seed.do(c(((...t)=>t.length?h(t[t.length-1]):e.hasFallback&&e.or?e.or:h(this.byDefault(e.context,this))))))}))}grow(e){let t;e.context.get(this.upKey,e.hasFallback?{or:null!=e.or?h(e.or):e.or}:void 0)((e=>t=e)).whenOff((e=>t=T(e))),e.insert(((...e)=>t(...e)))}}class N extends q{constructor(t,{seedKey:s,byDefault:r=e}={}){super(t,s),this.byDefault=r}get upKey(){return this}grow(e){const t=e.seed.do(c(((...t)=>{if(t.length)return h(t[t.length-1]);let s;if(e.hasFallback)s=e.or;else{const t=this.byDefault(e.context,this);s=t&&h(t)}return null!=s?s:l((()=>{throw new v(this)}))}))),s=e.context.get($,{or:null});e.insert(s?t.do(a(s)):t)}}export{b as C,J as F,N as S,C as a,k as b,F as c,q as d,T as e,$ as f,M as g};//# sourceMappingURL=context-values.69c73302.js.map
