{"version":3,"file":"articles.d75dce24.js","sources":["../../../src/common/articles/article.ts","../../../src/common/articles/feed-request.ts","../../../src/common/articles/feed-service.ts","../../../src/common/articles/feed-service.impl.ts","../../../src/common/articles/feed-support.feature.ts"],"sourcesContent":["import marked from 'marked';\nimport { UserProfile } from '../users';\n\nexport interface Article {\n  readonly slug: string;\n  readonly title: string;\n  readonly description: string;\n  readonly body: string;\n  readonly tagList: readonly string[];\n  readonly createdAt: string;\n  readonly updatedAt: string;\n  readonly favorited: boolean;\n  readonly favoritesCount: number;\n  readonly author: UserProfile;\n}\n\nexport function articleContent(article: Article): Promise<string> {\n  // TODO Sanitize article\n  return new Promise<string>((resolve, reject) => {\n    marked(article.body, (error, html) => {\n      if (error != null) {\n        reject(error);\n      } else {\n        resolve(html);\n      }\n    });\n  });\n}\n","import { itsEach, thruIt } from 'a-iterable';\nimport { NextSkip, nextSkip } from 'call-thru';\n\nexport type FeedId = '/personal-feed' | '/global-feed';\n\nexport interface FeedRequest {\n  readonly feed?: FeedId;\n  readonly tag?: string;\n  readonly author?: string;\n  readonly favorited?: string;\n  readonly limit?: number;\n  readonly offset?: number;\n}\n\nconst feedRequestKeys: readonly (keyof FeedRequest)[] = ['feed', 'tag', 'author', 'favorited', 'limit', 'offset'];\n\nexport function feedRequestsEqual(first: FeedRequest, second: FeedRequest): boolean {\n  return feedRequestKeys.every(key => first[key] === second[key]);\n}\n\nexport function feedRequestSearchParams(request: FeedRequest): URLSearchParams {\n\n  const params = new URLSearchParams();\n\n  itsEach(\n      thruIt(\n          feedRequestKeys,\n          key => key !== 'feed' ? key : nextSkip,\n          (key: keyof FeedRequest): [keyof FeedRequest, string] | NextSkip => {\n\n            const value = request[key];\n\n            return value ? [key, String(value)] : nextSkip;\n          },\n      ),\n      ([key, value]) => params.set(key, value),\n  );\n\n  return params;\n}\n","import { ContextRef, SingleContextKey } from 'context-values';\nimport { OnEvent } from 'fun-events';\nimport { ApiResponse } from '../api';\nimport { Article } from './article';\nimport { FeedRequest } from './feed-request';\n\nexport interface ArticleList {\n  readonly articles: readonly Article[];\n  readonly articlesCount: number;\n}\n\nexport interface FeedService {\n\n  articles(request: FeedRequest): OnEvent<[ApiResponse<ArticleList>]>;\n\n  tags(): OnEvent<string[]>;\n\n  article(slug: string): OnEvent<[ApiResponse<Article>]>;\n\n}\n\nexport const FeedService: ContextRef<FeedService> = new SingleContextKey<FeedService>('feed-service');\n","import { BootstrapContext } from '@wesib/wesib';\nimport { asis, nextArg, nextArgs, nextSkip } from 'call-thru';\nimport { afterSupplied, OnEvent, onEventBy, trackValueBy } from 'fun-events';\nimport { ApiFetch, ApiRequest, ApiResponse } from '../api';\nimport { Article } from './article';\nimport { FeedId, FeedRequest, feedRequestSearchParams } from './feed-request';\nimport { ArticleList, FeedService } from './feed-service';\n\ninterface FeedSource {\n  path: string;\n  auth?: boolean;\n}\n\nconst feedSources: { readonly [id in FeedId]: FeedSource } = {\n  '/personal-feed': { path: 'articles/feed', auth: true },\n  '/global-feed': { path: 'articles' },\n};\n\nexport class FeedService$ implements FeedService {\n\n  private readonly _apiFetch: ApiFetch;\n  private _tags?: OnEvent<string[]>;\n\n  constructor(context: BootstrapContext) {\n    this._apiFetch = context.get(ApiFetch);\n  }\n\n  articles(request: FeedRequest): OnEvent<[ApiResponse<ArticleList>]> {\n\n    const { path, auth } = feedSources[request.feed || '/global-feed'];\n\n    const apiRequest: ApiRequest<ArticleList> = {\n      path: `${path}?${feedRequestSearchParams(request)}`,\n      init: {\n        method: 'GET',\n        headers: {\n          Accept: 'application/json',\n        },\n      },\n      auth,\n      respondAs: asis,\n    };\n\n    return this._apiFetch(apiRequest);\n  }\n\n  article(slug: string): OnEvent<[ApiResponse<Article>]> {\n\n    const apiRequest: ApiRequest<Article> = {\n      path: `articles/${encodeURIComponent(slug)}`,\n      init: {\n        method: 'GET',\n        headers: {\n          Accept: 'application/json',\n        },\n      },\n      respondAs: 'article',\n    };\n\n    return this._apiFetch(apiRequest);\n  }\n\n  tags(): OnEvent<string[]> {\n    if (this._tags) {\n      return this._tags;\n    }\n\n    let onTags: OnEvent<string[]> | undefined;\n\n    return this._tags = onEventBy(receiver => {\n      if (!onTags) {\n\n        const apiRequest: ApiRequest<string[]> = {\n          path: 'tags',\n          init: {\n            method: 'GET',\n            headers: {\n              Accept: 'application/json',\n            },\n          },\n          respondAs: 'tags',\n          auth: false,\n        };\n        const onTagsLoad: OnEvent<[string[]]> = this._apiFetch(apiRequest).thru_(response => {\n          if (response.ok) {\n            return nextArg(response.body);\n          }\n          if (response.ok === false) {\n            console.log('Failed to load tags', response.errors);\n            return nextArg([]);\n          }\n          return nextSkip;\n        });\n        const tags = trackValueBy<string[] | undefined>(\n            afterSupplied<[string[]?]>(onTagsLoad, () => []),\n        );\n\n        onTags = tags.read.thru_(\n            tagList => tagList ? nextArgs(...tagList) : nextSkip,\n        );\n      }\n\n      onTags(receiver);\n    });\n  }\n\n}\n","import { Feature } from '@wesib/wesib';\nimport { FeedService } from './feed-service';\nimport { FeedService$ } from './feed-service.impl';\n\n@Feature({\n  setup(setup) {\n    setup.provide({ a: FeedService, as: FeedService$ });\n  },\n})\nexport class FeedSupport {\n}\n"],"names":["articleContent","article","Promise","resolve","reject","marked","body","error","html","feedRequestKeys","feedRequestsEqual","first","second","every","key","feedRequestSearchParams","request","params","URLSearchParams","itsEach","thruIt","nextSkip","value","String","set","FeedService","SingleContextKey","feedSources","/personal-feed","path","auth","/global-feed","FeedService$","[object Object]","context","this","_apiFetch","get","ApiFetch","feed","apiRequest","init","method","headers","Accept","respondAs","asis","slug","encodeURIComponent","_tags","onTags","onEventBy","receiver","onTagsLoad","thru_","response","ok","nextArg","console","log","errors","tags","trackValueBy","afterSupplied","read","tagList","nextArgs","FeedSupport","Feature","setup","provide","a","as"],"mappings":"ubAgBgBA,EAAeC,GAE7B,OAAO,IAAIC,QAAgB,CAACC,EAASC,KACnCC,EAAOJ,EAAQK,KAAM,CAACC,EAAOC,KACd,MAATD,EACFH,EAAOG,GAEPJ,EAAQK,OCThB,MAAMC,EAAkD,CAAC,OAAQ,MAAO,SAAU,YAAa,QAAS,mBAExFC,EAAkBC,EAAoBC,GACpD,OAAOH,EAAgBI,MAAMC,GAAOH,EAAMG,KAASF,EAAOE,aAG5CC,EAAwBC,GAEtC,MAAMC,EAAS,IAAIC,gBAgBnB,OAdAC,EACIC,EACIX,EACAK,GAAe,SAARA,EAAiBA,EAAMO,EAC7BP,IAEC,MAAMQ,EAAQN,EAAQF,GAEtB,OAAOQ,EAAQ,CAACR,EAAKS,OAAOD,IAAUD,IAG5C,EAAEP,EAAKQ,KAAWL,EAAOO,IAAIV,EAAKQ,IAG/BL,EACR,MClBYQ,EAAuC,IAAIC,EAA8B,gBCRhFC,EAAuD,CAC3DC,iBAAkB,CAAEC,KAAM,gBAAiBC,MAAM,GACjDC,eAAgB,CAAEF,KAAM,aAG1B,MAAaG,EAKXC,YAAYC,GACVC,KAAKC,UAAYF,EAAQG,IAAIC,GAG/BL,SAASjB,GAEP,MAAMa,KAAEA,EAAIC,KAAEA,GAASH,EAAYX,EAAQuB,MAAQ,gBAE7CC,EAAsC,CAC1CX,KAAM,GAAGA,KAAQd,EAAwBC,KACzCyB,KAAM,CACJC,OAAQ,MACRC,QAAS,CACPC,OAAQ,qBAGZd,KAAAA,EACAe,UAAWC,GAGb,OAAOX,KAAKC,UAAUI,GAGxBP,QAAQc,GAEN,MAAMP,EAAkC,CACtCX,KAAM,YAAYmB,mBAAmBD,KACrCN,KAAM,CACJC,OAAQ,MACRC,QAAS,CACPC,OAAQ,qBAGZC,UAAW,WAGb,OAAOV,KAAKC,UAAUI,GAGxBP,OACE,GAAIE,KAAKc,MACP,OAAOd,KAAKc,MAGd,IAAIC,EAEJ,OAAOf,KAAKc,MAAQE,EAAUC,IAC5B,IAAKF,EAAQ,CAEX,MAAMV,EAAmC,CACvCX,KAAM,OACNY,KAAM,CACJC,OAAQ,MACRC,QAAS,CACPC,OAAQ,qBAGZC,UAAW,OACXf,MAAM,GAEFuB,EAAkClB,KAAKC,UAAUI,GAAYc,MAAMC,GACnEA,EAASC,GACJC,EAAQF,EAASjD,OAEN,IAAhBiD,EAASC,IACXE,QAAQC,IAAI,sBAAuBJ,EAASK,QACrCH,EAAQ,KAEVpC,GAEHwC,EAAOC,EACTC,EAA2BV,EAAY,IAAM,KAGjDH,EAASW,EAAKG,KAAKV,MACfW,GAAWA,EAAUC,KAAYD,GAAW5C,GAIlD6B,EAAOE,MAIZ,ICjGYe,EAAb,QAAaA,KALZC,EAAQ,CACPnC,MAAMoC,GACJA,EAAMC,QAAQ,CAAEC,EAAG9C,EAAa+C,GAAIxC,QAG3BmC"}