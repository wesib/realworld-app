import{a6 as t,y as e,a7 as s,k as n,S as a,a1 as r,F as o,g as i,a8 as c,T as u,a9 as l,aa as p,p as h,Z as d,ab as f,K as g,ac as m,a as _,t as b,D as k,d as v,ad as y,r as w,N as x,A as j,ae as C,af as O,f as A,ag as E,ah as R,h as T,ai as P,aj as N,ak as S,al as $,am as q,an as F,ao as L,ap as I,a0 as D,L as M}from"./lib.722ff502.js";import{b as U,H as G,F as H,B as z,A as J,R as X,C as B,a as K,I as V,c as W,d as Z,t as Q,e as Y,f as tt,D as et,g as st,U as nt,h as at,i as rt,j as ot,k as it,l as ct}from"./wesib.828181c2.js";function ut(e){return new Promise((s,n)=>{t(e.body,(t,e)=>{null!=t?n(t):s(e)})})}const lt=["feed","tag","author","favorited","limit","offset"];function pt(t,e){return lt.every(s=>t[s]===e[s])}function ht(t){const a=new URLSearchParams;return e(s(lt,t=>"feed"!==t?t:n,e=>{const s=t[e];return s?[e,String(s)]:n}),([t,e])=>a.set(t,e)),a}const dt=new a("feed-service"),ft=new r("api-root-url",{byDefault:()=>new URL("https://conduit.productionready.io/api/")}),gt=new a("auth-service"),mt=new o("api-fetch",{byDefault:U((function(t){const e=t.get(G),s=t.get(ft);return n=>{const{path:a,init:r,auth:o}=n,l=s.thru_(t=>new URL(a,t),t=>function(t,e={}){const s=new Request(t.href,Object.assign({mode:"cors"},e)),{headers:n}=s;return n.set("X-Requested-With","XMLHttpRequest"),s}(t,r)).thru_(e=>!1===o?i({request:e}):c(function(t,e,s){return t.get(gt).authentication.keep.thru_(({token:t,failure:n})=>t?(e.headers.set("Authorization",`Token ${t}`),{request:e}):s?(n||(n={ok:!1,errors:{api:["Not authenticated"]}}),{failure:n}):{request:e})}(t,e,o)),t=>t.request?c(e(t.request).thru_(t=>({response:t}))):i({failure:t.failure}));return u(l.thru_(_t)).thru_(([t,e])=>function({respondAs:t},e,s){if(!e.response)return e.failure;const{response:n}=e;if(n.ok)return{ok:!0,response:n,body:"function"==typeof t?t(s):s[t]};return{ok:!1,response:n,errors:s.errors||{http:[n.statusText?`${n.status}: ${n.statusText}`:`ERROR ${n.status}`]}}}(n,t,e))}}))});function _t(t){return t.response?Promise.all([t,t.response.json()]).catch(e=>[{failure:{ok:!1,response:t.response,errors:{api:[`Failed to parse response: ${e}`]}}}]):[t]}new o("api-submitter",{byDefault:U((function(t){const e=t.get(mt);return t=>{const{init:s={}}=t,{method:n="POST",headers:a={}}=s;return r=>{const o=Object.assign(Object.assign({},t),{init:Object.assign(Object.assign({},s),{method:n,body:JSON.stringify(r),headers:Object.assign(Object.assign({},a),{Accept:"application/json","Content-Type":"application/json"})})});return bt(e(o))}}}))});function bt(t){return new Promise((e,s)=>{t.once(t=>{t.ok?e(t.body):s(new l({submit:"api",api:t.errors}))}).whenOff(t=>{s(t instanceof l?t:new l({submit:"cancel",cancel:t}))})})}const kt={"/personal-feed":{path:"articles/feed",auth:!0},"/global-feed":{path:"articles"}};class vt{constructor(t){this._apiFetch=t.get(mt)}articles(t){const{path:e,auth:s}=kt[t.feed||"/global-feed"],n={path:`${e}?${ht(t)}`,init:{method:"GET",headers:{Accept:"application/json"}},auth:s,respondAs:p};return this._apiFetch(n)}article(t){const e={path:`articles/${encodeURIComponent(t)}`,init:{method:"GET",headers:{Accept:"application/json"}},respondAs:"article"};return this._apiFetch(e)}tags(){if(this._tags)return this._tags;let t;return this._tags=h(e=>{if(!t){const e={path:"tags",init:{method:"GET",headers:{Accept:"application/json"}},respondAs:"tags",auth:!1},s=this._apiFetch(e).thru_(t=>t.ok?d(t.body):!1===t.ok?(console.log("Failed to load tags",t.errors),d([])):n),a=f(g(s,()=>[]));t=a.read.thru_(t=>t?i(...t):n)}t(e)})}}let yt=class{};yt=m([H({setup(t){t.provide({a:dt,as:vt})}})],yt);class wt{static get[_](){return gt}}class xt extends wt{constructor(t){super(),this._context=t;const e=t.get(z),s=e.localStorage;this._auth=b(jt(s.getItem("wesib-conduit:auth"))),this._auth.on((function({token:t}){t?s.setItem("wesib-conduit:auth",t):s.removeItem("wesib-conduit:auth")})),this.user=this.authentication.keep.thru((function(e){if(e.email)return i(e);if(e.failure)return i(void 0,e.failure);if(!e.token)return i();return c(function(e){const s=t.get(mt),n={path:"user",init:{headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Token ${e}`}},respondAs:"user",auth:!1};return v(t=>{s(n).thru_(t=>t.ok?i(t.body):i(void 0,t))({supply:w().needs(t.supply),receive(e,...s){t.receive(e,...s)}})},y())}(e.token))})),new k(e).on("storage")(({key:t,newValue:e})=>{if("wesib-conduit:auth"===t){const t=e||void 0;this._auth.it.token!==t&&(this._auth.it=jt(t))}})}get authentication(){return this._auth.read}login(t){return this._request("users/login",t)}register(t){return this._request("users",t)}logout(){this._auth.it={}}_request(t,e){return this._context.get(mt)({path:t,init:{method:"POST",body:JSON.stringify({user:e}),headers:{Accept:"application/json","Content-Type":"application/json"}},respondAs:"user",auth:!1}).thru_(t=>(t.ok?this._auth.it=t.body:!1===t.ok&&(this._auth.it={failure:t}),t))}}function jt(t){return t?{token:t}:{}}let Ct=class{};Ct=m([H({setup(t){t.provide({a:wt,as:xt})}})],Ct);const Ot=new x("https://wesib.github.io/realworld-app/ns/","conduit");let At=class{constructor(t){this._context=t}render(){const{document:t}=this._context.get(z),e=t.createRange();return e.selectNodeContents(this._context.contentRoot),()=>{e.deleteContents(),null!=this.loadError&&e.insertNode(t.createTextNode(this.loadError))}}};m([J("load-error")],At.prototype,"loadError",void 0),m([X()],At.prototype,"render",null),At=m([B(["loader",Ot])],At);class Et extends CustomEvent{}let Rt=class{constructor(t){this._context=t}render(){const{contentRoot:t}=this._context,{document:e}=this._context.get(z);return()=>{const n=this.totalPages&&parseInt(this.totalPages,10)||0,a=function(){const s=e.createRange();return s.selectNodeContents(t),s}();if(a.deleteContents(),n<=1)return;const r=Math.max(1,this.visiblePages&&parseInt(this.visiblePages,10)||5),o=this.currentPage&&parseInt(this.currentPage,10)||0,i=e.createElement("ul");i.className="pagination";let c=Math.max(0,o-(r>>1)),u=c+r;u>n&&(c=Math.max(0,c-(u-n)),u=n),i.appendChild(s("<<",0,o>0)),i.appendChild(s("<",o-1,o>0));for(let t=c;t<u;++t)i.appendChild(s(String(t+1),t,!0,o===t));i.appendChild(s(">",o+1,o+1<n)),i.appendChild(s(">>",n-1,o+1<n)),a.insertNode(i)};function s(t,s,n,a=!1){const r=e.createElement("li");let o;return r.className="page-item",n&&!a?(o=e.createElement("a"),o.setAttribute("href",""),new k(r).on("click").capture.instead(t=>{t.preventDefault(),r.dispatchEvent(new Et("conduit:pager",{cancelable:!0,bubbles:!0,detail:s}))})):(r.classList.add(a?"active":"disabled"),o=e.createElement("span")),o.className="page-link",o.innerHTML=t,r.appendChild(o),r}}};m([J("current-page")],Rt.prototype,"currentPage",void 0),m([J("total-pages")],Rt.prototype,"totalPages",void 0),m([J("visible-pages")],Rt.prototype,"visiblePages",void 0),m([X()],Rt.prototype,"render",null),Rt=m([B(["pager",Ot])],Rt);let Tt=class{};Tt=m([H({needs:[At,Rt]})],Tt);const Pt=new o("api-error-generator",{byDefault:U(t=>{const e=t.get(z).document;return t=>{let s;return j.from(C(t)).forEach(([t,n])=>{s||(s=e.createElement("ul"),s.classList.add("error-messages"));const a=s;n.forEach(s=>{const n=e.createElement("li");n.innerText=`${t} ${s}`,a.appendChild(n)})}),s}})});function Nt({mark:t="is-invalid",when:e}={}){return s=>{const n=s.aspect(O);return A({status:s.aspect(E),validity:s.aspect(R)}).keep.thru(({status:[{touched:s,hasFocus:a}],validity:[r]})=>{const o=r.has("incomplete")||r.has("missing");return!s||a&&o?i():T(n.specs(P({mark:t,when:e})))})}}const St={};let $t=class{constructor(t){this._context=t,this._errors=St,t.get(K).get(V).thru_(({control:t})=>t?T(t.aspect(R).read.keep.thru_(t=>t.messages("api").reduce((t,e)=>Object.assign(Object.assign({},t),e.api),St))):i(St))(t=>this.errors=t)}get errors(){return this._errors}set errors(t){const e=this._errors;e!==t&&(this._errors=t,this._context.updateState("errors",t,e))}render(){const{contentRoot:t}=this._context;let e;return()=>{e&&(e.remove(),e=void 0),e=this._context.get(Pt)(this.errors),e&&t.append(e)}}};m([X()],$t.prototype,"render",null),$t=m([B(["api-errors",Ot])],$t);let qt=class{};qt=m([B(["in-error",Ot],Z("code"),W(({control:{control:t},aspects:e,context:s})=>Q(s,"code").read.keep.thru_(t=>t?t.trim().split(/\s+/):[]).keep.thru(n=>t.convert(N.to(s.element),e).setup(O,t=>{t.add(S()),t.add(Nt({when:n}))}))))],qt);let Ft=class{};function Lt({emptyModel:t={},form:e={makeForm({node:e,aspects:s}){const n=q(t).setup(O,t=>t.add(S())).setup(F,t=>t.derive(L())),a=I(e.element,{form:n,aspects:s}).setup(O,t=>t.add(n.aspect(O)));return[n,a]}},button:s}={}){return B(st(e),function({select:t="button",pick:e={deep:!0,all:!0}}={}){return B({feature:{needs:Y},define(s){s.whenComponent(s=>{const n=s.get(tt),a=s.get(K);s.whenOn(r=>{A({form:a.get(V),button:n.select(t,e).first,aspects:s.get(et)}).tillOff(r).consume(({form:[{control:t}],button:[e],aspects:[s]})=>t&&e&&$(e.element,{form:t,aspects:s}))})})}})}(s))}function It(t){return nt(Object.assign(Object.assign({},t),{makeControl:e=>e.context.get(K).get(V).keep.thru_(({form:s})=>{const n=t.makeControl(e);return n?n instanceof D?a(n):T(g(n).keep.thru_((t,e)=>t?(a(t),e?i(t,e):i(t)):i())):i();function a(t){s&&t.aspect(F).derive(s.aspect(F));const e=t.aspect(O);return e.add(S()),e.add(Nt()),t}})}))}Ft=m([H({needs:[$t,qt]})],Ft);let Dt=class{};Dt=m([B(["main",Ot],at({onResponse({context:t,response:e,range:s}){if(!e.ok){s.deleteContents();const{document:n}=t.get(z),a=n.createElement("conduit-loader");null!=e.ok&&a.setAttribute("load-error",`Error. ${String(e.error)}`),s.insertNode(a)}}}))],Dt);let Mt=class{};Mt=m([B(["navbar",Ot],ot(),rt({active:"active"}))],Mt);const Ut=["authenticated",Ot],Gt=["not-authenticated",Ot];let Ht=class{constructor(t){this._context=t,this._auth={},t.whenOn(e=>{t.get(wt).authentication.tillOff(e)(t=>{this.auth=t})})}get auth(){return this._auth}set auth(t){const e=this._auth;this._auth=t,this._context.updateState("auth",t,e)}render(){const t=this._context.get(it),e=M.name(Ut,t),s=M.name(Gt,t),{classList:n}=this._context.element;return()=>{this.auth.token?(n.remove(s),n.add(e)):(n.remove(e),n.add(s))}}};m([X()],Ht.prototype,"render",null),Ht=m([B({name:["container",Ot],feature:{needs:[Dt,Mt]}})],Ht);let zt=class{};zt=m([B(["footer",Ot],ot())],zt);let Jt=class{};Jt=m([H({needs:[Ht,zt]})],Jt);let Xt=class{};Xt=m([H({needs:[Ct,Tt,Ft,Jt,yt]})],Xt);const Bt={"&":"&amp;","<":"&lt;",">":"&gt;"};function Kt(t){return Bt[t]||t}function Vt(t){return t?t.replace(/[&<>]/g,Kt):""}const Wt=ct(Xt);export{wt as A,Ot as C,dt as F,It as U,ut as a,pt as b,Wt as c,Pt as d,Vt as e,ht as f,Lt as g,bt as h};//# sourceMappingURL=common.d13eb97a.js.map
