import{d as e}from"./proc7ts/call-thru.e704f478.js";import{S as t,C as s,a as r}from"./proc7ts/context-values.fcd8ebea.js";import{g as n,t as a,i,n as o}from"./proc7ts/fun-events.8bfc632f.js";import{g as c,i as l,j as p,h as d,B as u,l as f,S as h,D as m,C as g,u as b,R as C}from"./wesib/wesib.4a501e1a.js";import{_}from"./helpers.e1623395.js";import{n as x,b as v}from"./core/auth.22a94593.js";import{e as E,f as y,P,a as w,N as j}from"./wesib/generic.d0f646b2.js";import{C as q}from"./core.714cbb7b.js";import{R as D,a as R}from"./core/loader.26b86fd6.js";import"./core/input.d2e380ed.js";import{A as S}from"./article-buttons-support.feature.51ab8e2a.js";import{r as A}from"./core/util.32ae6bb0.js";import{f as M,n as N,F as k,a as I,b as T}from"./core/feed.329a3c7f.js";import{a as F,C as O}from"./current-article.820caa9f.js";const H=Symbol("paging-info");function L(e={}){const{render:t}=e;return c(({get:e,set:s,key:r})=>{const n=[f,H,r],a=l.fulfill({on:n},t);return{componentDef:p.all(D({render:a,comment:`PAGER(${String(r)})`}).As((function(){const t=d.of(this),{document:s}=t.get(u),r=e(this);if(!r.totalPages||r.totalPages<=1)return;const n=r,{totalPages:a,visiblePages:i=5,currentPage:o=0}=n,c=Math.max(1,i),l=Math.max(0,o),p=s.createElement("ul");p.className="pagination";let f=Math.max(0,l-(c>>1)),h=f+c;h>a&&(f=Math.max(0,f-(h-a)),h=a);p.appendChild(m("<<",0,l>0)),p.appendChild(m("<",l-1,l>0));for(let e=f;e<h;++e)p.appendChild(m(String(e+1),e,!0,l===e));return p.appendChild(m(">",l+1,l+1<a)),p.appendChild(m(">>",a-1,l+1<a)),p;function m(e,t,r,a=!1){const i=s.createElement("li");let o;return i.className="page-item",r&&!a?(o=s.createElement("a"),o.setAttribute("href",n.pageHref(t))):(i.classList.add(a?"active":"disabled"),o=s.createElement("span")),o.className="page-link",o.innerHTML=e,i.appendChild(o),i}}),r),E()),get:e,set(t,r){const a=e(t);s(t,r),d.of(t).updateState(n,r,a)}}})}const B=new class extends y{create(e,t){const s=this.byDefault(e);return s.put(t),s}byDefault(e){return{get(){const{searchParams:t,pathname:s}=e.get(P);return{feed:"/personal-feed"===s?s:void 0,tag:t.get("tag")||void 0,limit:parseInt(t.get("limit")||"",10)||void 0,offset:parseInt(t.get("offset")||"",10)||void 0}},put(t){const{feed:s}=t,r=new URL(e.get(P).href);r.pathname="/personal-feed"===s?s:"";const n=M(t).toString();r.search=n?"?"+n:"",e.put(P,r)}}}};let U=(()=>{let e=class{constructor(e){this._context=e,this._article=new F,this.user=x;const t=e.get(v),s=e.get(w);t.user().tillOff(e).to(e=>this.user=e).whenOff(()=>this.user=x),s.provide({a:O,is:this._article})}get article(){return this._article.it}set article(e){this._article.set(e)}postMeta(){if(!this.article.slug)return;const{author:e}=this.article,{document:t}=this._context.get(u),s=t.createDocumentFragment(),r=s.appendChild(t.createElement("div"));r.className="post-meta";const n=r.appendChild(t.createElement("conduit-article-author"));if(A(n,this._context),this.user.username===e.username){const e=r.appendChild(t.createElement("conduit-edit-post-btn"));e.tabIndex=0,A(e,this._context);const s=r.appendChild(t.createElement("conduit-delete-post-btn"));s.tabIndex=0,A(s,this._context)}else{const e=r.appendChild(t.createElement("conduit-favorite-post-btn"));e.tabIndex=0,A(e,this._context)}const a=s.appendChild(t.createElement("a"));a.className="preview-link",a.setAttribute("href","article/#/"+encodeURIComponent(this.article.slug));a.appendChild(t.createElement("h1")).innerText=this.article.title;a.appendChild(t.createElement("p")).innerText=this.article.description;a.appendChild(t.createElement("span")).innerText="Read more...";const i=a.appendChild(t.createElement("conduit-article-tags"));return A(i,this._context),s}};return _([h()],e.prototype,"user",void 0),_([m({propertyKey:"feedArticle"})],e.prototype,"article",null),_([D()],e.prototype,"postMeta",null),e=_([g(["article-preview",q],{feature:{needs:[S]}},E({href(e){let t=e.target;for(;;){const e=t.getAttribute("href");if(null!=e)return e;const{parentNode:s}=t;if(!s||!b(s))return;t=s}}}))],e),e})();const $=new t("feed-article-list",{byDefault:()=>N});let G=(()=>{let e=class{constructor(e){this._context=e,this.articles=N;e.get(w).get($).to(e=>this.articles=e).whenOff(()=>this.articles=N)}render(){const e=this._context.get(u).document,t=e.createRange();return t.selectNodeContents(this._context.contentRoot),()=>{if(t.deleteContents(),!this.articles.articlesCount)return;const s=e.createDocumentFragment();this.articles.articles.forEach(t=>{const r=s.appendChild(e.createElement("conduit-article-preview"));r.feedArticle=t,A(r,this._context)}),t.insertNode(s)}}};return _([h()],e.prototype,"articles",void 0),_([C()],e.prototype,"render",null),e=_([g(["article-list",q],{feature:{needs:U}})],e),e})();const K=new t("feed-request-page-param",{byDefault:()=>B});let z=(()=>{let e=class{constructor(e){this._feedPaging={};const t=e.get(w),s=e.get(j);e.whenConnected(()=>{n({param:t.get(K),page:s,list:t.get($)}).tillOff(e).to(({param:[e],page:[t],list:[{articlesCount:r}]})=>{const n=t.get(e),{limit:a=20,offset:i=0}=n;this.feedPaging={totalPages:Math.ceil(r/a),currentPage:Math.floor(i/a),pageHref(t){var r;return(null===(r=s.with(e,{...n,offset:a*t}).pretend())||void 0===r?void 0:r.url.href)||""}}})})}get feedPaging(){return this._feedPaging}set feedPaging(e){this._feedPaging=e}};return _([L()],e.prototype,"feedPaging",null),e=_([g(["feed-pager",q])],e),e})();const J=new r("render-feed-state"),Q=Symbol("render-feed-state");class V{constructor(e,t){this.response=a(),this._request=a({}),i(e).cuts(this._request);const s=e.get(I);this.response.on((s,r)=>e.updateState(t,s,r)),e.get(w).provide({a:$,is:this.response.read().keepThru_(e=>(null==e?void 0:e.ok)?e.body:{articles:[],articlesCount:0})}),this._request.read().thru_(e=>(this.response.it=void 0,o(s.articles(e)))).to(e=>this.response.it=e),e.on("conduit:article").to(()=>this._request.it={...this._request.it})}static get[s](){return J}get request(){return this._request.it}set request(e){const t=this.request;T(e,t)||(this._request.it=e)}}function W(t={}){const{requestParam:s,render:r}=t;return c(({get:t,set:n,key:a})=>{const i=[f,Q,a],o=l.fulfill({on:i},r);return{componentDef:p.all({feature:{needs:[G,z,k]},define(e){e.perComponent({a:V,by:e=>new V(e,i)}),s&&e.whenComponent(e=>{e.get(w).provide({a:K,is:s})})}},R({render:o,comment:`FEED(${String(a)})`}).By((function(e){return d.of(e).get(V).response.it}),a),C(o).As((function(){const t=d.of(this),{contentRoot:s}=t,r=t.get(u).document;return s.appendChild(r.createElement("conduit-article-list")),s.appendChild(r.createElement("conduit-feed-pager")),e}),a)),get:t,set(e,t){n(e,t),d.of(e).get(V).request=t}}})}export{B as P,W as R};//# sourceMappingURL=render-feed.decorator.91a835d3.js.map
