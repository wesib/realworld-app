import{C as e,a as t}from"./proc7ts/context-values.24d38e04.js";import{m as s,t as r,j as a,s as n,G as i}from"./proc7ts/fun-events.3257bf57.js";import{n as o}from"./proc7ts/primitives.38e5298b.js";import{m as c,P as l,l as u,d,k as p,g as h,N as f}from"./wesib/generic.daf122de.js";import{S as g,A as m,C as b,u as _,B as v,s as C,R as F,c as w,e as y,f as P,d as x,g as E}from"./wesib/wesib.c496f508.js";import{f as q,b as j,C as A,n as R,a as S,F as D,c as I}from"./core/feed.d56f0914.js";import{R as N,b as k,a as M}from"./core/loader.b1c22415.js";import{_ as B}from"./helpers.e1623395.js";import{C as T}from"./core.10059585.js";import{n as O,b as U}from"./core/auth.3f3b4c69.js";import{A as $,C as G}from"./article-buttons-support.feature.8a881d48.js";class H extends c{create(e,t){const s=this.byDefault(e);return s.put(t),s}byDefault(e){return{get(){const{searchParams:t,pathname:s}=e.get(l);return{feed:"/personal-feed"===s?s:void 0,tag:t.get("tag")||void 0,limit:parseInt(t.get("limit")||"",10)||void 0,offset:parseInt(t.get("offset")||"",10)||void 0}},put(t){const{feed:s}=t,r=new URL(e.get(l).href);r.pathname="/personal-feed"===s?s:"";const a=q(t).toString();r.search=a?"?"+a:"",e.put(l,r)}}}}const L=new H;var z;class J extends u{constructor(){super("current-article")}static get[(z=d,e)](){return this[d][e]}static articlesFor(e){return this[d].articlesFor(e)}articlesFor(e){return this.valueFor(e).do(s(((e,t)=>e||j)))}}J[z]=new J;let K=class{constructor(e){this._context=e,this._slug=r(),this._article=new A,this.user=O,this._article.byArticles(a({list:J.articlesFor(e),slug:this._slug}).do(s((({list:[e],slug:[t]})=>t?e.bySlug(t):R)))),this._article.on(((t,s)=>{e.updateState(_("article"),t,s)})),this.currentArticle=this._article.read;e.get(U).user.do(n(e))((e=>{this.user=e})).whenOff((()=>{this.user=O}))}get slug(){return this._slug.it}set slug(e){this._slug.it=e}get article(){return this._article.it}postMeta(){if(!this.article.slug)return;const{author:e}=this.article,{document:t}=this._context.get(v),s=t.createDocumentFragment(),r=s.appendChild(t.createElement("div"));if(r.className="post-meta",r.appendChild(t.createElement("conduit-article-author")),this.user.username===e.username){r.appendChild(t.createElement("conduit-edit-post-btn")).tabIndex=0;r.appendChild(t.createElement("conduit-delete-post-btn")).tabIndex=0}else{r.appendChild(t.createElement("conduit-favorite-post-btn")).tabIndex=0}const a=s.appendChild(t.createElement("a"));a.className="preview-link",a.setAttribute("href",`article/#/${encodeURIComponent(this.article.slug)}`);a.appendChild(t.createElement("h1")).innerText=this.article.title;a.appendChild(t.createElement("p")).innerText=this.article.description;return a.appendChild(t.createElement("span")).innerText="Read more...",a.appendChild(t.createElement("conduit-article-tags")),s}};B([g()],K.prototype,"user",void 0),B([p(G)],K.prototype,"currentArticle",void 0),B([m({updateState:!1})],K.prototype,"slug",null),B([N()],K.prototype,"postMeta",null),K=B([b(["article-preview",T],{feature:{needs:[$]}},h({href(e){let t=e.target;for(;;){const e=t.getAttribute("href");if(null!=e)return e;const{parentNode:s}=t;if(!s||!C(s))return;t=s}}}))],K);let Q=class{constructor(e){this._context=e,this.articles=j,J.articlesFor(e)((e=>{this.articles=e})).whenOff((()=>{this.articles=j}))}render(){const e=this._context.get(v).document,t=e.createRange();return t.selectNodeContents(this._context.contentRoot),()=>{if(t.deleteContents(),!this.articles.count)return;const s=e.createDocumentFragment();this.articles.list.forEach((t=>{s.appendChild(e.createElement("conduit-article-preview")).setAttribute("slug",t.slug)})),t.insertNode(s)}}};var V;B([g()],Q.prototype,"articles",void 0),B([F()],Q.prototype,"render",null),Q=B([b(["article-list",T],{feature:{needs:K}})],Q);class W extends u{constructor(){super("feed-request")}static get[(V=d,e)](){return this[d][e]}static pageFeedParamFor(e){return this[d].pageFeedParamFor(e)}pageFeedParamFor(e){return this.valueFor(e).do(s(((e,t)=>e||L)))}}W[V]=new W;let X=class{constructor(e){this._feedPaging={};const t=e.get(f);e.whenConnected((()=>{a({param:W.pageFeedParamFor(e),page:t,list:J.articlesFor(e)}).do(n(e))((({param:[e],page:[s],list:[{count:r}]})=>{const a=s.get(e),{limit:n=20,offset:i=0}=a;this.feedPaging={totalPages:Math.ceil(r/n),currentPage:Math.floor(i/n),pageHref(s){var r;return(null===(r=t.with(e,{...a,offset:n*s}).pretend())||void 0===r?void 0:r.url.href)||""}}}))}))}get feedPaging(){return this._feedPaging}set feedPaging(e){this._feedPaging=e}};B([k()],X.prototype,"feedPaging",null),X=B([b(["feed-pager",T])],X);const Y=new t("render-feed-state"),Z=Symbol("render-feed-state");class ee{constructor(e,t){this.response=r(),this._request=r({}),e.supply.cuts(this._request);const s=e.get(D);this.response.on(((s,r)=>{e.updateState(t,s,r)})),e.on("conduit:article")((()=>{this._request.it={...this._request.it}})),e.whenConnected((()=>{this._request.read.do(i((t=>(this.response.it=void 0,s.articles(t)((e=>this.response.it=e)).needs(e)))))}))}static get[e](){return Y}get request(){return this._request.it}set request(e){const t=this.request;I(e,t)||(this._request.it=e)}}function te(e={}){const{requestParam:t,render:r}=e;return w((({get:e,set:a,key:n})=>{const i=[E,Z,n],c=y.fulfill({on:i},r);return{componentDef:P.all({feature:{needs:[Q,X,S]},define(e){e.perComponent({a:ee,by:e=>new ee(e,i)})}},M({render:c,comment:`FEED(${String(n)})`}).By((function(e){return x.of(e).get(ee).response.it}),n),F(c).As((function(){const e=x.of(this),{contentRoot:t}=e,s=e.get(v).document;return t.appendChild(s.createElement("conduit-article-list")),t.appendChild(s.createElement("conduit-feed-pager")),o}),n),...t?[p(W).As(t,n)]:[],p(J).By((e=>x.of(e).get(ee).response.read.do(s((e=>(null==e?void 0:e.ok)?e.body:j)))),n)),get:e,set(e,t){a(e,t),x.of(e).get(ee).request=t}}}))}export{L as P,te as R};//# sourceMappingURL=render-feed.decorator.02ef0b9f.js.map
