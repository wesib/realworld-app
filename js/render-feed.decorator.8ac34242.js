import{d as e}from"./proc7ts/call-thru.ea70618a.js";import{S as t,C as s,a as r}from"./proc7ts/context-values.ec10addc.js";import{g as a,t as n,i,n as o}from"./proc7ts/fun-events.6f8cd792.js";import{d as c,i as l,e as p,B as d,S as u,D as h,C as f,s as g,R as m}from"./wesib/wesib.b26c9eb2.js";import{_ as C}from"./helpers.920c7f83.js";import{n as b,b as _}from"./core/auth.d65ee920.js";import{f as x,g as v,P as E,a as y,N as P}from"./wesib/generic.69ca2bbe.js";import{C as w}from"./core.c852ba8c.js";import{R as j,a as q}from"./core/loader.136d3593.js";import{A as R}from"./article-buttons-support.feature.218ee76e.js";import{r as S}from"./core/util.8de4f331.js";import{f as A,n as D,F as M,a as N,b as I}from"./core/feed.00c91d3f.js";import{a as O,C as T}from"./current-article.34094ac4.js";const k=Symbol("paging-info");const L=new class extends v{create(e,t){const s=this.byDefault(e);return s.put(t),s}byDefault(e){return{get(){const{searchParams:t,pathname:s}=e.get(E);return{feed:"/personal-feed"===s?s:void 0,tag:t.get("tag")||void 0,limit:parseInt(t.get("limit")||"",10)||void 0,offset:parseInt(t.get("offset")||"",10)||void 0}},put(t){const{feed:s}=t,r=new URL(e.get(E).href);r.pathname="/personal-feed"===s?s:"";const a=A(t).toString();r.search=a?"?"+a:"",e.put(E,r)}}}};let F=class{constructor(e){this._context=e,this._article=new O,this.user=b;const t=e.get(_),s=e.get(y);t.user().tillOff(e).to(e=>this.user=e).whenOff(()=>this.user=b),s.provide({a:T,is:this._article})}get article(){return this._article.it}set article(e){this._article.set(e)}postMeta(){if(!this.article.slug)return;console.log("[article",this.article.slug);const{author:e}=this.article,{document:t}=this._context.get(d),s=t.createDocumentFragment(),r=s.appendChild(t.createElement("div"));r.className="post-meta";const a=r.appendChild(t.createElement("conduit-article-author"));if(S(a,this._context),this.user.username===e.username){const e=r.appendChild(t.createElement("conduit-edit-post-btn"));e.tabIndex=0,S(e,this._context);const s=r.appendChild(t.createElement("conduit-delete-post-btn"));s.tabIndex=0,S(s,this._context)}else{const e=r.appendChild(t.createElement("conduit-favorite-post-btn"));e.tabIndex=0,S(e,this._context)}const n=s.appendChild(t.createElement("a"));n.className="preview-link",n.setAttribute("href",`article/#/${encodeURIComponent(this.article.slug)}`),n.appendChild(t.createElement("h1")).innerText=this.article.title,n.appendChild(t.createElement("p")).innerText=this.article.description,n.appendChild(t.createElement("span")).innerText="Read more...";const i=n.appendChild(t.createElement("conduit-article-tags"));return S(i,this._context),console.log("]article",this.article.slug),s}};C([u()],F.prototype,"user",void 0),C([h({propertyKey:"feedArticle"})],F.prototype,"article",null),C([j()],F.prototype,"postMeta",null),F=C([f(["article-preview",w],{feature:{needs:[R]}},x({href(e){let t=e.target;for(;;){const e=t.getAttribute("href");if(null!=e)return e;const{parentNode:s}=t;if(!s||!g(s))return;t=s}}}))],F);const H=new t("feed-article-list",{byDefault:()=>D});let $=class{constructor(e){this._context=e,this.articles=D,e.get(y).get(H).to(e=>this.articles=e).whenOff(()=>this.articles=D)}render(){const e=this._context.get(d).document,t=e.createRange();return t.selectNodeContents(this._context.contentRoot),()=>{if(t.deleteContents(),!this.articles.articlesCount)return;console.log("[ARTICLES[");const s=e.createDocumentFragment();this.articles.articles.forEach(t=>{const r=s.appendChild(e.createElement("conduit-article-preview"));r.feedArticle=t,S(r,this._context)}),t.insertNode(s),console.log("]ARTICLES]")}}};C([u()],$.prototype,"articles",void 0),C([m()],$.prototype,"render",null),$=C([f(["article-list",w],{feature:{needs:F}})],$);const B=new t("feed-request-page-param",{byDefault:()=>L});let U=class{constructor(e){this._feedPaging={};const t=e.get(y),s=e.get(P);e.whenConnected(()=>{a({param:t.get(B),page:s,list:t.get(H)}).tillOff(e).to(({param:[e],page:[t],list:[{articlesCount:r}]})=>{const a=t.get(e),{limit:n=20,offset:i=0}=a;this.feedPaging={totalPages:Math.ceil(r/n),currentPage:Math.floor(i/n),pageHref(t){var r;return(null===(r=s.with(e,Object.assign(Object.assign({},a),{offset:n*t})).pretend())||void 0===r?void 0:r.url.href)||""}}})})}get feedPaging(){return this._feedPaging}set feedPaging(e){this._feedPaging=e}};C([c(({get:e,set:t,key:s})=>{const r=[k,s];return{componentDef:l.all(j({path:r,comment:`PAGER(${String(s)})`}).As((function(){const t=p.of(this),{document:s}=t.get(d),r=e(this);if(!r.totalPages||r.totalPages<=1)return;const a=r,{totalPages:n,visiblePages:i=5,currentPage:o=0}=a,c=Math.max(1,i),l=Math.max(0,o),u=s.createElement("ul");u.className="pagination";let h=Math.max(0,l-(c>>1)),f=h+c;f>n&&(h=Math.max(0,h-(f-n)),f=n),u.appendChild(g("<<",0,l>0)),u.appendChild(g("<",l-1,l>0));for(let e=h;e<f;++e)u.appendChild(g(String(e+1),e,!0,l===e));return u.appendChild(g(">",l+1,l+1<n)),u.appendChild(g(">>",n-1,l+1<n)),u;function g(e,t,r,n=!1){const i=s.createElement("li");let o;return i.className="page-item",r&&!n?(o=s.createElement("a"),o.setAttribute("href",a.pageHref(t))):(i.classList.add(n?"active":"disabled"),o=s.createElement("span")),o.className="page-link",o.innerHTML=e,i.appendChild(o),i}}),s),x()),get:e,set(s,a){const n=e(s);t(s,a),p.of(s).updateState(r,a,n)}}})],U.prototype,"feedPaging",null),U=C([f(["feed-pager",w])],U);const G=new r("render-feed-state"),K=Symbol("render-feed-state");class z{constructor(e,t){this.response=n(),this._request=n({}),i(e).cuts(this._request);const s=e.get(N);this.response.on((s,r)=>e.updateState(t,s,r)),e.get(y).provide({a:H,is:this.response.read().keepThru_(e=>(null==e?void 0:e.ok)?e.body:{articles:[],articlesCount:0})}),this._request.read().thru_(e=>(this.response.it=void 0,o(s.articles(e)))).to(e=>this.response.it=e),e.on("conduit:article").to(()=>this._request.it=Object.assign({},this._request.it))}static get[s](){return G}get request(){return this._request.it}set request(e){const t=this.request;I(e,t)||(this._request.it=e)}}function J({requestParam:t}={}){return c(({get:s,set:r,key:a})=>{const n=[K,a];return{componentDef:l.all({feature:{needs:[$,U,M]},define(e){e.perComponent({a:z,by:e=>new z(e,n)}),t&&e.whenComponent(e=>{e.get(y).provide({a:B,is:t})})}},q({path:n,comment:`FEED(${String(a)})`}).By((function(e){return p.of(e).get(z).response.it}),a),m({path:n}).As((function(){const t=p.of(this),{contentRoot:s}=t,r=t.get(d).document;return s.appendChild(r.createElement("conduit-article-list")),s.appendChild(r.createElement("conduit-feed-pager")),e}),a)),get:s,set(e,t){r(e,t),p.of(e).get(z).request=t}}})}export{L as P,J as R};//# sourceMappingURL=render-feed.decorator.8ac34242.js.map
