import{d as e}from"./proc7ts/call-thru.505a1d44.js";import{S as t,C as s,a}from"./proc7ts/context-values.4cd072ea.js";import{g as r,t as n,i,n as o}from"./proc7ts/fun-events.acc4e246.js";import{d as c,i as l,e as p,B as d,S as u,D as h,C as f,s as m,R as g}from"./wesib/wesib.3bdcccfe.js";import{_ as b}from"./helpers.920c7f83.js";import{n as C,b as _}from"./core/auth.edf46cc7.js";import{f as x,g as v,P as E,a as y,N as P}from"./wesib/generic.6c2cdd2b.js";import{C as w}from"./core.c852ba8c.js";import{R as j,a as q}from"./core/loader.200fc290.js";import{A as D}from"./article-buttons-support.feature.814801ce.js";import{r as R}from"./core/util.5b822750.js";import{f as S,n as A,F as M,a as N,b as O}from"./core/feed.7f124a84.js";import{a as k,C as I}from"./current-article.3de1eaaf.js";const T=Symbol("paging-info");const F=new class extends v{create(e,t){const s=this.byDefault(e);return s.put(t),s}byDefault(e){return{get(){const{searchParams:t,pathname:s}=e.get(E);return{feed:"/personal-feed"===s?s:void 0,tag:t.get("tag")||void 0,limit:parseInt(t.get("limit")||"",10)||void 0,offset:parseInt(t.get("offset")||"",10)||void 0}},put(t){const{feed:s}=t,a=new URL(e.get(E).href);a.pathname="/personal-feed"===s?s:"";const r=S(t).toString();a.search=r?"?"+r:"",e.put(E,a)}}}};let H=class{constructor(e){this._context=e,this._article=new k,this.user=C;const t=e.get(_),s=e.get(y);t.user().tillOff(e).to(e=>this.user=e).whenOff(()=>this.user=C),s.provide({a:I,is:this._article})}get article(){return this._article.it}set article(e){this._article.set(e)}postMeta(){if(!this.article.slug)return;const{author:e}=this.article,{document:t}=this._context.get(d),s=t.createDocumentFragment(),a=s.appendChild(t.createElement("div"));a.className="post-meta";const r=a.appendChild(t.createElement("conduit-article-author"));if(R(r,this._context),this.user.username===e.username){const e=a.appendChild(t.createElement("conduit-edit-post-btn"));e.tabIndex=0,R(e,this._context);const s=a.appendChild(t.createElement("conduit-delete-post-btn"));s.tabIndex=0,R(s,this._context)}else{const e=a.appendChild(t.createElement("conduit-favorite-post-btn"));e.tabIndex=0,R(e,this._context)}const n=s.appendChild(t.createElement("a"));n.className="preview-link",n.setAttribute("href",`article/#/${encodeURIComponent(this.article.slug)}`),n.appendChild(t.createElement("h1")).innerText=this.article.title,n.appendChild(t.createElement("p")).innerText=this.article.description,n.appendChild(t.createElement("span")).innerText="Read more...";const i=n.appendChild(t.createElement("conduit-article-tags"));return R(i,this._context),s}};b([u()],H.prototype,"user",void 0),b([h({propertyKey:"feedArticle"})],H.prototype,"article",null),b([j()],H.prototype,"postMeta",null),H=b([f(["article-preview",w],{feature:{needs:[D]}},x({href(e){let t=e.target;for(;;){const e=t.getAttribute("href");if(null!=e)return e;const{parentNode:s}=t;if(!s||!m(s))return;t=s}}}))],H);const L=new t("feed-article-list",{byDefault:()=>A});let $=class{constructor(e){this._context=e,this.articles=A,e.get(y).get(L).to(e=>this.articles=e).whenOff(()=>this.articles=A)}render(){const e=this._context.get(d).document,t=e.createRange();return t.selectNodeContents(this._context.contentRoot),()=>{if(t.deleteContents(),!this.articles.articlesCount)return;const s=e.createDocumentFragment();this.articles.articles.forEach(t=>{const a=s.appendChild(e.createElement("conduit-article-preview"));a.feedArticle=t,R(a,this._context)}),t.insertNode(s)}}};b([u()],$.prototype,"articles",void 0),b([g()],$.prototype,"render",null),$=b([f(["article-list",w],{feature:{needs:H}})],$);const B=new t("feed-request-page-param",{byDefault:()=>F});let U=class{constructor(e){this._feedPaging={};const t=e.get(y),s=e.get(P);e.whenConnected(()=>{r({param:t.get(B),page:s,list:t.get(L)}).tillOff(e).to(({param:[e],page:[t],list:[{articlesCount:a}]})=>{const r=t.get(e),{limit:n=20,offset:i=0}=r;this.feedPaging={totalPages:Math.ceil(a/n),currentPage:Math.floor(i/n),pageHref(t){var a;return(null===(a=s.with(e,Object.assign(Object.assign({},r),{offset:n*t})).pretend())||void 0===a?void 0:a.url.href)||""}}})})}get feedPaging(){return this._feedPaging}set feedPaging(e){this._feedPaging=e}};b([c(({get:e,set:t,key:s})=>{const a=[T,s];return{componentDef:l.all(j({path:a,comment:`PAGER(${String(s)})`}).As((function(){const t=p.of(this),{document:s}=t.get(d),a=e(this);if(!a.totalPages||a.totalPages<=1)return;const r=a,{totalPages:n,visiblePages:i=5,currentPage:o=0}=r,c=Math.max(1,i),l=Math.max(0,o),u=s.createElement("ul");u.className="pagination";let h=Math.max(0,l-(c>>1)),f=h+c;f>n&&(h=Math.max(0,h-(f-n)),f=n),u.appendChild(m("<<",0,l>0)),u.appendChild(m("<",l-1,l>0));for(let e=h;e<f;++e)u.appendChild(m(String(e+1),e,!0,l===e));return u.appendChild(m(">",l+1,l+1<n)),u.appendChild(m(">>",n-1,l+1<n)),u;function m(e,t,a,n=!1){const i=s.createElement("li");let o;return i.className="page-item",a&&!n?(o=s.createElement("a"),o.setAttribute("href",r.pageHref(t))):(i.classList.add(n?"active":"disabled"),o=s.createElement("span")),o.className="page-link",o.innerHTML=e,i.appendChild(o),i}}),s),x()),get:e,set(s,r){const n=e(s);t(s,r),p.of(s).updateState(a,r,n)}}})],U.prototype,"feedPaging",null),U=b([f(["feed-pager",w])],U);const G=new a("render-feed-state"),K=Symbol("render-feed-state");class z{constructor(e,t){this.response=n(),this._request=n({}),i(e).cuts(this._request);const s=e.get(N);this.response.on((s,a)=>e.updateState(t,s,a)),e.get(y).provide({a:L,is:this.response.read().keepThru_(e=>(null==e?void 0:e.ok)?e.body:{articles:[],articlesCount:0})}),this._request.read().thru_(e=>(this.response.it=void 0,o(s.articles(e)))).to(e=>this.response.it=e),e.on("conduit:article").to(()=>this._request.it=Object.assign({},this._request.it))}static get[s](){return G}get request(){return this._request.it}set request(e){const t=this.request;O(e,t)||(this._request.it=e)}}function J({requestParam:t}={}){return c(({get:s,set:a,key:r})=>{const n=[K,r];return{componentDef:l.all({feature:{needs:[$,U,M]},define(e){e.perComponent({a:z,by:e=>new z(e,n)}),t&&e.whenComponent(e=>{e.get(y).provide({a:B,is:t})})}},q({path:n,comment:`FEED(${String(r)})`}).By((function(e){return p.of(e).get(z).response.it}),r),g({path:n}).As((function(){const t=p.of(this),{contentRoot:s}=t,a=t.get(d).document;return s.appendChild(a.createElement("conduit-article-list")),s.appendChild(a.createElement("conduit-feed-pager")),e}),r)),get:s,set(e,t){a(e,t),p.of(e).get(z).request=t}}})}export{F as P,J as R};//# sourceMappingURL=render-feed.decorator.c649b50d.js.map
