{"version":3,"file":"main.b62dd7e2.js","sources":["../../src/pages/home/article-preview.component.ts","../../src/pages/home/feed-toggle.component.ts","../../src/pages/home/feed.component.ts","../../src/pages/home/home.component.ts","../../src/pages/home/index.ts"],"sourcesContent":["import { HandleNavLinks } from '@wesib/generic';\nimport { Component, ComponentContext, DomProperty, Render } from '@wesib/wesib';\nimport { Article, Conduit__NS, escapeHtml } from '../../common';\n\n@Component(\n    ['article-preview', Conduit__NS],\n    HandleNavLinks({\n      href(event) {\n\n        let target = event.target as Element;\n\n        for (;;) {\n\n          const href = target.getAttribute('href');\n\n          if (href != null) {\n            return href;\n          }\n\n          const { parentNode } = target;\n\n          if (!parentNode) {\n            return;\n          }\n          target = parentNode as Element;\n        }\n      },\n    }),\n)\nexport class ArticlePreviewComponent {\n\n  constructor(private readonly _context: ComponentContext) {\n  }\n\n  @DomProperty({ propertyKey: 'feedArticle' })\n  article: Article | undefined;\n\n  @Render()\n  render(): void {\n    if (!this.article) {\n      return;\n    }\n\n    const content = this._context.contentRoot as Element;\n    const { author } = this.article;\n    const profileURL = `profile/#${encodeURIComponent(author.username)}`;\n    const profileImage = author.image ? `<img src=\"${encodeURI(author.image)}\"/>` : '';\n    const username = escapeHtml(author.username);\n    const postDate = new Date(this.article.createdAt).toDateString();\n    const postURL = `article/#${encodeURIComponent(this.article.slug)}`;\n\n    content.innerHTML = `\n<div class=\"post-meta\">\n<a href=\"${profileURL}\">${profileImage}</a>\n<div class=\"info\">\n    <a href=\"${profileURL}\" class=\"author\">${username}</a>\n    <span class=\"date\">${postDate}</span>\n</div>\n<button class=\"btn btn-outline-primary btn-sm float-right\">\n  <i class=\"ion-heart\"></i> 32\n</button>\n</div>\n<a href=\"${postURL}\" class=\"preview-link\">\n<h1>${escapeHtml(this.article.title)}</h1>\n<p>${this.article.body}</p>\n<span>Read more...</span>\n</a>\n`;\n  }\n\n}\n","import { ActivateNavLink, HandleNavLinks, Navigation } from '@wesib/generic';\nimport { BootstrapWindow, Component, ComponentContext } from '@wesib/wesib';\nimport { noop } from 'call-thru';\nimport { afterAll } from 'fun-events';\nimport { AuthService, Conduit__NS, hashURL, setHashURL } from '../../common';\n\n@Component(\n    ['feed-toggle', Conduit__NS],\n    ActivateNavLink({ active: 'active' }),\n    HandleNavLinks(),\n)\nexport class FeedToggleComponent {\n\n  constructor(context: ComponentContext) {\n\n    const { document } = context.get(BootstrapWindow);\n    const navigation = context.get(Navigation);\n    const authService = context.get(AuthService);\n\n    context.whenOn(supply => {\n      afterAll({\n        user: authService.user,\n        page: navigation,\n      }).tillOff(supply)(\n          ({\n            user: [user],\n            page: [{ url }],\n          }) => {\n\n            const baseURL = new URL(document.baseURI);\n\n            if (url.pathname !== baseURL.pathname) {\n              return; // Not a home page\n            }\n\n            const hash = hashURL(url);\n            const feed = hash.pathname.substring(1);\n\n            if (!feed) {\n              return; // Global feed\n            }\n            if (feed !== 'personal' /* invalid feed */ || !user /* not authenticated */) {\n              // Redirect to global feed\n              hash.pathname = '';\n              navigation.replace(setHashURL(url, hash)).catch(noop);\n            }\n          },\n      );\n    });\n  }\n\n}\n","import { Navigation } from '@wesib/generic';\nimport { BootstrapWindow, Component, ComponentContext, ElementRender, Render } from '@wesib/wesib';\nimport { nextOnEvent, trackValue } from 'fun-events';\nimport {\n  ApiErrorGenerator,\n  ApiResponse,\n  ArticleList,\n  Conduit__NS,\n  FeedRequest,\n  feedRequestsEqual,\n  FeedService,\n  hashURL,\n} from '../../common';\n\n@Component(\n    ['feed', Conduit__NS],\n)\nexport class FeedComponent {\n\n  private readonly _request = trackValue<[boolean, FeedRequest]>([false, {}]);\n  private _response?: ApiResponse<ArticleList>;\n\n  constructor(private readonly _context: ComponentContext) {\n\n    const navigation = _context.get(Navigation);\n    const feedService = _context.get(FeedService);\n\n    _context.whenOn(supply => {\n      navigation.read.tillOff(supply)(({ url }) => {\n\n        const { pathname, searchParams: params } = hashURL(url);\n        const personal = pathname === '/personal';\n        const request: FeedRequest = {\n          tag: params.get('tag') || undefined,\n          author: params.get('author') || undefined,\n          favorited: params.get('favorited') || undefined,\n          limit: parseInt(params.get('limit') || '', 10) || undefined,\n          offset: parseInt(params.get('offset') || '', 10) || undefined,\n        };\n        const [prevPersonal, prevRequest] = this._request.it;\n\n        if (prevPersonal !== personal || !feedRequestsEqual(request, prevRequest)) {\n          this._request.it = [personal, request];\n        }\n      });\n      this._request.read\n          .tillOff(supply)\n          .thru_(\n              ([personal, request]) => {\n                this.response = undefined;\n                return nextOnEvent(personal\n                    ? feedService.feed(request)\n                    : feedService.articles(request));\n              },\n          )(response => this.response = response);\n    });\n  }\n\n  get response(): ApiResponse<ArticleList> | undefined {\n    return this._response;\n  }\n\n  set response(value: ApiResponse<ArticleList> | undefined) {\n\n    const old = this._response;\n\n    this._response = value;\n    this._context.updateState('posts', value, old);\n  }\n\n  @Render()\n  render(): ElementRender {\n\n    const document = this._context.get(BootstrapWindow).document;\n    const errorGen = this._context.get(ApiErrorGenerator);\n    const range = document.createRange();\n\n    range.selectNodeContents(this._context.contentRoot as unknown as Node);\n\n    return () => {\n\n      const response = this.response;\n\n      range.deleteContents();\n\n      if (!response) {\n        displayProgress();\n      } else if (response.ok) {\n        displayArticles(response.body);\n      } else {\n        displayError(response.errors);\n      }\n    };\n\n    function displayProgress(): void {\n      // TODO: Display articles load progress\n    }\n\n    function displayError(errors: ApiResponse.Errors): void {\n\n      const errorList = errorGen(errors);\n\n      if (errorList) {\n        range.insertNode(errorList);\n      } else {\n        range.insertNode(document.createTextNode('Failed to load articles'));\n      }\n    }\n\n    function displayArticles(articles: ArticleList): void {\n\n      const fragment = document.createDocumentFragment();\n\n      articles.articles.forEach(article => {\n\n        const element: any = fragment.appendChild(document.createElement('conduit-article-preview'));\n\n        element.feedArticle = article;\n      });\n\n      range.insertNode(fragment);\n    }\n  }\n\n}\n","import { Component } from '@wesib/wesib';\nimport { Conduit__NS } from '../../common';\nimport { ArticlePreviewComponent } from './article-preview.component';\nimport { FeedToggleComponent } from './feed-toggle.component';\nimport { FeedComponent } from './feed.component';\n\n@Component(\n    ['home', Conduit__NS],\n    {\n      feature: {\n        needs: [\n          ArticlePreviewComponent,\n          FeedComponent,\n          FeedToggleComponent,\n        ],\n      },\n    },\n)\nexport class HomeComponent {\n}\n","import { conduitContext } from '../../common';\nimport { HomeComponent } from './home.component';\n\nconduitContext.load(HomeComponent);\n"],"names":["ArticlePreviewComponent","[object Object]","_context","this","article","content","contentRoot","author","profileURL","encodeURIComponent","username","profileImage","image","encodeURI","escapeHtml","postDate","Date","createdAt","toDateString","postURL","slug","innerHTML","title","body","__decorate","DomProperty","propertyKey","Render","Component","Conduit__NS","HandleNavLinks","event","target","href","getAttribute","parentNode","FeedToggleComponent","context","document","get","BootstrapWindow","navigation","Navigation","authService","AuthService","whenOn","supply","afterAll","user","page","tillOff","url","baseURL","URL","baseURI","pathname","hash","hashURL","feed","substring","replace","setHashURL","catch","noop","ActivateNavLink","active","FeedComponent","trackValue","feedService","FeedService","read","searchParams","params","personal","request","tag","undefined","favorited","limit","parseInt","offset","prevPersonal","prevRequest","_request","it","feedRequestsEqual","thru_","response","nextOnEvent","articles","_response","value","old","updateState","errorGen","ApiErrorGenerator","range","createRange","selectNodeContents","deleteContents","ok","fragment","createDocumentFragment","forEach","appendChild","createElement","feedArticle","insertNode","displayArticles","errors","errorList","createTextNode","displayError","HomeComponent","feature","needs","conduitContext","load"],"mappings":"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"}